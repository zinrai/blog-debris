<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="This is an awesome blog">
        <meta name="viewport" content="width=device-width">
        <title>Home &mdash; command not found:</title>
            <link rel="stylesheet" href="_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="_static/main.css" type="text/css">
            <link rel="stylesheet" href="_static/dark.css" type="text/css">
            <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="_static/webfont.css" type="text/css">
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="next" title="Older" href="page2.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {
            // Adjusts document height if sidebar is taller
            var documentwrapper = document.getElementsByTagName('article')[0];
            var sidebar = document.getElementsByTagName('aside')[0];

            if (sidebar.offsetHeight > documentwrapper.offsetHeight)
            {
                documentwrapper.style.minHeight = sidebar.offsetHeight + "px";
            }

            // Scroll to content if on small screen
            if (screen.width < 480)
            {
                $(document).scrollTop(documentwrapper.offsetTop - 44);
            }
        });
    </script></head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><div class="header-container">
    <header class="wrapper clearfix">
        <div class="title">
          <h1><a href="#">command not found:</a></h1>
          <h4>Hello World</h4>
        </div>
        <nav>
          <ul>
            <li class="main-nav">
              <a href="#">Home</a>
            </li>
            <li class="quicklink"><div class="rss">
        <a href="rss.html" title="Subscribe via RSS"><span class="webfont">B</span></a>
    </div></li></ul>
        </nav>
    </header>
</div>

<div class="main-container"><div class="main wrapper clearfix"><article><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="page2.html">Older</a> &raquo; </li>
        </ul><div class="timestamp postmeta">
            <span>August 22, 2013</span>
        </div>
        <div class="section" id="freebsd-9-1-vimage-zfs-jail">
<h1><a href="2013/08/22/freebsd_jail_vimage_zfs.html">FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</a></h1>
<p>VIMAGE + ZFSでいくらでも作ったり、壊したり、巻き戻したり出来る環境を構築してみる。jail環境をビルドするためにソースを取ってくる。ソースはsubversionで管理されている。まずsubversionをインストールから。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># portsnap fetch</span>
<span class="c"># portsnap extract</span>
<span class="c"># portsnap update</span>

<span class="c"># cd /usr/ports/devel/subversion</span>
<span class="c"># make install</span>
</pre></div>
</div>
<p>VIMAGEが使えるようにカーネルを再構築する。</p>
<div class="highlight-python"><pre># cd /usr/src
# svn checkout svn://svn.freebsd.org/base/release/9.1.0
# cd 9.1.0/sys/amd64/conf
# cp GENERIC VIMAGE

# vi VIMAGE
options         VIMAGE

# cd /usr/src/9.1.0
# make buildkernel KERNCONF=VIMAGE
# make installkernel KERNCONF=VIMAGE
# reboot</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /usr/src/9.1.0</span>
<span class="c"># make buildworld</span>
<span class="c"># make installworld DESTDIR=/jails/test01</span>
<span class="c"># make distribution DESTDIR=/jails/test01</span>
</pre></div>
</div>
<div class="highlight-python"><pre># zpool list
NAME    SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
jails   356G   900M   355G     0%  1.00x  ONLINE  -

# zfs create jails/test01
# zfs snapshot jails/test01@base
# zfs clone jails/test01@base jails/test02</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>

<span class="n">ifconfig_re0</span><span class="o">=</span><span class="s">&quot; inet 192.168.0.253 netmask 255.255.255.0&quot;</span>
<span class="n">defaultrouter</span><span class="o">=</span><span class="s">&quot;192.168.0.254&quot;</span>

<span class="n">cloned_interfaces</span><span class="o">=</span><span class="s">&quot;bridge0&quot;</span>
<span class="n">ifconfig_bridge0_name</span><span class="o">=</span><span class="s">&quot;vswitch0&quot;</span>
<span class="n">ifconfig_vswitch0</span><span class="o">=</span><span class="s">&quot;addm re0&quot;</span>
</pre></div>
</div>
<p>netstatしたときなどに/dev/kmem,/dev/memがないよと言われるので、/etc/default/devfs.rulesを参考に、devfs.rules(5)のルールを追加しておく。</p>
<div class="highlight-python"><pre># vi /etc/devfs.rules

[devfsrules_jail=5]
add include $devfsrules_hide_all
add include $devfsrules_unhide_basic
add include $devfsrules_unhide_login
add path zfs unhide
add path mem unhide
add path kmem unhide</pre>
</div>
<p>jailの設定はrc.conf(5)ではなくjail.conf(5)に書く。jail(8)を眺めながら設定ファイルを書いてみた。変数が使えていい感じ。ネームサーバーを設定するパラメータが見当らないので、ネームサーバーの設定はjail内のresolv.confに書くことにする。</p>
<div class="highlight-python"><pre># vi /etc/jail.conf

exec.prestart  = &quot;ifconfig epair${if} create up &gt; /dev/null&quot;;
exec.prestart += &quot;ifconfig vswitch0 addm epair${if}a&quot;;
exec.start     = &quot;ifconfig lo0 up 127.0.0.1&quot;;
exec.start    += &quot;ifconfig epair${if}b up $ipaddr&quot;;
exec.start    += &quot;route add default 192.168.0.254&quot;;
exec.start    += &quot;sh /etc/rc&quot;;
exec.stop      = &quot;sh /etc/rc.shutdown&quot;;
exec.poststop  = &quot;ifconfig epair${if}a destroy&quot;;
host.hostname  = &quot;${name}.localnet&quot;;
mount.devfs;
devfs_ruleset = 5;
vnet;
vnet.interface = &quot;epair${if}b&quot;;
path = &quot;/jails/${name}&quot;;
persist;

test01 {
        $if = 1;
        $ipaddr = 192.168.0.1;
}

test02 {
        $if = 2;
        $ipaddr = 192.168.0.2;
}</pre>
</div>
<div class="highlight-python"><pre># jail -c test01
# jls
   JID  IP Address      Hostname                      Path
    11  -               test01.localnet               /jails/test01

# jexec 11 tcsh
# jail -r test01</pre>
</div>
<p>FreeBSD起動時にjailを起動させたければrc.conf(5)下記のように書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>

<span class="n">jail_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
<span class="n">jail_list</span><span class="o">=</span><span class="s">&quot;test01 test02&quot;</span>
</pre></div>
</div>
<p>ZFSのスナップショット、ロールバックで何度でもやり直せる。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs snapshot jails/test01@snap01</span>
<span class="c"># zfs rollback jails/test01@snap01</span>
<span class="c"># zfs set quota=10g jails/test01</span>
<span class="c"># zfs clone jails/test01@snap01 jails/test03</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.freebsd.org/doc/ja/books/handbook/svn-mirrors.html">http://www.freebsd.org/doc/ja/books/handbook/svn-mirrors.html</a></li>
<li><a class="reference external" href="http://www.freebsd.org/doc/ja/books/handbook/kernelconfig-building.html">http://www.freebsd.org/doc/ja/books/handbook/kernelconfig-building.html</a></li>
</ul>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by zinrai</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/freebsd.html">freebsd</a>, <a href="categories/jail.html">jail</a>, <a href="categories/zfs.html">zfs</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/freebsd.html">freebsd</a>, <a href="tags/jail.html">jail</a>, <a href="tags/zfs.html">zfs</a></span>
        </div>
        </div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>July 20, 2013</span>
        </div>
        <div class="section" id="pxe-boot-freebsd-9-1">
<h1><a href="2013/07/20/freebsd_pxeboot.html">PXE boot + シェルスクリプトでFreeBSD 9.1のインストール自動化</a></h1>
<p>OSインストールをするだけでお金が貰えるならば喜んでやるが、趣味の時間をOSインストールに奪われるのはつらいので、自動化してみた。</p>
<div class="section" id="pxe-boot">
<h2>PXE boot サーバ構築</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mdconfig -a -t vnode -f FreeBSD-9.1-RELEASE-amd64-disc1.iso</span>
<span class="n">md0</span>
<span class="c"># mount_cd9660 /dev/md0 /mnt</span>
<span class="c"># mkdir /var/pxeboot</span>
<span class="c"># cp -Rv /mnt/ /var/pxeboot</span>
<span class="c"># umount /mnt</span>
<span class="c"># mdconfig -d -u 0</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/pxeboot/etc/fstab</span>
<span class="c"># /dev/iso9660/FREEBSD_INSTALL / cd9660 ro 0 0 &lt;- コメントアウト</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /etc/inetd.conf
tftp    dgram   udp     wait    root    /usr/libexec/tftpd      tftpd -l -s /var/pxeboot/boot

# /etc/rc.d/inetd onestart</pre>
</div>
<div class="highlight-python"><pre># cd /usr/ports/net/isc-dhcp42-server
# make install

# vi /usr/local/etc/dhcpd.conf
ddns-update-style none;
server-name &quot;pxeboot&quot;;               # name of the tftp-server
server-identifier 192.168.0.253;  # address of the tftp-server
next-server 192.168.0.253;        # address of the NFS-server

subnet 192.168.0.0 netmask 255.255.255.0 {
    range 192.168.0.220 192.168.0.250;
    option routers 192.168.0.254;
    option root-path &quot;/var/pxeboot&quot;; # root-path for NFS
    filename &quot;pxeboot&quot;;                    # filename of NBP (network bootstrap program)
}

# /usr/local/etc/rc.d/isc-dhcpd onestart</pre>
</div>
<div class="highlight-python"><pre># vi /etc/exports
/var/pxeboot -alldirs -maproot=root

# /etc/rc.d/nfsd onestart</pre>
</div>
<p>再起動後もデーモンを起動させておきたければrc.confに書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">inetd_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
<span class="n">dhcpd_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
<span class="n">nfs_server_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="freebsd">
<h2>FreeBSDインストールスクリプト</h2>
<p>このシェルスクリプトはPXE bootしたマシンのMACアドレスを見てマッチした[MACアドレス].confファイルに書かれたシェルスクリプトを実行するようになっている。</p>
<div class="highlight-python"><pre># vi /var/pxeboot/var/scripts/os_install.sh

#!/bin/sh

get_conf() {
  if [ &quot;$OS&quot; = &quot;FreeBSD&quot; ]; then
    local MACADDR=&quot;`ifconfig | awk '/ether/ {print $NF}'`&quot;
  elif [ &quot;$OS&quot; = &quot;Linux&quot; ]; then
    local MACADDR=&quot;`ifconfig | awk '/HWaddr/ {print $NF}'`&quot;
  fi

  for a in $MACADDR; do
    find . -name ${a}.conf
  done
}

OS=`uname`
CONFFILE=`get_conf`

if [ &quot;$OS&quot; = &quot;FreeBSD&quot; ]; then
  IFACE=`netstat -nr | awk '{if($3 ~ /^UG$/) print $6}'`
  DIRNAME=`sha256 -q $CONFFILE`
elif [ &quot;$OS&quot; = &quot;Linux&quot; ]; then
  IFACE=`netstat -nr | awk '{if($4 ~ /^UG$/) print $8}'`
  DIRNAME=`sha256sum $CONFFILE | awk '{print $1}'`
fi

mkdir /mnt/${DIRNAME}

if [ -n &quot;$CONFFILE&quot; ]; then
  sh $CONFFILE $IFACE $DIRNAME
fi</pre>
</div>
<div class="highlight-python"><pre># vi /var/pxeboot/var/scripts/01:23:45:67:89:ab.conf

#!/bin/sh

IFACE=$1
DISK=ada1
MOUNTDIR=&quot;/mnt/$2&quot;
DIST_TXZ=`ls /usr/freebsd-dist/*.txz`

gpart destroy -F $DISK
gpart create -s gpt $DISK
gpart add -s 64K -t freebsd-boot $DISK
gpart add -s 8G -t freebsd-swap -l swap0 $DISK
gpart add -t freebsd-ufs $DISK
gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 $DISK

newfs -U /dev/${DISK}p3

mount /dev/${DISK}p3 $MOUNTDIR

cd $MOUNTDIR

for FILE in $DIST_TXZ; do
  tar xfzp $FILE
done

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/etc/rc.conf
hostname=&quot;freebsd.local&quot;
keymap=&quot;us.iso.kbd&quot;
ifconfig_${IFACE}=&quot; inet 192.168.0.252 netmask 255.255.255.0&quot;
defaultrouter=&quot;192.168.0.254&quot;
sshd_enable=&quot;YES&quot;
# Set dumpdev to &quot;AUTO&quot; to enable crash dumps, &quot;NO&quot; to disable
dumpdev=&quot;AUTO&quot;
EOF

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/etc/resolv.conf
nameserver 8.8.8.8
EOF

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/etc/fstab
# Device        Mountpoint      FStype  Options Dump    Pass#
/dev/${DISK}p3     /               ufs     rw      1       1
/dev/${DISK}p2     none            swap    sw      0       0
EOF

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/tmp/freebsd_setup.sh
newaliases
tzsetup Asia/Tokyo

printf &quot;hogefugamoge&quot; | pw usermod -n root -h 0

pw useradd -n nanashi -s /bin/tcsh -G wheel -m
printf &quot;ebifuraibutsukenzo&quot; | pw usermod -n nanashi -h 0

dumpon /dev/${DISK}p2
ln -sf /dev/${DISK}p2 /dev/dumpdev
EOF

mount -t devfs dev ${MOUNTDIR}/dev
chroot $MOUNTDIR /bin/sh /tmp/freebsd_setup.sh

rm ${MOUNTDIR}/tmp/freebsd_setup.sh

cd /
umount ${MOUNTDIR}/dev
umount $MOUNTDIR

rmdir $MOUNTDIR
reboot</pre>
</div>
<p>PXE boot時に指定のスクリプトを実行するようにrc.localに書いておく。</p>
<div class="highlight-python"><pre># vi /var/pxeboot/etc/rc.local

#!/bin/sh
# $FreeBSD: release/9.1.0/release/rc.local 232427 2012-03-03 02:13:53Z nwhitehorn $

/var/script/os_install.sh</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY_2013022201">https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY_2013022201</a></li>
<li><a class="reference external" href="http://stefankonarski.de/content/freebsd-9-pxe-boot-und-bsdinstall-installieren">http://stefankonarski.de/content/freebsd-9-pxe-boot-und-bsdinstall-installieren</a></li>
</ul>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by zinrai</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/freebsd.html">freebsd</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/freebsd.html">freebsd</a></span>
        </div>
        </div><div class="separator post_separator"></div><div class="timestamp postmeta">
            <span>June 22, 2013</span>
        </div>
        <div class="section" id="cobbler-puppet">
<h1><a href="2013/06/22/centos_cobbler_puppet_install.html">Cobbler + Puppet</a></h1>
<p>前回はCobblerでとりあえずOSインストールが出来るところまでやったので、今回はkickstartファイルの編集、Puppet(Puppet client)のインストールとセットアップを自動化してみる。</p>
<div class="section" id="dnsmasq">
<h2>dnsmasq</h2>
<p>DHCP,DNSサーバにdnsmasqを使用する。ISC DHCPよりもdnsmasqを使ったほうがPuppetと連携させやすいことに気が付いた。</p>
<div class="highlight-python"><pre># vi /etc/cobbler/settings

manage_dns: 1
manage_dhcp: 1
server: 192.168.0.1
next_server: 192.168.0.254 &lt;- Gateway</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/cobbler/modules.conf</span>

<span class="p">[</span><span class="n">dns</span><span class="p">]</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">manage_dnsmasq</span>

<span class="p">[</span><span class="n">dhcp</span><span class="p">]</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">manage_dnsmasq</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># yum install dnsmasq</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /etc/cobbler/dnsmasq.template

# Cobbler generated configuration file for dnsmasq
# $date
#

# resolve.conf .. ?
#no-poll
#enable-dbus
read-ethers
addn-hosts = /var/lib/cobbler/cobbler_hosts

dhcp-range=192.168.0.220,192.168.0.250
dhcp-option=3,$next_server
dhcp-lease-max=1000
dhcp-authoritative
dhcp-boot=pxelinux.0
dhcp-boot=net:normalarch,pxelinux.0
dhcp-boot=net:ia64,$elilo

$insert_cobbler_system_definitions</pre>
</div>
<div class="highlight-python"><pre># vi /etc/hosts
192.168.0.1 cobbler.localnet</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># chkconfig dnsmasq on</span>
<span class="c"># service dnsmasq start</span>
<span class="c"># service cobblerd restart</span>
<span class="c"># cobbler sync</span>
</pre></div>
</div>
</div>
<div class="section" id="cobbler">
<h2>Cobbler</h2>
<div class="highlight-python"><pre># cobbler profile report
Name                           : CentOS6.4-x86_64
TFTP Boot Files                : {}
Comment                        :
DHCP Tag                       : default
Distribution                   : CentOS6.4-x86_64
Enable gPXE?                   : 0
Enable PXE Menu?               : 1
Fetchable Files                : {}
Kernel Options                 : {}
Kernel Options (Post Install)  : {}
Kickstart                      : /var/lib/cobbler/kickstarts/sample.ks
Kickstart Metadata             : {}
Management Classes             : []
Management Parameters          : &lt;&lt;inherit&gt;&gt;
Name Servers                   : []
Name Servers Search Path       : []
Owners                         : ['admin']
Parent Profile                 :
Proxy                          :
Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;
Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;
Repos                          : []
Server Override                : &lt;&lt;inherit&gt;&gt;
Template Files                 : {}
Virt Auto Boot                 : 1
Virt Bridge                    : xenbr0
Virt CPUs                      : 1
Virt Disk Driver Type          : raw
Virt File Size(GB)             : 5
Virt Path                      :
Virt RAM (MB)                  : 512
Virt Type                      : qemu</pre>
</div>
<p>登録しているprofileからPuppet Server,Puppet Clientのprofileを作成する。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler profile copy --name=CentOS6.4-x86_64 --newname=CentOS6.4-puppet_server</span>
<span class="c"># cobbler profile copy --name=CentOS6.4-x86_64 --newname=CentOS6.4-puppet_client</span>
</pre></div>
</div>
<p>EPELにあるPuppetを使用する。</p>
<div class="highlight-python"><pre># yum -y install wget

# cobbler repo add --name=CentOS6.4-epel --mirror=http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel/6/x86_64 --mirror-locally=no
# cobbler reposync
# mkdir /var/www/cobbler/repo_mirror/CentOS6.4-epel/.origin
# cobbler reposync

# cobbler repo report
Name                           : CentOS6.4-epel
Arch                           : x86_64
Breed                          : yum
Comment                        :
Createrepo Flags               : &lt;&lt;inherit&gt;&gt;
Environment Variables          : {}
Keep Updated                   : True
Mirror                         : http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel/6/x86_64
Mirror locally                 : False
Owners                         : ['admin']
Priority                       : 99
RPM List                       : []
Yum Options                    : {}</pre>
</div>
<p>profileにリポジトリの情報を追加</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler profile edit --name=CentOS6.4-puppet_server --repos=&quot;CentOS6.4-epel&quot;</span>
<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_client --repos=&quot;CentOS6.4-epel&quot;</span>
</pre></div>
</div>
<p>profileをコピーしたままの状態ではsample.ksファイルが読み込まれるので、ksファイルをコピーしてPuppetをインストールするよう書き換える。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /var/lib/cobbler/kickstarts</span>
<span class="c"># cp sample.ks puppet_server.ks</span>
<span class="c"># cp sample.ks puppet_client.ks</span>

<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_server --kickstart=/var/lib/cobbler/kickstarts/puppet_server.ks</span>
<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_client --kickstart=/var/lib/cobbler/kickstarts/puppet_client.ks</span>
</pre></div>
</div>
<p>固定IPを割り振るためにsystemに登録する。</p>
<div class="highlight-python"><pre># vi /etc/cobbler/settings
pxe_just_once: 1

# service cobblerd restart</pre>
</div>
<div class="highlight-python"><pre># cobbler system add  \
--name=puppet-server-2 \
--hostname=puppetserver.localnet \
--dns-name=puppetserver.localnet \
--profile=CentOS6.4-puppet_server \
--interface=eth0 \
--mac=XX:XX:XX:XX:XX:XX \
--static=1 \
--ip-address=192.168.0.2 \
--subnet=255.255.255.0 \
--gateway=192.168.0.254 \
--name-servers=192.168.0.1

# cobbler system add  \
--name=puppet-client-003 \
--hostname=puppetclient003.localnet \
--dns-name=puppetclient003.localnet \
--profile=CentOS6.4-puppet_client \
--interface=eth0 \
--mac=XX:XX:XX:XX:XX:XX \
--static=1 \
--ip-address=192.168.0.3 \
--subnet=255.255.255.0 \
--gateway=192.168.0.254 \
--name-servers=192.168.0.1</pre>
</div>
<p>pxe_just_onceを有効にすると登録したsystemは1度しかpxe bootしないので、OSインストール後に、もう1度pxe bootさせたくなったら下記を実行する。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler system edit --name=puppet-client-003 --netboot-enabled=1</span>
</pre></div>
</div>
</div>
<div class="section" id="puppet">
<h2>Puppet</h2>
<p>PuppetにはPUSHモードとPULLモードがある。</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%"/>
<col width="86%"/>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>PULL</td>
<td>クライアントからサーバへ定期的にマニュフェストを取得し適用する。</td>
</tr>
<tr class="row-even"><td>PUSH</td>
<td>サーバからクライアントへマニュフェストを取得し適用するよう指示する。</td>
</tr>
</tbody>
</table>
<p>今回はPUSHモードのPuppet環境を構築する。</p>
<div class="section" id="puppet-server">
<h3>Puppet server</h3>
<p>Puppet clientを自動構築するためにPuppet serverを作り込む。</p>
<p>Puppet serverのほうはOSインストール後にPuppet serverをインストールするなり、Cobblerサーバのkickstartファイルのpackageセクションに記述するなり好きにすればいいと思う。</p>
<div class="highlight-python"><pre># puppet --version
2.6.18</pre>
</div>
<div class="highlight-python"><pre># vi /etc/sysconfig/puppet

# The puppetmaster server
#PUPPET_SERVER=puppet

# If you wish to specify the port to connect to do so here
PUPPET_PORT=8139

# Where to log to. Specify syslog to send log messages to the system log.
PUPPET_LOG=/var/log/puppet/puppet.log

# You may specify other parameters to the puppet client here
#PUPPET_EXTRA_OPTS=--waitforcert=500</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/autosign.conf

*.localnet</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/fileserver.conf

[files]
 path /etc/puppet/manifests/files
 allow *</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/manifests/site.pp

package { 'zsh' :
        ensure =&gt; present;
}

file { '/etc/sysconfig/puppet' :
        owner =&gt; 'root',
        group =&gt; 'root',
        mode =&gt; 644,
        source =&gt; 'puppet://puppetserver.localnet/files/puppet',
}

file { '/etc/puppet/auth.conf' :
        owner =&gt; 'root',
        group =&gt; 'root',
        mode =&gt; 644,
        source =&gt; 'puppet://puppetserver.localnet/files/auth.conf',
}</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/manifests/files/puppet

# The puppetmaster server
PUPPET_SERVER=puppetsrv.localnet

# If you wish to specify the port to connect to do so here
#PUPPET_PORT=8140

# Where to log to. Specify syslog to send log messages to the system log.
PUPPET_LOG=/var/log/puppet/puppet.log

# You may specify other parameters to the puppet client here
#PUPPET_EXTRA_OPTS=--waitforcert=500
PUPPET_EXTRA_OPTS=&quot;--listen --no-client&quot;</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/manifests/files/auth.conf

path /run
method save
allow *

path /
auth any</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># service puppetmaster start</span>
</pre></div>
</div>
<p>これで以下のコマンドを実行すればPuppet clientにマニュフェストが適用される。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># puppet kick --host puppetclient002.localnet</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="kickstart">
<h2>Kickstart</h2>
<p>Puppet client用のkickstartファイルは下記のようになっている。</p>
<p>postセクションに</p>
<div class="highlight-python"><pre>/sbin/chkconfig puppet on
puppet agent --server=puppetserver.localnet --no-daemonize --onetime</pre>
</div>
<p>を記述することで、Puppetの自動起動、Puppet serverからマニュフェストを取得する処理が1度だけ実行される。これでPuppet clientはOSインストールからPuppetインストール,セットアップまで自動化することが出来た。しかし、今回の設定では各clientの細かい制御(client1にはapache,client2にはmysqlなど)が出来ていないのでそれについては、またの機会に書きたいと思う。</p>
<div class="highlight-python"><pre># vi /var/lib/cobbler/kickstarts/puppet_client.ks

#platform=x86, AMD64, or Intel EM64T
# System authorization information
auth  --useshadow  --enablemd5
# System bootloader configuration
bootloader --location=mbr
# Partition clearing information
clearpart --all --initlabel
# Use text mode install
text
# Firewall configuration
#firewall --enabled
firewall --disabled
# Run the Setup Agent on first boot
firstboot --disable
# Timezone
timezone Asia/Tokyo
# System keyboard
keyboard us
# System language
lang en_US
# Use network installation
url --url=$tree
# If any cobbler repo definitions were referenced in the kickstart profile, include them here.
$yum_repo_stanza
# Network information
$SNIPPET('network_config')
# Reboot after installation
reboot

#Root password
rootpw --iscrypted $default_password_crypted
# SELinux configuration
selinux --disabled
# Do not configure the X Window System
skipx
# System timezone
timezone  America/New_York
# Install OS instead of upgrade
install
# Clear the Master Boot Record
zerombr
# Allow anaconda to partition the system as needed
autopart


%pre
$SNIPPET('log_ks_pre')
$SNIPPET('kickstart_start')
$SNIPPET('pre_install_network_config')
# Enable installation monitoring
$SNIPPET('pre_anamon')

%packages
$SNIPPET('func_install_if_enabled')
$SNIPPET('puppet_install_if_enabled')
puppet

%post
$SNIPPET('log_ks_post')
# Start yum configuration
$yum_config_stanza
# End yum configuration
$SNIPPET('post_install_kernel_options')
$SNIPPET('post_install_network_config')
$SNIPPET('func_register_if_enabled')
$SNIPPET('puppet_register_if_enabled')
$SNIPPET('download_config_files')
$SNIPPET('koan_environment')
$SNIPPET('redhat_register')
$SNIPPET('cobbler_register')
/sbin/chkconfig puppet on
puppet agent --server=puppetserver.localnet --no-daemonize --onetime
# Enable post-install boot notification
$SNIPPET('post_anamon')
# Start final steps
$SNIPPET('kickstart_done')
# End final steps</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.cobblerd.org/manuals/2.4.0/4/4/2_-_Managing_DNS.html">Managing DNS</a></li>
<li><a class="reference external" href="http://www.cobblerd.org/manuals/2.2.3/4/3/1_-_Managing_DHCP.html">Managing DHCP</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/int128/20120226/1330247800">http://d.hatena.ne.jp/int128/20120226/1330247800</a></li>
<li><a class="reference external" href="http://blog.glidenote.com/blog/2012/03/16/cobbler-system-add">http://blog.glidenote.com/blog/2012/03/16/cobbler-system-add/</a></li>
</ul>
</div>
</div>
        <div class="postmeta">
        <div class="author">
            <span>Posted by zinrai</span>
        </div>
        <div class="categories">
            <span>
                Filed under:
                <a href="categories/centos.html">centos</a>, <a href="categories/puppet.html">puppet</a>, <a href="categories/cobbler.html">cobbler</a></span>
        </div>
        <div class="tags">
            <span>
                Tags:
                <a href="tags/centos.html">centos</a>, <a href="tags/puppet.html">puppet</a>, <a href="tags/cobbler.html">cobbler</a></span>
        </div>
        </div><div class="archive_link">
        <a href="archive.html"> &mdash;  Blog Archive  &mdash; </a>
    </div><ul class="related clearfix">
            <li class="left"></li>
            <li class="right"><a href="page2.html">Older</a> &raquo; </li>
        </ul></article><aside class="sidebar"><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="2013/08/22/freebsd_jail_vimage_zfs.html">FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</a>
        </li><li>
            <a href="2013/07/20/freebsd_pxeboot.html">PXE boot + シェルスクリプトでFreeBSD 9.1のインストール自動化</a>
        </li><li>
            <a href="2013/06/22/centos_cobbler_puppet_install.html">Cobbler + Puppet</a>
        </li><li>
            <a href="2013/06/18/centos_cobbler_setup.html">CentOS6.4にCobblerサーバ構築</a>
        </li><li>
            <a href="2013/06/08/ubuntu_mongodb_rails3_setup.html">Rails3でMongoDBを使ってみる</a>
        </li><li>
            <a href="2013/06/05/debian_wheezy_nested_kvm.html">Debian wheezyでNested KVMを試してみる</a>
        </li><li>
            <a href="2013/05/26/ubuntu_mongodb_install.html">Ubuntu12.04にMongoDBをインストール</a>
        </li><li>
            <a href="2013/05/20/unbound_nsd.html">Unbound + NSD</a>
        </li><li>
            <a href="2013/03/23/tinkerer_github.html">Tinkerer + Github</a>
        </li></ul>
</div>
</section><section><div class="widget">
    <h1>Categories</h1>
    <ul><li><a href="categories/centos.html">centos</a> (2)</li><li><a href="categories/cobbler.html">cobbler</a> (2)</li><li><a href="categories/debian.html">debian</a> (1)</li><li><a href="categories/dns.html">dns</a> (1)</li><li><a href="categories/freebsd.html">freebsd</a> (2)</li><li><a href="categories/github.html">github</a> (1)</li><li><a href="categories/jail.html">jail</a> (1)</li><li><a href="categories/kvm.html">kvm</a> (1)</li><li><a href="categories/mongodb.html">mongodb</a> (2)</li><li><a href="categories/nsd.html">nsd</a> (1)</li><li><a href="categories/puppet.html">puppet</a> (1)</li><li><a href="categories/python.html">python</a> (1)</li><li><a href="categories/rails.html">rails</a> (1)</li><li><a href="categories/ubuntu.html">ubuntu</a> (3)</li><li><a href="categories/unbound.html">unbound</a> (1)</li><li><a href="categories/zfs.html">zfs</a> (1)</li></ul>
</div></section><section><div class="widget">
    <h1>Tags</h1><a href="tags/centos.html">centos</a> (2), <a href="tags/cobbler.html">cobbler</a> (2), <a href="tags/debian.html">debian</a> (1), <a href="tags/dns.html">dns</a> (1), <a href="tags/freebsd.html">freebsd</a> (2), <a href="tags/github.html">github</a> (1), <a href="tags/jail.html">jail</a> (1), <a href="tags/kvm.html">kvm</a> (1), <a href="tags/mongodb.html">mongodb</a> (2), <a href="tags/nsd.html">nsd</a> (1), <a href="tags/puppet.html">puppet</a> (1), <a href="tags/python.html">python</a> (1), <a href="tags/rails.html">rails</a> (1), <a href="tags/ubuntu.html">ubuntu</a> (3), <a href="tags/unbound.html">unbound</a> (1), <a href="tags/zfs.html">zfs</a> (1)</div></section><section><div class="widget" id="searchbox">
    <h1>Search</h1>
    <form action="search.html" method="get">
        <input type="text" name="q" />
        <button type="submit"><span class="webfont">L</span></button>
    </form>
</div></section></aside></div> <!-- #main --></div> <!-- #main-container -->

        <div class="footer-container"><footer class="wrapper">&copy; Copyright 2012, zinrai. Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.</footer></div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>