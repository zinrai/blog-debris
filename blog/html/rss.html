<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>command not found:</title>
        <link>http://127.0.0.1/blog/html/</link>
        <description>Hello World</description>
        <language>en-us</language>
        <pubDate>Thu, 12 Jun 2014 00:00:00 +0900</pubDate>
        
        <item>
            <link>http://127.0.0.1/blog/html/2014/06/12/centos65_forward_proxy_squid.html</link>
            <guid>http://127.0.0.1/blog/html/2014/06/12/centos65_forward_proxy_squid.html</guid>
            <title><![CDATA[squidでForward Proxy Server]]></title>
            <description><![CDATA[<h1>squidでForward Proxy Server</h1>
<p>yum(8)で取得するrpmをキャッシュさせたくて、squidでForward Proxy Serverを構築してみた。</p>
<div class="highlight-python"><div class="highlight"><pre>% uname -a
Linux proxy-server 2.6.32-431.el6.x86_64 #1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux

% cat /etc/redhat-release
CentOS release 6.5 (Final)
</pre></div>
</div>
<div class="section" id="squid">
<h2>squid</h2>
<div class="highlight-python"><div class="highlight"><pre>$ yum info squid
Available Packages
Name        : squid
Arch        : x86_64
Epoch       : 7
Version     : 3.1.10
Release     : 20.el6_5.3
Size        : 1.7 M
Repo        : updates
Summary     : The Squid proxy caching server
URL         : http://www.squid-cache.org
License     : GPLv2 and (LGPLv2+ and Public Domain)
Description : Squid is a high-performance proxy caching server for Web clients,
            : supporting FTP, gopher, and HTTP data objects. Unlike traditional
            : caching software, Squid handles all requests in a single,
            : non-blocking, I/O-driven process. Squid keeps meta data and especially
            : hot objects cached in RAM, caches DNS lookups, supports non-blocking
            : DNS lookups, and implements negative caching of failed requests.
            :
            : Squid consists of a main server program squid, a Domain Name System
            : lookup program (dnsserver), a program for retrieving FTP data
            : (ftpget), and some management and client tools.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% yum install squid
</pre></div>
</div>
<p>yum(8)で取得するrpmをキャッシュさせたいのでキャッシュするファイルの最大サイズを大きめに設定する。</p>
<div class="highlight-python"><div class="highlight"><pre>% diff -u squid.conf.org squid.conf
--- squid.conf.org      2014-06-12 13:55:43.444802617 +0000
+++ squid.conf  2014-06-13 01:35:22.999614814 +0000
@@ -65,7 +65,11 @@
 hierarchy_stoplist cgi-bin ?

 # Uncomment and adjust the following to add a disk cache directory.
-#cache_dir ufs /var/spool/squid 100 16 256
+cache_mem 1024 MB
+cache_dir ufs /var/spool/squid 4192 16 256
+
+maximum_object_size 128 MB
+maximum_object_size_in_memory 10 MB

 # Leave coredumps in the first cache dir
 coredump_dir /var/spool/squid
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ service squid start
</pre></div>
</div>
<p>squidclient(1)を使って、どれくれいキャッシュがヒットしているか調べてみた。</p>
<div class="highlight-python"><div class="highlight"><pre>% squidclient -p 3128 mgr:client_list
Cache Clients:
Address: 192.168.0.2
Currently established connections: 0
    ICP  Requests 0
    HTTP Requests 180
        TCP_HIT                  106  59%
        TCP_MISS                  70  39%
        TCP_REFRESH_UNMODIFI       4   2%

Address: ::1
Name:    localhost
Currently established connections: 1
    ICP  Requests 0
    HTTP Requests 2
        TCP_MISS                   2 100%

TOTALS
ICP : 0 Queries, 0 Hits (  0%)
HTTP: 182 Requests, 110 Hits ( 60%)
</pre></div>
</div>
</div>
<div class="section" id="client">
<h2>client</h2>
<p>yum(8)をProxy経由させるためにyum.conf(5)に設定する。</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/yum.conf
proxy=http://192.168.0.1:3128/

% yum update
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.squid-cache.org/Doc/config">http://www.squid-cache.org/Doc/config/</a></li>
<li><a class="reference external" href="http://www.squid-cache.org/Doc/config/cache_mem">http://www.squid-cache.org/Doc/config/cache_mem/</a></li>
<li><a class="reference external" href="http://www.squid-cache.org/Doc/config/cache_dir">http://www.squid-cache.org/Doc/config/cache_dir/</a></li>
<li><a class="reference external" href="http://www.squid-cache.org/Doc/config/maximum_object_size">http://www.squid-cache.org/Doc/config/maximum_object_size/</a></li>
<li><a class="reference external" href="http://www.squid-cache.org/Doc/config/maximum_object_size_in_memory">http://www.squid-cache.org/Doc/config/maximum_object_size_in_memory/</a></li>
</ul></div>]]></description>
            <category><![CDATA[ squid ]]></category>
             <pubDate>Thu, 12 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/06/11/debian_wheezy_mysql_community_server.html</link>
            <guid>http://127.0.0.1/blog/html/2014/06/11/debian_wheezy_mysql_community_server.html</guid>
            <title><![CDATA[Debian wheezy MySQL 5.6 インストール]]></title>
            <description><![CDATA[<h1>Debian wheezy MySQL 5.6 インストール</h1>
<p>MySQL5.6をapt-get(8)できるように設定する。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux zinrai 3.2.0-4-amd64 #1 SMP Debian 3.2.57-3+deb7u2 x86_64 GNU/Linux

$ cat /etc/debian_version
7.5
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% dpkg -i mysql-apt-config_0.1.5-1debian7_all.deb

$ cat /etc/apt/sources.list.d/mysql.list
### THIS FILE IS AUTOMATICALLY CONFIGURED ###
# You may comment out this entry, but any other modifications may be lost.
deb http://repo.mysql.com/apt/ stable mysql-5.6
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get update
% apt-get install mysql-community-server

% service mysql start
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% mysql -u root -p

mysql&gt; show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| performance_schema |
| test               |
+--------------------+
4 rows in set (0.00 sec)

mysql&gt; use test;
Database changed

mysql&gt; show tables;
Empty set (0.00 sec)
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://dev.mysql.com/downloads/repo/apt">http://dev.mysql.com/downloads/repo/apt/</a></li>
<li><a class="reference external" href="http://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en">http://dev.mysql.com/doc/mysql-apt-repo-quick-guide/en/</a></li>
</ul>]]></description>
            <category><![CDATA[ mysql ]]></category>
             <pubDate>Wed, 11 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/06/10/debian_wheezy_virtualbox_apt_line.html</link>
            <guid>http://127.0.0.1/blog/html/2014/06/10/debian_wheezy_virtualbox_apt_line.html</guid>
            <title><![CDATA[Debian wheezy VirtualBox apt-line 設定]]></title>
            <description><![CDATA[<h1>Debian wheezy VirtualBox apt-line 設定</h1>
<p>更新のたびにdebパッケージをダウンロードしてインストールするのは面倒なのでVirtualBoxが公開しているapt-lineを設定して、apt-get(8)できるようにした。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux zinrai 3.2.0-4-amd64 #1 SMP Debian 3.2.57-3+deb7u2 x86_64 GNU/Linux

$ cat /etc/debian_version
7.5
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/apt/sources.list
# virtualbox
deb http://download.virtualbox.org/virtualbox/debian wheezy contrib
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% wget -q http://download.virtualbox.org/virtualbox/debian/oracle_vbox.asc -O- | apt-key add -
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get update
% apt-get install virtualbox4.3
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="https://www.virtualbox.org/wiki/Linux_Downloads">https://www.virtualbox.org/wiki/Linux_Downloads</a></li>
</ul>]]></description>
            <category><![CDATA[ virtualbox ]]></category>
             <pubDate>Tue, 10 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/06/09/debian_wheezy_nfsv4_client.html</link>
            <guid>http://127.0.0.1/blog/html/2014/06/09/debian_wheezy_nfsv4_client.html</guid>
            <title><![CDATA[Debian wheezy NFSv4 Client]]></title>
            <description><![CDATA[<h1>Debian wheezy NFSv4 Client</h1>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2014/06/08/freebsd_nfsv4_server.html"><em>NFS Server</em></a>を構築したので、ClientからServerへ接続してみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% uname -a
Linux zinrai 3.2.0-4-amd64 #1 SMP Debian 3.2.57-3+deb7u2 x86_64 GNU/Linux

% cat /etc/debian_version
7.5
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install nfs-common

% service nfs-common status
all daemons running

% service nfs-common start
% service nfs-common stop
</pre></div>
</div>
<div class="section" id="mount-8">
<h2>mount(8)</h2>
<div class="highlight-python"><div class="highlight"><pre>% mount -t nfs4 192.168.0.1:/mnt/nfs /home/zinrai/nfs
</pre></div>
</div>
</div>
<div class="section" id="fstab-5">
<h2>fstab(5)</h2>
<p>nfs(5)を眺めながらfstab(5)を設定してみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/fstab
192.168.0.1:/mnt/nfs /home/zinrai/nfs nfs4 rw 0 0

% mount -a
% umount /home/zinrai/nfs
</pre></div>
</div>
</div>]]></description>
            <category><![CDATA[ nfs ]]></category>
             <pubDate>Mon, 09 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/06/08/freebsd_nfsv4_server.html</link>
            <guid>http://127.0.0.1/blog/html/2014/06/08/freebsd_nfsv4_server.html</guid>
            <title><![CDATA[FreeBSD 10 NFSv4 Server]]></title>
            <description><![CDATA[<h1>FreeBSD 10 NFSv4 Server</h1>
<p>FreeBSDでNFSv4サーバを構築してみる。nfsv4(4),exports(5)を眺めながら構築してみた。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
FreeBSD zinrai.localnet 10.0-RELEASE-p3 FreeBSD 10.0-RELEASE-p3 #0: Tue May 13 18:31:10 UTC 2014     root@amd64-builder.daemonology.net:/usr/obj/usr/src/sys/GENERIC  amd64
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/rc.conf
nfs_server_enable="YES"
nfsv4_server_enable="YES"
nfsuserd_enable="YES"
nfsd_enable="YES"
rpcbind_enable="YES"
mountd_enable="YES"
# NFSv3
rpc_statd_enable="YES"
rpc_lockd_enable="YES"
</pre></div>
</div>
<p>nfsv4(4)にはnfs_server_enable,nfsv4_server_enable,nfsuserd_enableをrc.conf(5)に設定するよう書かれている。/etc/rc.dディレクトリでnfs_server_enableをgrepしするとnfdsがマッチした。/etc/rc.d/nfsd(起動スクリプト)を眺めてみると、依存するmountd(8),rpcbind(8)を起動してくれている。ただrc.conf(5)に関係するものをすべて書いておいたほうがどのサービスが動いているのかがわかりやすいのでこうしている。exports(5)を書き換えて設定を反映させたいときはmountd(8)を再起動しなければいけないので、service(8)での明示的な起動と停止ができるこちらのほうが便利である。</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/exports
V4: / -network 192.168.0.1 -mask 255.255.255.0
/mnt/nfs -network 192.168.0.1 -mask 255.255.255.0
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% showmount -e
Exports list on localhost:
/mnt/nfs                   192.168.0.1
</pre></div>
</div>]]></description>
            <category><![CDATA[ nfs ]]></category>
             <pubDate>Sun, 08 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/06/07/debian_wheezy_direnv_xbuild.html</link>
            <guid>http://127.0.0.1/blog/html/2014/06/07/debian_wheezy_direnv_xbuild.html</guid>
            <title><![CDATA[direnv + xbuildで環境構築]]></title>
            <description><![CDATA[<h1>direnv + xbuildで環境構築</h1>
<p>direnvを使うと、ディレクトリに環境変数を設定したファイルを置いておけば、そのディレクトリがカレントになったときに設定した環境変数を有効することができる。AWSのACCESS_KEYやSECRET_KEYなどの切り替えが捗りそう。*envでPATHを.zshrcなどに設定しなければいけないことに抵抗があったので、いい感じ。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux zinrai 3.2.0-4-amd64 #1 SMP Debian 3.2.57-3+deb7u2 x86_64 GNU/Linux

$ cat /etc/debian_version
7.5
</pre></div>
</div>
<div class="section" id="xbuild">
<h2>xbuild</h2>
<p>Pythonを入れてみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install -y libssl-dev zlib1g-dev libbz2-dev libreadline-dev libsqlite3-dev curl

$ git clone https://github.com/tagomoris/xbuild.git
$ xbuild/python-install 2.7.6 $HOME/opt/python-2.7.6
</pre></div>
</div>
</div>
<div class="section" id="direnv">
<h2>direnv</h2>
<p>direnvのMakefileを眺めてみるとデフォルトは/usr/local/binにdirenvを配置するようになっている。削除については特に書かれていない。dpkg(1),apt(8)管理外のソフトに勝手にこういう場所に配置して欲しくないので<a class="reference external" href="http://www.gnu.org/software/stow">Stow</a>を使うことにする。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install -y golang

$ git clone https://github.com/zimbatm/direnv.git
$ cd direnv
$ make
% make install DESTDIR=/usr/local/stow/direnv
$ cd /usr/local/stow
% stow -v direnv
$ type direnv
direnv is /usr/local/bin/direnv
</pre></div>
</div>
<p>zshの場合は.zshrcに以下の設定をしておく。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vi $HOME/.zshrc
type direnv &gt; /dev/null
if [ $? -eq 0 ]; then
  eval "$(direnv hook zsh)"
fi

$ source $HOME/.zshrc
</pre></div>
</div>
<p>インストールと設定は完了したので実際に使ってみる。環境変数の設定は.envrcファイルに書く。</p>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir -p lang/python-2.7.6
$ cd lang/python-2.7.6

$ vi .envrc
PATH=$HOME/opt/python-2.7.6/bin:$PATH

$ direnv allow .
$  type python
python is /home/zinrai/opt/python-2.7.6/bin/python
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ wget https://pypi.python.org/packages/source/v/virtualenv/virtualenv-1.11.6.tar.gz
$ tar zvxf virtualenv-1.11.6.tar.gz
$ python virtualenv-1.11.6/virtualenv.py venv
$ source venv/bin/activate
$ type python
python is /home/zinrai/lang/python2.7.6/venv/bin/python
</pre></div>
</div>
<p>試しに<a class="reference external" href="http://tinkerer.me">Tinkerer</a>でも入れてみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install libxml2-dev libxslt-dev

$ pip install tinkerer
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="https://github.com/zimbatm/direnv">https://github.com/zimbatm/direnv</a></li>
<li><a class="reference external" href="https://github.com/tagomoris/xbuild">https://github.com/tagomoris/xbuild</a></li>
<li><a class="reference external" href="https://pypi.python.org/pypi/virtualenv">https://pypi.python.org/pypi/virtualenv</a></li>
<li><a class="reference external" href="https://github.com/yyuu/pyenv/wiki/Common-build-problems">https://github.com/yyuu/pyenv/wiki/Common-build-problems</a></li>
</ul></div>]]></description>
            <category><![CDATA[ direnv ]]></category>
            <category><![CDATA[ xbuild ]]></category>
             <pubDate>Sat, 07 Jun 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/05/05/centos_snort_pulledpork.html</link>
            <guid>http://127.0.0.1/blog/html/2014/05/05/centos_snort_pulledpork.html</guid>
            <title><![CDATA[snort ルールセット自動更新]]></title>
            <description><![CDATA[<h1>snort ルールセット自動更新</h1>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2014/05/04/centos_snort_install.html"><em>CentOS 6.5 snort インストール</em></a></li>
</ul><p>前回は自分でルールを書いていたが、既知の不正侵入や攻撃を検知するためのルールがまとまったもの(ルールセット)がsnort.orgから配布されている。ルールセットは大きく分けて2つある。</p>
<ul><li><div class="first line-block">
<div class="line"><strong>Sourcefire VRT Certified Rules</strong></div>
<div class="line">SroucefireのVulnerability Research Team(VRT)がメンテナンスをしているオフィシャルなルールセット。</div>
<div class="line">頻繁に更新が行われている。</div>
</div>
<ul><li><div class="first line-block">
<div class="line"><strong>Subscriber Release</strong></div>
<div class="line">最新のルールセット(有償)</div>
</div>
</li>
<li><div class="first line-block">
<div class="line">Registered User Release</div>
<div class="line">「Subscriber Release」より30日遅れのルールセット。snort.orgに登録すればダウンロードできる。</div>
</div>
</li>
</ul></li>
<li><div class="first line-block">
<div class="line"><strong>Community Rules</strong></div>
<div class="line">オープンソースコミュニティが作成したルールセットで、VRTが動作確認を行っている。</div>
</div>
</li>
</ul><p>pulledporkを使うとルールセットのダウンロード、展開、指定のディレクトリに配置を自動でやってくれる。今回は「Sourcefire VRT Certified Rules」の「Registered User Release」を使用する。</p>
<div class="section" id="rpm">
<h2>RPM作成</h2>
<p><a class="reference external" href="http://rpm.pbone.net/index.php3/stat/4/idpl/24017916/dir/opensuse/com/pulledpork-0.6.1-6.6.noarch.rpm.html">OpenSUSE用のSRPM</a>を見付けたのでダウンロードしてSPECファイルを参考にした。rpm作成に使用したSPECファイルは<a class="reference external" href="https://gist.github.com/zinrai/c5c29760b91aa438220c">Gist</a>に置いた。</p>
<div class="highlight-python"><div class="highlight"><pre>$ rpmbuild -ba rpmbuild/SPECS/pulledpork.spec
</pre></div>
</div>
</div>
<div class="section" id="pulledpork">
<h2>pulledpork</h2>
<div class="highlight-python"><div class="highlight"><pre>% diff -u pulledpork.conf.org pulledpork.conf
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>--- pulledpork.conf.org	2014-05-06 20:09:14.774046736 +0900
+++ pulledpork.conf	2014-05-06 23:26:04.791047913 +0900
@@ -16,14 +16,15 @@
 # i.e. rule_url=http://x.y.z/|a.tar.gz|123,http://z.y.z/|b.tar.gz|456
 # note that the url, rule file, and oinkcode itself are separated by a pipe |
 # i.e. url|tarball|123456789, 
-rule_url=https://www.snort.org/reg-rules/|snortrules-snapshot.tar.gz|&lt;oinkcode&gt;
+#rule_url=https://www.snort.org/reg-rules/|snortrules-snapshot.tar.gz|&lt;oinkcode&gt;
+rule_url=https://www.snort.org/reg-rules/|snortrules-snapshot.tar.gz|123456789
 # NEW Community ruleset:
-rule_url=https://s3.amazonaws.com/snort-org/www/rules/community/|community-rules.tar.gz|Community
+#rule_url=https://s3.amazonaws.com/snort-org/www/rules/community/|community-rules.tar.gz|Community
 # NEW For IP Blacklisting! Note the format is urltofile|IPBLACKLIST|&lt;oinkcode&gt;
 # This format MUST be followed to let pulledpork know that this is a blacklist
-rule_url=http://labs.snort.org/feeds/ip-filter.blf|IPBLACKLIST|open
+#rule_url=http://labs.snort.org/feeds/ip-filter.blf|IPBLACKLIST|open
 # URL for rule documentation! (slow to process)
-rule_url=https://www.snort.org/reg-rules/|opensource.gz|&lt;oinkcode&gt;
+#rule_url=https://www.snort.org/reg-rules/|opensource.gz|&lt;oinkcode&gt;
 #rule_url=https://rules.emergingthreatspro.com/|emerging.rules.tar.gz|open
 # THE FOLLOWING URL is for etpro downloads, note the tarball name change!
 # and the et oinkcode requirement!
@@ -69,14 +70,14 @@
 # rules? (this value has changed as of 0.4.0, previously we copied 
 # all of the rules, now we are creating a single large rules file
 # but still keeping a separate file for your so_rules!
-rule_path=/usr/local/etc/snort/rules/snort.rules
+rule_path=/etc/snort/rules/snort.rules
 
 # What path you want the .rules files to be written to, this is UNIQUE
 # from the rule_path and cannot be used in conjunction, this is to be used with the
 # -k runtime flag, this can be set at runtime using the -K flag or specified
 # here.  If specified here, the -k option must also be passed at runtime, however
 # specifying -K &lt;path&gt; at runtime forces the -k option to also be set
-# out_path=/usr/local/etc/snort/rules/
+out_path=/etc/snort/rules/
 
 # If you are running any rules in your local.rules file, we need to
 # know about them to properly build a sid-msg.map that will contain your
@@ -84,10 +85,10 @@
 # files that are local to your system here by adding a comma and more paths...
 # remember that the FULL path must be specified for EACH value.
 # local_rules=/path/to/these.rules,/path/to/those.rules
-local_rules=/usr/local/etc/snort/rules/local.rules
+local_rules=/etc/snort/rules/local.rules
 
 # Where should I put the sid-msg.map file?
-sid_msg=/usr/local/etc/snort/sid-msg.map
+sid_msg=/etc/snort/sid-msg.map
 
 # New for by2 and more advanced msg mapping.  Valid options are 1 or 2
 # specify version 2 if you are running barnyard2.2+.  Otherwise use 1
@@ -110,11 +111,11 @@
 sorule_path=/usr/local/lib/snort_dynamicrules/
 
 # Path to the snort binary, we need this to generate the stub files
-snort_path=/usr/local/bin/snort
+snort_path=/usr/sbin/snort
 
 # We need to know where your snort.conf file lives so that we can
 # generate the stub files
-config_path=/usr/local/etc/snort/snort.conf
+config_path=/etc/snort/snort.conf
 
 ##### Deprecated - The stubs are now  categorically written to the  single rule file!
 # sostub_path=/usr/local/etc/snort/rules/so_rules.rules
@@ -128,7 +129,7 @@
 # FreeBSD-7-3, FreeBSD-8-1
 # OpenBSD-4-8
 # Slackware-13-1
-distro=FreeBSD-8.1
+distro=RHEL-6-0
 
 #######  This next section is optional, but probably pretty useful to you.
 #######  Please read thoroughly!
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% pulledpork -c /etc/pulledpork/pulledpork.conf

    http://code.google.com/p/pulledpork/
      _____ ____
     `----,\    )
      `--==\\  /    PulledPork v0.7.0 - Swine Flu!
       `--==\\/
     .-~~~~-.Y|\\_  Copyright (C) 2009-2013 JJ Cummings
  @_/        /  66\_  cummingsj@gmail.com
    |    \   \   _(")
     \   /-| ||'--'  Rules give me wings!
      \_\  \_\\
 ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

Checking latest MD5 for snortrules-snapshot-2961.tar.gz....
        No Match
        Done
Rules tarball download of snortrules-snapshot-2961.tar.gz....
        They Match
        Done!
Prepping rules from snortrules-snapshot-2961.tar.gz for work....
        Done!
Reading rules...
Setting Flowbit State....
        Enabled 35 flowbits
        Done
Writing /etc/snort/rules/snort.rules....
        Done
Generating sid-msg.map....
        Done
Writing v1 /etc/snort/sid-msg.map....
        Done
Writing /var/log/sid_changes.log....
        Done
Rule Stats...
        New:-------21332
        Deleted:---0
        Enabled Rules:----5240
        Dropped Rules:----0
        Disabled Rules:---16091
        Total Rules:------21331
No IP Blacklist Changes

Done
Please review /var/log/sid_changes.log for additional details
Fly Piggy Fly!
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="https://code.google.com/p/pulledpork">https://code.google.com/p/pulledpork/</a></li>
<li><a class="reference external" href="http://www.snort.org/snort-rules">http://www.snort.org/snort-rules/</a></li>
<li><a class="reference external" href="https://www.snort.org/vrt/buy-a-subscription">https://www.snort.org/vrt/buy-a-subscription/</a></li>
</ul></div>]]></description>
            <category><![CDATA[ snort ]]></category>
             <pubDate>Mon, 05 May 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/05/04/centos_snort_install.html</link>
            <guid>http://127.0.0.1/blog/html/2014/05/04/centos_snort_install.html</guid>
            <title><![CDATA[CentOS 6.5 snort インストール]]></title>
            <description><![CDATA[<h1>CentOS 6.5 snort インストール</h1>
<p>使う用事ができたのでインストールして簡単なルールを書いて動作確認してみる。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux localhost.localdomain 2.6.32-431.11.2.el6.x86_64 #1 SMP Tue Mar 25 19:59:55 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux

$ cat /etc/centos-release
CentOS release 6.5 (Final)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ yum info snort
Name        : snort
Arch        : x86_64
Epoch       : 1
Version     : 2.9.6.1
Release     : 1
Size        : 15 M
Repo        : installed
Summary     : An open source Network Intrusion Detection System (NIDS)
URL         : http://www.snort.org/
License     : GPL
Description : Snort is an open source network intrusion detection system, capable of
            : performing real-time traffic analysis and packet logging on IP networks.
            : It can perform protocol analysis, content searching/matching and can be
            : used to detect a variety of attacks and probes, such as buffer overflows,
            : stealth port scans, CGI attacks, SMB probes, OS fingerprinting attempts,
            : and much more.
            :
            : Snort has three primary uses. It can be used as a straight packet sniffer
            : like tcpdump(1), a packet logger (useful for network traffic debugging,
            : etc), or as a full blown network intrusion detection system.
            :
            : You MUST edit /etc/snort/snort.conf to configure snort before it will work!
            :
            : There are 5 different packages available. All of them require the base
            : snort rpm (this one). Additionally, you may need to chose a different
            : binary to install if you want database support.
            :
            : If you install a different binary package /usr/sbin/snort should end up
            : being a symlink to a binary in one of the following configurations:
            :
            :         plain                Snort (this package, required)
            :
            : Please see the documentation in /usr/share/doc/snort-2.9.6.1 for more
            : information on snort features and configuration.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ yum info daq
Name        : daq
Arch        : x86_64
Version     : 2.0.2
Release     : 1
Size        : 961 k
Repo        : installed
Summary     : Data Acquisition Library
URL         : http://www.snort.org/
License     : GNU General Public License
Description : Data Acquisition library for Snort.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>Name        : libdnet
Arch        : x86_64
Version     : 1.12
Release     : 6.el6
Size        : 65 k
Repo        : installed
From repo   : epel
Summary     : Simple portable interface to lowlevel networking routines
URL         : http://code.google.com/p/libdnet/
License     : BSD
Description : libdnet provides a simplified, portable interface to several
            : low-level networking routines, including network address
            : manipulation, kernel arp(4) cache and route(4) table lookup and
            : manipulation, network firewalling (IP filter, ipfw, ipchains,
            : pf, ...), network interface lookup and manipulation, raw IP
            : packet and Ethernet frame, and data transmission.
</pre></div>
</div>
<div class="section" id="rpmbuild">
<h2>rpmbuild</h2>
<p>snort本家のCentOS用のRPMがうまくインストールできなかったので、snort本家が配布しているSRPMをrebuildした。</p>
<div class="highlight-python"><div class="highlight"><pre>% yum install rpm-build rpmdevtools
$ rpmdev-setuptree
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ curl -o snort-2.9.6.1-1.src.rpm -O -L http://www.snort.org/downloads/2909
$ curl -o daq-2.0.2-1.src.rpm -O -L http://www.snort.org/downloads/2900
</pre></div>
</div>
<div class="section" id="daq">
<h3>daq</h3>
<div class="highlight-python"><div class="highlight"><pre>% yum install flex bison
$ rpmbuild --rebuild daq-2.0.2-1.src.rpm
% rpm -ivh rpmbuild/RPMS/x86_64/daq-2.0.2-1.x86_64.rpm
</pre></div>
</div>
</div>
<div class="section" id="snort">
<h3>snort</h3>
<div class="highlight-python"><div class="highlight"><pre>% rpm -ivh http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel/6/x86_64/epel-release-6-8.noarch.rpm
% yum-config-manager --disable epel

% yum --enablerepo=epel install libdnet-devel
% yum install autoconf automake pcre-devel libpcap-devel gcc openssl-devel

$ rpmbuild --rebuild snort-2.9.6.1-1.src.rpm
% rpm -ivh rpmbuild/RPMS/x86_64/snort-2.9.6.1-1.x86_64.rpm
</pre></div>
</div>
</div>
</div>
<div class="section" id="id1">
<h2>snort 設定</h2>
<div class="highlight-python"><div class="highlight"><pre>$ diff -u snort.conf.org snort.conf
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>--- snort.conf.org	2014-05-04 23:52:08.958045878 +0900
+++ snort.conf	2014-05-05 20:00:07.720036619 +0900
@@ -246,7 +246,7 @@
 dynamicengine /usr/lib64/snort-2.9.6.1_dynamicengine/libsf_engine.so
 
 # path to dynamic rules libraries
-dynamicdetection directory /usr/local/lib/snort_dynamicrules
+#dynamicdetection directory /usr/local/lib/snort_dynamicrules
 
 ###################################################
 # Step #5: Configure preprocessors
@@ -499,12 +499,12 @@
    check_crc
 
 # Reputation preprocessor. For more information see README.reputation
-preprocessor reputation: \
-   memcap 500, \
-   priority whitelist, \
-   nested_ip inner, \
-   whitelist $WHITE_LIST_PATH/white_list.rules, \
-   blacklist $BLACK_LIST_PATH/black_list.rules 
+#preprocessor reputation: \
+#   memcap 500, \
+#   priority whitelist, \
+#   nested_ip inner, \
+#   whitelist $WHITE_LIST_PATH/white_list.rules, \
+#   blacklist $BLACK_LIST_PATH/black_list.rules 
 
 ###################################################
 # Step #6: Configure output plugins
@@ -538,123 +538,7 @@
 ###################################################
 
 # site specific rules
-include $RULE_PATH/local.rules
-
-include $RULE_PATH/app-detect.rules
-include $RULE_PATH/attack-responses.rules
-include $RULE_PATH/backdoor.rules
-include $RULE_PATH/bad-traffic.rules
-include $RULE_PATH/blacklist.rules
-include $RULE_PATH/botnet-cnc.rules
-include $RULE_PATH/browser-chrome.rules
-include $RULE_PATH/browser-firefox.rules
-include $RULE_PATH/browser-ie.rules
-include $RULE_PATH/browser-other.rules
-include $RULE_PATH/browser-plugins.rules
-include $RULE_PATH/browser-webkit.rules
-include $RULE_PATH/chat.rules
-include $RULE_PATH/content-replace.rules
-include $RULE_PATH/ddos.rules
-include $RULE_PATH/dns.rules
-include $RULE_PATH/dos.rules
-include $RULE_PATH/experimental.rules
-include $RULE_PATH/exploit-kit.rules
-include $RULE_PATH/exploit.rules
-include $RULE_PATH/file-executable.rules
-include $RULE_PATH/file-flash.rules
-include $RULE_PATH/file-identify.rules
-include $RULE_PATH/file-image.rules
-include $RULE_PATH/file-java.rules
-include $RULE_PATH/file-multimedia.rules
-include $RULE_PATH/file-office.rules
-include $RULE_PATH/file-other.rules
-include $RULE_PATH/file-pdf.rules
-include $RULE_PATH/finger.rules
-include $RULE_PATH/ftp.rules
-include $RULE_PATH/icmp-info.rules
 include $RULE_PATH/icmp.rules
-include $RULE_PATH/imap.rules
-include $RULE_PATH/indicator-compromise.rules
-include $RULE_PATH/indicator-obfuscation.rules
-include $RULE_PATH/indicator-scan.rules
-include $RULE_PATH/indicator-shellcode.rules
-include $RULE_PATH/info.rules
-include $RULE_PATH/malware-backdoor.rules
-include $RULE_PATH/malware-cnc.rules
-include $RULE_PATH/malware-other.rules
-include $RULE_PATH/malware-tools.rules
-include $RULE_PATH/misc.rules
-include $RULE_PATH/multimedia.rules
-include $RULE_PATH/mysql.rules
-include $RULE_PATH/netbios.rules
-include $RULE_PATH/nntp.rules
-include $RULE_PATH/oracle.rules
-include $RULE_PATH/os-linux.rules
-include $RULE_PATH/os-mobile.rules
-include $RULE_PATH/os-other.rules
-include $RULE_PATH/os-solaris.rules
-include $RULE_PATH/os-windows.rules
-include $RULE_PATH/other-ids.rules
-include $RULE_PATH/p2p.rules
-include $RULE_PATH/phishing-spam.rules
-include $RULE_PATH/policy-multimedia.rules
-include $RULE_PATH/policy-other.rules
-include $RULE_PATH/policy.rules
-include $RULE_PATH/policy-social.rules
-include $RULE_PATH/policy-spam.rules
-include $RULE_PATH/pop2.rules
-include $RULE_PATH/pop3.rules
-include $RULE_PATH/protocol-dns.rules
-include $RULE_PATH/protocol-finger.rules
-include $RULE_PATH/protocol-ftp.rules
-include $RULE_PATH/protocol-icmp.rules
-include $RULE_PATH/protocol-imap.rules
-include $RULE_PATH/protocol-nntp.rules
-include $RULE_PATH/protocol-pop.rules
-include $RULE_PATH/protocol-rpc.rules
-include $RULE_PATH/protocol-scada.rules
-include $RULE_PATH/protocol-services.rules
-include $RULE_PATH/protocol-snmp.rules
-include $RULE_PATH/protocol-telnet.rules
-include $RULE_PATH/protocol-tftp.rules
-include $RULE_PATH/protocol-voip.rules
-include $RULE_PATH/pua-adware.rules
-include $RULE_PATH/pua-other.rules
-include $RULE_PATH/pua-p2p.rules
-include $RULE_PATH/pua-toolbars.rules
-include $RULE_PATH/rpc.rules
-include $RULE_PATH/rservices.rules
-include $RULE_PATH/scada.rules
-include $RULE_PATH/scan.rules
-include $RULE_PATH/server-apache.rules
-include $RULE_PATH/server-iis.rules
-include $RULE_PATH/server-mail.rules
-include $RULE_PATH/server-mssql.rules
-include $RULE_PATH/server-mysql.rules
-include $RULE_PATH/server-oracle.rules
-include $RULE_PATH/server-other.rules
-include $RULE_PATH/server-samba.rules
-include $RULE_PATH/server-webapp.rules
-include $RULE_PATH/shellcode.rules
-include $RULE_PATH/smtp.rules
-include $RULE_PATH/snmp.rules
-include $RULE_PATH/specific-threats.rules
-include $RULE_PATH/spyware-put.rules
-include $RULE_PATH/sql.rules
-include $RULE_PATH/telnet.rules
-include $RULE_PATH/tftp.rules
-include $RULE_PATH/virus.rules
-include $RULE_PATH/voip.rules
-include $RULE_PATH/web-activex.rules
-include $RULE_PATH/web-attacks.rules
-include $RULE_PATH/web-cgi.rules
-include $RULE_PATH/web-client.rules
-include $RULE_PATH/web-coldfusion.rules
-include $RULE_PATH/web-frontpage.rules
-include $RULE_PATH/web-iis.rules
-include $RULE_PATH/web-misc.rules
-include $RULE_PATH/web-php.rules
-include $RULE_PATH/x11.rules
 
 ###################################################
 # Step #8: Customize your preprocessor and decoder alerts
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi /etc/snort/rules/icmp.rules
alert icmp any any -&gt; any any
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% service snortd start
</pre></div>
</div>
<p>pingを送受信したときにアラートを掃くルールを書いて、/var/log/snort/alertにアラートが吐かれることを確認した。</p>
<ul class="simple"><li><a class="reference external" href="http://www.snort.org">http://www.snort.org/</a></li>
<li><a class="reference external" href="http://www.snort.org/doc">http://www.snort.org/doc</a></li>
<li><a class="reference external" href="http://manual.snort.org">http://manual.snort.org/</a></li>
<li><a class="reference external" href="http://manual.snort.org/node23.html">http://manual.snort.org/node23.html</a></li>
<li><a class="reference external" href="http://manual.snort.org/node176.html">http://manual.snort.org/node176.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ snort ]]></category>
             <pubDate>Sun, 04 May 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/05/03/debian_wheezy_ntp_server.html</link>
            <guid>http://127.0.0.1/blog/html/2014/05/03/debian_wheezy_ntp_server.html</guid>
            <title><![CDATA[NTPサーバ 構築]]></title>
            <description><![CDATA[<h1>NTPサーバ 構築</h1>
<p>stratum1のNTPサーバを探してNTPサーバを構築してみた。</p>
<ul class="simple"><li><a class="reference external" href="http://www.shoshin.co.jp/c/endrun/cdma.html">SHOSHIN</a><ul><li>ntp.shoshin.co.jp</li>
</ul></li>
<li><a class="reference external" href="http://www2.nict.go.jp/aeri/sts/tsp/PubNtp">日本標準時プロジェクト</a><ul><li>ntp.nict.jp</li>
</ul></li>
<li><a class="reference external" href="http://www.e-timing.ne.jp">アマノ ビジネスソリューションズ株式会社</a><ul><li>ats1.e-timing.ne.jp</li>
</ul></li>
</ul><div class="highlight-python"><div class="highlight"><pre>$ cat /etc/debian_version
7.5

$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-cache show ntp
Package: ntp
Version: 1:4.2.6.p5+dfsg-2
Installed-Size: 1238
Maintainer: Debian NTP Team &lt;pkg-ntp-maintainers@lists.alioth.debian.org&gt;
Architecture: amd64
Depends: adduser, lsb-base (&gt;= 3.2-13), netbase, libc6 (&gt;= 2.12), libcap2 (&gt;= 2.10), libedit2 (&gt;= 2.11-20080614-1), libopts25 (&gt;= 1:5.12), libssl1.0.0 (&gt;= 1.0.0)
Pre-Depends: dpkg (&gt;= 1.15.7.2)
Recommends: perl
Suggests: ntp-doc
Breaks: dhcp3-client (&lt;&lt; 4.1.0-1)
Description-en: Network Time Protocol daemon and utility programs
 NTP, the Network Time Protocol, is used to keep computer clocks
 accurate by synchronizing them over the Internet or a local network,
 or by following an accurate hardware receiver that interprets GPS,
 DCF-77, NIST or similar time signals.
 .
 This package contains the NTP daemon and utility programs.  An NTP
 daemon needs to be running on each host that is to have its clock
 accuracy controlled by NTP.  The same NTP daemon is also used to
 provide NTP service to other hosts.
 .
 For more information about the NTP protocol and NTP server
 configuration and operation, install the package "ntp-doc".
Homepage: http://support.ntp.org/
Description-md5: 220487bd9eceed70fec6b929cb922fd3
Tag: admin::benchmarking, admin::configuring, implemented-in::c,
 interface::commandline, interface::daemon, network::server,
 network::service, protocol::TODO, role::program, scope::utility,
 use::monitor, use::timekeeping
Section: net
Priority: optional
Filename: pool/main/n/ntp/ntp_4.2.6.p5+dfsg-2_amd64.deb
Size: 561700
MD5sum: 508a6082b9aa647949a4f6aab81f51c4
SHA1: f41ab7b089503b2d4a4a67f289b5d8222f0e8912
SHA256: bd2d31f80e7dd070228664f8b48496505395ead795e4ef190cf7bff9931af332
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install ntp
</pre></div>
</div>
<p>ntp.nict.jpがIPv6のほうを見に行ってしまっていたのでntp.conf(5),ntpd(8)を眺めてみてIPv4を見に行くように設定した。</p>
<div class="highlight-python"><div class="highlight"><pre>$ diff -u /etc/ntp.conf.org /etc/ntp.conf
--- /etc/ntp.conf.org   2014-05-04 06:58:03.118951714 +0900
+++ /etc/ntp.conf       2014-05-04 06:59:49.198747483 +0900
@@ -18,10 +18,13 @@
 # pool.ntp.org maps to about 1000 low-stratum NTP servers.  Your server will
 # pick a different set every time it starts up.  Please consider joining the
 # pool: &lt;http://www.pool.ntp.org/join.html&gt;
-server 0.debian.pool.ntp.org iburst
-server 1.debian.pool.ntp.org iburst
-server 2.debian.pool.ntp.org iburst
-server 3.debian.pool.ntp.org iburst
+#server 0.debian.pool.ntp.org iburst
+#server 1.debian.pool.ntp.org iburst
+#server 2.debian.pool.ntp.org iburst
+#server 3.debian.pool.ntp.org iburst
+server -4 ntp.nict.jp
+server -4 ats1.e-timing.ne.jp
+server -4 ntp.shoshin.co.jp

 # Access control configuration; see /usr/share/doc/ntp-doc/html/accopt.html for
 # details.  The web page &lt;http://support.ntp.org/bin/view/Support/AccessRestrictions&gt;
@@ -42,6 +45,7 @@
 # Clients from this (example!) subnet have unlimited access, but only if
 # cryptographically authenticated.
 #restrict 192.168.123.0 mask 255.255.255.0 notrust
+restrict 192.168.0.0 mask 255.255.255.0


 # If you want to provide time to your local subnet, change the next line.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% service ntp restart
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ ntpq -pn
     remote           refid      st t when poll reach   delay   offset  jitter
==============================================================================
 133.243.238.243 .NICT.           1 u   22   64    1   10.702   -3.196   0.000
 61.114.187.55   .PPS.            1 u   21   64    1   10.119   -2.076   0.000
 210.168.211.231 .CDMA.           1 u   20   64    1   12.140   -0.344   0.000
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://ja.wikipedia.org/wiki/Network_Time_Protocol">http://ja.wikipedia.org/wiki/Network_Time_Protocol</a></li>
<li><a class="reference external" href="http://support.ntp.org/bin/view/Main/WebHome">http://support.ntp.org/bin/view/Main/WebHome</a></li>
<li><a class="reference external" href="http://www.eecis.udel.edu/~mills/ntp/html/comdex.html">http://www.eecis.udel.edu/~mills/ntp/html/comdex.html</a></li>
</ul>]]></description>
            <category><![CDATA[ ntp ]]></category>
             <pubDate>Sat, 03 May 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/04/22/freebsd_92_jail_rc_conf.html</link>
            <guid>http://127.0.0.1/blog/html/2014/04/22/freebsd_92_jail_rc_conf.html</guid>
            <title><![CDATA[FreeBSD 9.2 jail構築]]></title>
            <description><![CDATA[<h1>FreeBSD 9.2 jail構築</h1>
<p>ezjail,qjailなどjailを管理するツールはあるけれどrc.conf(5)にjailの設定を書いて管理する方法を考えてみた。</p>
<p>rc.conf(5)はsh(1)によって読み込まれているので、指定したディレクトリに個々のjailの設定を置いてrc.conf(5)にsourceすればいい感じではないかと思ったのでやってみた。jail.conf(5)あるけどついカッとなってやってみた。後悔はしていない。</p>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html"><em>nullfsを使いjailのportsを共有する</em></a></li>
</ul><p>が出来上がっている前提で話を進めていく。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
FreeBSD hoge.localnet 9.2-RELEASE FreeBSD 9.2-RELEASE #0 r256370: Sat Oct 12 22:47:21 JST 2013     root@hoge.localnet:/usr/obj/usr/src/9.2.0/sys/VIMAGE  amd64
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% mkdir /usr/local/etc/rc.jail
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/rc.conf
jail_enable="YES"

for JAIL in /usr/local/etc/rc.jail/*.conf; do
  . $JAIL
done
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /usr/local/etc/rc.jail/testjail.conf
. /usr/local/etc/rc.jail/jail_install.sh

NAME="testjail"
IFACE="6"
IPADDR="192.168.0.6"
NETMASK="255.255.255.0"
GATEWAY="192.168.0.254"

JAILROOT="/jails/${NAME}"

if [ ! -d ${JAILROOT} ]; then
  zfs create jails/${NAME}
  jail_install ${JAILROOT}
fi

export jail_${NAME}_devfs_enable="YES"
export jail_${NAME}_devfs_ruleset="devfsrules_jail2"
export jail_${NAME}_nama="${NAME}"
export jail_${NAME}_hostname="${NAME}.localnet"
export jail_${NAME}_rootdir="${JAILROOT}"
export jail_${NAME}_parameters="vnet"

export jail_${NAME}_exec_prestart0="ifconfig epair${IFACE} create up"
export jail_${NAME}_exec_prestart1="ifconfig vswitch0 addm epair${IFACE}a"
export jail_${NAME}_exec_prestart2="mount -t nullfs -o ro /jails/ports /jails/${NAME}/usr/ports"

export jail_${NAME}_exec_poststart0="ifconfig epair${IFACE}b vnet ${NAME}"
export jail_${NAME}_exec_poststart1="jexec ${NAME} ifconfig lo0 127.0.0.1 up"
export jail_${NAME}_exec_poststart2="jexec ${NAME} ifconfig epair${IFACE}b ${IPADDR} netmask ${NETMASK} up"
export jail_${NAME}_exec_poststart3="jexec ${NAME} route add default ${GATEWAY}"

export jail_${NAME}_exec_start0="sh /etc/rc"

export jail_${NAME}_exec_stop0="sh /etc/rc.shutdown"

export jail_${NAME}_exec_poststop0="ifconfig vswitch0 deletem epair${IFACE}a"
export jail_${NAME}_exec_poststop1="ifconfig epair${IFACE}a destroy"
export jail_${NAME}_exec_poststop2="umount /jails/${NAME}/usr/ports"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/devfs.rules
[devfsrules_jail2=5]
add include $devfsrules_jail

add path mem unhide
add path kmem unhide
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /usr/local/etc/rc.jail/jail_install.sh
jail_install() {
  local JAILROOT=$1

  for FILE in /usr/local/etc/rc.jail/*.txz; do
    tar xfzp $FILE -C $JAILROOT
  done

  cp /etc/resolv.conf $JAILROOT/etc
  cp /etc/localtime $JAILROOT/etc
  mkdir $JAILROOT/usr/ports
}
</pre></div>
</div>
<p>bsdinstall(8)にjailというサブコマンドが用意されていてkernelを含まない環境を指定したディレクトリに展開してくれるけど、毎回ファイルをネットから取りに行くのと、インタラクティブなのがつらかったので、ファイルを取得するところだけ眺めてみた。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cat `which bsdinstall`
exec "/usr/libexec/bsdinstall/$VERB" "$@" 2&gt;&gt; "$BSDINSTALL_LOG"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ cd /usr/libexec/bsdinstall
$ file `ls` | grep -v "ELF"
adduser:        POSIX shell script, ASCII text executable
auto:           POSIX shell script, ASCII text executable
checksum:       POSIX shell script, ASCII text executable
config:         POSIX shell script, ASCII text executable
docsinstall:    POSIX shell script, ASCII text executable
hostname:       POSIX shell script, ASCII text executable
jail:           POSIX shell script, ASCII text executable
keymap:         POSIX shell script, ASCII text executable
mirrorselect:   POSIX shell script, ASCII text executable, with very long lines
mount:          POSIX shell script, ASCII text executable
netconfig:      POSIX shell script, ASCII text executable
netconfig_ipv4: POSIX shell script, ASCII text executable
netconfig_ipv6: POSIX shell script, ASCII text executable
rootpass:       POSIX shell script, ASCII text executable
script:         POSIX shell script, ASCII text executable
services:       POSIX shell script, ASCII text executable
time:           POSIX shell script, ASCII text executable
umount:         POSIX shell script, ASCII text executable
wlanconfig:     POSIX shell script, ASCII text executable
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ cat mirrorselect
_UNAME_R=`uname -r`

case ${_UNAME_R} in
        *-CURRENT|*-STABLE|*-PRERELEASE)
                RELDIR="snapshots"
                ;;
        *)
                RELDIR="releases"
                ;;
esac

BSDINSTALL_DISTSITE="$MIRROR/pub/FreeBSD/${RELDIR}/`uname -m`/`uname -p`/${_UNAME_R}"
</pre></div>
</div>
<p>mirrorselectで展開される<a class="reference external" href="ftp://ftp.jp.freebsd.org/pub/FreeBSD/releases/amd64/9.2-RELEASE">アドレス</a>アクセスしてbase.txzと必要なファイルをダウンロードする。</p>
<ul class="simple"><li><a class="reference external" href="http://qjail.sourceforge.net">http://qjail.sourceforge.net/</a></li>
<li><a class="reference external" href="http://erdgeist.org/arts/software/ezjail">http://erdgeist.org/arts/software/ezjail/</a></li>
<li><a class="reference external" href="http://www.freebsd.org/doc/ja/books/handbook/configtuning-core-configuration.html">http://www.freebsd.org/doc/ja/books/handbook/configtuning-core-configuration.html</a></li>
<li><a class="reference external" href="ftp://ftp.jp.freebsd.org/pub/FreeBSD/releases/amd64/9.2-RELEASE">ftp://ftp.jp.freebsd.org/pub/FreeBSD/releases/amd64/9.2-RELEASE/</a></li>
</ul>]]></description>
            <category><![CDATA[ freebsd ]]></category>
             <pubDate>Tue, 22 Apr 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/03/29/debian_wheezy_ruby_build_rbenv.html</link>
            <guid>http://127.0.0.1/blog/html/2014/03/29/debian_wheezy_ruby_build_rbenv.html</guid>
            <title><![CDATA[rbenv + ruby-build]]></title>
            <description><![CDATA[<h1>rbenv + ruby-build</h1>
<p>最近使い始めてglobal,local,shellの理解がぼんやりしていたのでメモ</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install libreadline6-dev zlib1g-dev libssl-dev build-essential
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ git clone https://github.com/sstephenson/rbenv.git $HOME/.rbenv
$ git clone https://github.com/sstephenson/ruby-build.git ~/.rbenv/plugins/ruby-build

$ vi $HOME/.bashrc
export PATH="$HOME/.rbenv/bin:$PATH"
eval "$(rbenv init -)"

$ . .bashrc
</pre></div>
</div>
<div class="section" id="rbenv">
<h2>rbenv</h2>
<p>サブコマンドがいろいろあるけれど、自分はこれだけ覚えていればいいかなと思っている。</p>
<div class="highlight-python"><div class="highlight"><pre>$ rbenv
rbenv 0.4.0-89-g14bc162
</pre></div>
</div>
<div class="section" id="install">
<h3>install</h3>
<div class="highlight-python"><div class="highlight"><pre>$ rbenv install 1.9.3-p392
$ rbenv install 2.0.0-p353
</pre></div>
</div>
</div>
<div class="section" id="uninstall">
<h3>uninstall</h3>
<div class="highlight-python"><div class="highlight"><pre>$ rbenv uninstall 1.9.3-p392
$ rbenv uninstall 2.0.0-p353
</pre></div>
</div>
</div>
<div class="section" id="rehash">
<h3>rehash</h3>
<p>rbenvを使うとPATHに~/.rbenv/shimsが追加される。gemでインストールした実行ファイルは~/.rbenv/versions/x.y.x/binに格納される。rehashを実行するとgemでインストールした実行ファイルを呼び出すための実行ファイルが~/.rbenv/shimsに生成される。自分はbundlerを使っているので、bundler自体をインストールしたときにしか使っていない。</p>
<div class="highlight-python"><div class="highlight"><pre>$ gem install bundler
$ rbenv rehash
</pre></div>
</div>
<p>rubyのversionの切り替えには以下の3つが使われている。ここがrbenvの肝だと思う。</p>
<table border="1" class="docutils"><colgroup><col width="25%"/><col width="75%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>~/.rbenv/version</td>
<td>デフォルトで使用するversionが書かれている。</td>
</tr><tr class="row-even"><td>.ruby-version</td>
<td>カレントディレクトリにこのファイルがある場合はここに書かれているversionが優先される。</td>
</tr><tr class="row-odd"><td>RBENV_VERSION</td>
<td>この環境変数がセットされている場合はここに書かれているversionが優先される。</td>
</tr></tbody></table><p><strong>RBENV_VERSION &gt; .ruby-version &gt; ~/.rbenv/version</strong>となっている。</p>
</div>
<div class="section" id="global">
<h3>global</h3>
<div class="highlight-python"><div class="highlight"><pre>$ rbenv global 1.9.3-p392
</pre></div>
</div>
</div>
<div class="section" id="local">
<h3>local</h3>
<p>カレントディレクトリに.ruby-versionが生成される。–unsetオプションでカレントディレクトリの.ruby-versionは削除される。</p>
<div class="highlight-python"><div class="highlight"><pre>$ rbenv local 1.9.3-p392
$ rbenv local --unset
</pre></div>
</div>
</div>
<div class="section" id="shell">
<h3>shell</h3>
<p>RBENV_VERSIONがセットされる。–unsetオプションでRBENV_VERSIONはunsetされる。</p>
<div class="highlight-python"><div class="highlight"><pre>$ rbenv shell 1.9.3-p392
$ rbenv shell --unset
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="https://github.com/sstephenson/rbenv">https://github.com/sstephenson/rbenv</a></li>
<li><a class="reference external" href="https://github.com/sstephenson/ruby-build">https://github.com/sstephenson/ruby-build</a></li>
</ul></div>
</div>]]></description>
            <category><![CDATA[ rbenv ]]></category>
            <category><![CDATA[ ruby-build ]]></category>
             <pubDate>Sat, 29 Mar 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/03/28/debian_wheezy_packer_vagrant_box_build.html</link>
            <guid>http://127.0.0.1/blog/html/2014/03/28/debian_wheezy_packer_vagrant_box_build.html</guid>
            <title><![CDATA[Packerを使ってVagrantのBOX作成]]></title>
            <description><![CDATA[<h1>Packerを使ってVagrantのBOX作成</h1>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2014/03/21/debian_wheezy_chef_solo_jenkins_install.html"><em>Chef SoloでJenkinsをインストール</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2014/03/22/debian_wheezy_chef_solo_vsftpd_install.html"><em>Chef Soloでvsftpdのインストールと設定</em></a></li>
</ul><p>ではOpscodeが配布しているBOXを使用していたが、今回はPackerを使い自前のBOXを作成してみる。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy
</pre></div>
</div>
<div class="section" id="packer">
<h2>Packer</h2>
<div class="section" id="id1">
<h3>インストール</h3>
<div class="highlight-python"><div class="highlight"><pre>$ wget https://dl.bintray.com/mitchellh/packer/0.5.2_linux_amd64.zip
$ mkdir -p $HOME/opt/local/bin
$ unzip 0.5.2_linux_amd64.zip -d 0.5.2_linux_amd64
$ cd 0.5.2_linux_amd64
$ mv `ls` $HOME/opt/local/bin
$ vi .bashrc
PATH=$HOME/opt/local/bin:$PATH
$ . .bashrc
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ packer -v
Packer v0.5.2
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h3>テンプレート作成</h3>
<p><a class="reference external" href="https://github.com/ryuzee/sandbox-devops">ryuzee / sandbox-devops</a>にPackerのテンプレートがあったのでForkしてCentOS 6.5のテンプレートを弄ってBOXを作成してみた。BOXの作り方は「<a class="reference external" href="http://docs.vagrantup.com/v2/boxes/base.html">Creating a Base Box</a>」を参考にした。</p>
<div class="highlight-python"><div class="highlight"><pre>$ git clone https://github.com/zinrai/sandbox-devops.git
$ cd sandbox-devops/packer-vagrantbox/CentOS-6.5-x86_64
$ git diff master packer_vagrantbox
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ diff --git a/packer-vagrantbox/CentOS-6.5-x86_64/Vagrantfile b/packer-vagrantbox/CentOS-6.5-x86_64/Vagrantfile
index f0c350c..d15ec59 100644
--- a/packer-vagrantbox/CentOS-6.5-x86_64/Vagrantfile
+++ b/packer-vagrantbox/CentOS-6.5-x86_64/Vagrantfile
@@ -1,3 +1,3 @@
 Vagrant.configure("2") do |config|
-    config.vm.base_mac = "{{ .BaseMacAddress }}"
+    #config.vm.base_mac = "{{ .BaseMacAddress }}"
 end
</pre></div>
</div>
<p><a class="reference external" href="https://github.com/mitchellh/packer/commit/0f82c01b98567fbea4436fb142d5c1f21fba30ed">古い設定</a>が残っていたのでコメントアウトした。</p>
<div class="highlight-python"><div class="highlight"><pre>$ diff --git a/packer-vagrantbox/CentOS-6.5-x86_64/machine.json b/packer-vagrantbox/CentOS-6.5-x86_64/machine.json
index b9418c1..76d6013 100644
--- a/packer-vagrantbox/CentOS-6.5-x86_64/machine.json
+++ b/packer-vagrantbox/CentOS-6.5-x86_64/machine.json
@@ -2,7 +2,7 @@
   "builders":[{
     "type": "virtualbox-iso",
     "guest_os_type": "RedHat_64",
-    "iso_url": "http://mozilla.ftp.iij.ad.jp/pub/linux/centos/6/isos/x86_64/CentOS-6.5-x86_64-minimal.iso",
+    "iso_url": "http://ftp.jaist.ac.jp/pub/Linux/CentOS/6.5/isos/x86_64/CentOS-6.5-x86_64-minimal.iso",
     "iso_checksum": "0d9dc37b5dd4befa1c440d2174e88a87",
     "iso_checksum_type": "md5",
     "ssh_username": "vagrant",
</pre></div>
</div>
<p>iso_urlに書かれていたURLにアクセスしてみるとForbiddenだったので、変更した。</p>
<div class="highlight-python"><div class="highlight"><pre>$ diff --git a/packer-vagrantbox/CentOS-6.5-x86_64/virtualbox.sh b/packer-vagrantbox/CentOS-6.5-x86_64/virtualbox.sh
index 2b6cd8c..d4dc928 100644
--- a/packer-vagrantbox/CentOS-6.5-x86_64/virtualbox.sh
+++ b/packer-vagrantbox/CentOS-6.5-x86_64/virtualbox.sh
@@ -29,7 +29,3 @@ sudo sh /mnt/VBoxLinuxAdditions.run
 sudo umount /mnt
 #rm -rf /home/vagrant/VBoxGuestAdditions*.iso
 sudo /etc/rc.d/init.d/vboxadd setup
-
-sudo su -c "curl -L https://www.opscode.com/chef/install.sh | bash"
-which chef-solo
-sleep 5
</pre></div>
</div>
<p>Chef Soloインストールの部分は削除した。</p>
</div>
<div class="section" id="box">
<h3>BOX作成</h3>
<div class="highlight-python"><div class="highlight"><pre>$ packer validate machine.json
Template validated successfully.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ packer build machine.json
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ ls
CentOS-6.5-x86_64-ja.box  Vagrantfile  ks.cfg  machine.json  packer_cache  virtualbox.sh
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vagrant box add CentOS-6.5-x86_64-ja CentOS-6.5-x86_64-ja.box
$ vagrant box list
CentOS-6.5-x86_64-ja (virtualbox)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir centos65
$ cd centos65
$ vagrant init CentOS-6.5-x86_64-ja
$ vagrant up
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.packer.io">http://www.packer.io/</a></li>
<li><a class="reference external" href="https://github.com/ryuzee/sandbox-devops">https://github.com/ryuzee/sandbox-devops</a></li>
<li><a class="reference external" href="http://docs.vagrantup.com/v2/boxes/base.html">http://docs.vagrantup.com/v2/boxes/base.html</a></li>
</ul></div>
</div>]]></description>
            <category><![CDATA[ packer ]]></category>
             <pubDate>Fri, 28 Mar 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/03/25/debian_wheezy_vsftpd_serverspec.html</link>
            <guid>http://127.0.0.1/blog/html/2014/03/25/debian_wheezy_vsftpd_serverspec.html</guid>
            <title><![CDATA[serverspecを使ってみる]]></title>
            <description><![CDATA[<h1>serverspecを使ってみる</h1>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2014/03/22/debian_wheezy_chef_solo_vsftpd_install.html"><em>Chef Soloでvsftpdのインストールと設定</em></a></li>
</ul><p>で構築した環境をserverspecを使ってテストしてみる。</p>
<div class="section" id="vsftpd">
<h2>vsftpdのテスト項目</h2>
<ul class="simple"><li>インストールされているか</li>
<li>自動起動は設定されているか</li>
<li>起動しているか</li>
<li>ポート21番でListenしているか</li>
<li>vsftpd.confファイルは存在するか</li>
<li>vsftpd.confファイルはChefに書いてあるpermissionになっているか(600)</li>
<li>vsftpd.confファイルはChefに書いてあるownerになっているか(root)</li>
<li>vsftpd.confファイルはChefに書いてあるgroupになっているか(root)</li>
<li>vsftpd.confにanon_root=/var/vsftpdは設定されているか</li>
<li>anon_rootで指定しているディレクトリは存在するか(/var/vsftpd)</li>
<li>anon_rootで指定しているディレクトリはChefに書いてあるpermissionになっているか(755)</li>
<li>anon_rootで指定しているディレクトリはChefに書いてあるownerになっているか(root)</li>
<li>anon_rootで指定しているディレクトリはChefに書いてあるgroupになっているか(root)</li>
</ul><p>の13項目をテストする。</p>
</div>
<div class="section" id="id1">
<h2>serverspec</h2>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi Gemfile
source 'https://rubygems.org'

gem 'serverspec'
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ bundle install --path vendor/bundle
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ cat Gemfile.lock
GEM
  remote: https://rubygems.org/
  specs:
    serverspec (0.16.0)
      highline
      net-ssh
      rspec (~&gt; 2.13)
      specinfra (&gt;= 0.7.1)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec serverspec-init
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi spec/vsftpd/vsftpd_spec.rb
require 'spec_helper'

describe package('vsftpd') do
  it { should be_installed }
end

describe service('vsftpd') do
  it { should be_enabled }
  it { should be_running }
end

describe port(21) do
  it { should be_listening }
end

describe file('/etc/vsftpd/vsftpd.conf') do
  it { should be_file }
  it { should be_mode 600 }
  it { should be_owned_by 'root' }
  it { should be_grouped_into 'root' }
  its(:content) { should match /anon_root=\/var\/vsftpd/ }
end

describe file('/var/vsftpd') do
  it { should be_directory }
  it { should be_mode 755 }
  it { should be_owned_by 'root' }
  it { should be_grouped_into 'root' }
end
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec rake spec
/home/hoge/.rbenv/versions/2.0.0-p353/bin/ruby -S rspec spec/vsftpd/vsftpd_spec.rb
.............

Finished in 1.17 seconds
13 examples, 0 failures
</pre></div>
</div>
<p>日本語で長々と書いていたものが、Resourceを指定してResourceが持っているマッチャーを使いshould be_hogehoge argと書けば表現できていい感じ。</p>
<ul class="simple"><li><a class="reference external" href="http://serverspec.org">http://serverspec.org/</a></li>
<li><a class="reference external" href="http://serverspec.org/tutorial.html">http://serverspec.org/tutorial.html</a></li>
<li><a class="reference external" href="http://serverspec.org/resource_types.html">http://serverspec.org/resource_types.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ serverspec ]]></category>
             <pubDate>Tue, 25 Mar 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/03/22/debian_wheezy_chef_solo_vsftpd_install.html</link>
            <guid>http://127.0.0.1/blog/html/2014/03/22/debian_wheezy_chef_solo_vsftpd_install.html</guid>
            <title><![CDATA[Chef Soloでvsftpdのインストールと設定]]></title>
            <description><![CDATA[<h1>Chef Soloでvsftpdのインストールと設定</h1>
<ul class="simple"><li>某スイッチのアップグレードのためにFTPサーバを立てなければいけなくて、vsftpdでanonymous FTPのディレクトリを設定するのに手間取ったのでメモしておきたい。</li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2014/03/21/debian_wheezy_chef_solo_jenkins_install.html"><em>前回</em></a>はTemplate Resourceを使わなかったので使ってみたい。</li>
</ul><p>ということでChef Soloでvsftpdをインストール、Template Resource使った設定ファイルの設置まで行う。</p>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2014/03/21/debian_wheezy_chef_solo_jenkins_install.html"><em>前回</em></a>と同じくVagrantを使う。作ったCookbookは<a class="reference external" href="https://github.com/zinrai/chef-repo/tree/vsftpd">Github</a>に置くようにした。</p>
<div class="section" id="vagrant">
<h2>Vagrant</h2>
<div class="highlight-python"><div class="highlight"><pre>$ vagrant -v
Vagrant 1.4.3
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi Vagrantfile

# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.hostname = "vsftpd"
  config.vm.box = "opscode_centos-6.4"

  config.vm.network :public_network, :ip =&gt; "192.168.0.1", :netmask =&gt; "255.255.255.0", :bridge =&gt; "eth0"
  config.vm.provider :virtualbox do |vb|
    vb.customize ["modifyvm", :id, "--memory", "1024"]
  end
end
</pre></div>
</div>
<p>今回はforward portではなくbridgeするようにした。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vagrant up
$ vagrant ssh-config --host vsftpd &gt;&gt; ~/.ssh/config
</pre></div>
</div>
</div>
<div class="section" id="vsftpd">
<h2>vsftpd</h2>
<div class="highlight-python"><div class="highlight"><pre>$ cat /etc/centos-release
CentOS release 6.4 (Final)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ man -k vsftpd
vsftpd               (8)  - Very Secure FTP Daemon
vsftpd.conf [vsftpd] (5)  - config file for vsftpd

$ man vsftpd.conf

anon_root
              This option represents a directory which vsftpd will try to change into after  an
              anonymous login. Failure is silently ignored.

              Default: (none)
</pre></div>
</div>
<p>anonymous FTPは有効になっているけれどディレクトリは設定されていないのでanon_rootを設定する。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vsftpd -v
vsftpd: version 2.2.2
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ cat /etc/vsftpd.conf.org
anonymous_enable=YES
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=YES
pam_service_name=vsftpd
userlist_enable=YES
tcp_wrappers=YES
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ diff -u vsftpd.conf vsftpd.conf.org
--- vsftpd.conf 2014-03-22 09:37:23.935013981 +0000
+++ vsftpd.conf.org     2014-03-22 09:10:03.970016338 +0000
@@ -1,5 +1,4 @@
 anonymous_enable=YES
-anon_root=/var/vsftpd
 local_enable=YES
 write_enable=YES
 local_umask=022
</pre></div>
</div>
</div>
<div class="section" id="chef-solo">
<h2>Chef Solo</h2>
<p>anon_rootの設定を追加してanonymous FTP用のディレクトリを作成すればいいということがわかったのでCookbookに落し込んでいく。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec knife solo prepare vsftpd
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi Berksfile

site :opscode

cookbook "yum", "3.0.6"
cookbook "vsftpd", path: "./site-cookbooks/vsftpd"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec knife cookbook create vsftpd -o ./site-cookbooks
$ bundle exec berks install --path ./cookbooks
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi site-cookbooks/vsftpd/recipes/default.rb
%w(vsftpd).each do |pkg|
  package pkg do
    action :install
  end
end

directory '/var/vsftpd' do
  owner 'root'
  group 'root'
  mode '0755'
  action :create
end

template "vsftpd.conf" do
  path "/etc/vsftpd/vsftpd.conf"
  source "vsftpd.conf.erb"
  owner "root"
  group "root"
  mode "600"
end

service "vsftpd" do
  action [:enable, :start]
end
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi site-cookbooks/vsftpd/templates/default/vsftpd.conf.erb
anonymous_enable=YES
anon_root=/var/vsftpd
local_enable=YES
write_enable=YES
local_umask=022
dirmessage_enable=YES
xferlog_enable=YES
connect_from_port_20=YES
xferlog_std_format=YES
listen=YES
pam_service_name=vsftpd
userlist_enable=YES
tcp_wrappers=YES
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi nodes/vsftpd.json
{"run_list":[
    "recipe[vsftpd]"
  ]
}
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec berks install --path ./cookbooks
$ bundle exec knife solo cook vsftpd nodes/vsftpd.json
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ ftp 192.168.0.1
</pre></div>
</div>
<p>などしてFTPサーバにアクセスできれば成功している。</p>
<ul class="simple"><li><a class="reference external" href="http://docs.opscode.com/resource_directory.html">http://docs.opscode.com/resource_directory.html</a></li>
<li><a class="reference external" href="http://docs.opscode.com/resource_template.html">http://docs.opscode.com/resource_template.html</a></li>
<li><a class="reference external" href="http://docs.vagrantup.com/v2/networking/public_network.html">http://docs.vagrantup.com/v2/networking/public_network.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ chef ]]></category>
             <pubDate>Sat, 22 Mar 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/03/21/debian_wheezy_chef_solo_jenkins_install.html</link>
            <guid>http://127.0.0.1/blog/html/2014/03/21/debian_wheezy_chef_solo_jenkins_install.html</guid>
            <title><![CDATA[Chef SoloでJenkinsをインストール]]></title>
            <description><![CDATA[<h1>Chef SoloでJenkinsをインストール</h1>
<p>社内で詳しい人の助けを借りてChef SoloでJenkinsをインストールしてみた。</p>
<div class="section" id="vagrant">
<h2>Vagrant</h2>
<p>今回は「<a class="reference internal" href="http://127.0.0.1/blog/html/2014/03/20/debian_wheezy_virtualbox_vagrant.html"><em>Debian wheezyでVagrantを使てみた</em></a>」で追加したBOXを使う。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vi Vagrantfile

# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.hostname = "jenkins"
  config.vm.box = "opscode_centos-6.4"

  config.vm.network :private_network, ip: "192.168.11.11"
  config.vm.network :forwarded_port, guest: 8080, host: 8080

  config.vm.provider :virtualbox do |vb|
    vb.customize ["modifyvm", :id, "--memory", "1024"]
  end

  #config.omnibus.chef_version = "11.10.4"
end
</pre></div>
</div>
<p>vagrant-omnibusプラグイン使えば、Vagrantの管理下にある仮想マシンに指定したversionのChef Soloをインストールすることができるが、ここではvagrant-omnibusは使わず別の方法でChef Soloを仮想マシンにインストールする。</p>
<p>下記のコマンドを実行するとssh jenkinsでVagrant管理下のマシンに接続できるようになる設定を掃き出してくれるので.ssh/configにリダイレクトしておく。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vagrant ssh-config --host jenkins &gt;&gt; ~/.ssh/config
</pre></div>
</div>
</div>
<div class="section" id="chef-solo">
<h2>Chef Solo</h2>
<p>Chef SoloはDebianで動かした。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install libxml2-dev libxslt1-dev build-essential openssh-client rsync
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ ruby -v
ruby 2.0.0p353 (2013-11-22 revision 43784) [x86_64-linux]
</pre></div>
</div>
<div class="section" id="gemfile">
<h3>Gemfile</h3>
<div class="highlight-python"><div class="highlight"><pre>$ bundle install --path vendor/bundle
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi Gemfile
source 'https://rubygems.org'

gem 'berkshelf'
gem 'chef'
gem 'knife-solo'
gem 'rake'
</pre></div>
</div>
<table border="1" class="docutils"><colgroup><col width="17%"/><col width="83%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>berkshelf</td>
<td>cookbooksの依存関係を管理してくれるツール</td>
</tr><tr class="row-even"><td>knife-solo</td>
<td>ホストのrecipeをサーバへrsyncしChef Soloを実行。結果をホストに出力してくれるknifeプラグイン</td>
</tr></tbody></table></div>
<div class="section" id="gemfile-lock">
<h3>Gemfile.lock</h3>
<p>2014/03/20の時点でのGemfile.lockは以下のようになっている。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cat Gemfile.lock
GEM
  remote: https://rubygems.org/
  specs:
    activesupport (3.2.17)
      i18n (~&gt; 0.6, &gt;= 0.6.4)
      multi_json (~&gt; 1.0)
    addressable (2.3.5)
    akami (1.2.1)
      gyoku (&gt;= 0.4.0)
      nokogiri
    berkshelf (2.0.14)
      activesupport (~&gt; 3.2.0)
      addressable (~&gt; 2.3.4)
      buff-shell_out (~&gt; 0.1)
      chozo (&gt;= 0.6.1)
      faraday (~&gt; 0.8.0)
      faraday (~&gt; 0.8.5)
      hashie (&gt;= 2.0.2)
      minitar (~&gt; 0.5.4)
      rbzip2 (~&gt; 0.2.0)
      retryable (~&gt; 1.3.3)
      ridley (~&gt; 1.5.0)
      solve (&gt;= 0.5.0)
      thor (~&gt; 0.18.0)
    buff-config (0.4.0)
      buff-extensions (~&gt; 0.3)
      varia_model (~&gt; 0.1)
    buff-extensions (0.5.0)
    buff-ignore (1.1.1)
    buff-ruby_engine (0.1.0)
    buff-shell_out (0.1.1)
      buff-ruby_engine (~&gt; 0.1.0)
    builder (3.2.2)
    celluloid (0.14.1)
      timers (&gt;= 1.0.0)
    celluloid-io (0.14.1)
      celluloid (&gt;= 0.14.1)
      nio4r (&gt;= 0.4.5)
    chef (11.10.4)
      chef-zero (~&gt; 1.7, &gt;= 1.7.2)
      diff-lcs (~&gt; 1.2, &gt;= 1.2.4)
      erubis (~&gt; 2.7)
      highline (~&gt; 1.6, &gt;= 1.6.9)
      json (&gt;= 1.4.4, &lt;= 1.8.1)
      mime-types (~&gt; 1.16)
      mixlib-authentication (~&gt; 1.3)
      mixlib-cli (~&gt; 1.4)
      mixlib-config (~&gt; 2.0)
      mixlib-log (~&gt; 1.3)
      mixlib-shellout (~&gt; 1.3)
      net-ssh (~&gt; 2.6)
      net-ssh-multi (~&gt; 1.1)
      ohai (~&gt; 6.0)
      pry (~&gt; 0.9)
      puma (~&gt; 1.6)
      rest-client (&gt;= 1.0.4, &lt; 1.7.0)
      yajl-ruby (~&gt; 1.1)
    chef-zero (1.7.3)
      hashie (~&gt; 2.0)
      json
      mixlib-log (~&gt; 1.3)
      moneta (&lt; 0.7.0)
      rack
    chozo (0.6.1)
      activesupport (&gt;= 3.2.0)
      hashie (&gt;= 2.0.2)
      multi_json (&gt;= 1.3.0)
    coderay (1.1.0)
    diff-lcs (1.2.5)
    erubis (2.7.0)
    faraday (0.8.9)
      multipart-post (~&gt; 1.2.0)
    ffi (1.9.3)
    gssapi (1.0.3)
      ffi (&gt;= 1.0.1)
    gyoku (1.1.1)
      builder (&gt;= 2.1.2)
    hashie (2.0.5)
    highline (1.6.21)
    hitimes (1.2.1)
    httpclient (2.3.4.1)
    httpi (0.9.7)
      rack
    i18n (0.6.9)
    ipaddress (0.8.0)
    json (1.8.1)
    knife-solo (0.4.1)
      chef (&gt;= 10.12)
      erubis (~&gt; 2.7.0)
      net-ssh (&gt;= 2.2.2, &lt; 3.0)
    little-plugger (1.1.3)
    logging (1.8.2)
      little-plugger (&gt;= 1.1.3)
      multi_json (&gt;= 1.8.4)
    method_source (0.8.2)
    mime-types (1.25.1)
    mini_portile (0.5.2)
    minitar (0.5.4)
    mixlib-authentication (1.3.0)
      mixlib-log
    mixlib-cli (1.4.0)
    mixlib-config (2.1.0)
    mixlib-log (1.6.0)
    mixlib-shellout (1.3.0)
    moneta (0.6.0)
    multi_json (1.9.2)
    multipart-post (1.2.0)
    net-http-persistent (2.9.4)
    net-ssh (2.8.0)
    net-ssh-gateway (1.2.0)
      net-ssh (&gt;= 2.6.5)
    net-ssh-multi (1.2.0)
      net-ssh (&gt;= 2.6.5)
      net-ssh-gateway (&gt;= 1.2.0)
    nio4r (1.0.0)
    nokogiri (1.6.1)
      mini_portile (~&gt; 0.5.0)
    nori (1.1.5)
    ohai (6.20.0)
      ipaddress
      mixlib-cli
      mixlib-config
      mixlib-log
      mixlib-shellout
      systemu (~&gt; 2.5.2)
      yajl-ruby
    pry (0.9.12.6)
      coderay (~&gt; 1.0)
      method_source (~&gt; 0.8)
      slop (~&gt; 3.4)
    puma (1.6.3)
      rack (~&gt; 1.2)
    rack (1.5.2)
    rake (10.1.1)
    rbzip2 (0.2.0)
    rest-client (1.6.7)
      mime-types (&gt;= 1.16)
    retryable (1.3.5)
    ridley (1.5.3)
      addressable
      buff-config (~&gt; 0.2)
      buff-extensions (~&gt; 0.3)
      buff-ignore (~&gt; 1.1)
      buff-shell_out (~&gt; 0.1)
      celluloid (~&gt; 0.14.0)
      celluloid-io (~&gt; 0.14.0)
      erubis
      faraday (&gt;= 0.8.4)
      hashie (&gt;= 2.0.2)
      json (&gt;= 1.7.7)
      mixlib-authentication (&gt;= 1.3.0)
      net-http-persistent (&gt;= 2.8)
      net-ssh
      nio4r (&gt;= 0.5.0)
      retryable
      solve (&gt;= 0.4.4)
      varia_model (~&gt; 0.1)
      winrm (~&gt; 1.1.0)
    rubyntlm (0.1.1)
    savon (0.9.5)
      akami (~&gt; 1.0)
      builder (&gt;= 2.1.2)
      gyoku (&gt;= 0.4.0)
      httpi (~&gt; 0.9)
      nokogiri (&gt;= 1.4.0)
      nori (~&gt; 1.0)
      wasabi (~&gt; 1.0)
    slop (3.5.0)
    solve (0.8.2)
    systemu (2.5.2)
    thor (0.18.1)
    timers (2.0.0)
      hitimes
    uuidtools (2.1.4)
    varia_model (0.3.2)
      buff-extensions (~&gt; 0.2)
      hashie (&gt;= 2.0.2)
    wasabi (1.0.0)
      nokogiri (&gt;= 1.4.0)
    winrm (1.1.3)
      gssapi (~&gt; 1.0.0)
      httpclient (~&gt; 2.2, &gt;= 2.2.0.2)
      logging (~&gt; 1.6, &gt;= 1.6.1)
      nokogiri (~&gt; 1.5)
      rubyntlm (~&gt; 0.1.1)
      savon (= 0.9.5)
      uuidtools (~&gt; 2.1.2)
    yajl-ruby (1.2.0)

PLATFORMS
  ruby

DEPENDENCIES
  berkshelf
  chef
  knife-solo
  rake
</pre></div>
</div>
<p>cookbookの作成にはいっていくが、その前にサーバにChef Soloをインストールしておく。vagrant-omnibusではVagrantの管理下にあるマシンにしかChef Soloをインストールできないが、knife solo prepareを使えば指定したサーバにChef Soloをインストールすることができる。</p>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec knife solo prepare jenkins
</pre></div>
</div>
<p>ディレクトリの構成は</p>
<table border="1" class="docutils"><colgroup><col width="17%"/><col width="83%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>cookbooks</td>
<td>サードパーティのcookbooksを格納</td>
</tr><tr class="row-even"><td>site-cookbooks</td>
<td>自分で作成したcookbooksを格納</td>
</tr></tbody></table><p>と使い分けるのがモダンなやり方のようだ。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vi Berksfile

site :opscode

cookbook "yum", "3.0.6"
cookbook "jenkins", path: "./site-cookbooks/jenkins"
</pre></div>
</div>
<p>Berksfileとsite-cookbooksは必ず一致させておく。</p>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec knife cookbook create jenkins -o ./site-cookbooks/
$ bundle exec berks install --path ./cookbooks
</pre></div>
</div>
<p>berkshelfでcookbookを管理している場合は、site-cookbooks以下に変更を加えたら必ずberks installを実行する。</p>
<ul class="simple"><li><strong>Node</strong>: Chefで管理するサーバ/マシン</li>
<li><strong>Cookbook</strong>: Node対して行うオペレーションをまとめた単位<ul><li><strong>Recipe</strong>: Nodeに対して行うオペレーション</li>
<li><strong>Attribute</strong>: cookbook内にあるパラメータ</li>
<li><strong>Resource</strong>: オペレーションを抽象化したAPI</li>
</ul></li>
</ul><p>今回だと、RecipeにはJenkinsのrpmパッケージを取得してインストールして起動するまでをResourceを使って書き、Attributeには取得先のURLとパッケージバーションをパラメータとして設定して、これらがCookbookになっているという感じである。attributeにパラメータを設定して、recipeにオペレーションを書いて、nodes/jenkins.jsonに適用したいrecipeを書いて、Chef Soloを実行するまでが一連の流れになる。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vi site-cookbooks/jenkins/attributes/default.rb
default['jenkins']['rpm'] = "jenkins-1.555-1.1.noarch.rpm"
default['jenkins']['rpm_url'] = "http://pkg.jenkins-ci.org/redhat/#{node['jenkins']['rpm']}"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi sites-cookbooks/jenkins/recipe/default.rb
%w(java-1.7.0-openjdk).each do |pkg|
  package pkg do
    action :install
  end
end

remote_file "/tmp/" + node["jenkins"]["rpm"] do
  source node["jenkins"]["rpm_url"]
  owner "root"
  group "root"
  mode "0755"
end

package "jenkins" do
  action :install
  source "/tmp/" + node["jenkins"]["rpm"]
end

service "jenkins" do
  action [:enable, :start]
end
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi nodes/jenkins.json
{"run_list":[
    "recipe[jenkins]"
  ]
}
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ bundle exec berks install --path ./cookbooks
$ bundle exec knife solo cook jenkins nodes/jenkins.json
</pre></div>
</div>
<p>最後のコマンドはjenkinsというサーバに対してnodes/jenkins.jsonに書かれた情報をもとにrecipeを適用するという意味である。</p>
<ul class="simple"><li><a class="reference external" href="http://berkshelf.com">http://berkshelf.com/</a></li>
<li><a class="reference external" href="http://docs.opscode.com/chef/resources.html">http://docs.opscode.com/chef/resources.html</a></li>
<li><a class="reference external" href="http://docs.opscode.com/chef_overview_attributes.html">http://docs.opscode.com/chef_overview_attributes.html</a></li>
<li><a class="reference external" href="http://pkg.jenkins-ci.org/redhat">http://pkg.jenkins-ci.org/redhat/</a></li>
</ul></div>
</div>]]></description>
            <category><![CDATA[ chef ]]></category>
             <pubDate>Fri, 21 Mar 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/03/20/debian_wheezy_virtualbox_vagrant.html</link>
            <guid>http://127.0.0.1/blog/html/2014/03/20/debian_wheezy_virtualbox_vagrant.html</guid>
            <title><![CDATA[Debian wheezyでVagrantを使てみた]]></title>
            <description><![CDATA[<h1>Debian wheezyでVagrantを使てみた</h1>
<p>巷で人気のVagrantで</p>
<ul class="simple"><li>BOXの追加</li>
<li>仮想マシンの起動</li>
<li>プラグインのインストール</li>
<li>インストールしたプラグインの使用</li>
</ul><p>までやってみた。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.54-2 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy
</pre></div>
</div>
<div class="section" id="virtualbox">
<h2>Virtualbox</h2>
<div class="section" id="id1">
<h3>インストール</h3>
<div class="highlight-python"><div class="highlight"><pre>$ wget http://download.virtualbox.org/virtualbox/4.3.8/virtualbox-4.3_4.3.8-92456~Debian~wheezy_amd64.deb
% dpkg -i virtualbox*.deb
</pre></div>
</div>
</div>
</div>
<div class="section" id="vagrant">
<h2>Vagrant</h2>
<div class="section" id="id2">
<h3>インストール</h3>
<div class="highlight-python"><div class="highlight"><pre>$ wget https://dl.bintray.com/mitchellh/vagrant/vagrant_1.5.1_x86_64.deb
% dpkg -i vagrant*.deb
</pre></div>
</div>
</div>
<div class="section" id="box">
<h3>BOXの追加</h3>
<p>今回はopscodeが公開しているBOXを使う。</p>
<div class="highlight-python"><div class="highlight"><pre>$ wget http://opscode-vm-bento.s3.amazonaws.com/vagrant/virtualbox/opscode_centos-6.4_chef-provisionerless.box

$ vagrant box add opscode_centos-6.4 opscode_centos-6.4_chef-provisionerless.box
$ vagrant box list
opscode_centos-6.4 (virtualbox)
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>仮想マシンの起動</h3>
<div class="highlight-python"><div class="highlight"><pre>$ vi Vagrantfile

# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  config.vm.hostname = "test"
  config.vm.box = "opscode_centos-6.4"

  config.vm.network :private_network, ip: "192.168.11.11"
  config.vm.provider :virtualbox do |vb|
    vb.customize ["modifyvm", :id, "--memory", "1024"]
  end
end
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vagrant up
</pre></div>
</div>
</div>
</div>
<div class="section" id="sahara">
<h2>sahara</h2>
<p>Vagrantで管理されている仮想マシンのある時点の状態を保存しておきロールバックしたりすることができるプラグイン</p>
<div class="highlight-python"><div class="highlight"><pre>$ vagrant plugin install sahara
$ vagrant plugin list
sahara (0.0.16)
</pre></div>
</div>
<p>インストールするとVagrantにサブコマンドsandboxが追加される。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vagrant sandbox -h
Usage: vagrant plugin &lt;command&gt; [&lt;args&gt;]

Available subcommands:
     commit
     off
     on
     rollback
     status
</pre></div>
</div>
<table border="1" class="docutils"><colgroup><col width="13%"/><col width="88%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>commit</td>
<td>保存されて状態以降の変更を保存する。</td>
</tr><tr class="row-even"><td>off</td>
<td>sandboxをoffにする。保存されちている状態以降の変更は保存される。</td>
</tr><tr class="row-odd"><td>on</td>
<td>onにした時点の仮想マシンの状態が保存される。</td>
</tr><tr class="row-even"><td>rollback</td>
<td>最後に保存した時点までロールバックする。</td>
</tr><tr class="row-odd"><td>status</td>
<td>sandbox状態かの確認</td>
</tr></tbody></table><div class="highlight-python"><div class="highlight"><pre>$ vagrant status
Current machine states:

default                   running (virtualbox)

$ vagrant sandbox status
[default] Sandbox mode is off

$ vagrant sandbox commit
$ vagrant sandbox off
$ vagrant sandbox on
$ vagrant sandbox rollback
</pre></div>
</div>
<p>sandboxをonにしてVagrantで管理している仮想マシンにアクセスして変更を加えたあとrollbackすると仮想マシンがon時の状態に戻る。</p>
<ul class="simple"><li><a class="reference external" href="http://www.vagrantup.com">http://www.vagrantup.com/</a></li>
<li><a class="reference external" href="http://opscode.github.io/bento">http://opscode.github.io/bento/</a></li>
<li><a class="reference external" href="https://github.com/jedi4ever/sahara">https://github.com/jedi4ever/sahara</a></li>
<li><a class="reference external" href="https://www.virtualbox.org/wiki/Linux_Downloads">https://www.virtualbox.org/wiki/Linux_Downloads</a></li>
</ul></div>]]></description>
            <category><![CDATA[ vagrant ]]></category>
             <pubDate>Thu, 20 Mar 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/02/26/debian_wheezy_schroot_aufs.html</link>
            <guid>http://127.0.0.1/blog/html/2014/02/26/debian_wheezy_schroot_aufs.html</guid>
            <title><![CDATA[schrootでaufsを使う]]></title>
            <description><![CDATA[<h1>schrootでaufsを使う</h1>
<p>schroot(1)でaufsを使いたいなと思いschroot.conf(5)を眺めてみたところunion-type,union-mount-optionsというオプションを見付けた。union-typeにaufsを指定し、union-mount-optionsにunion mountするときのオプションを書けばオプションをパースしてくれる。</p>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/schroot/chroot.d/fuga.conf

[fuga]
type=directory
directory=/var/chroot/fuga
union-type=aufs
union-mount-options=br:/var/chroot/fuga:/var/chroot/wheezy=ro none /var/chroot/fuga
profile=fuga
users=hoge
root-groups=root
</pre></div>
</div>]]></description>
            <category><![CDATA[ schroot ]]></category>
             <pubDate>Wed, 26 Feb 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/02/25/debian_wheezy_synergy.html</link>
            <guid>http://127.0.0.1/blog/html/2014/02/25/debian_wheezy_synergy.html</guid>
            <title><![CDATA[Synergyでマウスとキーボードを共有]]></title>
            <description><![CDATA[<h1>Synergyでマウスとキーボードを共有</h1>
<p>最近、デスクトップPCの横にノートPCを置いて作業をるすことが多くなったのでsynergyを入れてみた。</p>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.4 (wheezy)
Release:        7.4
Codename:       wheezy

$ apt-cache show synergy
Package: synergy
Version: 1.3.8-2

% apt-get install synergy
</pre></div>
</div>
<div class="section" id="server">
<h2>Server</h2>
<div class="highlight-python"><div class="highlight"><pre>$ vi $HOME/.synergy.conf

section: screens
  hoge:
  fuga:
end

section: links
  hoge:
    right = fuga
  fuga:
    left = hoge
end

section: aliases
  hoge:
    192.168.0.1
  fuga:
    192.168.0.2
end

section: options
  keystroke(alt+control+j) = switchToScreen(hoge)
  keystroke(alt+control+k) = switchToScreen(fuga)
end
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ synergys
</pre></div>
</div>
</div>
<div class="section" id="client">
<h2>Client</h2>
<div class="highlight-python"><div class="highlight"><pre>$ synergyc 192.168.0.1
</pre></div>
</div>
<p>synergys(1),synergyc(1)をforegroundで起動したいときは、どちらも「-f」オプションを付ける。</p>
<ul class="simple"><li><a class="reference external" href="http://synergy-foss.org/?hl=ja">http://synergy-foss.org/?hl=ja</a></li>
<li><a class="reference external" href="http://synergy2.sourceforge.net/configuration.html">http://synergy2.sourceforge.net/configuration.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ synergy ]]></category>
             <pubDate>Tue, 25 Feb 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/02/07/debian_wheezy_openvpn.html</link>
            <guid>http://127.0.0.1/blog/html/2014/02/07/debian_wheezy_openvpn.html</guid>
            <title><![CDATA[OpenVPN サーバ構築]]></title>
            <description><![CDATA[<h1>OpenVPN サーバ構築</h1>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.51-1 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.3 (wheezy)
Release:        7.3
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% sysctl -p
net.ipv4.ip_forward = 1
</pre></div>
</div>
<div class="section" id="id1">
<h2>サーバ</h2>
<p>ルーティングモードとブリッジモードがあり、今回はブリッジモードで動かす。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install openvpn openssl bridge-utils

% openvpn --version
OpenVPN 2.2.1 x86_64-linux-gnu [SSL] [LZO2] [EPOLL] [PKCS11] [eurephia] [MH] [PF_INET6] [IPv6 payload 20110424-2 (2.2RC2)] built on Jun 18 2013
Originally developed by James Yonan
Copyright (C) 2002-2010 OpenVPN Technologies, Inc. &lt;sales@openvpn.net&gt;
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% cp -r /usr/share/doc/openvpn/examples/easy-rsa /etc/openvpn
% cd /etc/openvpn/easy-rsa/2.0
% . ./vars
% ./build-ca
% ./build-key-server server &lt;- サーバ用の証明書
% ./build-dh

% ./build-key client01 &lt;- クライアント用の証明書

% cd keys
% cp ca.crt server.crt server.key dh1024.pem /etc/openvpn
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/openvpn/openvpn.conf
port 1194
proto tcp
dev tap0
ca ca.crt
cert server.crt
key server.key
dh dh1024.pem
server-bridge 192.168.2.1 255.255.255.0 192.168.2.250 192.168.2.253
push "route 192.168.2.0 255.255.255.0"
duplicate-cn
keepalive 10 120
comp-lzo
persist-key
persist-tun
status openvpn-status.log
verb 4
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/network/interfaces
auto lo
iface lo inet loopback

auto br0
iface br0 inet static
address 192.168.2.1
netmask 255.255.255.0
gateway 192.168.2.254
bridge_ports eth0
up openvpn --mktun --dev tap0
up ifconfig tap0 up
up brctl addif br0 tap0
down brctl delif br0 tap0
down ifconfig tap0 down
down openvpn --rmtun --dev tap0
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% update-rc.d openvpn defaults
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>クライアント</h2>
<p>サーバ側で生成したクライアント用の証明書をクライアントPCにもってくる。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install openvpn openssl

% vi /etc/openvpn/client.conf
client
dev tap
proto tcp
remote 10.0.0.1 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
cert client01.crt
key client01.key
ns-cert-type server
comp-lzo
verb 3
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.openvpn.jp/document/how-to/debian_wheezy_openvpn.html#RoutedOrBridged">http://www.openvpn.jp/document/how-to/#RoutedOrBridged</a></li>
<li><a class="reference external" href="http://www.openvpn.jp/document/how-to/debian_wheezy_openvpn.html#CertificateAuthority">http://www.openvpn.jp/document/how-to/#CertificateAuthority</a></li>
</ul></div>]]></description>
            <category><![CDATA[ openvpn ]]></category>
             <pubDate>Fri, 07 Feb 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/02/06/debian_wheezy_kvm_zfs.html</link>
            <guid>http://127.0.0.1/blog/html/2014/02/06/debian_wheezy_kvm_zfs.html</guid>
            <title><![CDATA[KVMのGuestOSにZVOLを使う]]></title>
            <description><![CDATA[<h1>KVMのGuestOSにZVOLを使う</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2014/02/05/debian_wheezy_zfs.html"><em>ZFS on Linux (Debian wheezy)</em></a>」で最後に書いたブロックデバイスとして見えないかを調べてみた。</p>
<div class="section" id="zvol">
<h2>ZVOL</h2>
<p>ZFSの領域をブロックデバイスとして切り出すことができる機能</p>
<div class="highlight-python"><div class="highlight"><pre>% zfs create -V 20G zfspool/disk2
% zfs list
NAME            USED  AVAIL  REFER  MOUNTPOINT
zfspool        22.2G  1.76T   144K  /zfspool
zfspool/disk1   136K  1.76T   136K  /zfspool/disk1
zfspool/disk2  20.6G  1.78T    72K  -

% ls -l /dev/zvol/zfspool/
total 0
lrwxrwxrwx 1 root root 10 Feb  6 12:37 disk2 -&gt; ../../zd16
</pre></div>
</div>
</div>
<div class="section" id="sparse-volume">
<h2>sparse volume</h2>
<p>上記だと20GBの領域がまるまる割り当てられてしまうので、thin provisioning的な機能はないかzfs(8)を眺めてみた。</p>
<p>man zfsして「thin provisioning」で検索して「 “sparse volume” (also known as “thin provisioning”)」の文の見付けて「sparse volume」で検索したらオプションを探し当てることができた。</p>
<div class="highlight-python"><div class="highlight"><pre>Though not recommended, a "sparse volume" (also known as "thin provisioning") can be created by specifying the -s option to the  zfs  create  -V command,  or by changing the reservation after the volume has been created. A "sparse volume" is a volume where the reservation is less then the volume size. Consequently, writes to a sparse volume can fail with ENOSPC when the pool is low on space. For a sparse volume, changes to volsize are not reflected in the reservation.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>-s

Creates a sparse volume with no reservation. See volsize in the Native Properties section for more information about sparse volumes.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% zfs create -s -V 50G zfspool/kvm1
% zfs get all zfspool/kvm1
NAME          PROPERTY              VALUE                  SOURCE
zfspool/kvm1  type                  volume                 -
zfspool/kvm1  creation              Thu Feb  6  1:13 2014  -
zfspool/kvm1  used                  1.57G                  -
zfspool/kvm1  available             1.76T                  -
zfspool/kvm1  referenced            1.57G                  -
zfspool/kvm1  compressratio         1.00x                  -
zfspool/kvm1  reservation           none                   default
zfspool/kvm1  volsize               50G                    local
zfspool/kvm1  volblocksize          8K                     -
zfspool/kvm1  checksum              on                     default
zfspool/kvm1  compression           off                    default
zfspool/kvm1  readonly              off                    default
zfspool/kvm1  copies                1                      default
zfspool/kvm1  refreservation        none                   default
zfspool/kvm1  primarycache          all                    default
zfspool/kvm1  secondarycache        all                    default
zfspool/kvm1  usedbysnapshots       8K                     -
zfspool/kvm1  usedbydataset         1.57G                  -
zfspool/kvm1  usedbychildren        0                      -
zfspool/kvm1  usedbyrefreservation  0                      -
zfspool/kvm1  logbias               latency                default
zfspool/kvm1  dedup                 off                    default
zfspool/kvm1  mlslabel              none                   default
zfspool/kvm1  sync                  standard               default
zfspool/kvm1  refcompressratio      1.00x                  -
zfspool/kvm1  written               8K                     -
zfspool/kvm1  snapdev               hidden                 default
</pre></div>
</div>
</div>
<div class="section" id="kvm">
<h2>KVM</h2>
<p>ZVOLをKVMのGuestOSに使ってみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install kvm virtinst virt-manager
% brctl addbr br1
% brctl addif br1 eth1
% ifconfig eth1 up
% ifconfig br1 up
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">VM_NAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">MEM</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">OS</span><span class="o">=</span><span class="nv">$4</span>

<span class="nv">DISKIMAGE</span><span class="o">=</span><span class="s2">"/dev/zvol/zfspool/$VM_NAME"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"centos"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># CentOS 6.4 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jaist.ac.jp/pub/Linux/CentOS/6.4/os/x86_64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"precise"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Ubuntu 12.04 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.riken.jp/Linux/ubuntu/dists/precise/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"squeeze"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Squeeze amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/squeeze/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"wheezy"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Wheezy amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/wheezy/main/installer-amd64/'</span>
<span class="k">fi</span>

virt-install --hvm --accelerate --nographics <span class="se">\</span>
  --name <span class="nv">$VM_NAME</span> <span class="se">\</span>
  --network <span class="nv">bridge</span><span class="o">=</span><span class="nv">$IFACE</span>,model<span class="o">=</span>virtio <span class="se">\</span>
  --ram <span class="nv">$MEM</span> <span class="se">\</span>
  --vcpus 1 <span class="se">\</span>
  --cpu core2duo <span class="se">\</span>
  --os-type linux <span class="se">\</span>
  --location <span class="nv">$DIST</span> <span class="se">\</span>
  --disk <span class="nv">path</span><span class="o">=</span><span class="nv">$DISKIMAGE</span>,bus<span class="o">=</span>virtio <span class="se">\</span>
  --extra-args<span class="o">=</span><span class="s1">'console=tty0 console=ttyS0,115200n8'</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vm-install.sh kvm1 1024 br1 wheezy

% ls -l /dev/zvol/zfspool/
total 0
lrwxrwxrwx 1 root root 10 Feb  6 12:37 disk2 -&gt; ../../zd16
lrwxrwxrwx 1 root root  9 Feb  6 12:12 kvm1 -&gt; ../../zd0
lrwxrwxrwx 1 root root 11 Feb  6 12:12 kvm1-part1 -&gt; ../../zd0p1
lrwxrwxrwx 1 root root 11 Feb  6 12:12 kvm1-part2 -&gt; ../../zd0p2
lrwxrwxrwx 1 root root 11 Feb  6 12:12 kvm1-part5 -&gt; ../../zd0p5
</pre></div>
</div>
<p>ZFSでスナップショットをとったりロールバックできる環境が出来上がった。LVM2やqemu-img(1)とおさらばヒャッハー。GuestOSを停止しないでロールバックしようとすると「devide busy」と怒られる。</p>
<div class="highlight-python"><div class="highlight"><pre>% zfs snapshot zfspool/kvm1@snap1
% zfs list -t snapshot
NAME                 USED  AVAIL  REFER  MOUNTPOINT
zfspool/kvm1@snap1   600K      -  1.57G  -

% zfs rollback zfspool/kvm1@snap1
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="https://pthree.org/2012/12/21/zfs-administration-part-xiv-zvols">https://pthree.org/2012/12/21/zfs-administration-part-xiv-zvols/</a></li>
</ul></div>]]></description>
            <category><![CDATA[ debian ]]></category>
             <pubDate>Thu, 06 Feb 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2014/02/05/debian_wheezy_zfs.html</link>
            <guid>http://127.0.0.1/blog/html/2014/02/05/debian_wheezy_zfs.html</guid>
            <title><![CDATA[ZFS on Linux (Debian wheezy)]]></title>
            <description><![CDATA[<h1>ZFS on Linux (Debian wheezy)</h1>
<p>LinuxでもZFSがいい感じで動くという話を聞いたので使ってみた。</p>
<div class="highlight-python"><div class="highlight"><pre>% uname -a
Linux hoge 3.2.0-4-amd64 #1 SMP Debian 3.2.51-1 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.3 (wheezy)
Release:        7.3
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% wget http://archive.zfsonlinux.org/debian/pool/main/z/zfsonlinux/zfsonlinux_2%7Ewheezy_all.deb
% dpkg -i zfsonlinux_2~wheezy_all.deb
% apt-get update
% apt-get install debian-zfs
</pre></div>
</div>
<p>2TBのHDDをRAID1してみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% parted /dev/sda -s "mklabel gpt"
% parted /dev/sdc -s "mklabel gpt"

% zpool create zfspool mirror sda sdc
% zpool list -v
NAME   SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
zfspool  1.81T   556K  1.81T     0%  1.00x  ONLINE  -
  mirror  1.81T   556K  1.81T         -
    sda      -      -      -         -
    sdc      -      -      -         -
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% zfs create zfspool/disk1
% zfs list
NAME            USED  AVAIL  REFER  MOUNTPOINT
zfspool         692K  1.78T   136K  /zfspool
zfspool/disk1   136K  1.78T   136K  /zfspool/disk1
</pre></div>
</div>
<p>ブロックデバイスとして見えたらKVMのGuestOS用のディスクとして使えると思うので、その辺を調べてみる。</p>
<ul class="simple"><li><a class="reference external" href="http://zfsonlinux.org/debian.html">http://zfsonlinux.org/debian.html</a></li>
<li><a class="reference external" href="http://sourceforge.jp/magazine/13/04/01/133000">http://sourceforge.jp/magazine/13/04/01/133000</a></li>
</ul>]]></description>
            <category><![CDATA[ debian ]]></category>
            <category><![CDATA[ zfs ]]></category>
             <pubDate>Wed, 05 Feb 2014 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/12/03/ubuntu_docker_ansible.html</link>
            <guid>http://127.0.0.1/blog/html/2013/12/03/ubuntu_docker_ansible.html</guid>
            <title><![CDATA[Ansibleを使ってみる]]></title>
            <description><![CDATA[<h1>Ansibleを使ってみる</h1>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/11/28/ubuntu_docker.html"><em>Dockerを使ってみる</em></a></li>
</ul><p>前回はDockerの使い方を調べたので、今回はDocker上のコンテナで巷で噂の<a class="reference external" href="http://www.ansibleworks.com">Ansible</a>を動かしてみる。</p>
<div class="section" id="id1">
<h2>コンテナ起動</h2>
<div class="highlight-python"><div class="highlight"><pre>% docker run -i -t -id --name test01 ubuntu:latest /bin/bash
% docker attach test01
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>コンテナイメージ作成</h2>
<div class="highlight-python"><div class="highlight"><pre>% lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 12.04 LTS
Release:        12.04
Codename:       precise
</pre></div>
</div>
<ul class="simple"><li>Python,SSHインストール</li>
<li>SSH公開鍵 設定</li>
<li>sudo設定</li>
</ul><p>起動したコンテナで上記の作業してコンテナイメージを作成する。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install python2.7 python2.7-dev openssh-server vim sudo wget ca-certificates

% mkdir /var/run/sshd
% cd /etc/ssh
% cp sshd_config sshd_config.org
% diff -u sshd_config.org sshd_config
--- sshd_config.org     2013-12-05 05:51:00.924484160 +0000
+++ sshd_config 2013-12-05 05:51:37.676483746 +0000
@@ -29,7 +29,7 @@

 RSAAuthentication yes
 PubkeyAuthentication yes
-#AuthorizedKeysFile    %h/.ssh/authorized_keys
+AuthorizedKeysFile     %h/.ssh/authorized_keys

 # Don't read the user's ~/.rhosts and ~/.shosts files
 IgnoreRhosts yes
@@ -84,4 +84,4 @@
 # If you just want the PAM account and session checks to run without
 # PAM authentication, then enable this but set PasswordAuthentication
 # and ChallengeResponseAuthentication to 'no'.
-UsePAM yes
+UsePAM no

% /usr/sbin/sshd

% useradd -m -s /bin/bash zinrai
% usermod -a -G sudo zinrai
% passwd zinrai

% su - zinrai
$ ssh-keygen
$ cd .ssh
$ cp id_rsa.pub authorized_keys
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% docker commit test01 ansible/test01
% docker run -i -t -d --name ansible01 ansible/test01 /bin/bash
% docker run -i -t -d --name ansible02 ansible/test01 /bin/bash
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h2>Ansible</h2>
<ul class="simple"><li><a class="reference external" href="http://www.ansibleworks.com">Ansible</a>はvirtualenv上で動かす。</li>
<li>–ask-sudo-passオプションが使えるようにsshpassをインストール</li>
</ul><div class="highlight-python"><div class="highlight"><pre>$ wget https://pypi.python.org/packages/source/v/virtualenv/virtualenv-1.10.1.tar.gz
$ tar zvxf virtualenv-1.10.1.tar.gz
$ python virtualenv-1.10.1/virtualenv.py ansible
$ source ansible/bin/activate
$ pip install ansible
$ pip freeze
pip freeze
Jinja2==2.7.1
MarkupSafe==0.18
PyYAML==3.10
ansible==1.4.1
argparse==1.2.1
ecdsa==0.10
paramiko==1.12.0
pycrypto==2.6.1
wsgiref==0.1.2
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/apt/source.list
deb http://archive.ubuntu.com/ubuntu precise main universe
deb-src http://archive.ubuntu.com/ubuntu/ precise main universe
deb http://archive.ubuntu.com/ubuntu/ precise-updates main universe
deb-src http://archive.ubuntu.com/ubuntu/ precise-updates main universe

% apt-get update
% apt-get install sshpass
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir playbook
$ cd playbook
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi hosts
[test]
172.17.0.10
172.17.0.11
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi setup.yml
---
- hosts: test
  remote_user: zinrai
  sudo: yes

  tasks:
  - name: Package Installed
    apt: pkg={{ item }} state=latest
    with_items:
    - less
    - perl-modules
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ ansible-playbook -i hosts setup.yml --ask-sudo-pass
sudo password:

PLAY [test] *******************************************************************

GATHERING FACTS ***************************************************************
ok: [172.17.0.10]
ok: [172.17.0.11]

TASK: [Package Installed] *****************************************************
changed: [172.17.0.10] =&gt; (item=less,perl-modules)
changed: [172.17.0.11] =&gt; (item=less,perl-modules)

PLAY RECAP ********************************************************************
172.17.0.10                : ok=2    changed=1    unreachable=0    failed=0
172.17.0.11                : ok=2    changed=1    unreachable=0    failed=0
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.ansibleworks.com/docs/playbooks.html">http://www.ansibleworks.com/docs/playbooks.html</a></li>
<li><a class="reference external" href="http://www.slideshare.net/takushimizu/ansible-26200860">http://www.slideshare.net/takushimizu/ansible-26200860</a></li>
</ul></div>]]></description>
            <category><![CDATA[ ansible ]]></category>
             <pubDate>Tue, 03 Dec 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/11/28/ubuntu_docker.html</link>
            <guid>http://127.0.0.1/blog/html/2013/11/28/ubuntu_docker.html</guid>
            <title><![CDATA[Dockerを使ってみる]]></title>
            <description><![CDATA[<h1>Dockerを使ってみる</h1>
<p><a class="reference external" href="https://www.dotcloud.com">dotcloud</a>がオープンソースで公開している<a class="reference external" href="http://docs.docker.io">Docker</a>というソフトウェアを知った。Linuxコンテナの実装の一つである<a class="reference external" href="http://linuxcontainers.org">LXC</a>を使いOSレベルの仮想化を行い、<a class="reference external" href="http://aufs.sourceforge.net">Aufs</a>で「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/10/debian_wheezy_chroot_aufs.html"><em>aufsを使ったchroot環境</em></a>」のようにベースファイルを書き換えずに、更新が発生した部分は別ディレクトリに書き込み、この差分をGitっぽく管理できるフロントエンドなのかなというのが触ってみた印象だった。</p>
<div class="highlight-python"><div class="highlight"><pre>$ uname -a
Linux asuna 3.8.0-33-generic #48~precise1-Ubuntu SMP Thu Oct 24 16:28:06 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux

$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 12.04.3 LTS
Release:        12.04
Codename:       precise
</pre></div>
</div>
<div class="section" id="id1">
<h2>Docker インストール</h2>
<div class="highlight-python"><div class="highlight"><pre>$ sudo apt-get update
$ sudo apt-get install linux-image-generic-lts-raring linux-headers-generic-lts-raring
$ sudo reboot

$ sudo sh -c "wget -qO- https://get.docker.io/gpg | apt-key add -"
$ sudo sh -c "echo deb http://get.docker.io/ubuntu docker main &gt; /etc/apt/sources.list.d/docker.list"
$ sudo apt-get update
$ sudo apt-get install lxc-docker
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ apt-cache search lxc-docker
lxc-docker - Linux container runtime
lxc-docker-0.5.3 - lxc-docker is a Linux container runtime
lxc-docker-0.6.0 - lxc-docker is a Linux container runtime
lxc-docker-0.6.1 - lxc-docker is a Linux container runtime
lxc-docker-0.6.2 - lxc-docker is a Linux container runtime
lxc-docker-0.6.3 - lxc-docker is a Linux container runtime
lxc-docker-0.6.4 - lxc-docker is a Linux container runtime
lxc-docker-0.6.5 - lxc-docker is a Linux container runtime
lxc-docker-0.6.6 - lxc-docker is a Linux container runtime
lxc-docker-0.6.7 - Linux container runtime
lxc-docker-0.7.0 - Linux container runtime
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ apt-cache show lxc-docker
Package: lxc-docker
Version: 0.7.0
License: unknown
Vendor:
Architecture: amd64
Maintainer: docker@dotcloud.com
Installed-Size: 0
Depends: lxc-docker-0.7.0
Homepage: http://www.docker.io/
Priority: extra
Section: default
Filename: pool/main/l/lxc-docker/lxc-docker_0.7.0_amd64.deb
Size: 1914
SHA256: c344f7f4a583b6bda2dcb1adab10b92580c260ed058b762c083230f7868c9ead
SHA1: 157a3335594693062b85887f0a0b34e8afe79f69
MD5sum: 96821dcce0250cc522dbee2e36263bc5
Description: Linux container runtime
 Docker complements LXC with a high-level API which operates at the process
 level. It runs unix processes with strong guarantees of isolation and
 repeatability across servers.
 Docker is a great building block for automating distributed systems:
 large-scale web deployments, database clusters, continuous deployment systems,
 private PaaS, service-oriented architectures, etc.
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>Docker 使い方</h2>
<div class="highlight-python"><div class="highlight"><pre>% docker -v
Docker version 0.7.0, build 0d078b6
</pre></div>
</div>
<div class="section" id="pull">
<h3>pull</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker pull ubuntu
Pulling repository ubuntu
8dbd9e392a96: Download complete
b750fe79269d: Download complete
27cf78414709: Download complete
</pre></div>
</div>
<p><a class="reference external" href="https://index.docker.io">https://index.docker.io/</a>で公開されているコンテナイメージを取得しローカルに展開</p>
</div>
<div class="section" id="images">
<h3>images</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker images
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              12.04               8dbd9e392a96        7 months ago        128 MB (virtual 128 MB)
ubuntu              latest              8dbd9e392a96        7 months ago        128 MB (virtual 128 MB)
ubuntu              precise             8dbd9e392a96        7 months ago        128 MB (virtual 128 MB)
ubuntu              12.10               b750fe79269d        8 months ago        175.3 MB (virtual 350.6 MB)
ubuntu              quantal             b750fe79269d        8 months ago        175.3 MB (virtual 350.6 MB)
</pre></div>
</div>
<p>コンテナイメージを一覧する。コンテナを作成する際に使用するベースイメージ(<a class="reference external" href="http://aufs.sourceforge.net">Aufs</a>で重ね、書き変わらない部分)。</p>
</div>
<div class="section" id="run">
<h3>run</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker run -i -t -d --name ubuntu01 ubuntu:12.04 /bin/bash
% docker run -i -t -d --name ubuntu02 ubuntu:12.04 /bin/bash
% docker run -i -t -d --name ubuntu03 ubuntu:12.04 /bin/bash
% docker run -i -t -d -p 80 --name ubuntu04 ubuntu:12.04 /bin/bash
% docker run -i -t -d -p 80 -p 22 --name ubuntu05 ubuntu:12.04 /bin/bash
</pre></div>
</div>
<p>新規にコンテナを作成し起動する。start,stopというコマンドもあるが、これは作成したコンテナを起動・停止するために使用する。</p>
</div>
<div class="section" id="ps">
<h3>ps</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS                                          NAMES
1734fac49073        ubuntu:12.04        /bin/bash           51 seconds ago      Up 51 seconds       0.0.0.0:49159-&gt;22/tcp, 0.0.0.0:49160-&gt;80/tcp   ubuntu05
e54ec245fe2a        ubuntu:12.04        /bin/bash           2 minutes ago       Up 2 minutes        0.0.0.0:49158-&gt;80/tcp                          ubuntu04
fe54b9318dba        ubuntu:12.04        /bin/bash           8 hours ago         Up 8 hours                                                         ubuntu03
46d0ef544132        ubuntu:12.04        /bin/bash           8 hours ago         Up 8 hours                                                         ubuntu02
8fcfa5265233        ubuntu:12.04        /bin/bash           8 hours ago         Up 8 hours                                                         ubuntu01
</pre></div>
</div>
<ul class="simple"><li>「-a」オプションで停止中のコンテナの情報を表示できる。</li>
<li>「-q」オプションでコンテナIDのみを表示できる。</li>
</ul></div>
<div class="section" id="attach">
<h3>attach</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker attach ubuntu01
</pre></div>
</div>
<p>起動しているコンテナにアッタッチする。「Ctrl-p Ctrl-q」でデタッチ</p>
</div>
<div class="section" id="start">
<h3>start</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker start ubuntu05
</pre></div>
</div>
<p>停止しているコンテナを起動する。</p>
</div>
<div class="section" id="stop">
<h3>stop</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker stop ubuntu05
</pre></div>
</div>
<p>起動しているコンテナを停止する。</p>
</div>
<div class="section" id="commit">
<h3>commit</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker commit ubuntu02 python/ubuntu02
% docker run -i -t -d --name ubuntu06 python/ubuntu02 /bin/bash
</pre></div>
</div>
<p>変更を加えたコンテナからコンテナイメージを作成したい場合に使用する。例えば、コンテナにpythonをインストールし、commitすると、python入りのコンテナイメージが作られる。作ったコンテナイメージでrunすればpython入りコンテナが新たに起動する。</p>
</div>
<div class="section" id="rm">
<h3>rm</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker rm ubuntu05
</pre></div>
</div>
<p>コンテナを削除する。</p>
</div>
<div class="section" id="rmi">
<h3>rmi</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker rmi python/ubuntu02
</pre></div>
</div>
<p>コンテナイメージを削除する。</p>
</div>
<div class="section" id="export">
<h3>export</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker export ubuntu02 &gt; ubuntu02.tar
</pre></div>
</div>
<p>コンテナはtarでアーカイブすることができる。</p>
</div>
<div class="section" id="import">
<h3>import</h3>
<div class="highlight-python"><div class="highlight"><pre>% docker import http://exsample.com/ubuntu02.tar ubuntu02
% cat ubuntu02.tar | docker import - ubuntu02:new
</pre></div>
</div>
<p>アーカイブは他の<a class="reference external" href="http://docs.docker.io">Docker</a>にimportすることができる。「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/07/debian_wheezy_pxeboot.html"><em>シェルスクリプトでDebian wheezyのインストール自動化</em></a>」を使って実機やKVMなどの仮想マシンにも展開できそう。</p>
<p>環境を手軽に作れて差分で新たな環境を作ったりできてすごく便利。次は作成したコンテナでなにか動かしてみたいと思う。</p>
<ul class="simple"><li><a class="reference external" href="https://index.docker.io">https://index.docker.io/</a></li>
<li><a class="reference external" href="http://docs.docker.io/en/latest/commandline/cli">http://docs.docker.io/en/latest/commandline/cli/</a></li>
<li><a class="reference external" href="http://docs.docker.io/en/latest/installation/ubuntulinux/ubuntu_docker.html#ubuntu-precise">http://docs.docker.io/en/latest/installation/ubuntulinux/#ubuntu-precise</a></li>
<li><a class="reference external" href="http://www.infoq.com/jp/articles/docker-containers">http://www.infoq.com/jp/articles/docker-containers</a></li>
</ul></div>
</div>]]></description>
            <category><![CDATA[ docker ]]></category>
             <pubDate>Thu, 28 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/11/25/fabric_template_upload.html</link>
            <guid>http://127.0.0.1/blog/html/2013/11/25/fabric_template_upload.html</guid>
            <title><![CDATA[Fabric テンプレート アップロード]]></title>
            <description><![CDATA[<h1>Fabric テンプレート アップロード</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/11/22/fabric_decorators_task.html"><em>Fabric decorators task</em></a>」でディストリビューションやOSごとにファイルを分割してタスクを書けるようにした。今回はインストールスルクリプトをテンプレート化してアップロードするタスクを書いてみる。</p>
<div class="highlight-python"><div class="highlight"><pre>$ vi __init__.py
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fabric.api</span> <span class="kn">import</span> <span class="n">env</span>
<span class="kn">from</span> <span class="nn">fabric.decorators</span> <span class="kn">import</span> <span class="n">task</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">debian</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">centos</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">gentoo</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">freebsd</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">server</span><span class="p">():</span>
  <span class="n">env</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s">'192.168.0.1'</span><span class="p">]</span>
  <span class="n">env</span><span class="o">.</span><span class="n">port</span> <span class="o">=</span> <span class="mi">22</span>
  <span class="n">env</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="s">'root'</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi debian.py
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">fabric.decorators</span> <span class="kn">import</span> <span class="n">task</span>
<span class="kn">from</span> <span class="nn">fabric.contrib.files</span> <span class="kn">import</span> <span class="n">upload_template</span>

<span class="nd">@task</span>
<span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="n">macaddress</span><span class="p">,</span> <span class="n">disk</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">ipaddress</span><span class="p">,</span> <span class="n">netmask</span><span class="p">,</span> <span class="n">gateway</span><span class="p">,</span>
    <span class="n">source_template</span><span class="p">,</span> <span class="n">dest_template</span><span class="p">):</span>

    <span class="n">upload_template</span><span class="p">(</span>
      <span class="n">source_template</span><span class="p">,</span>
      <span class="n">dest_template</span><span class="p">,</span>
      <span class="n">context</span><span class="o">=</span><span class="p">{</span>
        <span class="s">'macaddress'</span><span class="p">:</span> <span class="n">macaddress</span><span class="p">,</span>
        <span class="s">'disk'</span><span class="p">:</span> <span class="n">disk</span><span class="p">,</span>
        <span class="s">'hostname'</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span>
        <span class="s">'ipaddress'</span><span class="p">:</span> <span class="n">ipaddress</span><span class="p">,</span>
        <span class="s">'netmask'</span><span class="p">:</span> <span class="n">netmask</span><span class="p">,</span>
        <span class="s">'gateway'</span><span class="p">:</span> <span class="n">gateway</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="n">use_jinja</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
    <span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir templates
$ vi templates/debian_template.conf
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash -x</span>

<span class="c"># {{ macaddress }}</span>

<span class="nv">DISK</span><span class="o">=</span>/dev/<span class="o">{{</span> disk <span class="o">}}</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">CWD</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">CHROOT_DEBIAN</span><span class="o">=</span><span class="s2">"/mnt/$3"</span>

dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$DISK</span> <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>1

parted <span class="nv">$DISK</span> -s <span class="s1">'mklabel msdos'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart primary 1 500'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart primary 501 35000'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart extended 35001 -0'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart logical 35001 38000'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart logical 38001 -0'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'set 1 boot on'</span>

mkswap <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>5
swapon <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>5
mkfs.ext2 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>1
mkfs.ext4 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>2
mkfs.ext4 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>6

mkdir <span class="nv">$CHROOT_DEBIAN</span>

mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>2 <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>

cp -Rp <span class="k">${</span><span class="nv">CWD</span><span class="k">}</span>/wheezy/* <span class="nv">$CHROOT_DEBIAN</span>

mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>1 <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/boot
mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>6 <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/home

mount --rbind /dev <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/dev
mount -t proc none <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/proc
mount --rbind /sys <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/sys

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/hostname</span>
<span class="s">{{ hostname }}</span>
<span class="s">EOF</span>


cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/resolv.conf</span>
<span class="s">nameserver 8.8.8.8</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/network/interfaces</span>
<span class="s">auto lo</span>
<span class="s">iface lo inet loopback</span>

<span class="s">auto eth0</span>
<span class="s">iface eth0 inet static</span>
<span class="s">address {{ ipaddress }}</span>
<span class="s">netmask {{ netmask }}</span>
<span class="s">gateway {{ gateway }}</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/fstab</span>
<span class="s">${DISK}1               /boot           ext2            defaults        0 2</span>
<span class="s">${DISK}2               /               ext4            defaults        0 1</span>
<span class="s">${DISK}6               /home           ext4            defaults        0 2</span>
<span class="s">${DISK}5               none            swap            sw              0 0</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/tmp/debian_setup.sh</span>
<span class="s">export DEBIAN_FRONTEND=noninteractive</span>
<span class="s">cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime</span>
<span class="s">grep -v rootfs /proc/mounts &gt; /etc/mtab</span>

<span class="s">apt-get install -y linux-image-`uname -r` grub2 openssh-server</span>

<span class="s">grub-mkconfig -o /boot/grub/grub.cfg</span>
<span class="s">grub-install --no-floppy --root-directory=/ $DISK</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; 'EOF' &gt; ${CHROOT_DEBIAN}/tmp/user_acount.sh</span>
<span class="s">useradd -m -G sudo nanashi</span>
<span class="s">printf 'nanashi:$6$oHUVG9WPkdiCoxCP$XsnO5TmowzdGWNkZHv9pPUmFqgsEojkfzUa1OQj2zUOWAChL5cdGkm.dhseF0z5Tz30IEDrxNzOcsflPUgHDs.' | chpasswd -e</span>
<span class="s">printf 'root:$6$wAeDl/exZFEDC0Sl$UdvTamL.94EcWFcGIAYJSgsvzaFxSd.ZLRMkD.KI27L6jxUGsWqOdEJs6if0rTG/XuEfQ9TNzHbjI99YfxPLD1' | chpasswd -e</span>
<span class="s">EOF</span>

chroot <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span> /bin/bash /tmp/debian_setup.sh
chroot <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span> /bin/bash /tmp/user_acount.sh

rm <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/tmp/debian_setup.sh
rm <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/tmp/user_acount.sh

<span class="nb">cd</span> /
umount -l <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/<span class="o">{</span>boot,home,proc,dev,sys<span class="o">}</span>
umount -l <span class="nv">$CHROOT_DEBIAN</span>
sleep 2
rmdir <span class="nv">$CHROOT_DEBIAN</span>
reboot
</pre></div>
</div>
<p>Pythonのweb frameworkのひとつ<a class="reference external" href="http://flask.pocoo.org">Flask</a>に使用されているテンプレートエンジン<a class="reference external" href="http://jinja.pocoo.org">Jinja</a>が、Fabricでも使えるようなのでuse_jinja=Trueして使うことにする。{{ hoge }}で囲まれた部分が変数展開される。</p>
<div class="highlight-python"><div class="highlight"><pre>$ fab -l
Available commands:

    server
    centos.cmd
    debian.upload
    freebsd.cmd
    gentoo.cmd
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ fab server debian.upload:macaddress="01:23:45:67:89:ab",disk="vda",hostname="hoge.localnet",ipaddress="192.168.0.50",netmask="255.255.255.0",gateway="192.168.0.254",source_template="templates/debian_template.conf",dest_template="/var/diskless/scripts/debian_template.conf"
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://docs.fabfile.org/en/1.8/api/contrib/files.html">http://docs.fabfile.org/en/1.8/api/contrib/files.html</a></li>
<li><a class="reference external" href="http://docs.fabfile.org/en/1.8/usage/fab.html#task-arguments">http://docs.fabfile.org/en/1.8/usage/fab.html#task-arguments</a></li>
<li><a class="reference external" href="https://speakerdeck.com/drillbits/fabric-python-developers-festa-2013-dot-03-number-pyfes">https://speakerdeck.com/drillbits/fabric-python-developers-festa-2013-dot-03-number-pyfes</a></li>
</ul>]]></description>
            <category><![CDATA[ fabric ]]></category>
             <pubDate>Mon, 25 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/11/22/fabric_decorators_task.html</link>
            <guid>http://127.0.0.1/blog/html/2013/11/22/fabric_decorators_task.html</guid>
            <title><![CDATA[Fabric decorators task]]></title>
            <description><![CDATA[<h1>Fabric decorators task</h1>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html"><em>シェルスクリプトでFreeBSD 9.1のインストール自動化</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/07/debian_wheezy_pxeboot.html"><em>シェルスクリプトでDebian wheezyのインストール自動化</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/08/gentoo_install_script.html"><em>Gentoo Linux インストールスクリプト</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/10/24/debian_wheezy_dnsmasq_proxy_dhcp.html"><em>Proxy DHCPを使ったディスクレスブート環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/10/26/centos_diskless.html"><em>CentOS ディスクレスブートサーバ構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/11/01/freebsd_mfsbsd.html"><em>virtioを組み込んだmfsBSDイメージ作成</em></a></li>
</ul><p>シェルスクリプトでLinuxをインストールする環境はできたが、サーバに接続してシェルスクリプトをコピー・編集するという状態である。Fabricを使いこの作業をホストから行えるようにしてみる。fabfile.pyひとつにタスクを書いていくのではなくディストリビューションやOSごとにファイルを分割してタスクを書いていく。</p>
<div class="highlight-python"><div class="highlight"><pre>$ python -V
Python 2.7.3

$ fab --version
Fabric 1.8.0
Paramiko 1.12.0
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir fabfile
$ cd fabfile
$ touch __init__.py centos.py debian.py freebsd.py gentoo.py
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi __init__.py

from . import debian
from . import centos
from . import gentoo
from . import freebsd
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi centos.py

from fabric.decorators import task

@task
def cmd():
    pass
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi debian.py

from fabric.decorators import task

@task
def cmd():
    pass
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi gentoo.py

from fabric.decorators import task

@task
def cmd():
    pass
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi freebsd.py

from fabric.decorators import task

@task
def cmd():
    pass
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ fab -l
Available commands:

    centos.cmd
    debian.cmd
    freebsd.cmd
    gentoo.cmd
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://docs.fabfile.org/en/1.8">http://docs.fabfile.org/en/1.8/</a></li>
<li><a class="reference external" href="http://docs.fabfile.org/en/1.8/api/core/decorators.html">http://docs.fabfile.org/en/1.8/api/core/decorators.html</a></li>
<li><a class="reference external" href="https://speakerdeck.com/drillbits/fabric-python-developers-festa-2013-dot-03-number-pyfes">https://speakerdeck.com/drillbits/fabric-python-developers-festa-2013-dot-03-number-pyfes</a></li>
</ul>]]></description>
            <category><![CDATA[ fabric ]]></category>
             <pubDate>Fri, 22 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/11/01/freebsd_mfsbsd.html</link>
            <guid>http://127.0.0.1/blog/html/2013/11/01/freebsd_mfsbsd.html</guid>
            <title><![CDATA[virtioを組み込んだmfsBSDイメージ作成]]></title>
            <description><![CDATA[<h1>virtioを組み込んだmfsBSDイメージ作成</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html"><em>シェルスクリプトでFreeBSD 9.1のインストール自動化</em></a>」だとFreeBSD母艦が必要になるので、どうにかして<a class="reference external" href="http://www.syslinux.org/wiki/index.php/The_Syslinux_Project">Syslinux</a>にまとめられないか調べてみたところ<a class="reference external" href="http://mfsbsd.vx.sk">mfsBSD</a>というものを見付けた。今回は「9.1-RELEASE」のmfsBSDを作成した。</p>
<div class="section" id="mfsbsd">
<h2>mfsBSDイメージ作成</h2>
<div class="highlight-python"><div class="highlight"><pre>% fetch http://mfsbsd.vx.sk/release/mfsbsd-2.1.tar.gz
% tar zvxf mfsbsd-2.1.tar.gz
% cd mfsbsd-2.1/conf
% cp rc.conf.sample rc.conf
% cp rc.local.sample rc.local
% cp loader.conf.sample loader.conf
% cd ..
% mkdir freebsd91
% cd freebsd91
% fetch http://ftp.jaist.ac.jp/pub/FreeBSD/releases/amd64/9.1-RELEASE/base.txz
% fetch http://ftp.jaist.ac.jp/pub/FreeBSD/releases/amd64/9.1-RELEASE/kernel.txz
% cd ..
% make RELEASE=9.1-RELEASE BASE=/path/freebsd91

% ls *.img
mfsbsd-9.1-RELEASE-amd64.img
</pre></div>
</div>
<p><a class="reference external" href="http://mfsbsd.vx.sk">mfsBSD</a>のMakefileを眺めてみると「RELEASE」オプションを付けない場合、生成されるイメージファイル名にuname(1)が使われる。「RELEASE」オプションを付けてないとホストが「9.2-RELEASE」「10-CURRENT」のとき「9.1-RELEASE」のイメージファイルを作成するとホストのversionの付いたファイル名でイメージファイルが生成される。</p>
<p>VirtIOを有効にしている仮想環境でも<a class="reference external" href="http://mfsbsd.vx.sk">mfsBSD</a>を使えるようにしてみる。VirtIOのバイナリを作るのが面倒だったので配布されていないか調べてみたら見付けた。</p>
<div class="highlight-python"><div class="highlight"><pre>% mkdir virtio
% cd virtio
% fetch http://people.freebsd.org/~kuriyama/virtio/9.1/virtio-kmod-9.1-0.250249.tbz
% tar Jxf virtio-kmod-9.1-0.250249.tbz
</pre></div>
</div>
<p>「BOOTMODULES」変数にモジュールをスペース区切り書いておけばイメージファイル作成時にモジュールが組込まれる。VirtIOモジュールのほうはkernel.txzを展開し、boot/kernelにコピーして再度圧縮しておく。</p>
<div class="highlight-python"><div class="highlight"><pre>% cd /path/freebsd91
% tar zxpf kernel.txz

% cd /path/virtio/boot/modules
% cp `ls` /path/freebsd91/boot/kernel

% cd /path/freebsd91
% tar Jcvf kernel.txz boot
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% diff -u Makefile Makefile.org
--- Makefile    2013-11-01 12:43:34.000000000 +0900
+++ Makefile.org        2013-11-01 01:34:12.000000000 +0900
@@ -73,7 +73,7 @@
 #
 DOFS=${TOOLSDIR}/doFS.sh
 SCRIPTS=mdinit mfsbsd interfaces packages
-BOOTMODULES=acpi ahci virtio virtio_pci virtio_blk virtio_balloon if_vtnet
+BOOTMODULES=acpi ahci
 MFSMODULES=geom_mirror geom_nop opensolaris zfs ext2fs snp smbus ipmi ntfs nullfs tmpfs
 #
</pre></div>
</div>
</div>
<div class="section" id="syslinux">
<h2>Syslinux</h2>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/10/24/debian_wheezy_dnsmasq_proxy_dhcp.html"><em>Proxy DHCPを使ったディスクレスブート環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/10/26/centos_diskless.html"><em>CentOS ディスクレスブートサーバ構築</em></a></li>
</ul><p>これでDebian,CentOS,FreeBSDのディスクレスブート環境が出来上がった。</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /path/pxelinux.cfg/default

default menu.c32
label FreeBSD 9.1
kernel memdisk
append initrd=mfsbsd-9.1-RELEASE-amd64.img harddisk
</pre></div>
</div>
<p>9.2-RELEASEからVirtIOは標準で入っている。VirtIOを使いたければ、設定をloader.confに書くだけ。シェルスクリプトには下記のような変更を加えておけばいい。</p>
<div class="highlight-python"><div class="highlight"><pre>% diff -u freebsd_install.conf freebsd_virtio.conf
--- freebsd_install.conf        2013-11-01 18:05:26.993246593 +0900
+++ freebsd_virtio.conf 2013-11-01 17:48:52.725299517 +0900
@@ -1,8 +1,8 @@
 #!/bin/sh -x

-# 01:23:45:67:89:ab
+# 01:23:45:67:89:cd

-DISK=ada0
+DISK=vtbd0
 IFACE=$1
 CWD=$2
 CHROOT_FREEBSD="/mnt/$3"
@@ -27,8 +27,16 @@
   tar xfzp $FILE
 done

+cat &lt;&lt; EOF &gt; ${CHROOT_FREEBSD}/boot/loader.conf
+virtio_load="YES"
+virtio_pci_load="YES"
+virtio_blk_load="YES"
+if_vtnet_load="YES"
+virtio_balloon_load="YES"
+EOF
+
 cat &lt;&lt; EOF &gt; ${CHROOT_FREEBSD}/etc/rc.conf
-hostname="freebsd-install.local"
+hostname="freebsd-virtio.local"
 keymap="us.iso.kbd"
 ifconfig_${IFACE}=" inet 192.168.2.200 netmask 255.255.255.0"
 defaultrouter="192.168.2.254"
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://mfsbsd.vx.sk">http://mfsbsd.vx.sk/</a></li>
<li><a class="reference external" href="http://people.freebsd.org/~kuriyama/virtio">http://people.freebsd.org/~kuriyama/virtio/</a></li>
</ul></div>]]></description>
            <category><![CDATA[ mfsbsd ]]></category>
             <pubDate>Fri, 01 Nov 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/10/26/centos_diskless.html</link>
            <guid>http://127.0.0.1/blog/html/2013/10/26/centos_diskless.html</guid>
            <title><![CDATA[CentOS ディスクレスブートサーバ構築]]></title>
            <description><![CDATA[<h1>CentOS ディスクレスブートサーバ構築</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/10/24/debian_wheezy_dnsmasq_proxy_dhcp.html"><em>Proxy DHCPを使ったディスクレスブート環境構築</em></a>」にCentOSのディスクレスブート環境を追加してみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% cat /etc/centos-release
CentOS release 6.4 (Final)

% uname -a
Linux localhost.localdomain 2.6.32-358.23.2.el6.x86_64 #1 SMP Wed Oct 16 18:37:12 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% yum groupinstall --releasever=6 --installroot=/var/diskless/centos6  Base -y
% yum upgrade --releasever=6 --installroot=/var/diskless/centos6 -y
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% mount --rbind /dev /var/diskless/centos6/dev
% cd /var/diskless/centos6
% cp usr/share/zoneinfo/Asia/Tokyo etc/localtime
% chroot /var/diskless/centos6 passwd
% chroot /var/diskless/centos6 yum -y install kernel

% vi /var/diskless/centos6/etc/fstab
none    /tmp        tmpfs   defaults   0 0
tmpfs   /dev/shm    tmpfs   defaults   0 0
sysfs   /sys        sysfs   defaults   0 0
proc    /proc       proc    defaults   0 0

% vi /var/diskless/centos6/etc/resolv.conf
nameserver 8.8.8.8
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% yum -y install dracut-network
% dracut initramfs-`uname -r`.img
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/exports
/var/diskless/centos6 192.168.2.0/24(rw,sync,no_root_squash,no_all_squash)

% service rpcbind start
% service nfslock start
% service nfs start
</pre></div>
</div>
<p>あとはブートメニューにCentOSを追加するだけ。</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /var/diskless/pxelinux.cfg/default
default menu.c32
label Debian wheezy
kernel vmlinuz-3.2.0-4-amd64
append initrd=initrd.img-3.2.0-4-amd64 root=/dev/nfs ip=dhcp nfsroot=192.168.2.100:/var/diskless/wheezy rw

label CentOS 6.4
kernel vmlinuz-2.6.32-358.23.2.el6.x86_64
append initrd=initramfs-2.6.32-358.23.2.el6.x86_64.img root=nfs:192.168.2.101:/var/diskless/centos6 rw
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.server-world.info/query?os=CentOS_6&amp;p=pxe&amp;f=4">http://www.server-world.info/query?os=CentOS_6&amp;p=pxe&amp;f=4</a></li>
</ul>]]></description>
            <category><![CDATA[ centos ]]></category>
             <pubDate>Sat, 26 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/10/25/gentoo_emerge_sync_local_mirror.html</link>
            <guid>http://127.0.0.1/blog/html/2013/10/25/gentoo_emerge_sync_local_mirror.html</guid>
            <title><![CDATA[Gentoo Linux rsync ロカールミラー]]></title>
            <description><![CDATA[<h1>Gentoo Linux rsync ロカールミラー</h1>
<p>Gentoo Linuxマシンを複数台動かしている場合、それぞれのGentooマシンからemerge –syncするとリモートのミラーサーバに負荷が掛かるのでローカルにミラーサーバを構築し参照するようにした。</p>
<div class="section" id="id1">
<h2>サーバ</h2>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/crontab
0 23 * * * root emerge-webrsync
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/rsyncd.conf
# /etc/rsyncd.conf

# Minimal configuration file for rsync daemon
# See rsync(1) and rsyncd.conf(5) man pages for help

# This line is required by the /etc/init.d/rsyncd script
pid file = /var/run/rsyncd.pid
use chroot = yes
read only = yes
hosts allow = 192.168.2.0/24

# Simple example for enabling your own local rsync server
[gentoo-portage]
        path = /usr/portage
        comment = Gentoo Portage tree
        exclude = /distfiles /packages
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% /etc/init.d/rsyncd start
% rc-update add rsyncd default
</pre></div>
</div>
</div>
<div class="section" id="id2">
<h2>クライアント</h2>
<div class="highlight-python"><div class="highlight"><pre>% rsync 192.168.2.1::
gentoo-portage  Gentoo Portage tree

% rsync 192.168.2.1::gentoo-portage | head
drwxr-xr-x        4096 2013/10/25 10:30:12 .
-rw-r--r--         121 2013/01/01 09:31:01 header.txt
-rw-r--r--        3658 2013/01/01 09:31:01 skel.ChangeLog
-rw-r--r--        8147 2013/01/01 09:31:01 skel.ebuild
-rw-r--r--        1232 2013/03/06 06:31:01 skel.metadata.xml
drwxr-xr-x        4096 2013/10/17 09:31:02 app-accessibility
drwxr-xr-x       12288 2013/10/17 09:31:02 app-admin
drwxr-xr-x        4096 2013/10/17 09:31:02 app-antivirus
drwxr-xr-x        4096 2013/10/25 06:01:12 app-arch
drwxr-xr-x        4096 2013/10/25 06:01:13 app-backup
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/portage/make.conf
SYNC="rsync://192.168.2.1/gentoo-portage"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% emerge --sync
</pre></div>
</div>
</div>]]></description>
            <category><![CDATA[ gentoo ]]></category>
             <pubDate>Fri, 25 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/10/24/debian_wheezy_dnsmasq_proxy_dhcp.html</link>
            <guid>http://127.0.0.1/blog/html/2013/10/24/debian_wheezy_dnsmasq_proxy_dhcp.html</guid>
            <title><![CDATA[Proxy DHCPを使ったディスクレスブート環境構築]]></title>
            <description><![CDATA[<h1>Proxy DHCPを使ったディスクレスブート環境構築</h1>
<p>Proxy DHCPを使ってDHCPサーバとネットワークブートサーバを切り離し、ディスクレスブート環境を構築してみる。</p>
<p>DHCPサーバ,Proxy DHCPともにdnsmasq、OSはDebian wheezyを使用する。</p>
<div class="highlight-python"><div class="highlight"><pre>% lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.2 (wheezy)
Release:        7.2
Codename:       wheezy
</pre></div>
</div>
<div class="section" id="dhcp">
<h2>DHCPサーバ</h2>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install dnsmasq
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/dnsmasq.d/dhcp.conf
dhcp-range=192.168.2.230,192.168.2.253,2h
dhcp-option=3,192.168.2.254
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% service dnsmasq restart
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Proxy DHCP</h2>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install dnsmasq
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/dnsmasq.d/pxe.conf
dhcp-range=192.168.2.0,proxy
pxe-service=x86PC, "os install", pxelinux
enable-tftp
tftp-root=/var/diskless
</pre></div>
</div>
</div>
<div class="section" id="diskless-boot">
<h2>Diskless Boot</h2>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install syslinux nfs-kernel-server debootstrap
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% debootstrap stable /var/diskless/wheezy http://ftp.jp.debian.org/debian
% chroot /var/diskless/Wheezy passwd root
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/exports
/var/diskless/wheezy 192.168.2.0/24(rw,no_root_squash,no_subtree_check)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% mkdir /var/diskless
% cp /usr/lib/syslinux/menu.c32 /var/diskless
% cp /usr/lib/syslinux/pxelinux.0 /var/diskless
% cp /boot/initrd* /var/diskless
% cp /boot/vmlinuz* /var/diskless
% mkdir /var/diskless/pxelinux.cfg
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /var/diskless/pxelinux.cfg/default
default menu.c32
label Debian Wheezy
kernel vmlinuz-3.2.0-4-amd64
append initrd=initrd.img-3.2.0-4-amd64 root=/dev/nfs ip=dhcp nfsroot=192.168.2.100:/var/diskless/wheezy rw
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% service dnsmasq restart
% service nfs-kernel-server restart
</pre></div>
</div>
</div>]]></description>
            <category><![CDATA[ dnsmasq ]]></category>
             <pubDate>Thu, 24 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/10/22/debian_wheezy_openvswitch_bridge.html</link>
            <guid>http://127.0.0.1/blog/html/2013/10/22/debian_wheezy_openvswitch_bridge.html</guid>
            <title><![CDATA[Open vSwitchを使ってみる]]></title>
            <description><![CDATA[<h1>Open vSwitchを使ってみる</h1>
<p>bridgeをOpen vSwitchに変えてみた。</p>
<div class="highlight-python"><div class="highlight"><pre>% lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.2 (wheezy)
Release:        7.2
Codename:       wheezy
</pre></div>
</div>
<div class="section" id="bridge">
<h2>bridge停止</h2>
<div class="highlight-python"><div class="highlight"><pre>% service networking stop

% brctl delif br0 eth0
% brctl delif br1 eth1
% brctl delbr br0
% brctl delbr br1

% modprobe -r bridge
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Open vSwitch インストール</h2>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install -y openvswitch-switch openvswitch-datapath-source openvswitch-brcompat module-assistant
% module-assistant auto-install openvswitch-datapath-source
% modprobe openvswitch_mod
% modprobe brcompat_mod
% service openvswitch-switch start
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/default/openvswitch-switch
BRCOMPAT=yes
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/modules
openvswitch_mod
brcompat_mod
</pre></div>
</div>
</div>
<div class="section" id="open-vswitch-bridge">
<h2>Open vSwitch bridge設定</h2>
<div class="highlight-python"><div class="highlight"><pre>% ovs-vsctl add-br br0
% ovs-vsctl add-br br1
% ovs-vsctl add-port br0 eth0
% ovs-vsctl add-port br1 eth1
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% ovs-vsctl show
2a8eb1c3-4273-42b3-9f84-108918d53d15
    Bridge "br0"
        Port "eth0"
            Interface "eth0"
        Port "br0"
            Interface "br0"
                type: internal
    Bridge "br1"
        Port "eth1"
            Interface "eth1"
        Port "br1"
            Interface "br1"
                type: internal
    ovs_version: "1.4.2"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/network/interfaces
auto eth0
iface eth0 inet manual
  up /sbin/ifconfig eth0 up
  down /sbin/ifconfig eth0 down

auto eth1
iface eth1 inet manual
  up /sbin/ifconfig eth1 up
  down /sbin/ifconfig eth1 down
</pre></div>
</div>
</div>
<div class="section" id="libvirt">
<h2>libvirt</h2>
<p>openvswitch-brcompat使わず仮想マシンをOpen vSwitchのbridgeに接続するには、&lt;virtualport type=’openvswitch’&gt;を追加する。</p>
<div class="highlight-python"><div class="highlight"><pre>% libvirtd --version
libvirtd (libvirt) 0.9.12
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% virsh edit vm01
&lt;interface type='bridge'&gt;
      &lt;source bridge='br1'/&gt;
      &lt;virtualport type='openvswitch'&gt;
      &lt;model type='virtio'/&gt;
&lt;/interface&gt;
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://libvirt.org/formatnetwork.html">http://libvirt.org/formatnetwork.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ openvswitch ]]></category>
             <pubDate>Tue, 22 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/10/17/freebsd_supervisor_uwsgi.html</link>
            <guid>http://127.0.0.1/blog/html/2013/10/17/freebsd_supervisor_uwsgi.html</guid>
            <title><![CDATA[Supervisorを使ってuWSGIを管理]]></title>
            <description><![CDATA[<h1>Supervisorを使ってuWSGIを管理</h1>
<p>uWSGIのプロセスをSupervisorを使って管理してみる。</p>
<div class="highlight-python"><div class="highlight"><pre>% uname -a
FreeBSD uwsgi.localnet 9.2-RELEASE FreeBSD 9.2-RELEASE #0 r256370: Sat Oct 12 22:47:21 JST 2013

% python -V
Python 2.7.5

% supervisord -v
3.0b1

% uwsgi --version
1.9.18.1
</pre></div>
</div>
<div class="section" id="uwsgi">
<h2>uWSGI</h2>
<div class="highlight-python"><div class="highlight"><pre>% vi /path/app/dev.ini

[uwsgi]
http = :9090
workers = 3
virtualenv = /path/test
python-path = /path/app
wsgi = sample
callable = app
uid = www
gid = www
pidfile = /path/app/uwsgi.pid
logto = /path/app/uwsgi.log
log-format = %(addr) - %(user) [%(ltime)] "%(method) %(uri) %(proto)" %(status) %(size)`` "%(referer)" "%(uagent)"
</pre></div>
</div>
</div>
<div class="section" id="supervisor">
<h2>Supervisor</h2>
<div class="highlight-python"><div class="highlight"><pre>% cd /usr/local/etc
% grep -v "^;" supervisord.conf.sample &gt; supervisord.conf
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /usr/local/etc/supervisord.conf

[unix_http_server]
file=/var/run/supervisor/supervisor.sock   ; (the path to the socket file)

[supervisord]
logfile=/var/log/supervisord.log ; (main log file;default $CWD/supervisord.log)
logfile_maxbytes=50MB       ; (max main logfile bytes b4 rotation;default 50MB)
logfile_backups=10          ; (num of main logfile rotation backups;default 10)
loglevel=info               ; (log level;default info; others: debug,warn,trace)
pidfile=/var/run/supervisor/supervisord.pid ; (supervisord pidfile;default supervisord.pid)
nodaemon=false              ; (start in foreground if true;default false)
minfds=1024                 ; (min. avail startup file descriptors;default 1024)
minprocs=200                ; (min. avail process descriptors;default 200)

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor/supervisor.sock ; use a unix:// URL  for a unix socket

[include]
files = /usr/local/etc/supervisord.d/*.ini
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /usr/local/etc/supervisord.d/uwsgi.ini

[program:uwsgi]
command = /path/bin/uwsgi /path/app/dev.ini
stopasgroup = true
</pre></div>
</div>
<p>子プロセスまでkillするにはstopasgroupオプションが必要</p>
<p>stopasgroupオプションを有効にしなければ、Supervisor経由でuWSGIを止められない。(stopasgroupオプションなしでは、Supervisorのstopを実行したときにuWSGIの親プロセスしかkillされず、子プロセスが残ったままになってしまう。)</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/rc.conf
supervisord_enable="YES"
supervisord_flags="-c /usr/local/etc/supervisord.conf"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% service supervisord start
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% supervisorctl status
uwsgi                            RUNNING    pid 58014, uptime 0:15:23

% supervisorctl stop uwsgi
% supervisorctl start uwsgi
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://supervisord.org/configuration.html">http://supervisord.org/configuration.html</a></li>
<li><a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/Options.html">http://uwsgi-docs.readthedocs.org/en/latest/Options.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ supervisor ]]></category>
             <pubDate>Thu, 17 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/10/02/xdm_setting.html</link>
            <guid>http://127.0.0.1/blog/html/2013/10/02/xdm_setting.html</guid>
            <title><![CDATA[XDM 設定]]></title>
            <description><![CDATA[<h1>XDM 設定</h1>
<p>XDMのログイン画面はデフォルトだと寂しいので、ログイン毎に背景画像が代わるようにしている。</p>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.1 (wheezy)
Release:        7.1
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% cd /etc/X11/xdm
% cp xdm-config xdm-config.bak
% cp Xsetup Xsetup_0
% cp Xresources Xresources_0
</pre></div>
</div>
<div class="section" id="xdm-config">
<h2>xdm-config</h2>
<div class="highlight-python"><div class="highlight"><pre>% diff -u xdm-config xdm-config.bak
--- xdm-config  2013-10-03 00:28:33.000000000 +0900
+++ xdm-config.bak      2013-10-02 23:18:35.000000000 +0900
@@ -15,7 +15,7 @@
 DisplayManager.keyFile:                /etc/X11/xdm/xdm-keys
 DisplayManager.servers:                /etc/X11/xdm/Xservers
 DisplayManager.accessFile:     /etc/X11/xdm/Xaccess
-DisplayManager*resources:      /etc/X11/xdm/Xresources_0
+DisplayManager*resources:      /etc/X11/xdm/Xresources
 DisplayManager.willing:                su nobody -s /bin/sh -c /etc/X11/xdm/Xwilling
 ! All displays should use authorization, but we cannot be sure
 ! X terminals will be configured to support it, so those that do not will
@@ -25,7 +25,7 @@
 DisplayManager*chooser:                /usr/lib/X11/xdm/chooser
 DisplayManager*startup:                /etc/X11/xdm/Xstartup
 DisplayManager*session:                /etc/X11/xdm/Xsession
-DisplayManager*setup:          /etc/X11/xdm/Xsetup_0
+DisplayManager*setup:          /etc/X11/xdm/Xsetup
 DisplayManager*reset:          /etc/X11/xdm/Xreset
 DisplayManager*authComplain:   true
</pre></div>
</div>
</div>
<div class="section" id="xsetup-0">
<h2>Xsetup_0</h2>
<p>このファイルに指定したディレクトリにある画像をランダムに背景画像にするスクリプトを書く。</p>
<p>指定した範囲の値から一つ取り出す処理にathena-jot(1)、背景画像の設定にはxsetbg(1x)を使った。</p>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install athena-jot xloadimage
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/X11/xdm/Xsetup_0
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>#!/bin/sh
#
# This script is run as root before showing login widget.

#xsetroot -solid rgb:8/8/8

IMGDIR=/home/hoge/gazo

IMG_COUNT=`ls $IMGDIR | wc -l`
LINE_NUM=`jot -r 1 1 $IMG_COUNT`

IMG=`ls $IMGDIR | awk 'NR == '$LINE_NUM' { print $1 }'`

if [ -x /usr/bin/xsetbg ]; then
  /usr/bin/xsetbg -fullscreen $IMGDIR/$IMG
fi
</pre></div>
</div>
</div>
<div class="section" id="xresources-0">
<h2>Xresources_0</h2>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/X11/xdm/Xresources_0
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>--- Xresources        2011-10-23 01:48:34.000000000 +0900
+++ Xresources_0      2013-10-03 01:50:27.000000000 +0900
@@ -15,34 +15,35 @@
  Ctrl&lt;Key&gt;Return: set-session-argument(failsafe) finish-field()\n\
  &lt;Key&gt;Return: set-session-argument() finish-field()

-xlogin*greeting: Welcome to CLIENTHOST
-xlogin*namePrompt: \040\040\040\040\040\040\040Login:
+xlogin*greeting: Hello World
+xlogin*namePrompt: Login:
 xlogin*fail: Login incorrect or forbidden by policy

 #if WIDTH &gt; 800
-xlogin*greetFont: -adobe-helvetica-bold-o-normal--24-240-75-75-p-138-iso8859-1
-xlogin*font: -adobe-helvetica-medium-r-normal--18-180-75-75-p-98-iso8859-1
-xlogin*promptFont: -adobe-helvetica-bold-r-normal--18-180-75-75-p-103-iso8859-1
-xlogin*failFont: -adobe-helvetica-bold-r-normal--18-180-75-75-p-103-iso8859-1
-xlogin*greetFace:    Serif-24:bold:italic
-xlogin*face:                 Helvetica-18
-xlogin*promptFace:   Helvetica-18:bold
-xlogin*failFace:     Helvetica-18:bold
+xlogin*greetFont: -adobe-helvetica-bold-o-normal--10-100-75-75-p-60-iso8859-1
+xlogin*font: -adobe-helvetica-medium-r-normal--10-100-75-75-p-56-iso8859-1
+xlogin*promptFont: -adobe-helvetica-bold-r-normal--10-100-75-75-p-60-iso8859-1
+xlogin*failFont: -adobe-helvetica-bold-o-normal--10-100-75-75-p-60-iso8859-1
+xlogin*greetFace:       Serif-8:bold:italic
+xlogin*face:            Helvetica-8
+xlogin*promptFace:      Helvetica-8:bold
+xlogin*failFace:        Helvetica-8:bold
 #else
-xlogin*greetFont: -adobe-helvetica-bold-o-normal--17-120-100-100-p-92-iso8859-1
-xlogin*font: -adobe-helvetica-medium-r-normal--12-120-75-75-p-67-iso8859-1
-xlogin*promptFont: -adobe-helvetica-bold-r-normal--12-120-75-75-p-70-iso8859-1
-xlogin*failFont: -adobe-helvetica-bold-o-normal--14-140-75-75-p-82-iso8859-1
-xlogin*greetFace:    Serif-18:bold:italic
-xlogin*face:         Helvetica-12
-xlogin*promptFace:   Helvetica-12:bold
-xlogin*failFace:     Helvetica-14:bold
+xlogin*greetFont: -adobe-helvetica-bold-o-normal--10-100-75-75-p-60-iso8859-1
+xlogin*font: -adobe-helvetica-medium-r-normal--10-100-75-75-p-56-iso8859-1
+xlogin*promptFont: -adobe-helvetica-bold-r-normal--10-100-75-75-p-60-iso8859-1
+xlogin*failFont: -adobe-helvetica-bold-o-normal--10-100-75-75-p-60-iso8859-1
+xlogin*greetFace:       Serif-8:bold:italic
+xlogin*face:            Helvetica-8
+xlogin*promptFace:      Helvetica-8:bold
+xlogin*failFace:        Helvetica-8:bold
 #endif

 #ifdef COLOR
-xlogin*borderWidth: 1
-xlogin*frameWidth: 5
-xlogin*innerFramesWidth: 2
+xlogin*geometry: 180x120-0-0
+!xlogin*borderWidth: 1
+!xlogin*frameWidth: 5
+!xlogin*innerFramesWidth: 2
 xlogin*shdColor: grey30
 xlogin*hiColor: grey90
 xlogin*background: grey
@@ -59,13 +60,13 @@
 xlogin*hiColor: black
 #endif

-#if PLANES &gt;= 8
-xlogin*logoFileName: /usr/share/X11/xdm/pixmaps/debian.xpm
-#else
-xlogin*logoFileName: /usr/share/X11/xdm/pixmaps/debianbw.xpm
-#endif
-xlogin*useShape: true
-xlogin*logoPadding: 10
+!#if PLANES &gt;= 8
+!xlogin*logoFileName: /usr/share/X11/xdm/pixmaps/debian.xpm
+!#else
+!xlogin*logoFileName: /usr/share/X11/xdm/pixmaps/debianbw.xpm
+!#endif
+!xlogin*useShape: true
+!xlogin*logoPadding: 10


 XConsole.text.geometry:      480x130
</pre></div>
</div>
</div>]]></description>
            <category><![CDATA[ xdm ]]></category>
             <pubDate>Wed, 02 Oct 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/20/ssh_proxycommand.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/20/ssh_proxycommand.html</guid>
            <title><![CDATA[netcatを使わずに多段SSH]]></title>
            <description><![CDATA[<h1>netcatを使わずに多段SSH</h1>
<p>netcatを使い多段SSHをしている記事をよく見掛けるが、私はnetcatのプロセスが動くのが気持ち悪いのでこちらの方法で多段SSHをしている。いつからあるオプションなのかは知らないがCentOS 6.4のSSH(OpenSSH 5.3)ではすでに存在している。</p>
<p>ssh(1)より。</p>
<div class="highlight-python"><div class="highlight"><pre>-W host:port
             Requests that standard input and output on the client be forwarded to host on
             port over the secure channel.  Implies -N, -T, ExitOnForwardFailure and
             ClearAllForwardings and works with Protocol version 2 only.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi $HOME/.ssh/config
Host fumidai
  HostName 192.168.2.1
  User hoge
  Port 22
  IdentityFile ~/.ssh/id_rsa
Host server1
  Hostname 192.168.0.2
  User fuga
  Port 22
  IdentityFile ~/.ssh/id_rsa
  ProxyCommand ssh fumidai -W %h:%p
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ ssh server1
</pre></div>
</div>]]></description>
            <category><![CDATA[ ssh ]]></category>
             <pubDate>Fri, 20 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/19/debian_wheezy_schroot_chroot.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/19/debian_wheezy_schroot_chroot.html</guid>
            <title><![CDATA[schrootを使って一般ユーザでchroot]]></title>
            <description><![CDATA[<h1>schrootを使って一般ユーザでchroot</h1>
<p>schrootはroot権限を持たない一般ユーザでもchrootできるようにするwrapperである。オプションや設定ひとつでホストの環境,環境変数を引き継ぐことができとても便利なツールだ。</p>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.1 (wheezy)
Release:        7.1
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install schroot
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% schroot --version
schroot (Debian sbuild) 1.6.4 (26 Oct 2012)
Written by Roger Leigh

Copyright © 2004–2012 Roger Leigh
This is free software; see the source for copying conditions.  There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Configured features:
  DEVLOCK      Device locking
  PAM          Pluggable Authentication Modules
  PERSONALITY  Linux kernel Application Binary Interface switching
  UNION        Support for filesystem unioning

Available chroot types:
  BLOCKDEV     Support for ‘block-device’ chroots
  BTRFSSNAP    Support for ‘btrfs-snapshot’ chroots
  CUSTOM       Support for ‘custom’ chroots
  DIRECTORY    Support for ‘directory’ chroots
  FILE         Support for ‘file’ chroots
  LOOPBACK     Support for ‘loopback’ chroots
  LVMSNAP      Support for ‘lvm-snapshot’ chroots
  PLAIN        Support for ‘plain’ chroots
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir -p /var/chroot/wheezy
% debootstrap stable /var/chroot/wheezy http://ftp.jp.debian.org/debian
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% find /etc/schroot
/etc/schroot
/etc/schroot/buildd
/etc/schroot/buildd/nssdatabases
/etc/schroot/buildd/copyfiles
/etc/schroot/buildd/fstab
/etc/schroot/desktop
/etc/schroot/desktop/nssdatabases
/etc/schroot/desktop/copyfiles
/etc/schroot/desktop/fstab
/etc/schroot/default
/etc/schroot/default/nssdatabases
/etc/schroot/default/copyfiles
/etc/schroot/default/fstab
/etc/schroot/setup.d
/etc/schroot/setup.d/05file
/etc/schroot/setup.d/00check
/etc/schroot/setup.d/70services
/etc/schroot/setup.d/50chrootname
/etc/schroot/setup.d/15killprocs
/etc/schroot/setup.d/99check
/etc/schroot/setup.d/15binfmt
/etc/schroot/setup.d/05lvm
/etc/schroot/setup.d/05btrfs
/etc/schroot/setup.d/05union
/etc/schroot/setup.d/10mount
/etc/schroot/setup.d/20copyfiles
/etc/schroot/setup.d/20nssdatabases
/etc/schroot/minimal
/etc/schroot/minimal/nssdatabases
/etc/schroot/minimal/copyfiles
/etc/schroot/minimal/fstab
/etc/schroot/sbuild
/etc/schroot/sbuild/nssdatabases
/etc/schroot/sbuild/copyfiles
/etc/schroot/sbuild/fstab
/etc/schroot/chroot.d
/etc/schroot/schroot.conf
</pre></div>
</div>
<p>ホストのfstabにschroot用の設定を書いていたり、ホストのfstabに設定を書くのがイケてないと言っている記事を見掛けるが、schroot(1),schroot.conf(5)を眺めたのだろうか。/etc/schroot以下の構成は上記のようになっている。ホストからchroot環境へコピーするファイル(passwd,resolv.confなど)やマウントするディレクトリの設定などは/etc/schroot以下にディレクトリを切り設定ファイルを書いていく(このディレクトリをプロファイルと呼ぶことにする)。下記はdefaultプロファイルの設定ファイルである。</p>
<div class="highlight-python"><div class="highlight"><pre>$ cat /etc/schroot/default/copyfiles
# Files to copy into the chroot from the host system.
#
# &lt;source and destination&gt;
/etc/resolv.conf
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ cat /etc/schroot/default/nssdatabases
# System databases to copy into the chroot from the host system.
#
# &lt;database name&gt;
passwd
shadow
group
gshadow
services
protocols
networks
hosts
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ cat /etc/schroot/default/fstab
# fstab: static file system information for chroots.
# Note that the mount point will be prefixed by the chroot path
# (CHROOT_PATH)
#
# &lt;file system&gt; &lt;mount point&gt;   &lt;type&gt;  &lt;options&gt;       &lt;dump&gt;  &lt;pass&gt;
/proc           /proc           none    rw,bind        0       0
/sys            /sys            none    rw,bind        0       0
/dev            /dev            none    rw,bind         0       0
/dev/pts        /dev/pts        none    rw,bind         0       0
/home           /home           none    rw,bind         0       0
/tmp            /tmp            none    rw,bind         0       0

# It may be desirable to have access to /run, especially if you wish
# to run additional services in the chroot.  However, note that this
# may potentially cause undesirable behaviour on upgrades, such as
# killing services on the host.
#/run           /run            none    rw,bind         0       0
#/run/lock      /run/lock       none    rw,bind         0       0
#/dev/shm       /dev/shm        none    rw,bind         0       0
#/run/shm       /run/shm        none    rw,bind         0       0
</pre></div>
</div>
<p>プロファイルはprofileオプションを使い呼び出す。デフォルトではdefaultプロファイルが呼び出される。</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/schroot/chroot.d/wheezy.conf
[wheezy]
type=directory
directory=/var/chroot/wheezy
profile=desktop
users=zinrai
root-groups=root
</pre></div>
</div>
<p>環境変数を引き継ぐ場合は「-p」オプションを付ける。</p>
<div class="highlight-python"><div class="highlight"><pre>$ schroot -c wheezy -p bash
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="https://wiki.debian.org/Schroot">https://wiki.debian.org/Schroot</a></li>
</ul>]]></description>
            <category><![CDATA[ schroot ]]></category>
             <pubDate>Thu, 19 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/11/debian_wheezy_cowbuilder_chroot.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/11/debian_wheezy_cowbuilder_chroot.html</guid>
            <title><![CDATA[cowbuilderを使ったsandbox環境]]></title>
            <description><![CDATA[<h1>cowbuilderを使ったsandbox環境</h1>
<p>今回もchrootネタである。cowbuilderを使うとホスト環境を汚さずにいろいろできる。</p>
<ul class="simple"><li>気になるパッケージをとりあえずインストールして使ってみたい</li>
<li>Debianのパッケージが古く最新のソースをビルドして使ってみる</li>
<li>Texを使いたいがホスト環境には入れたくない</li>
</ul><p>などのシーンで私は使っている。</p>
<div class="highlight-python"><div class="highlight"><pre>lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.1 (wheezy)
Release:        7.1
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% apt-get install cowbuilder
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% cowbuilder --create --distribution wheezy --architecture amd64 --basepath  /var/cache/pbuilder/base_wheezy_amd64.cow
</pre></div>
</div>
<p>ベース環境を毎回取ってくるのはサーバに負荷がかかるので同じバージョンとアーキテクチャを使うときはコピーする。</p>
<div class="highlight-python"><div class="highlight"><pre>% cd /var/cache/pbuilder
% cp -R base_wheezy_amd64.cow rails3_wheezy_amd64.cow
</pre></div>
</div>
<table border="1" class="docutils"><colgroup><col width="18%"/><col width="82%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>–distribution</td>
<td>作成するディストリビューションの指定。sidもしくはコードネームを選ぶ。(省略した場合のデフォルトはsid)</td>
</tr><tr class="row-even"><td>–architecture</td>
<td>アーキテクチャの指定。(省略した場合のデフォルトはホストと同じ)</td>
</tr><tr class="row-odd"><td>–basepath</td>
<td>テンプレートのディレクトリパス(省略した場合のデフォルトは/var/cache/pbuilder/base.cow)</td>
</tr></tbody></table><p>「–save」オプションを付けると変更を保存できる。オプションなしの場合はログアウトすると変更は消える。</p>
<div class="highlight-python"><div class="highlight"><pre>% cowbuilder --login --save --basepath /var/cache/pbuilder/base_wheezy_amd64.cow
</pre></div>
</div>
<p>「–bindmount」オプションでホストのディレクトリをchroot環境にマウントできる。</p>
<div class="highlight-python"><div class="highlight"><pre>% cowbuilder --login --save --bindmount /home/hoge/dir --basepath /var/cache/pbuilder/base_wheezy_amd64.cow
</pre></div>
</div>
<p>ほかにもいろいろオプションがあるのでcowbuilder(8)を眺めてみるといい。</p>]]></description>
            <category><![CDATA[ cowbuilder ]]></category>
             <pubDate>Wed, 11 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/10/debian_wheezy_chroot_aufs.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/10/debian_wheezy_chroot_aufs.html</guid>
            <title><![CDATA[aufsを使ったchroot環境]]></title>
            <description><![CDATA[<h1>aufsを使ったchroot環境</h1>
<p>aufsとはLinuxにおけるunion mountの実装の1つである。union mountとは複数のファイルシステムを重ね合わせ一つのファイルシステムに見せる機能である。この機能はchroot環境と組み合わせると非常に勝手がいい。chroot環境をリードオンリーにし書き込み用のディレクトリと重ね合わせることでchroot環境を汚すことなく使うことができるようになる。</p>
<div class="highlight-python"><div class="highlight"><pre>% lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.1 (wheezy)
Release:        7.1
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% modinfo aufs
filename:       /lib/modules/3.2.0-4-amd64/kernel/fs/aufs/aufs.ko
staging:        Y
version:        3.2-20130204
description:    aufs -- Advanced multi layered unification filesystem
author:         Junjiro R. Okajima &lt;aufs-users@lists.sourceforge.net&gt;
license:        GPL
srcversion:     523C2808903A77806346A06
depends:
intree:         Y
vermagic:       3.2.0-4-amd64 SMP mod_unload modversions
parm:           brs:use &lt;sysfs&gt;/fs/aufs/si_*/brN (int)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% modprobe aufs
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% debootstrap stable /hoge/wheezy http://ftp.jp.debian.org/debian
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% mount -t aufs -o br:/hoge/rails:/hoge/wheezy=ro none /hoge/rails
% mount --rbind /dev /hoge/aufs_dir/dev
% mount -t proc none /hoge/aufs_dir/proc
% mount --rbind /sys /hoge/aufs_dir/sys
% chroot /hoge/aufs_dir /bin/bash
</pre></div>
</div>
<p>重ねるディレクトリを変えることで簡単にchroot環境を切り替えられる。</p>
<p>起動時にaufsを有効にしたければmodules(5)に書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre>% vi /etc/modules
aufs
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://aufs.sourceforge.net">http://aufs.sourceforge.net/</a></li>
</ul>]]></description>
            <category><![CDATA[ debian ]]></category>
             <pubDate>Tue, 10 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/09/centos_chroot.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/09/centos_chroot.html</guid>
            <title><![CDATA[CentOSでchroot環境構築]]></title>
            <description><![CDATA[<h1>CentOSでchroot環境構築</h1>
<p>yum(8)では役割単位(Web,Mailサーバなど)でパッケージがグループ化されており、グループ名を指定することでグループに属しているパッケージをまとめてインストールできるようになっている。</p>
<p>グループ名はサブコマンドgrouplistで調べることができる。</p>
<div class="highlight-python"><div class="highlight"><pre># cat /etc/centos-release
CentOS release 6.4 (Final)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>% yum grouplist
Loaded plugins: fastestmirror
Setting up Group Process
Loading mirror speeds from cached hostfile
 * base: ftp.iij.ad.jp
 * extras: ftp.iij.ad.jp
 * updates: ftp.iij.ad.jp
Installed Groups:
   E-mail server
Available Groups:
   Additional Development
   Backup Client
   Backup Server
   Base
   CIFS file server
   Client management tools
   Compatibility libraries
   ~~~~~~~~~~以下略~~~~~~~~~~
</pre></div>
</div>
<p>サブコマンドgroupifnoでグループに属しているパッケージを調べられる。</p>
<div class="highlight-python"><div class="highlight"><pre>% yum groupinfo "E-mail Server"
Loaded plugins: fastestmirror
Setting up Group Process
Loading mirror speeds from cached hostfile
 * base: ftp.iij.ad.jp
 * extras: ftp.iij.ad.jp
 * updates: ftp.iij.ad.jp

Group: E-mail server
 Description: Allows the system to act as a SMTP and/or IMAP e-mail server.
 Default Packages:
   dovecot
   postfix
   spamassassin
 Optional Packages:
   cyrus-imapd
   dovecot-mysql
   dovecot-pgsql
   dovecot-pigeonhole
   mailman
   sendmail
   sendmail-cf
</pre></div>
</div>
<p>BaseはCentOSのベースシステムがグループ化されている。</p>
<p>さらに「–installroot」オプションで指定したディレクトリにベースシステムを展開できる。</p>
<p>これを使えばCentOSのchroot環境を簡単に構築できる。</p>
<div class="highlight-python"><div class="highlight"><pre>% yum -y --releasever=6 --installroot=/root/centos6 groupinstall "Base"
% cd /root/centos6
% cp usr/share/zoneinfo/Asia/Tokyo etc/localtime
% cp /etc/resolv.conf etc/
% chroot /root/centos6 ntpdate ntp.jst.mfeed.ad.jp
% chroot /root/centos6 hwclock --systohc

% mount --rbind /dev /root/centos6/dev
% mount -t proc none /root/centos6/proc
% mount --rbind /sys /root/centos6/sys

% chroot /root/centos6 /bin/bash
</pre></div>
</div>
<p>chroot環境のアップグレードは下記のようにすればいい。</p>
<div class="highlight-python"><div class="highlight"><pre>% yum upgrade --releasever=6 --installroot=/root/centos6 -y
</pre></div>
</div>]]></description>
            <category><![CDATA[ centos ]]></category>
             <pubDate>Mon, 09 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/08/gentoo_install_script.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/08/gentoo_install_script.html</guid>
            <title><![CDATA[Gentoo Linux インストールスクリプト]]></title>
            <description><![CDATA[<h1>Gentoo Linux インストールスクリプト</h1>
<ul class="simple"><li>「そして私はOpenOfficeのビルドを諦めた」</li>
<li>「俺たちはなにと戦っているのだ...」</li>
</ul><p>などの名言で知られる(私調べ)Gentoo Linuxのインストールスクリプトを書いてみた。</p>
<ul class="simple"><li>「Gentoo LiveCD」を使わなくてもGentooはインストール出来るよ</li>
<li>Gentooインストールまでの各種コマンドを間違いなく打ち込む自身がないよ</li>
<li>Gentoo怖くないよ</li>
</ul><p>などが今回のモチベーションである。</p>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/07/debian_wheezy_pxeboot.html"><em>シェルスクリプトでDebian wheezyのインストール自動化</em></a>」で構築した環境にスクリプトを配置する。</p>
<p>その他に、<a class="reference external" href="http://www.gentoo.org/main/en/where.xml">stage3</a>,<a class="reference external" href="http://ftp.jaist.ac.jp/pub/Linux/Gentoo/snapshots">portage</a>, カーネルのコンフィグファイルをスクリプトのあるディレクトリに用意しておく。</p>
<p>実機,仮想環境(KVM)ともに動作することは確認した。Gentooを複数台セットアップする予定はいまのところない。</p>
<div class="highlight-python"><div class="highlight"><pre>% cp /boot/config-* /var/scripts
% cd /var/scripts
% wget http://ftp.jaist.ac.jp/pub/Linux/Gentoo/snapshots/portage-20130830.tar.bz2
% wget http://ftp.jaist.ac.jp/pub/Linux/Gentoo/releases/amd64/current-stage3/stage3-amd64-20131010.tar.bz2
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/scripts/gentoo_install.conf</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash -x</span>

<span class="c"># 01:23:45:67:89:ab</span>

<span class="nv">DATETIME</span><span class="o">=</span><span class="sb">`</span>date +<span class="s2">"%m%d%H%M%Y"</span><span class="sb">`</span>

<span class="nv">DISK</span><span class="o">=</span><span class="s2">"/dev/vda"</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">CWD</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">CHROOT_GENTOO</span><span class="o">=</span><span class="s2">"/mnt/$3"</span>

dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$DISK</span> <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>1

parted <span class="nv">$DISK</span> -s <span class="s1">'mklabel msdos'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart primary 1 500'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart primary 501 35000'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart extended 35001 -0'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart logical 35001 38000'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart logical 38001 -0'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'set 1 boot on'</span>

mkswap <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>5
swapon <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>5
mkfs.ext2 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>1
mkfs.ext3 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>2
mkfs.ext3 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>6

mkdir <span class="nv">$CHROOT_GENTOO</span>

mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>2 <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>

tar xvjf <span class="k">${</span><span class="nv">CWD</span><span class="k">}</span>/stage3-*.tar.bz2 -C <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>
tar xvjf <span class="k">${</span><span class="nv">CWD</span><span class="k">}</span>/portage-*.tar.bz2 -C <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/usr

mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>1 <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/boot
mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>6 <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/home

mount --rbind /dev <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/dev
mount -t proc none <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/proc
mount --rbind /sys <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/sys

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_GENTOO}/etc/conf.d/hostname</span>
<span class="s">HOSTNAME="gentoo.localnet"</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_GENTOO}/etc/conf.d/hwclock</span>
<span class="s">clock="local"</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_GENTOO}/etc/conf.d/keymaps</span>
<span class="s">KEYMAP="us"</span>
<span class="s">EOF</span>

cp -L /etc/resolv.conf <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/etc

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_GENTOO}/etc/conf.d/net</span>
<span class="s">config_${IFACE}="192.168.2.251/24"</span>
<span class="s">routes_${IFACE}="default via 192.168.2.254"</span>
<span class="s">EOF</span>

<span class="nb">cd</span> <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/etc/init.d
ln -s net.lo net.<span class="k">${</span><span class="nv">IFACE</span><span class="k">}</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_GENTOO}/etc/fstab</span>
<span class="s">${DISK}1               /boot           ext2            defaults        0 2</span>
<span class="s">${DISK}2               /               ext3            defaults        0 1</span>
<span class="s">${DISK}6               /home           ext3            defaults        0 2</span>
<span class="s">${DISK}5               none            swap            sw              0 0</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt;&gt; ${CHROOT_GENTOO}/etc/portage/make.conf</span>
<span class="s">SYNC="rsync://ftp.jaist.ac.jp/pub/Linux/Gentoo"</span>
<span class="s">GENTOO_MIRRORS="http://ftp.jaist.ac.jp/pub/Linux/Gentoo/ ftp://ftp.iij.ad.jp/pub/linux/gentoo/"</span>
<span class="s">EOF</span>

cp /var/scripts/config-* <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/root

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_GENTOO}/tmp/gentoo_setup.sh</span>
<span class="s">env-update</span>
<span class="s">source /etc/profile</span>

<span class="s">export CONFIG_PROTECT_MASK="/etc"</span>

<span class="s">cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime</span>
<span class="s">echo "Asia/Tokyo" &gt; /etc/timezone</span>
<span class="s">date $DATETIME</span>

<span class="s">echo "ja_JP.UTF-8 UTF-8" &gt;&gt; /etc/locale.gen</span>
<span class="s">locale-gen</span>

<span class="s">emerge-webrsync</span>

<span class="s">emerge rsyslog vixie-cron</span>
<span class="s">rc-update add vixie-cron default</span>
<span class="s">rc-update add rsyslog default</span>
<span class="s">rc-update add sshd default</span>
<span class="s">rc-update add net.${IFACE} default</span>

<span class="s">emerge vim gentoo-sources</span>

<span class="s">cd /usr/src/linux</span>
<span class="s">cat &lt;(egrep '(EXT2|EXT3|VIRTIO)' /root/config-* | sed 's/=m/=y/g') &lt;(egrep -v '(EXT2|EXT3|VIRTIO)' /root/config-*) &gt; .config</span>

<span class="s">echo n | make oldconfig</span>
<span class="s">make</span>
<span class="s">make modules_install</span>
<span class="s">make install</span>

<span class="s">emerge --autounmask-write grub:2</span>
<span class="s">emerge grub:2</span>
<span class="s">mkdir /boot/grub</span>
<span class="s">grub2-mkconfig -o /boot/grub/grub.cfg</span>
<span class="s">grub2-install --no-floppy --root-directory=/ $DISK</span>

<span class="s">grep -v rootfs /proc/mounts &gt; /etc/mtab</span>
<span class="s">EOF</span>


cat <span class="s">&lt;&lt; 'EOF' &gt; ${CHROOT_DEBIAN}/tmp/user_acount.sh</span>
<span class="s">useradd -m -G wheel nanashi</span>
<span class="s">printf 'nanashi:$6$oHUVG9WPkdiCoxCP$XsnO5TmowzdGWNkZHv9pPUmFqgsEojkfzUa1OQj2zUOWAChL5cdGkm.dhseF0z5Tz30IEDrxNzOcsflPUgHDs.' | chpasswd -e</span>
<span class="s">printf 'root:$6$wAeDl/exZFEDC0Sl$UdvTamL.94EcWFcGIAYJSgsvzaFxSd.ZLRMkD.KI27L6jxUGsWqOdEJs6if0rTG/XuEfQ9TNzHbjI99YfxPLD1' | chpasswd -e</span>
<span class="s">EOF</span>

chroot <span class="nv">$CHROOT_GENTOO</span> /bin/bash /tmp/gentoo_setup.sh
chroot <span class="nv">$CHROOT_GENTOO</span> /bin/bash /tmp/user_acount.sh

rm <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/tmp/gentoo_setup.sh
rm <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/tmp/user_acount.sh

<span class="nb">cd</span> /
umount -l <span class="k">${</span><span class="nv">CHROOT_GENTOO</span><span class="k">}</span>/<span class="o">{</span>boot,home,proc,dev,sys<span class="o">}</span>
umount -l <span class="nv">$CHROOT_GENTOO</span>
sleep 2
rmdir <span class="nv">$CHROOT_GENTOO</span>
reboot
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://d.hatena.ne.jp/meech/20120221/1329839829">http://d.hatena.ne.jp/meech/20120221/1329839829</a></li>
<li><a class="reference external" href="http://www.gentoo.org/doc/ja/handbook/handbook-amd64.xml?full=1">http://www.gentoo.org/doc/ja/handbook/handbook-amd64.xml?full=1</a></li>
</ul>]]></description>
            <category><![CDATA[ gentoo ]]></category>
             <pubDate>Sun, 08 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/07/debian_wheezy_pxeboot.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/07/debian_wheezy_pxeboot.html</guid>
            <title><![CDATA[シェルスクリプトでDebian wheezyのインストール自動化]]></title>
            <description><![CDATA[<h1>シェルスクリプトでDebian wheezyのインストール自動化</h1>
<p>みなさん、Debianのインストール作業はどうやっているだろうか。私は、OSのインストール作業なんてお金を貰わない限り手動でやりたくないので自動化している。OSの手動インストールをするだけでお金が発生するのであれば喜んでやらせていただく所存である。RedHat系の「<a class="reference external" href="http://fedoraproject.org/wiki/Anaconda/Kickstart">Kickstart</a>」と同じような仕組みの「<a class="reference external" href="http://www.debian.org/releases/stable/amd64/apb.html.ja">preseed</a>」というものがDebianにも存在するが、これを使わずに「pxeboot + debootstrap + シェルスクリプト」でインストールの自動化をしている。</p>
<div class="section" id="pxeboot">
<h2>pxeboot</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install debootstrap syslinux dnsmasq nfs-kernel-server</span>
</pre></div>
</div>
<div class="section" id="dnsmasq">
<h3>dnsmasq</h3>
<p>DNSサーバ以外にもDHCP,TFTPサーバとしても使える便利なdnsmasq</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/dnsmasq.d/pxe.conf
enable-tftp
tftp-root=/var/lib/tftpboot
dhcp-range=192.168.2.200,192.168.2.250,2h
dhcp-option=3,192.168.2.254
dhcp-boot=pxelinux.0
</pre></div>
</div>
</div>
<div class="section" id="nfs">
<h3>NFS</h3>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/exports
/var/lib/tftpboot/wheezy 192.168.2.0/24(rw,no_root_squash,no_subtree_check)
</pre></div>
</div>
</div>
<div class="section" id="debootstrap">
<h3>debootstrap</h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir -p /var/lib/tftpboot/wheezy</span>
<span class="c"># debootstrap stable /var/lib/tftpboot/wheezy http://ftp.jp.debian.org/debian</span>
<span class="c"># chroot /var/lib/tftpboot/wheezy passwd root</span>
<span class="c"># chroot /var/lib/tftpboot/wheezy/ apt-get install linux-image-`uname -r` parted build-essential bzip2 grub2 debootstrap nfs-common</span>
</pre></div>
</div>
</div>
<div class="section" id="syslinux">
<h3>syslinux</h3>
<div class="highlight-python"><div class="highlight"><pre># cp /boot/initrd* /var/lib/tftpboot
# cp /boot/vmlinuz* /var/lib/tftpboot

# cp /usr/lib/syslinux/pxelinux.0 /var/lib/tftpboot
# mkdir /var/lib/tftpboot/pxelinux.cfg

# vi /var/lib/tftpboot/pxelinux.cfg/default
default Debian
prompt 1
timeout 10
label Debian
kernel vmlinuz-3.2.0-4-amd64
append initrd=initrd.img-3.2.0-4-amd64 root=/dev/nfs ip=dhcp nfsroot=192.168.2.253:/var/lib/tftpboot/wheezy rw
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># service dnsmasq start</span>
<span class="c"># service nfs-kernel-server start</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="debian">
<h2>Debianインストールスクリプト</h2>
<p>仕組みは「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html"><em>シェルスクリプトでFreeBSD 9.1のインストール自動化</em></a>」と同じである。</p>
<p>debootstrapで取得した最小構成のWheezyをコピーするスクリプトを書いただけ。</p>
<p>パッケージインストール時にダイアログが表示され入力待ちにならないよう環境変数「DEBIAN_FRONTEND=noninteractive」を設定しておくのがポイントである。</p>
<p>この環境変数は解決方法はないかとdebconf(1)を眺めていたら</p>
<div class="highlight-python"><div class="highlight"><pre>Debconf is a configuration system for Debian packages. For a debconf overview and documentation for sysadmins, see debconf(7) (in the debconf-doc package).
</pre></div>
</div>
<p>書かれており、説明に従いdebconf-docをインストールし、debconf(7)を眺めたところ見付けた。</p>
<p>os_install.shはconfファイルが1つだとうまく動いてくれないのでダミーのconfファイルを1つ作っておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># touch /var/scripts/dummy.conf</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir -p /var/scripts/wheezy</span>
<span class="c"># debootstrap stable /var/scripts/wheezy http://ftp.jp.debian.org/debian</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/scripts/os_install.sh</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/sh</span>

get_conf<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"FreeBSD"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">"`ifconfig | awk '/ether/ {print $NF}'`"</span>
  <span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"Linux"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">"`ifconfig | awk '/HWaddr/ {print $NF}'`"</span>
  <span class="k">fi</span>

<span class="k">  for </span>a in <span class="nv">$MACADDR</span>; <span class="k">do</span>
<span class="k">    </span>grep -r <span class="nv">$MACADDR</span> <span class="k">${</span><span class="nv">CWD</span><span class="k">}</span>/*.conf | awk -F: <span class="s1">'{print $1}'</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="nv">CWD</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>

<span class="nv">OS</span><span class="o">=</span><span class="sb">`</span>uname<span class="sb">`</span>
<span class="nv">CONFFILE</span><span class="o">=</span><span class="sb">`</span>get_conf<span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">"$CONFFILE"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nb">printf</span> <span class="s1">'Script Not Found\n'</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"FreeBSD"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($1 ~ /^default$/) print $6}'</span><span class="sb">`</span>
  <span class="nv">MOUNTNAME</span><span class="o">=</span><span class="sb">`</span>sha256 -q <span class="nv">$CONFFILE</span><span class="sb">`</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"Linux"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($4 ~ /^UG$/) print $8}'</span><span class="sb">`</span>
  <span class="nv">MOUNTNAME</span><span class="o">=</span><span class="sb">`</span>sha256sum <span class="nv">$CONFFILE</span> | awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="k">fi</span>

<span class="nv">$CONFFILE</span> <span class="nv">$IFACE</span> <span class="nv">$CWD</span> <span class="nv">$MOUNTNAME</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/scripts/debian_install.conf</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash -x</span>

<span class="c"># 01:23:45:67:89:ab</span>

<span class="nv">DISK</span><span class="o">=</span><span class="s2">"/dev/vda"</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">CWD</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">CHROOT_DEBIAN</span><span class="o">=</span><span class="s2">"/mnt/$3"</span>

dd <span class="k">if</span><span class="o">=</span>/dev/zero <span class="nv">of</span><span class="o">=</span><span class="nv">$DISK</span> <span class="nv">bs</span><span class="o">=</span>1024 <span class="nv">count</span><span class="o">=</span>1

parted <span class="nv">$DISK</span> -s <span class="s1">'mklabel msdos'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart primary 1 500'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart primary 501 35000'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart extended 35001 -0'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart logical 35001 38000'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'mkpart logical 38001 -0'</span>
parted <span class="nv">$DISK</span> -s <span class="s1">'set 1 boot on'</span>

mkswap <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>5
swapon <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>5
mkfs.ext2 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>1
mkfs.ext4 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>2
mkfs.ext4 <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>6

mkdir <span class="nv">$CHROOT_DEBIAN</span>

mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>2 <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>

cp -Rp <span class="k">${</span><span class="nv">CWD</span><span class="k">}</span>/wheezy/* <span class="nv">$CHROOT_DEBIAN</span>

mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>1 <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/boot
mount <span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>6 <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/home

mount --rbind /dev <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/dev
mount -t proc none <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/proc
mount --rbind /sys <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/sys

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/hostname</span>
<span class="s">install.localnet</span>
<span class="s">EOF</span>


cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/resolv.conf</span>
<span class="s">nameserver 8.8.8.8</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/network/interfaces</span>
<span class="s">auto lo</span>
<span class="s">iface lo inet loopback</span>

<span class="s">auto eth0</span>
<span class="s">iface eth0 inet static</span>
<span class="s">address  192.168.2.100</span>
<span class="s">netmask 255.255.255.0</span>
<span class="s">gateway 192.168.2.254</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/fstab</span>
<span class="s">${DISK}1               /boot           ext2            defaults        0 2</span>
<span class="s">${DISK}2               /               ext4            defaults        0 1</span>
<span class="s">${DISK}6               /home           ext4            defaults        0 2</span>
<span class="s">${DISK}5               none            swap            sw              0 0</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/tmp/debian_setup.sh</span>
<span class="s">export DEBIAN_FRONTEND=noninteractive</span>
<span class="s">cp /usr/share/zoneinfo/Asia/Tokyo /etc/localtime</span>
<span class="s">grep -v rootfs /proc/mounts &gt; /etc/mtab</span>

<span class="s">apt-get install -y linux-image-`uname -r` grub2 openssh-server</span>

<span class="s">grub-mkconfig -o /boot/grub/grub.cfg</span>
<span class="s">grub-install --no-floppy --root-directory=/ $DISK</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; 'EOF' &gt; ${CHROOT_DEBIAN}/tmp/user_acount.sh</span>
<span class="s">useradd -m -G sudo nanashi</span>
<span class="s">printf 'nanashi:$6$oHUVG9WPkdiCoxCP$XsnO5TmowzdGWNkZHv9pPUmFqgsEojkfzUa1OQj2zUOWAChL5cdGkm.dhseF0z5Tz30IEDrxNzOcsflPUgHDs.' | chpasswd -e</span>
<span class="s">printf 'root:$6$wAeDl/exZFEDC0Sl$UdvTamL.94EcWFcGIAYJSgsvzaFxSd.ZLRMkD.KI27L6jxUGsWqOdEJs6if0rTG/XuEfQ9TNzHbjI99YfxPLD1' | chpasswd -e</span>
<span class="s">EOF</span>

chroot <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span> /bin/bash /tmp/debian_setup.sh
chroot <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span> /bin/bash /tmp/user_acount.sh

rm <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/tmp/debian_setup.sh
rm <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/tmp/user_acount.sh

<span class="nb">cd</span> /
umount -l <span class="k">${</span><span class="nv">CHROOT_DEBIAN</span><span class="k">}</span>/<span class="o">{</span>boot,home,proc,dev,sys<span class="o">}</span>
umount -l <span class="nv">$CHROOT_DEBIAN</span>
sleep 2
rmdir <span class="nv">$CHROOT_DEBIAN</span>
reboot
</pre></div>
</div>
<p>pxeboot時にインストールスクリプトが実行されるようrc.localに書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /var/lib/tftpboot/wheezy/etc/rc.local

#!/bin/sh -e
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will "exit 0" on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.

/var/scripts/os_install.sh

exit 0
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://fedoraproject.org/wiki/Anaconda/Kickstart">http://fedoraproject.org/wiki/Anaconda/Kickstart</a></li>
<li><a class="reference external" href="http://www.debian.org/releases/stable/amd64/apb.html.ja">http://www.debian.org/releases/stable/amd64/apb.html.ja</a></li>
</ul></div>]]></description>
            <category><![CDATA[ debian ]]></category>
            <category><![CDATA[ pxeboot ]]></category>
             <pubDate>Sat, 07 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/06/debian_wheezy_sshfs.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/06/debian_wheezy_sshfs.html</guid>
            <title><![CDATA[sshfs]]></title>
            <description><![CDATA[<h1>sshfs</h1>
<p>言わずと知れたSSH経由でリモートサーバのディレクトリをマウントしてくれるツール</p>
<p>いつも便利に使わせてもらっている。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get instal sshfs</span>
</pre></div>
</div>
<p>fuseグループに所属していないと「fuse: failed to open /dev/fuse: Permission denied」となる。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># usermod -a -G fuse hoge</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.1 (wheezy)
Release:        7.1
Codename:       wheezy
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ sshfs --version
SSHFS version 2.4
FUSE library version: 2.9.0
using FUSE kernel interface version 7.18
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ sshfs -p 18465 hoge@192.168.2.1:/home/hoge remote_dir
$ fusermount -u remote_dir
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://fuse.sourceforge.net/sshfs.html">http://fuse.sourceforge.net/sshfs.html</a></li>
</ul>]]></description>
            <category><![CDATA[ sshfs ]]></category>
             <pubDate>Fri, 06 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/05/freebsd_python_uwsgi_logformat.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/05/freebsd_python_uwsgi_logformat.html</guid>
            <title><![CDATA[uWSGIのログフォーマット]]></title>
            <description><![CDATA[<h1>uWSGIのログフォーマット</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/04/freebsd_nginx_reverse_proxy.html"><em>Nginxでリバースプロキシ</em></a>」でバックエンドにアクセス元のIPアドレスがログに記録されると書いたが、バックエンド側でも設定しなければログには記録されない。個人でひっそりとWebサービスを運営していてもディレクトリトラバーサルや某CMSを攻撃しているのかなと思われるリクエストがログに記録されている。ログを眺めるのは楽しいものだ。</p>
<p>今回はバックエンドに「<a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>」を置いた場合のログ設定について書く。動作するまでを書いた記事はよく見掛けるが、ログについて書いている記事は見たことがない。ドキュメントに書いてある通りに設定すればいいだけなので、わざわざ書き留めるほどの情報ではないのだろうか。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># pw groupadd uwsgi -g 9090</span>
<span class="c"># pw useradd uwsgi -u 9090 -g 9090 -c "uWSGI" -d /nonexistent -s /usr/sbin/nologin</span>
</pre></div>
</div>
<p>アクセスしたら「Hellow World」を出力するだけの<a class="reference external" href="http://flask.pocoo.org">Flask</a>を使ったアプリケーション</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi sample.py</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/myapp'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">"Hello World!"</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>の設定をいろいろと書いているが大事なのはlog-x-forwarded-forとlog-formatの部分である。log-x-forwarded-forを有効にすればlog-formatの%(addr)にアクセス元のIPアドレスが記録される。</p>
<p>ログフォーマットは「<a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/LogFormat.html">Formatting uWSGI requests logs</a>」に詳しく書いてある。</p>
<div class="highlight-python"><div class="highlight"><pre># vi development.ini
[uwsgi]
http = :9090
workers = 3
threads = 2
virtualenv = ${virtualenv_path}
python-path = ${application_path}
wsgi = sample
callable = app
pidfile = /var/run/uwsgi.pid
uid = uwsgi
gid = uwsgi
log-x-forwarded-for = true
daemonize = uwsgi.log
touch-reload = reload.txt
log-format = %(addr) - %(user) [%(ltime)] "%(method) %(uri) %(proto)" %(status) %(size)`` "%(referer)" "%(uagent)"
</pre></div>
</div>
<table border="1" class="docutils"><colgroup><col width="23%"/><col width="77%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>virtualenv</td>
<td>virtualenvを使用している場合、virtualenvのパスを指定する</td>
</tr><tr class="row-even"><td>python-path</td>
<td>アプリケーションのパスを指定する。</td>
</tr><tr class="row-odd"><td>touch-reload</td>
<td>指定したファイルをtouchすることでアプリと<a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>の設定がリロードされる</td>
</tr></tbody></table><div class="highlight-python"><div class="highlight"><pre><span class="c"># touch reload.txt</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># uwsgi development.ini</span>
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html">http://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html</a></li>
<li><a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/Options.html">http://uwsgi-docs.readthedocs.org/en/latest/Options.html</a></li>
<li><a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/LogFormat.html">http://uwsgi-docs.readthedocs.org/en/latest/LogFormat.html</a></li>
</ul>]]></description>
            <category><![CDATA[ uwsgi ]]></category>
             <pubDate>Thu, 05 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/04/freebsd_nginx_reverse_proxy.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/04/freebsd_nginx_reverse_proxy.html</guid>
            <title><![CDATA[Nginxでリバースプロキシ]]></title>
            <description><![CDATA[<h1>Nginxでリバースプロキシ</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/03/freebsd_jail_jenkins.html"><em>jail環境でJenkinsを動かす</em></a>」からの続きでlocalhostでListenしているJenkinsをNginxのリバースプロキシを使いlocalhost以外からもアクセスできるようにする。</p>
<p>Nginxのディレクトリ構成は下記を参考に</p>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/31/freebsd_nginx_virtualhost.html"><em>Nginxでバーチャルホスト</em></a></li>
</ul><div class="highlight-python"><div class="highlight"><pre># nginx -v
nginx version: nginx/1.4.2
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /usr/local/etc/nginx/nginx.conf
http {

    server {
        listen       80;
        server_name  localhost;

        location /jenkins {
            proxy_pass http://127.0.0.1:8180;
        }
}
</pre></div>
</div>
<p>proxy_passを設定するだけでJenkinsに接続できるようになる。</p>
<p>「Python+<a class="reference external" href="http://flask.pocoo.org">Flask</a>+<a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>」で作ったAPサーバをバックエンドに置き、リバースプロキシにNginxを使った場合を考えると、上記の設定ではAPサーバのアクセスログにはリバースプロキシのIPアドレスが記録されてしまいアクセス元はどこなのかがわからない状態になってしまう。アクセス元のIPアドレスがAPサーバに記録されるようにするにはproxy_set_headerを設定する必要がある。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /usr/local/etc/nginx/nginx.conf
http {

    server {
        listen       80;
        server_name  localhost;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Real-IP $remote_addr;

        location /myapp {
            proxy_pass http://127.0.0.1:9090;
        }
}
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass</a></li>
<li><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header</a></li>
</ul>]]></description>
            <category><![CDATA[ nginx ]]></category>
             <pubDate>Wed, 04 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/03/freebsd_jail_jenkins.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/03/freebsd_jail_jenkins.html</guid>
            <title><![CDATA[jail環境でJenkinsを動かす]]></title>
            <description><![CDATA[<h1>jail環境でJenkinsを動かす</h1>
<p>会社員だったときに仕様書がエルセル方眼紙だったので、「<a class="reference external" href="http://sphinx-doc.org">Sphinx</a>にするとプレーンテキストで管理でき、gitなどのバージョン管理システムの管理下に置け、さらに<a class="reference external" href="http://jenkins-ci.org">Jenkins</a>を使えば手元に<a class="reference external" href="http://sphinx-doc.org">Sphinx</a>がなくてもバージョン管理下に置いたソースをリモートリポジトリにpushするだけでビルドしてくれる環境ができますよ」というようなことをもう少しわかりやすく提案し見事に却下された。エクセル方眼紙は3人で編集していたのでマージ作業が辛かった。</p>
<p>jail環境の構築は下記を参考に</p>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
</ul><p>FreeBSDにJenkinsをインストールするとインストール後に下記のように表示される。</p>
<div class="highlight-python"><div class="highlight"><pre>======================================================================

This OpenJDK implementation requires fdescfs(5) mounted on /dev/fd and
procfs(5) mounted on /proc.

If you have not done it yet, please do the following:

        mount -t fdescfs fdesc /dev/fd
        mount -t procfs proc /proc

To make it permanent, you need the following lines in /etc/fstab:

        fdesc   /dev/fd         fdescfs         rw      0       0
        proc    /proc           procfs          rw      0       0

======================================================================
</pre></div>
</div>
<p>jail環境ではマウントできないのでホストのjail.conf(5)にjail起動時にマウントするよう書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/jail.conf
jenkins {
        exec.prestart += "mount -t fdescfs fdesc /jails/${name}/dev/fd";
        exec.prestart += "mount -t procfs proc /jails/${name}/proc";
        exec.poststop += "umount /jails/${name}/dev/fd";
        exec.poststop += "umount /jails/${name}/proc";
        $if = 9;
        $ipaddr = 192.168.0.9;
}
</pre></div>
</div>
<div class="section" id="jenkins">
<h2>jenkins</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">jenkins_enable</span><span class="o">=</span><span class="s">"YES"</span>

<span class="c"># service jenkins start</span>
</pre></div>
</div>
<p>JenkinsはlocalhostでListenしているので、このままだと他からアクセスできない。</p>
<p>次回はリバースプロキシにnginxを使いJenkinsにアクセスできるようにする。</p>
<ul class="simple"><li><a class="reference external" href="http://sphinx-users.jp">http://sphinx-users.jp/</a></li>
<li><a class="reference external" href="http://build-shokunin.org">http://build-shokunin.org/</a></li>
</ul></div>]]></description>
            <category><![CDATA[ jenkins ]]></category>
             <pubDate>Tue, 03 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/02/freebsd_irc_znc.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/02/freebsd_irc_znc.html</guid>
            <title><![CDATA[ZNCでIRC Proxy]]></title>
            <description><![CDATA[<h1>ZNCでIRC Proxy</h1>
<p>IRCクライアオンからIRCサーバに接続してない間の発言は見ることが出来無い。IRC Proxyを置けば接続していない間の発言を記録し、IRCクライアントからIRC Proxyに接続すれば記録された発言を見ることが出来る。IRC Proxyでログを定期的にメールすると外出中は捗る。IRC Proxyといえばネットでは「<a class="reference external" href="http://www.clovery.jp/tiarra">Tiarra</a>」をよく見掛けるが、SSL接続のために「<a class="reference external" href="http://sourceforge.jp/projects/stone">stone</a>」などを使わなければならず面倒くさい。SSL接続できるIRC Proxyはないか探してみたところ「<a class="reference external" href="http://wiki.znc.in/ZNC">ZNC</a>」を見付け使っている。</p>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/01/freebsd_irc_ngircd.html"><em>ngircdでIRCサーバ</em></a></li>
</ul><div class="highlight-python"><div class="highlight"><pre><span class="c"># pw useradd -n znc -s /bin/tcsh -m</span>
<span class="c"># su - znc</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ znc --help
[ ** ] USAGE: znc [options]
[ ** ] Options are:
[ ** ]  -h, --help         List available command line options (this page)
[ ** ]  -v, --version      Output version information and exit
[ ** ]  -f, --foreground   Don't fork into the background
[ ** ]  -D, --debug        Output debugging information (Implies -f)
[ ** ]  -n, --no-color     Don't use escape sequences in the output
[ ** ]  -r, --allow-root   Don't complain if ZNC is run as root
[ ** ]  -c, --makeconf     Interactively create a new config
[ ** ]  -s, --makepass     Generates a password for use in config
[ ** ]  -p, --makepem      Generates a pemfile for use with SSL
[ ** ]  -d, --datadir      Set a different ZNC repository (default is ~/.znc)
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ znc -v
ZNC 1.0 - http://znc.in
IPv6: yes, SSL: yes, DNS: threads
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ znc -c
[ ok ] Checking for list of available modules...
[ ** ] Building new config
[ ** ]
[ ** ] First let's start with some global settings...
[ ** ]
[ ?? ] What port would you like ZNC to listen on? (1025 to 65535): 6668
[ ?? ] Would you like ZNC to listen using SSL? (yes/no) [no]: yes
[ ** ] Unable to locate pem file: [/home/znc/.znc/znc.pem]
[ ?? ] Would you like to create a new pem file now? (yes/no) [yes]:
[ ok ] Writing Pem file [/home/znc/.znc/znc.pem]...
[ ?? ] Would you like ZNC to listen using ipv6? (yes/no) [yes]: no
[ ?? ] Listen Host (Blank for all ips): 192.168.0.8
[ ok ] Verifying the listener...
[ ** ]
[ ** ] -- Global Modules --
[ ** ]
[ ** ] +-----------+----------------------------------------------------------+
[ ** ] | Name      | Description                                              |
[ ** ] +-----------+----------------------------------------------------------+
[ ** ] | partyline | Internal channels and queries for users connected to znc |
[ ** ] | webadmin  | Web based administration module                          |
[ ** ] +-----------+----------------------------------------------------------+
[ ** ] And 10 other (uncommon) modules. You can enable those later.
[ ** ]
[ ?? ] Load global module &lt;partyline&gt;? (yes/no) [no]:
[ ?? ] Load global module &lt;webadmin&gt;? (yes/no) [no]:
[ ** ]
[ ** ] Now we need to set up a user...
[ ** ]
[ ?? ] Username (AlphaNumeric): hoge
[ ?? ] Enter Password:
[ ?? ] Confirm Password:
[ ?? ] Would you like this user to be an admin? (yes/no) [yes]:
[ ?? ] Nick [hoge]:
[ ?? ] Alt Nick [hoge_]:
[ ?? ] Ident [hoge]:
[ ?? ] Real Name [Got ZNC?]: fuga
[ ?? ] Bind Host (optional):
[ ?? ] Number of lines to buffer per channel [50]:
[ ?? ] Would you like to clear channel buffers after replay? (yes/no) [yes]:
[ ?? ] Default channel modes [+stn]:
[ ** ]
[ ** ] -- User Modules --
[ ** ]
[ ** ] +--------------+------------------------------------------------------------------------------------------+
[ ** ] | Name         | Description                                                                              |
[ ** ] +--------------+------------------------------------------------------------------------------------------+
[ ** ] | chansaver    | Keep config up-to-date when user joins/parts                                             |
[ ** ] | controlpanel | Dynamic configuration through IRC. Allows editing only yourself if you're not ZNC admin. |
[ ** ] | perform      | Keeps a list of commands to be executed when ZNC connects to IRC.                        |
[ ** ] +--------------+------------------------------------------------------------------------------------------+
[ ** ] And 22 other (uncommon) modules. You can enable those later.
[ ** ]
[ ?? ] Load module &lt;chansaver&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;controlpanel&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;perform&gt;? (yes/no) [no]:
[ ** ]
[ ?? ] Would you like to set up a network? (yes/no) [no]: yes
[ ?? ] Network (e.g. `freenode' or `efnet'): hogeirc
[ ** ]
[ ** ] -- Network Modules --
[ ** ]
[ ** ] +-------------+-------------------------------------------------------------------------------------------------+
[ ** ] | Name        | Description                                                                                     |
[ ** ] +-------------+-------------------------------------------------------------------------------------------------+
[ ** ] | chansaver   | Keep config up-to-date when user joins/parts                                                    |
[ ** ] | keepnick    | Keep trying for your primary nick                                                               |
[ ** ] | kickrejoin  | Autorejoin on kick                                                                              |
[ ** ] | nickserv    | Auths you with NickServ                                                                         |
[ ** ] | perform     | Keeps a list of commands to be executed when ZNC connects to IRC.                               |
[ ** ] | simple_away | This module will automatically set you away on IRC while you are disconnected from the bouncer. |
[ ** ] +-------------+-------------------------------------------------------------------------------------------------+
[ ** ] And 16 other (uncommon) modules. You can enable those later.
[ ** ]
[ ?? ] Load module &lt;chansaver&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;keepnick&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;kickrejoin&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;nickserv&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;perform&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;simple_away&gt;? (yes/no) [no]:
[ ** ]
[ ** ] -- IRC Servers --
[ ** ] Only add servers from the same IRC network.
[ ** ] If a server from the list can't be reached, another server will be used.
[ ** ]
[ ?? ] IRC server (host only): 192.168.0.7
[ ?? ] [192.168.50.7] Port (1 to 65535) [6667]: 6669
[ ?? ] [192.168.50.7] Password (probably empty): aiueo
[ ?? ] Does this server use SSL? (yes/no) [no]: yes
[ ** ]
[ ?? ] Would you like to add another server for this IRC network? (yes/no) [no]:
[ ** ]
[ ** ] -- Channels --
[ ** ]
[ ?? ] Would you like to add a channel for ZNC to automatically join? (yes/no) [yes]:
[ ?? ] Channel name: #fuga
[ ?? ] Would you like to add another channel? (yes/no) [no]:
[ ?? ] Would you like to set up another network? (yes/no) [no]:
[ ** ]
[ ?? ] Would you like to set up another user? (yes/no) [no]:
[ ok ] Writing config [/home/znc/.znc/configs/znc.conf]...
[ ** ]
[ ** ] To connect to this ZNC you need to connect to it as your IRC server
[ ** ] using the port that you supplied.  You have to supply your login info
[ ** ] as the IRC server password like this: user/network:pass.
[ ** ]
[ ** ] Try something like this in your IRC client...
[ ** ] /server &lt;znc_server_ip&gt; +6668 hoge:&lt;pass&gt;
[ ** ] And this in your browser...
[ ** ] https://&lt;znc_server_ip&gt;:6668/
[ ** ]
[ ?? ] Launch ZNC now? (yes/no) [yes]:
[ ok ] Opening config [/home/znc/.znc/configs/znc.conf]...
[ ok ] Binding to port [+6668] on host [192.168.0.8] using ipv4...
[ ** ] Loading user [hoge]
[ ** ] Loading network [hogeirc]
[ ok ] Adding server [192.168.0.7 +6669 aiueo]...
[ ok ] Forking into the background... [pid: 42611]
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ vi .znc/configs/znc.conf
// WARNING
//
// Do NOT edit this file while ZNC is running!
// Use webadmin or *controlpanel instead.
//
// Buf if you feel risky, you might want to read help on /znc saveconfig and /znc rehash.
// Also check http://en.znc.in/wiki/Configuration

Version = 1.0
&lt;Listener l&gt;
        Port = 6668
        IPv4 = true
        IPv6 = false
        SSL = true
        Host = 192.168.0.8
&lt;/Listener&gt;

&lt;User hoge&gt;
        Pass       = sha256#...#...#
        Admin      = true
        Nick       = hoge
        AltNick    = hoge_
        Ident      = hoge
        RealName   = fuga
        Buffer     = 50
        AutoClearChanBuffer = true
        ChanModes  = +stn


        &lt;Network hogeirc&gt;

                Server     = 192.168.0.7 +6669 aiueo

                &lt;Chan #atchan&gt;
                &lt;/Chan&gt;
        &lt;/Network&gt;
&lt;/User&gt;
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">znc_enable</span><span class="o">=</span><span class="s">"YES"</span>
<span class="n">znc_user</span><span class="o">=</span><span class="s">"znc"</span>
<span class="n">znc_conf_dir</span><span class="o">=</span><span class="s">"/home/znc/.znc"</span>

<span class="c"># service znc start</span>
</pre></div>
</div>
<div class="section" id="weechat">
<h2>WeeChat</h2>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/02/freebsd_irc_znc.html#weechat">WeeChat</a>」で「<a class="reference external" href="http://wiki.znc.in/ZNC">ZNC</a>」に接続するには</p>
<div class="highlight-python"><div class="highlight"><pre>/server add hoge irc.hoge.localnet/6668 -ssl -username=hoge -password=hogepassword
/connect hoge
/disconnect hoge
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.weechat.org">http://www.weechat.org/</a></li>
<li><a class="reference external" href="http://wiki.znc.in/Weechat">http://wiki.znc.in/Weechat</a></li>
<li><a class="reference external" href="http://wiki.znc.in/Using_commands">http://wiki.znc.in/Using_commands</a></li>
</ul></div>]]></description>
            <category><![CDATA[ znc ]]></category>
             <pubDate>Mon, 02 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/01/freebsd_irc_ngircd.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/01/freebsd_irc_ngircd.html</guid>
            <title><![CDATA[ngircdでIRCサーバ]]></title>
            <description><![CDATA[<h1>ngircdでIRCサーバ</h1>
<p>IT系のアルバイトをしていたときにNagios,Zabbixなどから定期的にメールがバンバン飛んできて、未読が4万通くらいになってメーラーを立ち上げるのを諦めたことがある。なんでもかんでもメールで飛ばすのは嫌いだ。メール振り分けなどの作業を各々がやらなければいけないなんて時間のムダだし、集約できる情報を各々にわざわざ管理させ余計な負担を強いているのがイケてないと私はいつも思っている。</p>
<p>このイライラをIRCは解決してくれる。IRCはチャットとして使うよりも、情報を集約させるのに非常に便利である。Nagiosのアラート,SSHのログイン情報などをIRCにポストするようにしている。IRCを積極的に使っている会社に勤めたことがないので個人でひっそりとやっているだけだが、IRCを眺めれば何が起っているかわかり、いい感じである。</p>
<p>「つかれた」とポストしたら返事をしてくれる(妹)BOTを仕込んで荒んだ心を癒すことも出来る。</p>
<p>今回はIRCサーバ(<a class="reference external" href="http://ngircd.barton.de">ngircd</a>)の構築を行う。</p>
<div class="highlight-python"><div class="highlight"><pre># ngircd -V
ngIRCd 20.2-IPv6+IRCPLUS+SSL+SYSLOG+TCPWRAP+ZLIB-amd64/portbld/freebsd9.1
Copyright (c)2001-2013 Alexander Barton (&lt;alex@barton.de&gt;) and Contributors.
Homepage: &lt;http://ngircd.barton.de/&gt;

This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /usr/local/etc</span>
<span class="c"># touch ngircd.conf</span>
<span class="c"># yes | ngircd -t | tee ngircd.conf</span>
<span class="c"># echo "SUPER SONIKO" | tee ngircd.motd</span>
<span class="c"># cp ngircd.conf ngircd.conf.org</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># mkdir ngircd_ssl
# cd ngircd_ssl

# openssl dhparam -out dhparams.pem 2048.
# openssl req -newkey rsa:2048 -x509 -keyout server-key.pem -out server-cert.pem -days 3650
writing new private key to 'server-key.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:
State or Province Name (full name) [Some-State]:
Locality Name (eg, city) []:
Organization Name (eg, company) [Internet Widgits Pty Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:
Email Address []:
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># diff -u ngircd.conf.org ngircd.conf
--- ngircd.conf.org     2013-08-31 12:44:37.665880056 +0900
+++ ngircd.conf 2013-08-31 12:45:03.457801026 +0900
@@ -1,17 +1,17 @@
 [GLOBAL]
-  Name =
+  Name = irc.hoge.localnet
   AdminInfo1 =
   AdminInfo2 =
-  AdminEMail =
+  AdminEMail = hoge@mail.localnet
   Info = ngIRCd 20.2
   Listen = ::,0.0.0.0
   MotdFile = /usr/local/etc/ngircd.motd
   MotdPhrase =
-  Password =
+  Password = aiueo
   PidFile =
   Ports = 6667
-  ServerGID = wheel
-  ServerUID = root
+  ServerGID = nobody
+  ServerUID = nobody

 [LIMITS]
   ConnectRetry = 60
@@ -28,10 +28,10 @@
   ChrootDir =
   CloakHost =
   CloakHostModeX =
-  CloakHostSalt = salt_mogemoge
+  CloakHostSalt = salt_fugafuga
   CloakUserToNick = no
   ConnectIPv4 = yes
-  ConnectIPv6 = yes
+  ConnectIPv6 = no
   DNS = yes
   MorePrivacy = no
   NoticeAuth = no
@@ -45,9 +45,9 @@
   WebircPassword =

 [SSL]
-  CertFile =
-  DHFile =
-  KeyFile =
-  KeyFilePassword =
-  Ports =
+  CertFile = /usr/local/etc/ngircd_ssl/server-cert.pem
+  DHFile = /usr/local//etc/ngircd_ssl/dhparams.pem
+  KeyFile = /usr/local/etc/ngircd_ssl/server-key.pem
+  KeyFilePassword = kakikukeko
+  Ports = 6669
</pre></div>
</div>
<p>設定ファイルのチェックをするオプションがあるので、これを使い設定をチェックする。下記のように表示されれば設定は問題ない。</p>
<div class="highlight-python"><div class="highlight"><pre># ngircd -t
ngIRCd 20.2-IPv6+IRCPLUS+SSL+SYSLOG+TCPWRAP+ZLIB-amd64/portbld/freebsd9.1
Copyright (c)2001-2013 Alexander Barton (&lt;alex@barton.de&gt;) and Contributors.
Homepage: &lt;http://ngircd.barton.de/&gt;

This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Reading configuration from "/usr/local/etc/ngircd.conf" ...
OK, press enter to see a dump of your server configuration ...
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">ngircd_enable</span><span class="o">=</span><span class="s">"YES"</span>

<span class="c"># service ngircd start</span>
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://ngircd.barton.de/documentation.php.en">http://ngircd.barton.de/documentation.php.en</a></li>
</ul>]]></description>
            <category><![CDATA[ ngircd ]]></category>
             <pubDate>Sun, 01 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/31/freebsd_nginx_virtualhost.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/31/freebsd_nginx_virtualhost.html</guid>
            <title><![CDATA[Nginxでバーチャルホスト]]></title>
            <description><![CDATA[<h1>Nginxでバーチャルホスト</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html"><em>packages配布サーバ構築</em></a>」で課題にしていたnginxでのバーチャルホストの設定を行う。</p>
<p>バーチャルホストには</p>
<ul class="simple"><li><strong>IPベース</strong>: 1台のサーバに対して複数のドメイン,IPアドレスで運用する。</li>
<li><strong>名前ベース</strong>: 1台のサーバに対して複数のドメインを1つのIPアドレスで共用する。</li>
</ul><p>の2種類がある。</p>
<p>今回は「名前ベース」のバーチャルホストを設定する。</p>
<div class="section" id="dnsmasq">
<h2>dnsmasq</h2>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html"><em>前回構築したDNSサーバ</em></a>に名前を登録する。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/hosts
192.168.0.5 srv.localnet
192.168.0.5 packages.localnet

# service dnsmasq restart
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>Nginx</h2>
<p>nginxのほうも「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html"><em>dnsmasqを使ったDNSサーバ</em></a>」と同じようにDebian Aapache2風のディレクトリ構成をとる。最低限の設定しか載せていないので、他のパラメータはドキュメントを眺めながら各自で設定して欲しい。</p>
<div class="highlight-python"><div class="highlight"><pre># nginx -v
nginx version: nginx/1.4.2
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># cd /usr/local/etc/nginx
# mkdir sites-available sites-enabled

# vi nginx.conf
http {
  include /usr/local/etc/nginx/sites-enabled/*;
}

# vi sites-available/packages.localnet
server {
    listen 80;
    server_name packages.localnet;

    autoindex on;

    location / {
        root   /var/packages;
        index  index.html;
    }
}

# vi sites-avaliable/srv.localnet
server {
    listen       80;
    server_name  srv.localnet;

    location / {
        root   /usr/local/www/nginx;
        index  index.html index.htm;
    }
}

# cd sites-enabled
# ln -s ../sites-available/packages.localnet
# ln -s ../sites-available/srv.localnet

# service nginx start
</pre></div>
</div>
<p>packages.localnetにアクセスするとpackagesが見え、srv.localnetにアクセスするとnginxのインデックスページが見えれば名前ベースバーチャルホストの設定は完了である。</p>
<ul class="simple"><li><a class="reference external" href="http://ja.wikipedia.org/wiki/バーチャルホスト">http://ja.wikipedia.org/wiki/バーチャルホスト</a></li>
<li><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#server">http://nginx.org/en/docs/http/ngx_http_core_module.html#server</a></li>
</ul></div>]]></description>
            <category><![CDATA[ nginx ]]></category>
             <pubDate>Sat, 31 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html</guid>
            <title><![CDATA[dnsmasqを使ったDNSサーバ]]></title>
            <description><![CDATA[<h1>dnsmasqを使ったDNSサーバ</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html"><em>packages配布サーバ構築</em></a>」で課題にしていたDNSサーバ構築を行う。DNSサーバというとBINDや<a class="reference external" href="http://www.nlnetlabs.nl/projects/nsd">NSD</a>などが思い浮ぶだろうが、これらを使うのは腰が重い(とくにBIND、またはBIND、あるいはBIND)。</p>
<p><a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq">dnsmasq</a>は少しの設定ファイル変更とhosts(5)を書くだけでDNSサーバとして機能する。DHCP,TFTPサーバの機能も持っており、PXE Bootなどに使え非常に勝手がいい。</p>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html"><em>nullfsを使いjailのportsを共有する</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html"><em>portsのパッケージをビルドする環境を構築する</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html"><em>packages配布サーバ構築</em></a></li>
</ul><div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs clone jails/test01@base jails/dns</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/jail.conf
dns {
        $if = 6;
        $ipaddr = 192.168.0.6;
}
</pre></div>
</div>
<div class="section" id="dns">
<h2>dns</h2>
<p>dnsmasqのpackagesはbuildboxで作成し、自前のpackages配布サーバを環境変数を設定しておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># pkg_add -r dnsmasq</span>
<span class="c"># cd /usr/local/etc</span>
<span class="c"># cp dnsmasq.conf.example dnsmasq.conf</span>
</pre></div>
</div>
<p>dnsmasq.confはdnsmasq.dディレクトリ下のファイルを読み込む設定だけ有効にしておく。dnsmasq.confは600行くらいろいろ書いてあるので必要な設定項目だけをdnsmasq.dディレクトリ下に書いて管理したほうが設定を見通しやすい。Debian Apache風にavailableディレクトリに設定ファイルを置き、有効にしたい設定だけをenableディレクトリにシンボリックリンクを貼る。これで設定ファイルの切り替えが楽になる。</p>
<div class="highlight-python"><div class="highlight"><pre># cd /usr/local/etc
# mkdir -p dnsmasq.d/dnsmasq-available
# mkdir -p dnsmasq.d/dnsmasq-enabled

# vi dnsmasq.conf
conf-dir=/usr/local/etc/dnsmasq.d/dnsmasq-enabled
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi dnsmasq.d/dnsmasq-avalilable/dns.conf

# Never forward plain names (without a dot or domain part)
domain-needed

# Never forward addresses in the non-routed address spaces.
bogus-priv

# Add local-only domains here, queries in these domains are answered
# from /etc/hosts or DHCP only.
local=/localnet/

# Set this (and domain: see below) if you want to have a domain
# automatically added to simple names in a hosts-file.
expand-hosts

# Set the domain for dnsmasq. this is optional, but if it is set, it
# does the following things.
# 1) Allows DHCP hosts to have fully qualified domain names, as long
#     as the domain part matches this setting.
# 2) Sets the "domain" DHCP option thereby potentially setting the
#    domain of all systems configured by DHCP
# 3) Provides the domain part for "expand-hosts"
domain=localnet
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd dnsmasq.d/dnsmasq-enabled</span>
<span class="c"># ln -s ../dnsmasq-available/dns.conf</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/hosts
192.168.0.5 pkgsrv.localnet
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">dnsmasq_enable</span><span class="o">=</span><span class="s">"YES"</span>

<span class="c"># service dnsmasq start</span>
</pre></div>
</div>
<p>これで自前のpackages配布サーバを名前で引けるようになった。あとはresolv.confにdnsmasqが動いているサーバを指定するだけである。</p>
<ul class="simple"><li><a class="reference external" href="http://d.hatena.ne.jp/int128/20120226/1330247800">http://d.hatena.ne.jp/int128/20120226/1330247800</a></li>
</ul></div>]]></description>
            <category><![CDATA[ dnsmasq ]]></category>
             <pubDate>Fri, 30 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html</guid>
            <title><![CDATA[packages配布サーバ構築]]></title>
            <description><![CDATA[<h1>packages配布サーバ構築</h1>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html"><em>前回</em></a>はpackagesを作成する環境を構築した。</p>
<p>今回は作成したpackagesを各FreeBSDマシンに配布する環境を構築する。</p>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html"><em>nullfsを使いjailのportsを共有する</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html"><em>portsのパッケージをビルドする環境を構築する</em></a></li>
</ul><p>jails/pkg/packagesにpackagesが作られているので配布サーバ用jailにリードオンリーでマウントしてWebサーバ(nginx)を動かすだけの簡単なお仕事である。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs clone jails/test01@base jails/pkgsrv</span>
<span class="c"># mkdir /jails/pkgsrv/var/packages</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/jail.conf
test02 {
        $if = 2;
        $ipaddr = 192.168.0.2;
}

pkgsrv {
        exec.prestart += "mount -t nullfs -o ro /jails/pkg/packages /jails/${name}/var/packages";
        exec.poststop += "umount /jails/${name}/var/packages";
        $if = 5;
        $ipaddr = 192.168.0.5;
}
</pre></div>
</div>
<div class="section" id="pkgsrv">
<h2>pkgsrv</h2>
<p>pkgsrvにpackagesのnginxをインストールするためbuildboxでnginxをビルドしておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /var/packages/Latest</span>
<span class="c"># pkg_add nginx</span>

<span class="c"># cd /usr/local/nginx</span>
<span class="c"># cp nginx.conf nginx.conf.bak</span>

<span class="c"># mkdir /var/tmp/nginx</span>
<span class="c"># touch /var/tmp/nginx/client_body_temp</span>
</pre></div>
</div>
<p>serverブロックに以下のように書いていればとりあえず目的は達成できる。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /usr/local/nginx/nginx.conf
server {
        autoindex on;

        location / {
            root   /var/packages;
            index  index.html index.htm;
            allow 192.168.0.0/24;
            deny all;
        }
}
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># nginx -t
nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok
nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful

# service nginx onestart
</pre></div>
</div>
</div>
<div class="section" id="test02">
<h2>test02</h2>
<p>pkg_add(1)は環境変数を設定することで取得するpackagesのサーバを指定できる。環境変数の設定方法は調べればいくらでも引っ掛かるのでcshでの設定のみ書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre># vi .cshrc
setenv PACKAGEROOT http://192.168.0.5/
setenv PACKAGESITE http://192.168.0.5/Latest/

# source .cshrc
# pkg_add -r wget
</pre></div>
</div>
<p>packages配布サーバの構築は無事に完了した。ただ、IP直打ちだと配布サーバのIPを変更したとき環境変数を書き換えなければならず面倒だし、nginxを配布サーバ以外のことにも使いたい。</p>
<p>というわけで</p>
<ul class="simple"><li>DNSサーバの構築</li>
<li>nginx バーチャルホストの設定</li>
</ul><p>を課題としておく。</p>
</div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ nginx ]]></category>
             <pubDate>Thu, 29 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html</guid>
            <title><![CDATA[portsのパッケージをビルドする環境を構築する]]></title>
            <description><![CDATA[<h1>portsのパッケージをビルドする環境を構築する</h1>
<p>FreeBSDを複数台動かす場合、パッケージをどのような手段でインストールするか考えることになると思う。</p>
<p>FreeBSDでのパッケージのインストールは</p>
<ul class="simple"><li><strong>ports</strong>: ソースコードをコンパイルしてインストール</li>
<li><strong>packages</strong>:  コンパイル済みのバイナリをインストール</li>
</ul><p>の2種類が用意されている。</p>
<p>それぞれのFreeBSDにあるportsからパッケージをインストールするのは面倒だし、コンパイルオプションの指定ミスなどが発生したとき原因調査に時間を取られて泣きをみることは間違いない。</p>
<p>というわけでpackagesを使いFreeBSDマシンにパッケージをインストールする。packagesはFreeBSDから提供されているが、portsからも作成できる。portsからだとコンパイルオプションを自分の好きなようにカスタマイズしたpackagesを作ることが出来る。ただし、portsからpackagesを作成するにはパッケージをインストールしなければならない。</p>
<p>FreeBSDでは自前のpackagesを作成するツールとして「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」が存在する。「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」は様々なユーザーランド,portsを組み合わせビルド環境を作り、packagesを作成してくれる。WebUIも供えておりpackagesにしたいパッケージを登録すれば勝手にビルドしていく。4.0.0からDBにSQLiteが使えるようになり導入のハードルがグッと下っているので気になったら触ってみて欲しい。</p>
<p>今回は「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」は使わず、「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」の動きを真似たビルド環境を自分で構築することにした。下記の記事のような環境がすでに出来ているものとする。</p>
<ul class="simple"><li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html"><em>nullfsを使いjailのportsを共有する</em></a></li>
</ul><div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs create jails/pkg</span>
<span class="c"># zfs create jails/buildbox</span>

<span class="c"># cd /usr/src/9.1.0</span>
<span class="c"># make buildworld</span>
<span class="c"># make installworld DESTDIR=/jails/buildbox</span>
<span class="c"># make distribution DESTDIR=/jails/buildbox</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir /jails/buildbox/usr/ports</span>
<span class="c"># mkdir /jails/buildbox/var/ports</span>
<span class="c"># cd /jails/pkg</span>
<span class="c"># mkdir distfiles packages coptions</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /jails/buildbox//etc/resolv.conf
nameserver 8.8.8.8
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /jails/buildbox/etc/make.conf
WRKDIRPREFIX = /var/ports/
DISTDIR = /var/ports/distfiles/
PACKAGES = /var/ports/packages/
PORT_DBDIR = /var/ports/coptions/
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/jail.conf
buildbox {
        exec.prestart += "mount -t nullfs /jails/pkg /jails/${name}/var/ports";
        exec.poststop += "umount /jails/${name}/var/ports";
        $if = 4;
        $ipaddr = 192.168.0.4;
}
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs snapshot jails/pkg@base</span>
<span class="c"># zfs snapshot jails/buildbox@base</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># jail -c buildbox</span>
</pre></div>
</div>
<p>書いてある設定でピンときたでしょうが、ビルド作業用ディレクトリを別にマウントしてbuildboxのほうはzfs rollbackでいつでも初期状態に戻せるようにしているだけである。</p>
<p>あとはjail環境で</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /usr/ports/ftp/wget</span>
<span class="c"># make config-recursive</span>
<span class="c"># make install</span>
<span class="c"># make package-recursive</span>
</pre></div>
</div>
<p>すれば/jails/pkg/packagesにpackagesが作られる。</p>
<p>packagesをどう配布するかは次の機会に。(調べればすぐに見付かるけど...)</p>
<ul class="simple"><li><a class="reference external" href="http://ftp.marcuscom.com">http://ftp.marcuscom.com/</a></li>
</ul>]]></description>
            <category><![CDATA[ freebsd ]]></category>
             <pubDate>Wed, 28 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html</guid>
            <title><![CDATA[nullfsを使いjailのportsを共有する]]></title>
            <description><![CDATA[<h1>nullfsを使いjailのportsを共有する</h1>
<p>jailを複数動かしているとports(Ports Collection)をどのように取り扱うかという壁にブチ当たると思う。jailごとにportsnap fetchしているとportsnapサーバに負荷がかかるし、管理が面倒くさい。ということでjailのportsは共有し、ホストからしかfetch,updateなどが出来ないようにしてみた。</p>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>前回</em></a>からの続きということで。</p>
<div class="highlight-python"><div class="highlight"><pre># cd 9.1.0/sys/amd64/conf
# cp VIMAGE NULLFS

# vi VIMAGE
options         NULLFS

# cd /usr/src/9.1.0
# make buildkernel KERNCONF=NULLFS
# make installkernel KERNCONF=NULLFS
# reboot
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs create jails/ports</span>
<span class="c"># portsnap -p /jails/ports fetch</span>
<span class="c"># portsnap -p /jails/ports extract</span>
<span class="c"># portsnap -p /jails/ports update</span>
</pre></div>
</div>
<p>設定があちこちに散らばると管理が面倒なのでnullfsのマウントはホストのfstabではなくjail.conf(5)に書く。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/jail.conf

exec.prestart  = "ifconfig epair${if} create up &gt; /dev/null";
exec.prestart += "ifconfig vswitch0 addm epair${if}a";
exec.prestart += "mount -t nullfs -o ro /jails/ports /jails/${name}/usr/ports";
exec.start     = "ifconfig lo0 up 127.0.0.1";
exec.start    += "ifconfig epair${if}b up $ipaddr";
exec.start    += "route add default 192.168.0.254";
exec.start    += "sh /etc/rc";
exec.stop      = "sh /etc/rc.shutdown";
exec.poststop  = "ifconfig epair${if}a destroy";
exec.poststop += "umount /jails/${name}/usr/ports";
host.hostname = "${name}.localnet";
mount.devfs;
devfs_ruleset = 5;
vnet;
vnet.interface = "epair${if}b";
path = "/jails/${name}";
persist;

test01 {
        $if = 1;
        $ipaddr = 192.168.0.1;
}

test02 {
        $if = 2;
        $ipaddr = 192.168.0.2;
}
</pre></div>
</div>
<p>portsをリードオンリーでマウントしているのでビルド時の作業用ディレクトリが作成できない。そのためjail環境のmake.conf(5)に作業ディレクトリの指定、ディレクトリを作成する必要がある。設定した環境変数の説明はports(5)に書いてある。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /jails/test01/etc/make.conf

WRKDIRPREFIX = /var/ports/
DISTDIR = /var/ports/distfiles/
PACKAGES = /var/ports/packages/

# mkdir -p /jails/test01/var/ports/distfiles
# mkdir -p /jails/test01/var/ports/packages
</pre></div>
</div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ jail ]]></category>
             <pubDate>Fri, 23 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html</guid>
            <title><![CDATA[FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築]]></title>
            <description><![CDATA[<h1>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</h1>
<p>VIMAGE + ZFSでいくらでも作ったり、壊したり、巻き戻したり出来る環境を構築してみる。jail環境をビルドするためにソースを取ってくる。ソースはsubversionで管理されている。まずsubversionをインストールから。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># portsnap fetch</span>
<span class="c"># portsnap extract</span>
<span class="c"># portsnap update</span>

<span class="c"># cd /usr/ports/devel/subversion</span>
<span class="c"># make install</span>
</pre></div>
</div>
<p>VIMAGEが使えるようにカーネルを再構築する。</p>
<div class="highlight-python"><div class="highlight"><pre># cd /usr/src
# svn checkout svn://svn.freebsd.org/base/release/9.1.0
# cd 9.1.0/sys/amd64/conf
# cp GENERIC VIMAGE

# vi VIMAGE
options         VIMAGE

# cd /usr/src/9.1.0
# make buildkernel KERNCONF=VIMAGE
# make installkernel KERNCONF=VIMAGE
# reboot
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /usr/src/9.1.0</span>
<span class="c"># make buildworld</span>
<span class="c"># make installworld DESTDIR=/jails/test01</span>
<span class="c"># make distribution DESTDIR=/jails/test01</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># zpool list
NAME    SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
jails   356G   900M   355G     0%  1.00x  ONLINE  -

# zfs create jails/test01
# zfs snapshot jails/test01@base
# zfs clone jails/test01@base jails/test02
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>

<span class="n">ifconfig_re0</span><span class="o">=</span><span class="s">" inet 192.168.0.253 netmask 255.255.255.0"</span>
<span class="n">defaultrouter</span><span class="o">=</span><span class="s">"192.168.0.254"</span>

<span class="n">cloned_interfaces</span><span class="o">=</span><span class="s">"bridge0"</span>
<span class="n">ifconfig_bridge0_name</span><span class="o">=</span><span class="s">"vswitch0"</span>
<span class="n">ifconfig_vswitch0</span><span class="o">=</span><span class="s">"addm re0"</span>
</pre></div>
</div>
<p>netstatしたときなどに/dev/kmem,/dev/memがないよと言われるので、/etc/default/devfs.rulesを参考に、devfs.rules(5)のルールを追加しておく。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/devfs.rules

[devfsrules_jail=5]
add include $devfsrules_hide_all
add include $devfsrules_unhide_basic
add include $devfsrules_unhide_login
add path zfs unhide
add path mem unhide
add path kmem unhide
</pre></div>
</div>
<p>jailの設定はrc.conf(5)ではなくjail.conf(5)に書く。jail(8)を眺めながら設定ファイルを書いてみた。変数が使えていい感じ。ネームサーバーを設定するパラメータが見当らないので、ネームサーバーの設定はjail内のresolv.confに書くことにする。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/jail.conf

exec.prestart  = "ifconfig epair${if} create up &gt; /dev/null";
exec.prestart += "ifconfig vswitch0 addm epair${if}a";
exec.start     = "ifconfig lo0 up 127.0.0.1";
exec.start    += "ifconfig epair${if}b up $ipaddr";
exec.start    += "route add default 192.168.0.254";
exec.start    += "sh /etc/rc";
exec.stop      = "sh /etc/rc.shutdown";
exec.poststop  = "ifconfig epair${if}a destroy";
host.hostname  = "${name}.localnet";
mount.devfs;
devfs_ruleset = 5;
vnet;
vnet.interface = "epair${if}b";
path = "/jails/${name}";
persist;

test01 {
        $if = 1;
        $ipaddr = 192.168.0.1;
}

test02 {
        $if = 2;
        $ipaddr = 192.168.0.2;
}
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># jail -c test01
# jls
   JID  IP Address      Hostname                      Path
    11  -               test01.localnet               /jails/test01

# jexec 11 tcsh
# jail -r test01
</pre></div>
</div>
<p>FreeBSD起動時にjailを起動させたければrc.conf(5)下記のように書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>

<span class="n">jail_enable</span><span class="o">=</span><span class="s">"YES"</span>
<span class="n">jail_list</span><span class="o">=</span><span class="s">"test01 test02"</span>
</pre></div>
</div>
<p>ZFSのスナップショット、ロールバックで何度でもやり直せる。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs snapshot jails/test01@snap01</span>
<span class="c"># zfs rollback jails/test01@snap01</span>
<span class="c"># zfs set quota=10g jails/test01</span>
<span class="c"># zfs clone jails/test01@snap01 jails/test03</span>
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.freebsd.org/doc/ja/books/handbook/svn-mirrors.html">http://www.freebsd.org/doc/ja/books/handbook/svn-mirrors.html</a></li>
<li><a class="reference external" href="http://www.freebsd.org/doc/ja/books/handbook/kernelconfig-building.html">http://www.freebsd.org/doc/ja/books/handbook/kernelconfig-building.html</a></li>
</ul>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ jail ]]></category>
            <category><![CDATA[ zfs ]]></category>
             <pubDate>Thu, 22 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html</link>
            <guid>http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html</guid>
            <title><![CDATA[シェルスクリプトでFreeBSD 9.1のインストール自動化]]></title>
            <description><![CDATA[<h1>シェルスクリプトでFreeBSD 9.1のインストール自動化</h1>
<p>OSインストールをするだけでお金が貰えるならば喜んでやるが、趣味の時間をOSインストールに奪われるのはつらいので、自動化してみた。</p>
<div class="section" id="pxe-boot">
<h2>PXE boot サーバ構築</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mdconfig -a -t vnode -f FreeBSD-9.1-RELEASE-amd64-disc1.iso</span>
<span class="n">md0</span>
<span class="c"># mount_cd9660 /dev/md0 /mnt</span>
<span class="c"># mkdir /var/pxeboot</span>
<span class="c"># cp -Rv /mnt/ /var/pxeboot</span>
<span class="c"># umount /mnt</span>
<span class="c"># mdconfig -d -u 0</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/pxeboot/etc/fstab</span>
<span class="c"># /dev/iso9660/FREEBSD_INSTALL / cd9660 ro 0 0 &lt;- コメントアウト</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/inetd.conf
tftp    dgram   udp     wait    root    /usr/libexec/tftpd      tftpd -l -s /var/pxeboot/boot

# /etc/rc.d/inetd onestart
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># cd /usr/ports/net/isc-dhcp42-server
# make install

# vi /usr/local/etc/dhcpd.conf
ddns-update-style none;
server-name "pxeboot";            # name of the tftp-server
server-identifier 192.168.0.253;  # address of the tftp-server
next-server 192.168.0.253;        # address of the NFS-server

subnet 192.168.0.0 netmask 255.255.255.0 {
    range 192.168.0.220 192.168.0.250;
    option routers 192.168.0.254;
    option root-path "/var/pxeboot"; # root-path for NFS
    filename "pxeboot";              # filename of NBP (network bootstrap program)
}

# /usr/local/etc/rc.d/isc-dhcpd onestart
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/exports
/var/pxeboot -alldirs -maproot=root

# /etc/rc.d/nfsd onestart
</pre></div>
</div>
<p>再起動後もデーモンを起動させておきたければrc.confに書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">inetd_enable</span><span class="o">=</span><span class="s">"YES"</span>
<span class="n">dhcpd_enable</span><span class="o">=</span><span class="s">"YES"</span>
<span class="n">dhcpd_ifaces</span><span class="o">=</span><span class="s">"em0"</span>
<span class="n">nfs_server_enable</span><span class="o">=</span><span class="s">"YES"</span>
</pre></div>
</div>
</div>
<div class="section" id="freebsd">
<h2>FreeBSDインストールスクリプト</h2>
<p>PXE BootしたマシンのMACアドレスが書かれたシェルスクリプトを探し、実行するようになっている。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir /var/scripts/freebsd91</span>
<span class="c"># cd /usr/freebsd-dist</span>
<span class="c"># cp *.txz /var/scripts/freebsd91</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/pxeboot/var/scripts/os_install.sh</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/sh</span>

get_conf<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"FreeBSD"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">"`ifconfig | awk '/ether/ {print $NF}'`"</span>
  <span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"Linux"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">"`ifconfig | awk '/HWaddr/ {print $NF}'`"</span>
  <span class="k">fi</span>

<span class="k">  for </span>a in <span class="nv">$MACADDR</span>; <span class="k">do</span>
<span class="k">    </span>grep -r <span class="nv">$MACADDR</span> <span class="k">${</span><span class="nv">CWD</span><span class="k">}</span>/*.conf | awk -F: <span class="s1">'{print $1}'</span>
  <span class="k">done</span>
<span class="o">}</span>

<span class="nv">CWD</span><span class="o">=</span><span class="sb">`</span>dirname <span class="nv">$0</span><span class="sb">`</span>

<span class="nv">OS</span><span class="o">=</span><span class="sb">`</span>uname<span class="sb">`</span>
<span class="nv">CONFFILE</span><span class="o">=</span><span class="sb">`</span>get_conf<span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> -z <span class="s2">"$CONFFILE"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nb">printf</span> <span class="s1">'Script Not Found\n'</span>
  <span class="nb">exit </span>1
<span class="k">fi</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"FreeBSD"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($1 ~ /^default$/) print $6}'</span><span class="sb">`</span>
  <span class="nv">MOUNTNAME</span><span class="o">=</span><span class="sb">`</span>sha256 -q <span class="nv">$CONFFILE</span><span class="sb">`</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"Linux"</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($4 ~ /^UG$/) print $8}'</span><span class="sb">`</span>
  <span class="nv">MOUNTNAME</span><span class="o">=</span><span class="sb">`</span>sha256sum <span class="nv">$CONFFILE</span> | awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="k">fi</span>

<span class="nv">$CONFFILE</span> <span class="nv">$IFACE</span> <span class="nv">$CWD</span> <span class="nv">$MOUNTNAME</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/pxeboot/var/scripts/freebsd_install.conf</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/sh</span>

<span class="c"># 01:23:45:67:89:ab</span>

<span class="nv">DISK</span><span class="o">=</span>ada0
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">CWD</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">CHROOT_FREEBSD</span><span class="o">=</span><span class="s2">"/mnt/$3"</span>
<span class="nv">DIST_TXZ</span><span class="o">=</span><span class="sb">`</span>ls <span class="k">${</span><span class="nv">CWD</span><span class="k">}</span>/freebsd91/*.txz<span class="sb">`</span>

gpart destroy -F <span class="nv">$DISK</span>
gpart create -s gpt <span class="nv">$DISK</span>
gpart add -s 64K -t freebsd-boot <span class="nv">$DISK</span>
gpart add -s 8G -t freebsd-swap -l swap0 <span class="nv">$DISK</span>
gpart add -t freebsd-ufs <span class="nv">$DISK</span>
gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 <span class="nv">$DISK</span>

newfs -U /dev/<span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>p3

mkdir <span class="nv">$CHROOT_FREEBSD</span>

mount /dev/<span class="k">${</span><span class="nv">DISK</span><span class="k">}</span>p3 <span class="nv">$CHROOT_FREEBSD</span>

<span class="nb">cd</span> <span class="nv">$CHROOT_FREEBSD</span>

<span class="k">for </span>FILE in <span class="nv">$DIST_TXZ</span>; <span class="k">do</span>
<span class="k">  </span>tar xfzp <span class="nv">$FILE</span>
<span class="k">done</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_FREEBSD}/etc/rc.conf</span>
<span class="s">hostname="freebsd.local"</span>
<span class="s">keymap="us.iso.kbd"</span>
<span class="s">ifconfig_${IFACE}=" inet 192.168.0.252 netmask 255.255.255.0"</span>
<span class="s">defaultrouter="192.168.0.254"</span>
<span class="s">sshd_enable="YES"</span>
<span class="s"># Set dumpdev to "AUTO" to enable crash dumps, "NO" to disable</span>
<span class="s">dumpdev="AUTO"</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_FREEBSD}/etc/resolv.conf</span>
<span class="s">nameserver 8.8.8.8</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_FREEBSD}/etc/fstab</span>
<span class="s"># Device        Mountpoint      FStype  Options Dump    Pass#</span>
<span class="s">/dev/${DISK}p3     /               ufs     rw      1       1</span>
<span class="s">/dev/${DISK}p2     none            swap    sw      0       0</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; EOF &gt; ${CHROOT_FREEBSD}/tmp/freebsd_setup.sh</span>
<span class="s">newaliases</span>
<span class="s">touch /etc/wall_cmos_clock</span>
<span class="s">tzsetup Asia/Tokyo</span>

<span class="s">dumpon /dev/${DISK}p2</span>
<span class="s">ln -sf /dev/${DISK}p2 /dev/dumpdev</span>
<span class="s">EOF</span>

cat <span class="s">&lt;&lt; 'EOF' &gt; ${CHROOT_FREEBSD}/tmp/user_acount.sh</span>
<span class="s">printf "$6$oHUVG9WPkdiCoxCP$XsnO5TmowzdGWNkZHv9pPUmFqgsEojkfzUa1OQj2zUOWAChL5cdGkm.dhseF0z5Tz30IEDrxNzOcsflPUgHDs." | pw usermod -n root -H 0</span>

<span class="s">pw useradd -n nanashi -s /bin/tcsh -G wheel -m</span>
<span class="s">printf "$6$wAeDl/exZFEDC0Sl$UdvTamL.94EcWFcGIAYJSgsvzaFxSd.ZLRMkD.KI27L6jxUGsWqOdEJs6if0rTG/XuEfQ9TNzHbjI99YfxPLD1" | pw usermod -n nanashi -H 0</span>
<span class="s">EOF</span>

mount -t devfs dev <span class="k">${</span><span class="nv">CHROOT_FREEBSD</span><span class="k">}</span>/dev

chroot <span class="nv">$CHROOT_FREEBSD</span> /bin/sh /tmp/freebsd_setup.sh
chroot <span class="nv">$CHROOT_FREEBSD</span> /bin/sh /tmp/user_acount.sh

rm <span class="k">${</span><span class="nv">CHROOT_FREEBSD</span><span class="k">}</span>/tmp/freebsd_setup.sh
rm <span class="k">${</span><span class="nv">CHROOT_FREEBSD</span><span class="k">}</span>/tmp/user_acount.sh

<span class="nb">cd</span> /
umount <span class="k">${</span><span class="nv">CHROOT_FREEBSD</span><span class="k">}</span>/dev
umount <span class="nv">$CHROOT_FREEBSD</span>

rmdir <span class="nv">$CHROOT_FREEBSD</span>
reboot
</pre></div>
</div>
<p>PXE boot時に指定のスクリプトを実行するようにrc.localに書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /var/pxeboot/etc/rc.local

#!/bin/sh
# $FreeBSD: release/9.1.0/release/rc.local 232427 2012-03-03 02:13:53Z nwhitehorn $

/var/script/os_install.sh
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY_2013022201">https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY_2013022201</a></li>
<li><a class="reference external" href="http://stefankonarski.de/content/freebsd-9-pxe-boot-und-bsdinstall-installieren">http://stefankonarski.de/content/freebsd-9-pxe-boot-und-bsdinstall-installieren</a></li>
</ul></div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ pxeboot ]]></category>
             <pubDate>Sat, 20 Jul 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/22/centos_cobbler_puppet_install.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/22/centos_cobbler_puppet_install.html</guid>
            <title><![CDATA[Cobbler + Puppet]]></title>
            <description><![CDATA[<h1>Cobbler + Puppet</h1>
<p>前回はCobblerでとりあえずOSインストールが出来るところまでやったので、今回はkickstartファイルの編集、Puppet(Puppet client)のインストールとセットアップを自動化してみる。</p>
<div class="section" id="dnsmasq">
<h2>dnsmasq</h2>
<p>DHCP,DNSサーバにdnsmasqを使用する。ISC DHCPよりもdnsmasqを使ったほうがPuppetと連携させやすいことに気が付いた。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/cobbler/settings

manage_dns: 1
manage_dhcp: 1
server: 192.168.0.1
next_server: 192.168.0.254 &lt;- Gateway
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/cobbler/modules.conf</span>

<span class="p">[</span><span class="n">dns</span><span class="p">]</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">manage_dnsmasq</span>

<span class="p">[</span><span class="n">dhcp</span><span class="p">]</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">manage_dnsmasq</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># yum install dnsmasq</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/cobbler/dnsmasq.template

# Cobbler generated configuration file for dnsmasq
# $date
#

# resolve.conf .. ?
#no-poll
#enable-dbus
read-ethers
addn-hosts = /var/lib/cobbler/cobbler_hosts

dhcp-range=192.168.0.220,192.168.0.250
dhcp-option=3,$next_server
dhcp-lease-max=1000
dhcp-authoritative
dhcp-boot=pxelinux.0
dhcp-boot=net:normalarch,pxelinux.0
dhcp-boot=net:ia64,$elilo

$insert_cobbler_system_definitions
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/hosts
192.168.0.1 cobbler.localnet
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># chkconfig dnsmasq on</span>
<span class="c"># service dnsmasq start</span>
<span class="c"># service cobblerd restart</span>
<span class="c"># cobbler sync</span>
</pre></div>
</div>
</div>
<div class="section" id="cobbler">
<h2>Cobbler</h2>
<div class="highlight-python"><div class="highlight"><pre># cobbler profile report
Name                           : CentOS6.4-x86_64
TFTP Boot Files                : {}
Comment                        :
DHCP Tag                       : default
Distribution                   : CentOS6.4-x86_64
Enable gPXE?                   : 0
Enable PXE Menu?               : 1
Fetchable Files                : {}
Kernel Options                 : {}
Kernel Options (Post Install)  : {}
Kickstart                      : /var/lib/cobbler/kickstarts/sample.ks
Kickstart Metadata             : {}
Management Classes             : []
Management Parameters          : &lt;&lt;inherit&gt;&gt;
Name Servers                   : []
Name Servers Search Path       : []
Owners                         : ['admin']
Parent Profile                 :
Proxy                          :
Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;
Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;
Repos                          : []
Server Override                : &lt;&lt;inherit&gt;&gt;
Template Files                 : {}
Virt Auto Boot                 : 1
Virt Bridge                    : xenbr0
Virt CPUs                      : 1
Virt Disk Driver Type          : raw
Virt File Size(GB)             : 5
Virt Path                      :
Virt RAM (MB)                  : 512
Virt Type                      : qemu
</pre></div>
</div>
<p>登録しているprofileからPuppet Server,Puppet Clientのprofileを作成する。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler profile copy --name=CentOS6.4-x86_64 --newname=CentOS6.4-puppet_server</span>
<span class="c"># cobbler profile copy --name=CentOS6.4-x86_64 --newname=CentOS6.4-puppet_client</span>
</pre></div>
</div>
<p>EPELにあるPuppetを使用する。</p>
<div class="highlight-python"><div class="highlight"><pre># yum -y install wget

# cobbler repo add --name=CentOS6.4-epel --mirror=http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel/6/x86_64 --mirror-locally=no
# cobbler reposync
# mkdir /var/www/cobbler/repo_mirror/CentOS6.4-epel/.origin
# cobbler reposync

# cobbler repo report
Name                           : CentOS6.4-epel
Arch                           : x86_64
Breed                          : yum
Comment                        :
Createrepo Flags               : &lt;&lt;inherit&gt;&gt;
Environment Variables          : {}
Keep Updated                   : True
Mirror                         : http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel/6/x86_64
Mirror locally                 : False
Owners                         : ['admin']
Priority                       : 99
RPM List                       : []
Yum Options                    : {}
</pre></div>
</div>
<p>profileにリポジトリの情報を追加</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler profile edit --name=CentOS6.4-puppet_server --repos="CentOS6.4-epel"</span>
<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_client --repos="CentOS6.4-epel"</span>
</pre></div>
</div>
<p>profileをコピーしたままの状態ではsample.ksファイルが読み込まれるので、ksファイルをコピーしてPuppetをインストールするよう書き換える。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /var/lib/cobbler/kickstarts</span>
<span class="c"># cp sample.ks puppet_server.ks</span>
<span class="c"># cp sample.ks puppet_client.ks</span>

<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_server --kickstart=/var/lib/cobbler/kickstarts/puppet_server.ks</span>
<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_client --kickstart=/var/lib/cobbler/kickstarts/puppet_client.ks</span>
</pre></div>
</div>
<p>固定IPを割り振るためにsystemに登録する。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/cobbler/settings
pxe_just_once: 1

# service cobblerd restart
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># cobbler system add  \
--name=puppet-server-2 \
--hostname=puppetserver.localnet \
--dns-name=puppetserver.localnet \
--profile=CentOS6.4-puppet_server \
--interface=eth0 \
--mac=XX:XX:XX:XX:XX:XX \
--static=1 \
--ip-address=192.168.0.2 \
--subnet=255.255.255.0 \
--gateway=192.168.0.254 \
--name-servers=192.168.0.1

# cobbler system add  \
--name=puppet-client-003 \
--hostname=puppetclient003.localnet \
--dns-name=puppetclient003.localnet \
--profile=CentOS6.4-puppet_client \
--interface=eth0 \
--mac=XX:XX:XX:XX:XX:XX \
--static=1 \
--ip-address=192.168.0.3 \
--subnet=255.255.255.0 \
--gateway=192.168.0.254 \
--name-servers=192.168.0.1
</pre></div>
</div>
<p>pxe_just_onceを有効にすると登録したsystemは1度しかpxe bootしないので、OSインストール後に、もう1度pxe bootさせたくなったら下記を実行する。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler system edit --name=puppet-client-003 --netboot-enabled=1</span>
</pre></div>
</div>
</div>
<div class="section" id="puppet">
<h2>Puppet</h2>
<p>PuppetにはPUSHモードとPULLモードがある。</p>
<table border="1" class="docutils"><colgroup><col width="14%"/><col width="86%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>PULL</td>
<td>クライアントからサーバへ定期的にマニュフェストを取得し適用する。</td>
</tr><tr class="row-even"><td>PUSH</td>
<td>サーバからクライアントへマニュフェストを取得し適用するよう指示する。</td>
</tr></tbody></table><p>今回はPUSHモードのPuppet環境を構築する。</p>
<div class="section" id="puppet-server">
<h3>Puppet server</h3>
<p>Puppet clientを自動構築するためにPuppet serverを作り込む。</p>
<p>Puppet serverのほうはOSインストール後にPuppet serverをインストールするなり、Cobblerサーバのkickstartファイルのpackageセクションに記述するなり好きにすればいいと思う。</p>
<div class="highlight-python"><div class="highlight"><pre># puppet --version
2.6.18
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/sysconfig/puppet

# The puppetmaster server
#PUPPET_SERVER=puppet

# If you wish to specify the port to connect to do so here
PUPPET_PORT=8139

# Where to log to. Specify syslog to send log messages to the system log.
PUPPET_LOG=/var/log/puppet/puppet.log

# You may specify other parameters to the puppet client here
#PUPPET_EXTRA_OPTS=--waitforcert=500
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/puppet/autosign.conf

*.localnet
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/puppet/fileserver.conf

[files]
 path /etc/puppet/manifests/files
 allow *
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/puppet/manifests/site.pp

package { 'zsh' :
        ensure =&gt; present;
}

file { '/etc/sysconfig/puppet' :
        owner =&gt; 'root',
        group =&gt; 'root',
        mode =&gt; 644,
        source =&gt; 'puppet://puppetserver.localnet/files/puppet',
}

file { '/etc/puppet/auth.conf' :
        owner =&gt; 'root',
        group =&gt; 'root',
        mode =&gt; 644,
        source =&gt; 'puppet://puppetserver.localnet/files/auth.conf',
}
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/puppet/manifests/files/puppet

# The puppetmaster server
PUPPET_SERVER=puppetsrv.localnet

# If you wish to specify the port to connect to do so here
#PUPPET_PORT=8140

# Where to log to. Specify syslog to send log messages to the system log.
PUPPET_LOG=/var/log/puppet/puppet.log

# You may specify other parameters to the puppet client here
#PUPPET_EXTRA_OPTS=--waitforcert=500
PUPPET_EXTRA_OPTS="--listen --no-client"
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/puppet/manifests/files/auth.conf

path /run
method save
allow *

path /
auth any
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># service puppetmaster start</span>
</pre></div>
</div>
<p>これで以下のコマンドを実行すればPuppet clientにマニュフェストが適用される。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># puppet kick --host puppetclient002.localnet</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="kickstart">
<h2>Kickstart</h2>
<p>Puppet client用のkickstartファイルは下記のようになっている。</p>
<p>postセクションに</p>
<div class="highlight-python"><div class="highlight"><pre>/sbin/chkconfig puppet on
puppet agent --server=puppetserver.localnet --no-daemonize --onetime
</pre></div>
</div>
<p>を記述することで、Puppetの自動起動、Puppet serverからマニュフェストを取得する処理が1度だけ実行される。これでPuppet clientはOSインストールからPuppetインストール,セットアップまで自動化することが出来た。しかし、今回の設定では各clientの細かい制御(client1にはapache,client2にはmysqlなど)が出来ていないのでそれについては、またの機会に書きたいと思う。</p>
<div class="highlight-python"><div class="highlight"><pre># vi /var/lib/cobbler/kickstarts/puppet_client.ks

#platform=x86, AMD64, or Intel EM64T
# System authorization information
auth  --useshadow  --enablemd5
# System bootloader configuration
bootloader --location=mbr
# Partition clearing information
clearpart --all --initlabel
# Use text mode install
text
# Firewall configuration
#firewall --enabled
firewall --disabled
# Run the Setup Agent on first boot
firstboot --disable
# Timezone
timezone Asia/Tokyo
# System keyboard
keyboard us
# System language
lang en_US
# Use network installation
url --url=$tree
# If any cobbler repo definitions were referenced in the kickstart profile, include them here.
$yum_repo_stanza
# Network information
$SNIPPET('network_config')
# Reboot after installation
reboot

#Root password
rootpw --iscrypted $default_password_crypted
# SELinux configuration
selinux --disabled
# Do not configure the X Window System
skipx
# System timezone
timezone  America/New_York
# Install OS instead of upgrade
install
# Clear the Master Boot Record
zerombr
# Allow anaconda to partition the system as needed
autopart


%pre
$SNIPPET('log_ks_pre')
$SNIPPET('kickstart_start')
$SNIPPET('pre_install_network_config')
# Enable installation monitoring
$SNIPPET('pre_anamon')

%packages
$SNIPPET('func_install_if_enabled')
$SNIPPET('puppet_install_if_enabled')
puppet

%post
$SNIPPET('log_ks_post')
# Start yum configuration
$yum_config_stanza
# End yum configuration
$SNIPPET('post_install_kernel_options')
$SNIPPET('post_install_network_config')
$SNIPPET('func_register_if_enabled')
$SNIPPET('puppet_register_if_enabled')
$SNIPPET('download_config_files')
$SNIPPET('koan_environment')
$SNIPPET('redhat_register')
$SNIPPET('cobbler_register')
/sbin/chkconfig puppet on
puppet agent --server=puppetserver.localnet --no-daemonize --onetime
# Enable post-install boot notification
$SNIPPET('post_anamon')
# Start final steps
$SNIPPET('kickstart_done')
# End final steps
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.cobblerd.org/manuals/2.4.0/4/4/2_-_Managing_DNS.html">Managing DNS</a></li>
<li><a class="reference external" href="http://www.cobblerd.org/manuals/2.2.3/4/3/1_-_Managing_DHCP.html">Managing DHCP</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/int128/20120226/1330247800">http://d.hatena.ne.jp/int128/20120226/1330247800</a></li>
<li><a class="reference external" href="http://blog.glidenote.com/blog/2012/03/16/cobbler-system-add">http://blog.glidenote.com/blog/2012/03/16/cobbler-system-add/</a></li>
</ul></div>]]></description>
            <category><![CDATA[ puppet ]]></category>
            <category><![CDATA[ cobbler ]]></category>
             <pubDate>Sat, 22 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/18/centos_cobbler_setup.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/18/centos_cobbler_setup.html</guid>
            <title><![CDATA[CentOS6.4にCobblerサーバ構築]]></title>
            <description><![CDATA[<h1>CentOS6.4にCobblerサーバ構築</h1>
<p>サーバ100台くらいにOSインストールする作業が発生するかもしれないので怠けるための作業をメモしておく。まずはCobblerサーバを構築してOSインストールが出来るまで。</p>
<div class="highlight-python"><div class="highlight"><pre># uname -a
Linux localhost.localdomain 2.6.32-358.11.1.el6.x86_64 #1 SMP Wed Jun 12 03:34:52 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux

# cat /etc/centos-release
CentOS release 6.4 (Final)
</pre></div>
</div>
<p>SELinuxを無効にしないとCobblerが動作しない。</p>
<p>下記のファイルを編集して再起動</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/selinux/config</span>
<span class="n">SELINUX</span><span class="o">=</span><span class="n">disabled</span>

<span class="c"># chkconfig xinetd on</span>
<span class="c"># chkconfig httpd on</span>
<span class="c"># chkconfig cobblerd on</span>
<span class="c"># chkconfig dhcpd on</span>
<span class="c"># reboot</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># rpm -i http://mirror.symnds.com/distributions/fedora-epel/6/x86_64/epel-release-6-8.noarch.rpm
# yum -y install cobbler pykickstart dhcp

# cobbler --version
Cobbler 2.2.3
  source: ?, ?
  build time: Mon Jun 18 01:04:49 2012

# cobbler check
The following are potential configuration items that you may want to fix:

1 : The 'server' field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.
2 : For PXE to be functional, the 'next_server' field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.
3 : some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run 'cobbler get-loaders' to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The 'cobbler get-loaders' command is the easiest way to resolve these requirements.
4 : change 'disable' to 'no' in /etc/xinetd.d/rsync
5 : since iptables may be running, ensure 69, 80/443, and 25151 are unblocked
6 : debmirror package is not installed, it will be required to manage debian deployments and repositories
7 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: "openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'" to generate new one
8 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them

Restart cobblerd and then run 'cobbler sync' to apply changes.

# /etc/init.d/cobblerd start

# vi /etc/xinetd.d/rsync
disable = no

# vi /etc/xinetd.d/tftp
disable = no

# vi /etc/cobbler/settings
server: 192.168.0.1
manage_dhcp: 1
next_server: 192.168.0.254 &lt;- Gateway

# vi /etc/cobbler/dhcp.template
subnet 192.168.0.0 netmask 255.255.255.0 {
     option routers             192.168.0.254;
     option domain-name-servers 8.8.8.8;
     option subnet-mask         255.255.255.0;
     range dynamic-bootp        192.168.0.200 192.168.0.250;
     filename                   "/pxelinux.0";
     default-lease-time         21600;
     max-lease-time             43200;
     next-server                $next_server;
}

# /etc/init.d/iptables stop
# /etc/init.d/xinetd restart
# /etc/init.d/cobblerd restart

# cobbler get-loaders
# cobbler sync

# cobbler import --path=rsync://ftp.jaist.ac.jp/pub/Linux/CentOS/6.4/os/x86_64/ --name=CentOS6.4_x86_64
# cobbler sync
</pre></div>
</div>
<p>Cobblerを使いインストールするとデフォルトのパスワードはcobblerとなっている。</p>
<p>変更する場合は</p>
<div class="highlight-python"><div class="highlight"><pre># cobbler check
The following are potential configuration items that you may want to fix:

1 : debmirror package is not installed, it will be required to manage debian deployments and repositories
2 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: "openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'" to generate new one
3 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them

Restart cobblerd and then run 'cobbler sync' to apply changes.
</pre></div>
</div>
<p>に書いてあるように</p>
<div class="highlight-python"><div class="highlight"><pre># openssl passwd -1 -salt "cobbler" "password"
$1$cobbler$UTIGTKoLfLdeMAPNxROQZ1
</pre></div>
</div>
<p>を実行して</p>
<div class="highlight-python"><div class="highlight"><pre># vi /etc/cobbler/settings
default_password_crypted: "$1$cobbler$UTIGTKoLfLdeMAPNxROQZ1"
</pre></div>
</div>
<p>設定ファイルを書き換えてCobblerを再起動</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># /etc/init.d/cobblerd restart</span>
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.asahi-net.or.jp/~aa4t-nngk/pxeinstall.html">http://www.asahi-net.or.jp/~aa4t-nngk/pxeinstall.html</a></li>
<li><a class="reference external" href="http://blog.glidenote.com/blog/2012/03/15/cobbler-install">http://blog.glidenote.com/blog/2012/03/15/cobbler-install/</a></li>
<li><a class="reference external" href="http://www.ibm.com/developerworks/jp/linux/library/l-cobbler">http://www.ibm.com/developerworks/jp/linux/library/l-cobbler/</a></li>
</ul>]]></description>
            <category><![CDATA[ cobbler ]]></category>
             <pubDate>Tue, 18 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/08/ubuntu_mongodb_rails3_setup.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/08/ubuntu_mongodb_rails3_setup.html</guid>
            <title><![CDATA[Rails3でMongoDBを使ってみる]]></title>
            <description><![CDATA[<h1>Rails3でMongoDBを使ってみる</h1>
<div class="highlight-python"><div class="highlight"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 12.04.2 LTS
Release:        12.04
Codename:       precise

$ uname -a
Linux ubuntu1204-64-base 3.2.0-45-generic #70-Ubuntu SMP Wed May 29 20:12:06 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux

$ rails -v
Rails 3.2.12

$ rails new mongodb_app --skip-active-record

$ cd mongodb_app

$ vi Gemfile
gem 'mongoid'
gem 'bson_ext'

$ bundle install --path vendor/bundle --binstubs

$ bin/rails g mongoid:config
  create  config/mongoid.yml

$ bin/rails g scaffold Post title:string subscription:text

$ cat app/models/post.rb
class Post
  include Mongoid::Document
  field :title, type: String
  field :subscription, type: String
end

$ mongo
&gt; show dbs
mongodb_app_development 0.203125GB
&gt; use mongodb_app_development
&gt; show collections
posts
&gt; db.posts.find()
{ "_id" : ObjectId("51b1ea5da64aef614e000001"), "title" : "sample", "subscription" : "text" }
{ "_id" : ObjectId("51b2afb0a64aef0c3f000001"), "title" : "hogehoge", "subscription" : "fugafuga" }
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://mongoid.org/en/mongoid">http://mongoid.org/en/mongoid/</a></li>
<li><a class="reference external" href="http://docs.mongodb.org/ecosystem/tutorial/getting-started-with-ruby-on-rails-3">http://docs.mongodb.org/ecosystem/tutorial/getting-started-with-ruby-on-rails-3/</a></li>
</ul>]]></description>
            <category><![CDATA[ mongodb ]]></category>
            <category><![CDATA[ rails ]]></category>
             <pubDate>Sat, 08 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/05/debian_wheezy_nested_kvm.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/05/debian_wheezy_nested_kvm.html</guid>
            <title><![CDATA[Debian wheezyでNested KVMを試してみる]]></title>
            <description><![CDATA[<h1>Debian wheezyでNested KVMを試してみる</h1>
<p><a class="reference external" href="https://code.google.com/p/ganeti">ganeti</a>のbetaを触るのに実機を2,3台用意しないといけないことから開放されそう。</p>
<div class="section" id="kvm">
<h2>KVM インストール</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install install qemu-kvm libvirt-bin virtinst bridge-utils</span>
</pre></div>
</div>
</div>
<div class="section" id="nested-kvm">
<h2>Nested KVM</h2>
<p>Nested KVMを有効にするための設定を行う。</p>
<div class="highlight-python"><div class="highlight"><pre># modinfo kvm_intel
filename:       /lib/modules/3.2.0-4-amd64/kernel/arch/x86/kvm/kvm-intel.ko
license:        GPL
author:         Qumranet
depends:        kvm
intree:         Y
vermagic:       3.2.0-4-amd64 SMP mod_unload modversions
parm:           vpid:bool
parm:           flexpriority:bool
parm:           ept:bool
parm:           unrestricted_guest:bool
parm:           emulate_invalid_guest_state:bool
parm:           vmm_exclusive:bool
parm:           yield_on_hlt:bool
parm:           fasteoi:bool
parm:           nested:bool
parm:           ple_gap:int
parm:           ple_window:int

# cat /sys/module/kvm_intel/parameters/nested
N

# vi /etc/modprobe.d/kvm-nested.conf
options kvm_intel nested=1

# modprobe -r kvm_intel
# modprobe kvm_intel

# cat /sys/module/kvm_intel/parameters/nested
Y
</pre></div>
</div>
</div>
<div class="section" id="id1">
<h2>仮想マシンの作成</h2>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">VM_NAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">MEM</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">SIZE</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$4</span>
<span class="nv">OS</span><span class="o">=</span><span class="nv">$5</span>

<span class="nv">DISKIMAGE</span><span class="o">=</span><span class="s2">"/var/lib/libvirt/images/$VM_NAME"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"centos"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># CentOS 6.4 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jaist.ac.jp/pub/Linux/CentOS/6.4/os/x86_64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"precise"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Ubuntu 12.04 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.riken.jp/Linux/ubuntu/dists/precise/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"squeeze"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Squeeze amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/squeeze/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"wheezy"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Wheezy amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/wheezy/main/installer-amd64/'</span>
<span class="k">fi</span>

virt-install --hvm --accelerate --nographics <span class="se">\</span>
  --name <span class="nv">$VM_NAME</span> <span class="se">\</span>
  --network <span class="nv">bridge</span><span class="o">=</span><span class="nv">$IFACE</span>,model<span class="o">=</span>virtio <span class="se">\</span>
  --ram <span class="nv">$MEM</span> <span class="se">\</span>
  --vcpus 1 <span class="se">\</span>
  --cpu core2duo <span class="se">\</span>
  --os-type linux <span class="se">\</span>
  --location <span class="nv">$DIST</span> <span class="se">\</span>
  --disk <span class="nv">path</span><span class="o">=</span><span class="nv">$DISKIMAGE</span>.qcow2,format<span class="o">=</span>qcow2,size<span class="o">=</span><span class="nv">$SIZE</span>,bus<span class="o">=</span>virtio,cache<span class="o">=</span>writethrough <span class="se">\</span>
  --extra-args<span class="o">=</span><span class="s1">'console=tty0 console=ttyS0,115200n8'</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vm-install.sh debian7_vm 1500 100 br1 wheezy</span>
</pre></div>
</div>
</div>
<div class="section" id="os">
<h2>ゲストOSでの仮想マシン作成</h2>
<p>ゲストOSでKVMのインストールと仮想マシンの作成を行う。</p>
<p>スクリプトは–cpuオプションを取っただけであとは同じ。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install install qemu-kvm libvirt-bin virtinst bridge-utils</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">VM_NAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">MEM</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">SIZE</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$4</span>
<span class="nv">OS</span><span class="o">=</span><span class="nv">$5</span>

<span class="nv">DISKIMAGE</span><span class="o">=</span><span class="s2">"/var/lib/libvirt/images/$VM_NAME"</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"centos"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># CentOS 6.4 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jaist.ac.jp/pub/Linux/CentOS/6.4/os/x86_64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"precise"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Ubuntu 12.04 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.riken.jp/Linux/ubuntu/dists/precise/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"squeeze"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Squeeze amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/squeeze/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">"$OS"</span> <span class="o">=</span> <span class="s2">"wheezy"</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Wheezy amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/wheezy/main/installer-amd64/'</span>
<span class="k">fi</span>

virt-install --hvm --accelerate --nographics <span class="se">\</span>
  --name <span class="nv">$VM_NAME</span> <span class="se">\</span>
  --network <span class="nv">bridge</span><span class="o">=</span><span class="nv">$IFACE</span>,model<span class="o">=</span>virtio <span class="se">\</span>
  --ram <span class="nv">$MEM</span> <span class="se">\</span>
  --vcpus 1 <span class="se">\</span>
  --os-type linux <span class="se">\</span>
  --location <span class="nv">$DIST</span> <span class="se">\</span>
  --disk <span class="nv">path</span><span class="o">=</span><span class="nv">$DISKIMAGE</span>.qcow2,format<span class="o">=</span>qcow2,size<span class="o">=</span><span class="nv">$SIZE</span>,bus<span class="o">=</span>virtio,cache<span class="o">=</span>writethrough <span class="se">\</span>
  --extra-args<span class="o">=</span><span class="s1">'console=tty0 console=ttyS0,115200n8'</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre># virsh net-list --all
Name                 State      Autostart
-----------------------------------------
default              inactive   no

# virsh net-start default
# vm-install.sh debian7_nested 500 50 virbr0 wheezy
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.debian.org/releases/wheezy">http://www.debian.org/releases/wheezy/</a></li>
<li><a class="reference external" href="http://wiki.debian.org/KVM">http://wiki.debian.org/KVM</a></li>
<li><a class="reference external" href="http://aikotobaha.blogspot.jp/2012/02/kvm-on-kvmnested-kvm.html">http://aikotobaha.blogspot.jp/2012/02/kvm-on-kvmnested-kvm.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ kvm ]]></category>
             <pubDate>Wed, 05 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/05/26/ubuntu_mongodb_install.html</link>
            <guid>http://127.0.0.1/blog/html/2013/05/26/ubuntu_mongodb_install.html</guid>
            <title><![CDATA[Ubuntu12.04にMongoDBをインストール]]></title>
            <description><![CDATA[<h1>Ubuntu12.04にMongoDBをインストール</h1>
<p>積読になっていた「MongoDB イン・アクション」をようやく読み始めた。</p>
<p>「Ubuntu 12.04 amd64」にMongoDBをインストールして手を動かしてみたのでメモしておく。</p>
<p>Railsで使いたいなと思っているところ。</p>
<p>本家のドキュメントにaptでインストール出来ると書いているのでそれに従ってみた。</p>
<div class="section" id="mongodb">
<h2>MongoDB インストール</h2>
<div class="highlight-python"><div class="highlight"><pre>$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10
$ echo 'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' | sudo tee /etc/apt/sources.list.d/10gen.list
$ sudo apt-get update
$ sudo apt-get install mongodb-10gen
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install mongodb-10gen=2.2.3</span>
</pre></div>
</div>
<p>で指定のVersionをインストールすることが出来る。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># echo "mongodb-10gen hold" | dpkg --set-selections</span>
</pre></div>
</div>
<p>でインストールしたVersionからアップグレードしないように出来る。</p>
</div>
<div class="section" id="id1">
<h2>MongoDB 操作</h2>
<div class="highlight-python"><div class="highlight"><pre>$ mongo
MongoDB shell version: 2.4.3
connecting to: test
Welcome to the MongoDB shell.
For interactive help, type "help".
For more comprehensive documentation, see
        http://docs.mongodb.org/
Questions? Try the support group
        http://groups.google.com/group/mongodb-user

use tutorial

db.users.insert({username: "hoge"})

db.users.find()
{ "_id" : ObjectId("51a1f5c136f07a662784e8ae"), "username" : "hoge" }

db.users.save({username: "moge"})

db.users.find()
{ "_id" : ObjectId("51a1f5c136f07a662784e8ae"), "username" : "hoge" }
{ "_id" : ObjectId("51a1f8d336f07a662784e8af"), "username" : "moge" }

db.users.count()
2

db.users.update({username: "hoge"}, {$set: {country: "canada"}})
db.users.find({username: "hoge"})
{ "_id" : ObjectId("51a1f5c136f07a662784e8ae"), "country" : "canada", "username" : "hoge" }

db.users.update({username: "hoge"}, {$unset: {country: 1}})
db.users.find({username: "hoge"})
{ "_id" : ObjectId("51adf33a197bc318df1ad8ad"), "username" : "hoge" }
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu">http://docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu/</a></li>
</ul></div>]]></description>
            <category><![CDATA[ mongodb ]]></category>
             <pubDate>Sun, 26 May 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/05/20/unbound_nsd.html</link>
            <guid>http://127.0.0.1/blog/html/2013/05/20/unbound_nsd.html</guid>
            <title><![CDATA[Unbound + NSD]]></title>
            <description><![CDATA[<h1>Unbound + NSD</h1>
<p>Chef Serverと戯れるときにhostsをいちいち書き換えるのは</p>
<p>面倒なので内部にDNSサーバを立ててみた。</p>
<table border="1" class="docutils"><caption>Ubuntu 12.04 server amd64</caption>
<colgroup><col width="33%"/><col width="33%"/><col width="33%"/></colgroup><tbody valign="top"><tr class="row-odd"><td>コンテンツサーバ</td>
<td>NSD(3.2.9)</td>
<td>192.168.0.1</td>
</tr><tr class="row-even"><td>キャッシュサーバ</td>
<td>Unbound(1.4.16)</td>
<td>192.168.0.2</td>
</tr></tbody></table><div class="section" id="nsd">
<h2>NSD</h2>
<p>今回は正引きだけ設定した。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install nsd</span>
<span class="c"># cd /etc/nsd3</span>
<span class="c"># cp nsd.conf.sample nsd.conf</span>
<span class="c"># vi nsd.conf</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>server:
  ip-address: 192.168.0.1
  hide-version: yes
  ipv4-only: yes
  database: "/etc/nsd3/nsd.conf"
  pidfile: "/etc/nsd3/nsd.pid"
  chroot: "/etc/nsd3"
  username: nsd
  zonedir: "/etc/nsd3"
  difffile: "/etc/nsd3/ixfr.db"
  xfrdfile: "/etc/nsd3/xfrd.state"

zone:
  name: chef.local
  zonefile: chef.local.zone
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi chef.local.zone</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$TTL 3600
@ IN SOA ns1.chef.local. postmaster.chef.local. (
  2013052001  ;Serial
  3600        ;Refresh
  1800        ;Retry
  57200       ;Expire
  86400       ;Minimum TTL
)

@ IN  NS  ns1.chef.local.

ns1   IN  A 192.168.0.1
ns2   IN  A 192.168.0.2
www   IN  A 192.168.0.3
hoge  IN  A 192.168.0.4
fuga  IN  A 192.168.0.5
moge  IN  A 192.168.0.6
</pre></div>
</div>
</div>
<div class="section" id="unbound">
<h2>Unbound</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install unbound</span>
<span class="c"># cd /etc/unbound</span>
<span class="c"># zcat `locate unbound.conf | sed -n 2p` &gt; unbound.conf</span>
<span class="c"># vi unbound.conf</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>server:
  verbosity: 1
  interface 192.168.0.2
  do-ip6: no
  access-control: 127.0.0.0/8 allow
  access-control: 192.168.0.0/24 allow
  chroot: "etc/unbound"
  username: "unbound"
  directory: "/etc/unbound"
  use-syslog: yes
  pidfile: "/etc/unbound/unbound.pid"

stub-zone:
  name: "chef.local"
  stub-addr: 192.168.0.1
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://unbound.jp">http://unbound.jp/</a></li>
<li><a class="reference external" href="http://unbound.jp/news20110624">http://unbound.jp/news20110624/</a></li>
<li><a class="reference external" href="http://gihyo.jp/admin/feature/01/unbound">http://gihyo.jp/admin/feature/01/unbound</a></li>
</ul></div>]]></description>
            <category><![CDATA[ nsd ]]></category>
            <category><![CDATA[ unbound ]]></category>
             <pubDate>Mon, 20 May 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/03/23/tinkerer_github.html</link>
            <guid>http://127.0.0.1/blog/html/2013/03/23/tinkerer_github.html</guid>
            <title><![CDATA[Tinkerer + Github]]></title>
            <description><![CDATA[<h1>Tinkerer + Github</h1>
<p>jekyll + Githubを使ってブログを書いていたのだけれどローカルで確認するのにWEBRick動かすということに面倒くささを感じ流らく放置してしまっていた。</p>
<p>もっと手軽な(Sphinxみたいにhtmlが掃き出される)ものはないかと探してみたところTinkererというものを見付けた。</p>
<div class="highlight-python"><div class="highlight"><pre>$ pip install tinkerer
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ tinker -s
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ wget http://dl.dropbox.com/u/218108/files/japanesesupport.py
$ mkdir _exts
$ mv japanesesupport.py _exts
$ hg clone https://bitbucket.org/vladris/tinkerer-contrib
$ cp `find tinkerer-contrib -name withgithub.py` _exts
$ rm -rf tinkerer-contrib
$ touch .nojekyll
</pre></div>
</div>
<div class="section" id="conf-py">
<h2>conf.py 修正</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tinkerer.ext.blog'</span><span class="p">,</span> <span class="s">'tinkerer.ext.disqus'</span><span class="p">,</span> <span class="s">'japanesesupport'</span><span class="p">,</span> <span class="s">'withgithub'</span><span class="p">]</span>

<span class="c"># Add templates to be rendered in sidebar here</span>
<span class="n">html_sidebars</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">"**"</span><span class="p">:</span> <span class="p">[</span><span class="s">"recent.html"</span><span class="p">,</span> <span class="s">"categories.html"</span><span class="p">,</span> <span class="s">"tags.html"</span><span class="p">,</span> <span class="s">"searchbox.html"</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre>$ tinker -p 'first post'
$ tinker -b
$ git init
$ git add .
$ git commit -m 'first post'
$ git remote add origin git@github.com:zinrai/zinrai.github.com.git
$ git push -u origin master
</pre></div>
</div>
<ul class="simple"><li><a class="reference external" href="http://www.tinkerer.me/exts/withgithub.html">http://www.tinkerer.me/exts/withgithub.html</a></li>
<li><a class="reference external" href="http://sphinx-users.jp/reverse-dict/html/japanese.html">http://sphinx-users.jp/reverse-dict/html/japanese.html</a></li>
</ul></div>]]></description>
            <category><![CDATA[ tinkerer ]]></category>
             <pubDate>Sat, 23 Mar 2013 00:00:00 +0900</pubDate>
        </item>
    
    </channel>
</rss>