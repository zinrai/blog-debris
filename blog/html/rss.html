<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>command not found:</title>
        <link>http://127.0.0.1/blog/html/</link>
        <description>Hello World</description>
        <language>en-us</language>
        <pubDate>Sat, 07 Sep 2013 00:00:00 +0900</pubDate>
        
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/07/debian_wheezy_pxeboot.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/07/debian_wheezy_pxeboot.html</guid>
            <title><![CDATA[PXE boot + シェルスクリプトでDebian Wheezyのインストール自動化]]></title>
            <description><![CDATA[<div class="section" id="pxe-boot-debian-wheezy">
<h1>PXE boot + シェルスクリプトでDebian Wheezyのインストール自動化</h1>
<p>みなさん、Debianのインストール作業はどうやっているだろうか。私は、OSのインストール作業なんてお金を貰わない限り手動でやりたくないので自動化している。OSの手動インストールをするだけでお金が発生するのであれば喜んでやらせていただく所存である。RedHat系の「<a class="reference external" href="http://fedoraproject.org/wiki/Anaconda/Kickstart">Kickstart</a>」と同じような仕組みの「<a class="reference external" href="http://www.debian.org/releases/stable/amd64/apb.html.ja">preseed</a>」というものがDebianにも存在するが、これを使わずに「pxeboot + debootstrap + シェルスクリプト」でインストールの自動化をしている。</p>
<div class="section" id="pxeboot">
<h2>pxeboot</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install debootstrap syslinux dnsmasq nfs-kernel-server</span>
</pre></div>
</div>
<div class="section" id="dnsmasq">
<h3>dnsmasq</h3>
<p>DNSサーバ以外にもDHCP,TFTPサーバとしても使える便利なdnsmasq</p>
<div class="highlight-python"><pre># vi /etc/dnsmasq.d/pxe.conf
enable-tftp
tftp-root=/var/lib/tftpboot
dhcp-range=192.168.2.200,192.168.2.250,2h
dhcp-option=3,192.168.2.254
dhcp-boot=pxelinux.0</pre>
</div>
</div>
<div class="section" id="nfs">
<h3>NFS</h3>
<div class="highlight-python"><pre># vi /etc/exports
/var/lib/tftpboot/wheezy 192.168.2.0/24(rw,no_root_squash,no_subtree_check)</pre>
</div>
</div>
<div class="section" id="debootstrap">
<h3>debootstrap</h3>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir -p /var/lib/tftpboot/wheezy</span>
<span class="c"># debootstrap stable /var/lib/tftpboot/wheezy http://ftp.jp.debian.org/debian</span>
<span class="c"># chroot /var/lib/tftpboot/wheezy/ apt-get install linux-image-`uname -r` parted build-essential bzip2 debootstrap</span>
</pre></div>
</div>
</div>
<div class="section" id="syslinux">
<h3>syslinux</h3>
<div class="highlight-python"><pre># cp /boot/initrd* /var/lib/tftpboot
# cp /boot/vmlinuz* /var/lib/tftpboot

# cp /usr/lib/syslinux/pxelinux.0 /var/lib/tftpboot
# mkdir /var/lib/tftpboot/pxelinux.cfg

# vi /var/lib/tftpboot/pxelinux.cfg/default
default Debian
prompt 1
timeout 10
label Debian
kernel vmlinuz-3.2.0-4-amd64
append initrd=initrd.img-3.2.0-4-amd64 root=/dev/nfs ip=dhcp nfsroot=192.168.2.253:/var/lib/tftpboot/wheezy ro single</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># service dnsmasq start</span>
<span class="c"># service nfs-kernel-server start</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="debian">
<h2>Debianインストールスクリプト</h2>
<p>仕組みは「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html"><em>PXE boot + シェルスクリプトでFreeBSD 9.1のインストール自動化</em></a>」と同じである。</p>
<p>debootstrapで取得した最小構成のWheezyをコピーするスクリプトを書いただけ。</p>
<p>grub2のインストール時にブートローダをどのディスクにインストールするかを設定するダイアログが出てきてしまうので「DEBIAN_FRONTEND=noninteractive」を環境変数として設定しダイアログを出さないのがポイントである。</p>
<p>代わりにダイアログで実行されるコマンドをスクリプト内で実行する。</p>
<p>この環境変数は解決方法はないかとdebconf(1)を眺めていたら</p>
<div class="highlight-python"><pre>Debconf is a configuration system for Debian packages. For a debconf overview and documentation for sysadmins, see debconf(7) (in the debconf-doc package).</pre>
</div>
<p>書かれており、説明に従いdebconf-docをインストールし、debconf(7)を眺めたところ見付けた。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir -p /var/scripts/wheezy</span>
<span class="c"># debootstrap stable /var/scripts/wheezy http://ftp.jp/debian.org/debian</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/scripts/os_install.sh</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/sh</span>

get_conf<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;FreeBSD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">&quot;`ifconfig | awk '/ether/ {print $NF}'`&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;Linux&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">&quot;`ifconfig | awk '/HWaddr/ {print $NF}'`&quot;</span>
  <span class="k">fi</span>

<span class="k">  for </span>a in <span class="nv">$MACADDR</span>; <span class="k">do</span>
<span class="k">    </span>find . -name <span class="k">${</span><span class="nv">a</span><span class="k">}</span>.conf
  <span class="k">done</span>
<span class="o">}</span>

<span class="nv">OS</span><span class="o">=</span><span class="sb">`</span>uname<span class="sb">`</span>
<span class="nv">CONFFILE</span><span class="o">=</span><span class="sb">`</span>get_conf<span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;FreeBSD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($3 ~ /^UG$/) print $6}'</span><span class="sb">`</span>
  <span class="nv">DIRNAME</span><span class="o">=</span><span class="sb">`</span>sha256 -q <span class="nv">$CONFFILE</span><span class="sb">`</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;Linux&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($4 ~ /^UG$/) print $8}'</span><span class="sb">`</span>
  <span class="nv">DIRNAME</span><span class="o">=</span><span class="sb">`</span>sha256sum <span class="nv">$CONFFILE</span> | awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="k">fi</span>

mkdir /mnt/<span class="k">${</span><span class="nv">DIRNAME</span><span class="k">}</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$CONFFILE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  ./<span class="nv">$CONFFILE</span> <span class="nv">$IFACE</span> <span class="nv">$DIRNAME</span>
<span class="k">fi</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/scripts/01:23:45:67:89:ab.conf</span>
</pre></div>
</div>
<div class="highlight-python"><pre>#!/bin/bash -x

DISK=&quot;/dev/vda&quot;
IFACE=$1
CHROOT_DEBIAN=&quot;/mnt/$2&quot;

dd if=/dev/zero of=$DISK bs=1024 count=1

parted $DISK -s 'mklabel msdos'
parted $DISK -s 'mkpart primary 1 500'
parted $DISK -s 'mkpart primary 501 35000'
parted $DISK -s 'mkpart extended 35001 -0'
parted $DISK -s 'mkpart logical 35001 38000'
parted $DISK -s 'mkpart logical 38001 -0'
parted $DISK -s 'set 1 boot on'

mkswap ${DISK}5
swapon ${DISK}5
mkfs.ext2 ${DISK}1
mkfs.ext4 ${DISK}2
mkfs.ext4 ${DISK}6

mount ${DISK}2 ${CHROOT_DEBIAN}

cp -Rp wheezy/* $CHROOT_DEBIAN

mount ${DISK}1 ${CHROOT_DEBIAN}/boot
mount ${DISK}6 ${CHROOT_DEBIAN}/home

mount --rbind /dev ${CHROOT_DEBIAN}/dev
mount -t proc none ${CHROOT_DEBIAN}/proc
mount --rbind /sys ${CHROOT_DEBIAN}/sys

cat &lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/hostname
install.localnet
EOF


cat &lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/resolv.conf
nameserver 8.8.8.8
EOF

cat &lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/network/interfaces
auto lo
iface lo inet loopback

auto eth0
iface eth0 inet static
address  192.168.2.100
netmask 255.255.255.0
gateway 192.168.2.254
EOF

cat &lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/etc/fstab
${DISK}1               /boot           ext2            defaults        0 2
${DISK}2               /               ext4            defaults        0 1
${DISK}6               /home           ext4            defaults        0 2
${DISK}5               none            swap            sw              0 0
EOF


cat &lt;&lt; EOF &gt; ${CHROOT_DEBIAN}/tmp/debian_setup.sh
#!/bin/bash

export DEBIAN_FRONTEND=noninteractive
cp /usr/local/share/zoneinfo/Asia/Tokyo /etc/localtime

apt-get install -y linux-image-`uname -r` grub2 openssh-server

grub-mkconfig -o /boot/grub/grub.cfg
grub-install --no-floppy --root-directory=/ $DISK

grep -v rootfs /proc/mounts &gt; /etc/mtab

useradd -m -G sudo nanashi
echo &quot;nanashi:ebifuraibutsukenzo&quot; | chpasswd
echo &quot;root:hogefugamoge&quot; | chpasswd
EOF

chroot ${CHROOT_DEBIAN} /bin/bash /tmp/debian_setup.sh

rm ${CHROOT_DEBIAN}/tmp/debian_setup.sh

cd /
umount -l ${CHROOT_DEBIAN}/{boot,home,proc,dev,sys}
umount -l $CHROOT_DEBIAN
sleep 2
rmdir $CHROOT_DEBIAN
reboot</pre>
</div>
<p>pxeboot時にインストールスクリプトが実行されるようrc.localに書いておく。</p>
<div class="highlight-python"><pre># vi /var/lib/tftpboot/wheezy/etc/rc.local

#!/bin/sh -e
#
# rc.local
#
# This script is executed at the end of each multiuser runlevel.
# Make sure that the script will &quot;exit 0&quot; on success or any other
# value on error.
#
# In order to enable or disable this script just change the execution
# bits.
#
# By default this script does nothing.

/var/scripts/os_install.sh

exit 0</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://fedoraproject.org/wiki/Anaconda/Kickstart">http://fedoraproject.org/wiki/Anaconda/Kickstart</a></li>
<li><a class="reference external" href="http://www.debian.org/releases/stable/amd64/apb.html.ja">http://www.debian.org/releases/stable/amd64/apb.html.ja</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ debian ]]></category>
            <category><![CDATA[ pxeboot ]]></category>
             <pubDate>Sat, 07 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/06/debian_wheezy_sshfs.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/06/debian_wheezy_sshfs.html</guid>
            <title><![CDATA[sshfs]]></title>
            <description><![CDATA[<div class="section" id="sshfs">
<h1>sshfs</h1>
<p>言わずと知れたSSH経由でリモートサーバのディレクトリをマウントしてくれるツール</p>
<p>いつも便利に使わせてもらっている。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get instal sshfs</span>
</pre></div>
</div>
<p>fuseグループに所属していないと「fuse: failed to open /dev/fuse: Permission denied」となる。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># usermod -a -G fuse hoge</span>
</pre></div>
</div>
<div class="highlight-python"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Debian
Description:    Debian GNU/Linux 7.1 (wheezy)
Release:        7.1
Codename:       wheezy</pre>
</div>
<div class="highlight-python"><pre>$ sshfs --version
SSHFS version 2.4
FUSE library version: 2.9.0
using FUSE kernel interface version 7.18</pre>
</div>
<div class="highlight-python"><pre>$ sshfs -p 18465 hoge@192.168.2.1:/home/hoge remote_dir
$ fusermount -u remote_dir</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://fuse.sourceforge.net/sshfs.html">http://fuse.sourceforge.net/sshfs.html</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ sshfs ]]></category>
             <pubDate>Fri, 06 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/05/freebsd_python_uwsgi_logformat.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/05/freebsd_python_uwsgi_logformat.html</guid>
            <title><![CDATA[uWSGIのログフォーマット]]></title>
            <description><![CDATA[<div class="section" id="uwsgi">
<h1>uWSGIのログフォーマット</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/04/freebsd_nginx_reverse_proxy.html"><em>Nginxでリバースプロキシ</em></a>」でバックエンドにアクセス元のIPアドレスがログに記録されると書いたが、バックエンド側でも設定しなければログには記録されない。個人でひっそりとWebサービスを運営していてもディレクトリトラバーサルや某CMSを攻撃しているのかなと思われるリクエストがログに記録されている。ログを眺めるのは楽しいものだ。</p>
<p>今回はバックエンドに「<a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>」を置いた場合のログ設定について書く。動作するまでを書いた記事はよく見掛けるが、ログについて書いている記事は見たことがない。ドキュメントに書いてある通りに設定すればいいだけなので、わざわざ書き留めるほどの情報ではないのだろうか。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># pw groupadd uwsgi -g 9090</span>
<span class="c"># pw useradd uwsgi -u 9090 -g 9090 -c &quot;uWSGI&quot; -d /nonexistent -s /usr/sbin/nologin</span>
</pre></div>
</div>
<p>アクセスしたら「Hellow World」を出力するだけの<a class="reference external" href="http://flask.pocoo.org">Flask</a>を使ったアプリケーション</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi sample.py</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s">'/myapp'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
    <span class="k">return</span> <span class="s">&quot;Hello World!&quot;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">'__main__'</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p><a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>の設定をいろいろと書いているが大事なのはlog-x-forwarded-forとlog-formatの部分である。log-x-forwarded-forを有効にすればlog-formatの%(addr)にアクセス元のIPアドレスが記録される。</p>
<p>ログフォーマットは「<a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/LogFormat.html">Formatting uWSGI requests logs</a>」に詳しく書いてある。</p>
<div class="highlight-python"><pre># vi development.ini
[uwsgi]
http = :9090
workers = 3
threads = 2
virtualenv = ${virtualenv_path}
python-path = ${application_path}
wsgi = sample
callable = app
pidfile = /var/run/uwsgi.pid
uid = uwsgi
gid = uwsgi
log-x-forwarded-for = true
daemonize = uwsgi.log
touch-reload = reload.txt
log-format = %(addr) - %(user) [%(ltime)] &quot;%(method) %(uri) %(proto)&quot; %(status) %(size)`` &quot;%(referer)&quot; &quot;%(uagent)&quot;</pre>
</div>
<table border="1" class="docutils">
<colgroup>
<col width="23%"/>
<col width="77%"/>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>virtualenv</td>
<td>virtualenvを使用している場合、virtualenvのパスを指定する</td>
</tr>
<tr class="row-even"><td>python-path</td>
<td>アプリケーションのパスを指定する。</td>
</tr>
<tr class="row-odd"><td>touch-reload</td>
<td>指定したファイルをtouchすることでアプリと<a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>の設定がリロードされる</td>
</tr>
</tbody>
</table>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># touch reload.txt</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># uwsgi development.ini</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html">http://uwsgi-docs.readthedocs.org/en/latest/WSGIquickstart.html</a></li>
<li><a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/Options.html">http://uwsgi-docs.readthedocs.org/en/latest/Options.html</a></li>
<li><a class="reference external" href="http://uwsgi-docs.readthedocs.org/en/latest/LogFormat.html">http://uwsgi-docs.readthedocs.org/en/latest/LogFormat.html</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ uwsgi ]]></category>
             <pubDate>Thu, 05 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/04/freebsd_nginx_reverse_proxy.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/04/freebsd_nginx_reverse_proxy.html</guid>
            <title><![CDATA[Nginxでリバースプロキシ]]></title>
            <description><![CDATA[<div class="section" id="nginx">
<h1>Nginxでリバースプロキシ</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/03/freebsd_jail_jenkins.html"><em>jail環境でJenkinsを動かす</em></a>」からの続きでlocalhostでListenしているJenkinsをNginxのリバースプロキシを使いlocalhost以外からもアクセスできるようにする。</p>
<p>Nginxのディレクトリ構成は下記を参考に</p>
<ul class="simple">
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/31/freebsd_nginx_virtualhost.html"><em>Nginxでバーチャルホスト</em></a></li>
</ul>
<div class="highlight-python"><pre># nginx -v
nginx version: nginx/1.4.2</pre>
</div>
<div class="highlight-python"><pre># vi /usr/local/etc/nginx/nginx.conf
http {

    server {
        listen       80;
        server_name  localhost;

        location /jenkins {
            proxy_pass http://127.0.0.1:8180;
        }
}</pre>
</div>
<p>proxy_passを設定するだけでJenkinsに接続できるようになる。</p>
<p>「Python+<a class="reference external" href="http://flask.pocoo.org">Flask</a>+<a class="reference external" href="http://projects.unbit.it/uwsgi">uWSGI</a>」で作ったAPサーバをバックエンドに置き、リバースプロキシにNginxを使った場合を考えると、上記の設定ではAPサーバのアクセスログにはリバースプロキシのIPアドレスが記録されてしまいアクセス元はどこなのかがわからない状態になってしまう。アクセス元のIPアドレスがAPサーバに記録されるようにするにはproxy_set_headerを設定する必要がある。</p>
<div class="highlight-python"><pre># vi /usr/local/etc/nginx/nginx.conf
http {

    server {
        listen       80;
        server_name  localhost;

        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Host $host;
        proxy_set_header X-Forwarded-Server $host;
        proxy_set_header X-Real-IP $remote_addr;

        location /myapp {
            proxy_pass http://127.0.0.1:9090;
        }
}</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_pass</a></li>
<li><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_set_header</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ nginx ]]></category>
             <pubDate>Wed, 04 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/03/freebsd_jail_jenkins.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/03/freebsd_jail_jenkins.html</guid>
            <title><![CDATA[jail環境でJenkinsを動かす]]></title>
            <description><![CDATA[<div class="section" id="jailjenkins">
<h1>jail環境でJenkinsを動かす</h1>
<p>会社員だったときに仕様書がエルセル方眼紙だったので、「<a class="reference external" href="http://sphinx-doc.org">Sphinx</a>にするとプレーンテキストで管理でき、gitなどのバージョン管理システムの管理下に置け、さらに<a class="reference external" href="http://jenkins-ci.org">Jenkins</a>を使えば手元に<a class="reference external" href="http://sphinx-doc.org">Sphinx</a>がなくてもバージョン管理下に置いたソースをリモートリポジトリにpushするだけでビルドしてくれる環境ができますよ」というようなことをもう少しわかりやすく提案し見事に却下された。エクセル方眼紙は3人で編集していたのでマージ作業が辛かった。</p>
<p>jail環境の構築は下記を参考に</p>
<ul class="simple">
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
</ul>
<p>FreeBSDにJenkinsをインストールするとインストール後に下記のように表示される。</p>
<div class="highlight-python"><pre>======================================================================

This OpenJDK implementation requires fdescfs(5) mounted on /dev/fd and
procfs(5) mounted on /proc.

If you have not done it yet, please do the following:

        mount -t fdescfs fdesc /dev/fd
        mount -t procfs proc /proc

To make it permanent, you need the following lines in /etc/fstab:

        fdesc   /dev/fd         fdescfs         rw      0       0
        proc    /proc           procfs          rw      0       0

======================================================================</pre>
</div>
<p>jail環境ではマウントできないのでホストのjail.conf(5)にjail起動時にマウントするよう書いておく。</p>
<div class="highlight-python"><pre># vi /etc/jail.conf
jenkins {
        exec.prestart += &quot;mount -t fdescfs fdesc /jails/${name}/dev/fd&quot;;
        exec.prestart += &quot;mount -t procfs proc /jails/${name}/proc&quot;;
        exec.poststop += &quot;umount /jails/${name}/dev/fd&quot;;
        exec.poststop += &quot;umount /jails/${name}/proc&quot;;
        $if = 9;
        $ipaddr = 192.168.0.9;
}</pre>
</div>
<div class="section" id="jenkins">
<h2>jenkins</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">jenkins_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>

<span class="c"># service jenkins start</span>
</pre></div>
</div>
<p>JenkinsはlocalhostでListenしているので、このままだと他からアクセスできない。</p>
<p>次回はリバースプロキシにnginxを使いJenkinsにアクセスできるようにする。</p>
<ul class="simple">
<li><a class="reference external" href="http://sphinx-users.jp">http://sphinx-users.jp/</a></li>
<li><a class="reference external" href="http://build-shokunin.org">http://build-shokunin.org/</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ jenkins ]]></category>
             <pubDate>Tue, 03 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/02/freebsd_irc_znc.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/02/freebsd_irc_znc.html</guid>
            <title><![CDATA[ZNCでIRC Proxy]]></title>
            <description><![CDATA[<div class="section" id="zncirc-proxy">
<h1>ZNCでIRC Proxy</h1>
<p>IRCクライアオンからIRCサーバに接続してない間の発言は見ることが出来無い。IRC Proxyを置けば接続していない間の発言を記録し、IRCクライアントからIRC Proxyに接続すれば記録された発言を見ることが出来る。IRC Proxyでログを定期的にメールすると外出中は捗る。IRC Proxyといえばネットでは「<a class="reference external" href="http://www.clovery.jp/tiarra">Tiarra</a>」をよく見掛けるが、SSL接続のために「<a class="reference external" href="http://sourceforge.jp/projects/stone">stone</a>」などを使わなければならず面倒くさい。SSL接続できるIRC Proxyはないか探してみたところ「<a class="reference external" href="http://wiki.znc.in/ZNC">ZNC</a>」を見付け使っている。</p>
<ul class="simple">
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/01/freebsd_irc_ngircd.html"><em>ngircdでIRCサーバ</em></a></li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># pw useradd -n znc -s /bin/tcsh -m</span>
<span class="c"># su - znc</span>
</pre></div>
</div>
<div class="highlight-python"><pre>$ znc --help
[ ** ] USAGE: znc [options]
[ ** ] Options are:
[ ** ]  -h, --help         List available command line options (this page)
[ ** ]  -v, --version      Output version information and exit
[ ** ]  -f, --foreground   Don't fork into the background
[ ** ]  -D, --debug        Output debugging information (Implies -f)
[ ** ]  -n, --no-color     Don't use escape sequences in the output
[ ** ]  -r, --allow-root   Don't complain if ZNC is run as root
[ ** ]  -c, --makeconf     Interactively create a new config
[ ** ]  -s, --makepass     Generates a password for use in config
[ ** ]  -p, --makepem      Generates a pemfile for use with SSL
[ ** ]  -d, --datadir      Set a different ZNC repository (default is ~/.znc)</pre>
</div>
<div class="highlight-python"><pre>$ znc -v
ZNC 1.0 - http://znc.in
IPv6: yes, SSL: yes, DNS: threads</pre>
</div>
<div class="highlight-python"><pre>$ znc -c
[ ok ] Checking for list of available modules...
[ ** ] Building new config
[ ** ]
[ ** ] First let's start with some global settings...
[ ** ]
[ ?? ] What port would you like ZNC to listen on? (1025 to 65535): 6668
[ ?? ] Would you like ZNC to listen using SSL? (yes/no) [no]: yes
[ ** ] Unable to locate pem file: [/home/znc/.znc/znc.pem]
[ ?? ] Would you like to create a new pem file now? (yes/no) [yes]:
[ ok ] Writing Pem file [/home/znc/.znc/znc.pem]...
[ ?? ] Would you like ZNC to listen using ipv6? (yes/no) [yes]: no
[ ?? ] Listen Host (Blank for all ips): 192.168.0.8
[ ok ] Verifying the listener...
[ ** ]
[ ** ] -- Global Modules --
[ ** ]
[ ** ] +-----------+----------------------------------------------------------+
[ ** ] | Name      | Description                                              |
[ ** ] +-----------+----------------------------------------------------------+
[ ** ] | partyline | Internal channels and queries for users connected to znc |
[ ** ] | webadmin  | Web based administration module                          |
[ ** ] +-----------+----------------------------------------------------------+
[ ** ] And 10 other (uncommon) modules. You can enable those later.
[ ** ]
[ ?? ] Load global module &lt;partyline&gt;? (yes/no) [no]:
[ ?? ] Load global module &lt;webadmin&gt;? (yes/no) [no]:
[ ** ]
[ ** ] Now we need to set up a user...
[ ** ]
[ ?? ] Username (AlphaNumeric): hoge
[ ?? ] Enter Password:
[ ?? ] Confirm Password:
[ ?? ] Would you like this user to be an admin? (yes/no) [yes]:
[ ?? ] Nick [hoge]:
[ ?? ] Alt Nick [hoge_]:
[ ?? ] Ident [hoge]:
[ ?? ] Real Name [Got ZNC?]: fuga
[ ?? ] Bind Host (optional):
[ ?? ] Number of lines to buffer per channel [50]:
[ ?? ] Would you like to clear channel buffers after replay? (yes/no) [yes]:
[ ?? ] Default channel modes [+stn]:
[ ** ]
[ ** ] -- User Modules --
[ ** ]
[ ** ] +--------------+------------------------------------------------------------------------------------------+
[ ** ] | Name         | Description                                                                              |
[ ** ] +--------------+------------------------------------------------------------------------------------------+
[ ** ] | chansaver    | Keep config up-to-date when user joins/parts                                             |
[ ** ] | controlpanel | Dynamic configuration through IRC. Allows editing only yourself if you're not ZNC admin. |
[ ** ] | perform      | Keeps a list of commands to be executed when ZNC connects to IRC.                        |
[ ** ] +--------------+------------------------------------------------------------------------------------------+
[ ** ] And 22 other (uncommon) modules. You can enable those later.
[ ** ]
[ ?? ] Load module &lt;chansaver&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;controlpanel&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;perform&gt;? (yes/no) [no]:
[ ** ]
[ ?? ] Would you like to set up a network? (yes/no) [no]: yes
[ ?? ] Network (e.g. `freenode' or `efnet'): hogeirc
[ ** ]
[ ** ] -- Network Modules --
[ ** ]
[ ** ] +-------------+-------------------------------------------------------------------------------------------------+
[ ** ] | Name        | Description                                                                                     |
[ ** ] +-------------+-------------------------------------------------------------------------------------------------+
[ ** ] | chansaver   | Keep config up-to-date when user joins/parts                                                    |
[ ** ] | keepnick    | Keep trying for your primary nick                                                               |
[ ** ] | kickrejoin  | Autorejoin on kick                                                                              |
[ ** ] | nickserv    | Auths you with NickServ                                                                         |
[ ** ] | perform     | Keeps a list of commands to be executed when ZNC connects to IRC.                               |
[ ** ] | simple_away | This module will automatically set you away on IRC while you are disconnected from the bouncer. |
[ ** ] +-------------+-------------------------------------------------------------------------------------------------+
[ ** ] And 16 other (uncommon) modules. You can enable those later.
[ ** ]
[ ?? ] Load module &lt;chansaver&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;keepnick&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;kickrejoin&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;nickserv&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;perform&gt;? (yes/no) [no]:
[ ?? ] Load module &lt;simple_away&gt;? (yes/no) [no]:
[ ** ]
[ ** ] -- IRC Servers --
[ ** ] Only add servers from the same IRC network.
[ ** ] If a server from the list can't be reached, another server will be used.
[ ** ]
[ ?? ] IRC server (host only): 192.168.0.7
[ ?? ] [192.168.50.7] Port (1 to 65535) [6667]: 6669
[ ?? ] [192.168.50.7] Password (probably empty): aiueo
[ ?? ] Does this server use SSL? (yes/no) [no]: yes
[ ** ]
[ ?? ] Would you like to add another server for this IRC network? (yes/no) [no]:
[ ** ]
[ ** ] -- Channels --
[ ** ]
[ ?? ] Would you like to add a channel for ZNC to automatically join? (yes/no) [yes]:
[ ?? ] Channel name: #fuga
[ ?? ] Would you like to add another channel? (yes/no) [no]:
[ ?? ] Would you like to set up another network? (yes/no) [no]:
[ ** ]
[ ?? ] Would you like to set up another user? (yes/no) [no]:
[ ok ] Writing config [/home/znc/.znc/configs/znc.conf]...
[ ** ]
[ ** ] To connect to this ZNC you need to connect to it as your IRC server
[ ** ] using the port that you supplied.  You have to supply your login info
[ ** ] as the IRC server password like this: user/network:pass.
[ ** ]
[ ** ] Try something like this in your IRC client...
[ ** ] /server &lt;znc_server_ip&gt; +6668 hoge:&lt;pass&gt;
[ ** ] And this in your browser...
[ ** ] https://&lt;znc_server_ip&gt;:6668/
[ ** ]
[ ?? ] Launch ZNC now? (yes/no) [yes]:
[ ok ] Opening config [/home/znc/.znc/configs/znc.conf]...
[ ok ] Binding to port [+6668] on host [192.168.0.8] using ipv4...
[ ** ] Loading user [hoge]
[ ** ] Loading network [hogeirc]
[ ok ] Adding server [192.168.0.7 +6669 aiueo]...
[ ok ] Forking into the background... [pid: 42611]</pre>
</div>
<div class="highlight-python"><pre>$ vi .znc/configs/znc.conf
// WARNING
//
// Do NOT edit this file while ZNC is running!
// Use webadmin or *controlpanel instead.
//
// Buf if you feel risky, you might want to read help on /znc saveconfig and /znc rehash.
// Also check http://en.znc.in/wiki/Configuration

Version = 1.0
&lt;Listener l&gt;
        Port = 6668
        IPv4 = true
        IPv6 = false
        SSL = true
        Host = 192.168.0.8
&lt;/Listener&gt;

&lt;User hoge&gt;
        Pass       = sha256#...#...#
        Admin      = true
        Nick       = hoge
        AltNick    = hoge_
        Ident      = hoge
        RealName   = fuga
        Buffer     = 50
        AutoClearChanBuffer = true
        ChanModes  = +stn


        &lt;Network hogeirc&gt;

                Server     = 192.168.0.7 +6669 aiueo

                &lt;Chan #atchan&gt;
                &lt;/Chan&gt;
        &lt;/Network&gt;
&lt;/User&gt;</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">znc_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
<span class="n">znc_user</span><span class="o">=</span><span class="s">&quot;znc&quot;</span>
<span class="n">znc_conf_dir</span><span class="o">=</span><span class="s">&quot;/home/znc/.znc&quot;</span>

<span class="c"># service znc start</span>
</pre></div>
</div>
<div class="section" id="weechat">
<h2>WeeChat</h2>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/09/02/freebsd_irc_znc.html#weechat">WeeChat</a>」で「<a class="reference external" href="http://wiki.znc.in/ZNC">ZNC</a>」に接続するには</p>
<div class="highlight-python"><pre>/server add hoge irc.hoge.localnet/6668 -ssl -username=hoge -password=hogepassword
/connect hoge
/disconnect hoge</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.weechat.org">http://www.weechat.org/</a></li>
<li><a class="reference external" href="http://wiki.znc.in/Weechat">http://wiki.znc.in/Weechat</a></li>
<li><a class="reference external" href="http://wiki.znc.in/Using_commands">http://wiki.znc.in/Using_commands</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ znc ]]></category>
             <pubDate>Mon, 02 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/09/01/freebsd_irc_ngircd.html</link>
            <guid>http://127.0.0.1/blog/html/2013/09/01/freebsd_irc_ngircd.html</guid>
            <title><![CDATA[ngircdでIRCサーバ]]></title>
            <description><![CDATA[<div class="section" id="ngircdirc">
<h1>ngircdでIRCサーバ</h1>
<p>IT系のアルバイトをしていたときにNagios,Zabbixなどから定期的にメールがバンバン飛んできて、未読が4万通くらいになってメーラーを立ち上げるのを諦めたことがある。なんでもかんでもメールで飛ばすのは嫌いだ。メール振り分けなどの作業を各々がやらなければいけないなんて時間のムダだし、集約できる情報を各々にわざわざ管理させ余計な負担を強いているのがイケてないと私はいつも思っている。</p>
<p>このイライラをIRCは解決してくれる。IRCはチャットとして使うよりも、情報を集約させるのに非常に便利である。Nagiosのアラート,SSHのログイン情報などをIRCにポストするようにしている。IRCを積極的に使っている会社に勤めたことがないので個人でひっそりとやっているだけだが、IRCを眺めれば何が起っているかわかり、いい感じである。</p>
<p>「つかれた」とポストしたら返事をしてくれる(妹)BOTを仕込んで荒んだ心を癒すことも出来る。</p>
<p>今回はIRCサーバ(<a class="reference external" href="http://ngircd.barton.de">ngircd</a>)の構築を行う。</p>
<div class="highlight-python"><pre># ngircd -V
ngIRCd 20.2-IPv6+IRCPLUS+SSL+SYSLOG+TCPWRAP+ZLIB-amd64/portbld/freebsd9.1
Copyright (c)2001-2013 Alexander Barton (&lt;alex@barton.de&gt;) and Contributors.
Homepage: &lt;http://ngircd.barton.de/&gt;

This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /usr/local/etc</span>
<span class="c"># touch ngircd.conf</span>
<span class="c"># yes | ngircd -t | tee ngircd.conf</span>
<span class="c"># echo &quot;SUPER SONIKO&quot; | tee ngircd.motd</span>
<span class="c"># cp ngircd.conf ngircd.conf.org</span>
</pre></div>
</div>
<div class="highlight-python"><pre># mkdir ngircd_ssl
# cd ngircd_ssl

# openssl dhparam -out dhparams.pem 2048.
# openssl req -newkey rsa:2048 -x509 -keyout server-key.pem -out server-cert.pem -days 3650
writing new private key to 'server-key.pem'
Enter PEM pass phrase:
Verifying - Enter PEM pass phrase:
-----
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter '.', the field will be left blank.
-----
Country Name (2 letter code) [AU]:
State or Province Name (full name) [Some-State]:
Locality Name (eg, city) []:
Organization Name (eg, company) [Internet Widgits Pty Ltd]:
Organizational Unit Name (eg, section) []:
Common Name (e.g. server FQDN or YOUR name) []:
Email Address []:</pre>
</div>
<div class="highlight-python"><pre># diff -u ngircd.conf.org ngircd.conf
--- ngircd.conf.org     2013-08-31 12:44:37.665880056 +0900
+++ ngircd.conf 2013-08-31 12:45:03.457801026 +0900
@@ -1,17 +1,17 @@
 [GLOBAL]
-  Name =
+  Name = irc.hoge.localnet
   AdminInfo1 =
   AdminInfo2 =
-  AdminEMail =
+  AdminEMail = hoge@mail.localnet
   Info = ngIRCd 20.2
   Listen = ::,0.0.0.0
   MotdFile = /usr/local/etc/ngircd.motd
   MotdPhrase =
-  Password =
+  Password = aiueo
   PidFile =
   Ports = 6667
-  ServerGID = wheel
-  ServerUID = root
+  ServerGID = nobody
+  ServerUID = nobody

 [LIMITS]
   ConnectRetry = 60
@@ -28,10 +28,10 @@
   ChrootDir =
   CloakHost =
   CloakHostModeX =
-  CloakHostSalt = salt_mogemoge
+  CloakHostSalt = salt_fugafuga
   CloakUserToNick = no
   ConnectIPv4 = yes
-  ConnectIPv6 = yes
+  ConnectIPv6 = no
   DNS = yes
   MorePrivacy = no
   NoticeAuth = no
@@ -45,9 +45,9 @@
   WebircPassword =

 [SSL]
-  CertFile =
-  DHFile =
-  KeyFile =
-  KeyFilePassword =
-  Ports =
+  CertFile = /usr/local/etc/ngircd_ssl/server-cert.pem
+  DHFile = /usr/local//etc/ngircd_ssl/dhparams.pem
+  KeyFile = /usr/local/etc/ngircd_ssl/server-key.pem
+  KeyFilePassword = kakikukeko
+  Ports = 6669</pre>
</div>
<p>設定ファイルのチェックをするオプションがあるので、これを使い設定をチェックする。下記のように表示されれば設定は問題ない。</p>
<div class="highlight-python"><pre># ngircd -t
ngIRCd 20.2-IPv6+IRCPLUS+SSL+SYSLOG+TCPWRAP+ZLIB-amd64/portbld/freebsd9.1
Copyright (c)2001-2013 Alexander Barton (&lt;alex@barton.de&gt;) and Contributors.
Homepage: &lt;http://ngircd.barton.de/&gt;

This is free software; see the source for copying conditions. There is NO
warranty; not even for MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.

Reading configuration from &quot;/usr/local/etc/ngircd.conf&quot; ...
OK, press enter to see a dump of your server configuration ...</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">ngircd_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>

<span class="c"># service ngircd start</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://ngircd.barton.de/documentation.php.en">http://ngircd.barton.de/documentation.php.en</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ ngircd ]]></category>
             <pubDate>Sun, 01 Sep 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/31/freebsd_nginx_virtualhost.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/31/freebsd_nginx_virtualhost.html</guid>
            <title><![CDATA[Nginxでバーチャルホスト]]></title>
            <description><![CDATA[<div class="section" id="nginx">
<h1>Nginxでバーチャルホスト</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html"><em>packages配布サーバ構築</em></a>」で課題にしていたnginxでのバーチャルホストの設定を行う。</p>
<p>バーチャルホストには</p>
<ul class="simple">
<li><strong>IPベース</strong>: 1台のサーバに対して複数のドメイン,IPアドレスで運用する。</li>
<li><strong>名前ベース</strong>: 1台のサーバに対して複数のドメインを1つのIPアドレスで共用する。</li>
</ul>
<p>の2種類がある。</p>
<p>今回は「名前ベース」のバーチャルホストを設定する。</p>
<div class="section" id="dnsmasq">
<h2>dnsmasq</h2>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html"><em>前回構築したDNSサーバ</em></a>に名前を登録する。</p>
<div class="highlight-python"><pre># vi /etc/hosts
192.168.0.5 srv.localnet
192.168.0.5 packages.localnet

# service dnsmasq restart</pre>
</div>
</div>
<div class="section" id="id1">
<h2>Nginx</h2>
<p>nginxのほうも「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html"><em>dnsmasqを使ったDNSサーバ</em></a>」と同じようにDebian Aapache2風のディレクトリ構成をとる。最低限の設定しか載せていないので、他のパラメータはドキュメントを眺めながら各自で設定して欲しい。</p>
<div class="highlight-python"><pre># nginx -v
nginx version: nginx/1.4.2</pre>
</div>
<div class="highlight-python"><pre># cd /usr/local/etc/nginx
# mkdir sites-available sites-enabled

# vi nginx.conf
http {
  include /usr/local/etc/nginx/sites-enabled/*;
}

# vi sites-available/packages.localnet
server {
    listen 80;
    server_name packages.localnet;

    autoindex on;

    location / {
        root   /var/packages;
        index  index.html;
    }
}

# vi sites-avaliable/srv.localnet
server {
    listen       80;
    server_name  srv.localnet;

    location / {
        root   /usr/local/www/nginx;
        index  index.html index.htm;
    }
}

# cd sites-enabled
# ln -s ../sites-available/packages.localnet
# ln -s ../sites-available/srv.localnet

# service nginx start</pre>
</div>
<p>packages.localnetにアクセスするとpackagesが見え、srv.localnetにアクセスするとnginxのインデックスページが見えれば名前ベースバーチャルホストの設定は完了である。</p>
<ul class="simple">
<li><a class="reference external" href="http://ja.wikipedia.org/wiki/バーチャルホスト">http://ja.wikipedia.org/wiki/バーチャルホスト</a></li>
<li><a class="reference external" href="http://nginx.org/en/docs/http/ngx_http_core_module.html#server">http://nginx.org/en/docs/http/ngx_http_core_module.html#server</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ nginx ]]></category>
             <pubDate>Sat, 31 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/30/freebsd_dns_dnsmasq.html</guid>
            <title><![CDATA[dnsmasqを使ったDNSサーバ]]></title>
            <description><![CDATA[<div class="section" id="dnsmasqdns">
<h1>dnsmasqを使ったDNSサーバ</h1>
<p>「<a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html"><em>packages配布サーバ構築</em></a>」で課題にしていたDNSサーバ構築を行う。DNSサーバというとBINDや<a class="reference external" href="http://www.nlnetlabs.nl/projects/nsd">NSD</a>などが思い浮ぶだろうが、これらを使うのは腰が重い(とくにBIND、またはBIND、あるいはBIND)。</p>
<p><a class="reference external" href="http://www.thekelleys.org.uk/dnsmasq">dnsmasq</a>は少しの設定ファイル変更とhosts(5)を書くだけでDNSサーバとして機能する。DHCP,TFTPサーバの機能も持っており、PXE Bootなどに使え非常に勝手がいい。</p>
<ul class="simple">
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html"><em>nullfsを使いjailのportsを共有する</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html"><em>portsのパッケージをビルドする環境を構築する</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html"><em>packages配布サーバ構築</em></a></li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs clone jails/test01@base jails/dns</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /etc/jail.conf
dns {
        $if = 6;
        $ipaddr = 192.168.0.6;
}</pre>
</div>
<div class="section" id="dns">
<h2>dns</h2>
<p>dnsmasqのpackagesはbuildboxで作成し、自前のpackages配布サーバを環境変数を設定しておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># pkg_add -r dnsmasq</span>
<span class="c"># cd /usr/local/etc</span>
<span class="c"># cp dnsmasq.conf.example dnsmasq.conf</span>
</pre></div>
</div>
<p>dnsmasq.confはdnsmasq.dディレクトリ下のファイルを読み込む設定だけ有効にしておく。dnsmasq.confは600行くらいろいろ書いてあるので必要な設定項目だけをdnsmasq.dディレクトリ下に書いて管理したほうが設定を見通しやすい。Debian Apache風にavailableディレクトリに設定ファイルを置き、有効にしたい設定だけをenableディレクトリにシンボリックリンクを貼る。これで設定ファイルの切り替えが楽になる。</p>
<div class="highlight-python"><pre># cd /usr/local/etc
# mkdir -p dnsmasq.d/dnsmasq-available
# mkdir -p dnsmasq.d/dnsmasq-enabled

# vi dnsmasq.conf
conf-dir=/usr/local/etc/dnsmasq.d/dnsmasq-enabled</pre>
</div>
<div class="highlight-python"><pre># vi dnsmasq.d/dnsmasq-avalilable/dns.conf

# Never forward plain names (without a dot or domain part)
domain-needed

# Never forward addresses in the non-routed address spaces.
bogus-priv

# Add local-only domains here, queries in these domains are answered
# from /etc/hosts or DHCP only.
local=/localnet/

# Set this (and domain: see below) if you want to have a domain
# automatically added to simple names in a hosts-file.
expand-hosts

# Set the domain for dnsmasq. this is optional, but if it is set, it
# does the following things.
# 1) Allows DHCP hosts to have fully qualified domain names, as long
#     as the domain part matches this setting.
# 2) Sets the &quot;domain&quot; DHCP option thereby potentially setting the
#    domain of all systems configured by DHCP
# 3) Provides the domain part for &quot;expand-hosts&quot;
domain=localnet</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd dnsmasq.d/dnsmasq-enabled</span>
<span class="c"># ln -s ../dnsmasq-available/dns.conf</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /etc/hosts
192.168.0.5 pkgsrv.localnet</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">dnsmasq_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>

<span class="c"># service dnsmasq start</span>
</pre></div>
</div>
<p>これで自前のpackages配布サーバを名前で引けるようになった。あとはresolv.confにdnsmasqが動いているサーバを指定するだけである。</p>
<ul class="simple">
<li><a class="reference external" href="http://d.hatena.ne.jp/int128/20120226/1330247800">http://d.hatena.ne.jp/int128/20120226/1330247800</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ dnsmasq ]]></category>
             <pubDate>Fri, 30 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/29/freebsd_packages_nginx.html</guid>
            <title><![CDATA[packages配布サーバ構築]]></title>
            <description><![CDATA[<div class="section" id="packages">
<h1>packages配布サーバ構築</h1>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html"><em>前回</em></a>はpackagesを作成する環境を構築した。</p>
<p>今回は作成したpackagesを各FreeBSDマシンに配布する環境を構築する。</p>
<ul class="simple">
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html"><em>nullfsを使いjailのportsを共有する</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html"><em>portsのパッケージをビルドする環境を構築する</em></a></li>
</ul>
<p>jails/pkg/packagesにpackagesが作られているので配布サーバ用jailにリードオンリーでマウントしてWebサーバ(nginx)を動かすだけの簡単なお仕事である。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs clone jails/test01@base jails/pkgsrv</span>
<span class="c"># mkdir /jails/pkgsrv/var/packages</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /etc/jail.conf
test02 {
        $if = 2;
        $ipaddr = 192.168.0.2;
}

pkgsrv {
        exec.prestart += &quot;mount -t nullfs -o ro /jails/pkg/packages /jails/${name}/var/packages&quot;;
        exec.poststop += &quot;umount /jails/${name}/var/packages&quot;;
        $if = 5;
        $ipaddr = 192.168.0.5;
}</pre>
</div>
<div class="section" id="pkgsrv">
<h2>pkgsrv</h2>
<p>pkgsrvにpackagesのnginxをインストールするためbuildboxでnginxをビルドしておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /var/packages/Latest</span>
<span class="c"># pkg_add nginx</span>

<span class="c"># cd /usr/local/nginx</span>
<span class="c"># cp nginx.conf nginx.conf.bak</span>

<span class="c"># mkdir /var/tmp/nginx</span>
<span class="c"># touch /var/tmp/nginx/client_body_temp</span>
</pre></div>
</div>
<p>serverブロックに以下のように書いていればとりあえず目的は達成できる。</p>
<div class="highlight-python"><pre># vi /usr/local/nginx/nginx.conf
server {
        autoindex on;

        location / {
            root   /var/packages;
            index  index.html index.htm;
            allow 192.168.0.0/24;
            deny all;
        }
}</pre>
</div>
<div class="highlight-python"><pre># nginx -t
nginx: the configuration file /usr/local/etc/nginx/nginx.conf syntax is ok
nginx: configuration file /usr/local/etc/nginx/nginx.conf test is successful

# service nginx onestart</pre>
</div>
</div>
<div class="section" id="test02">
<h2>test02</h2>
<p>pkg_add(1)は環境変数を設定することで取得するpackagesのサーバを指定できる。環境変数の設定方法は調べればいくらでも引っ掛かるのでcshでの設定のみ書いておく。</p>
<div class="highlight-python"><pre># vi .cshrc
setenv PACKAGEROOT http://192.168.0.5/
setenv PACKAGESITE http://192.168.0.5/Latest/

# source .cshrc
# pkg_add -r wget</pre>
</div>
<p>packages配布サーバの構築は無事に完了した。ただ、IP直打ちだと配布サーバのIPを変更したとき環境変数を書き換えなければならず面倒だし、nginxを配布サーバ以外のことにも使いたい。</p>
<p>というわけで</p>
<ul class="simple">
<li>DNSサーバの構築</li>
<li>nginx バーチャルホストの設定</li>
</ul>
<p>を課題としておく。</p>
</div>
</div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ nginx ]]></category>
             <pubDate>Thu, 29 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/28/freebsd_jail_ports_packages.html</guid>
            <title><![CDATA[portsのパッケージをビルドする環境を構築する]]></title>
            <description><![CDATA[<div class="section" id="ports">
<h1>portsのパッケージをビルドする環境を構築する</h1>
<p>FreeBSDを複数台動かす場合、パッケージをどのような手段でインストールするか考えることになると思う。</p>
<p>FreeBSDでのパッケージのインストールは</p>
<ul class="simple">
<li><strong>ports</strong>: ソースコードをコンパイルしてインストール</li>
<li><strong>packages</strong>:  コンパイル済みのバイナリをインストール</li>
</ul>
<p>の2種類が用意されている。</p>
<p>それぞれのFreeBSDにあるportsからパッケージをインストールするのは面倒だし、コンパイルオプションの指定ミスなどが発生したとき原因調査に時間を取られて泣きをみることは間違いない。</p>
<p>というわけでpackagesを使いFreeBSDマシンにパッケージをインストールする。packagesはFreeBSDから提供されているが、portsからも作成できる。portsからだとコンパイルオプションを自分の好きなようにカスタマイズしたpackagesを作ることが出来る。ただし、portsからpackagesを作成するにはパッケージをインストールしなければならない。</p>
<p>FreeBSDでは自前のpackagesを作成するツールとして「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」が存在する。「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」は様々なユーザーランド,portsを組み合わせビルド環境を作り、packagesを作成してくれる。WebUIも供えておりpackagesにしたいパッケージを登録すれば勝手にビルドしていく。4.0.0からDBにSQLiteが使えるようになり導入のハードルがグッと下っているので気になったら触ってみて欲しい。</p>
<p>今回は「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」は使わず、「<a class="reference external" href="http://ftp.marcuscom.com">Tinderbox</a>」の動きを真似たビルド環境を自分で構築することにした。下記の記事のような環境がすでに出来ているものとする。</p>
<ul class="simple">
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</em></a></li>
<li><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html"><em>nullfsを使いjailのportsを共有する</em></a></li>
</ul>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs create jails/pkg</span>
<span class="c"># zfs create jails/buildbox</span>

<span class="c"># cd /usr/src/9.1.0</span>
<span class="c"># make buildworld</span>
<span class="c"># make installworld DESTDIR=/jails/buildbox</span>
<span class="c"># make distribution DESTDIR=/jails/buildbox</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mkdir /jails/buildbox/usr/ports</span>
<span class="c"># mkdir /jails/buildbox/var/ports</span>
<span class="c"># cd /jails/pkg</span>
<span class="c"># mkdir distfiles packages coptions</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /jails/buildbox//etc/resolv.conf
nameserver 8.8.8.8</pre>
</div>
<div class="highlight-python"><pre># vi /jails/buildbox/etc/make.conf
WRKDIRPREFIX = /var/ports/
DISTDIR = /var/ports/distfiles/
PACKAGES = /var/ports/packages/
PORT_DBDIR = /var/ports/coptions/</pre>
</div>
<div class="highlight-python"><pre># vi /etc/jail.conf
buildbox {
        exec.prestart += &quot;mount -t nullfs /jails/pkg /jails/${name}/var/ports&quot;;
        exec.poststop += &quot;umount /jails/${name}/var/ports&quot;;
        $if = 4;
        $ipaddr = 192.168.0.4;
}</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs snapshot jails/pkg@base</span>
<span class="c"># zfs snapshot jails/buildbox@base</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># jail -c buildbox</span>
</pre></div>
</div>
<p>書いてある設定でピンときたでしょうが、ビルド作業用ディレクトリを別にマウントしてbuildboxのほうはzfs rollbackでいつでも初期状態に戻せるようにしているだけである。</p>
<p>あとはjail環境で</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /usr/ports/ftp/wget</span>
<span class="c"># make config-recursive</span>
<span class="c"># make install</span>
<span class="c"># make package-recursive</span>
</pre></div>
</div>
<p>すれば/jails/pkg/packagesにpackagesが作られる。</p>
<p>packagesをどう配布するかは次の機会に。(調べればすぐに見付かるけど...)</p>
<ul class="simple">
<li><a class="reference external" href="http://ftp.marcuscom.com">http://ftp.marcuscom.com/</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
             <pubDate>Wed, 28 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/23/freebsd_jail_nullfs_ports.html</guid>
            <title><![CDATA[nullfsを使いjailのportsを共有する]]></title>
            <description><![CDATA[<div class="section" id="nullfsjailports">
<h1>nullfsを使いjailのportsを共有する</h1>
<p>jailを複数動かしているとports(Ports Collection)をどのように取り扱うかという壁にブチ当たると思う。jailごとにportsnap fetchしているとportsnapサーバに負荷がかかるし、管理が面倒くさい。ということでjailのportsは共有し、ホストからしかfetch,updateなどが出来ないようにしてみた。</p>
<p><a class="reference internal" href="http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html"><em>前回</em></a>からの続きということで。</p>
<div class="highlight-python"><pre># cd 9.1.0/sys/amd64/conf
# cp VIMAGE NULLFS

# vi VIMAGE
options         NULLFS

# cd /usr/src/9.1.0
# make buildkernel KERNCONF=NULLFS
# make installkernel KERNCONF=NULLFS
# reboot</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs create jails/ports</span>
<span class="c"># portsnap -p /jails/ports fetch</span>
<span class="c"># portsnap -p /jails/ports extract</span>
<span class="c"># portsnap -p /jails/ports update</span>
</pre></div>
</div>
<p>設定があちこちに散らばると管理が面倒なのでnullfsのマウントはホストのfstabではなくjail.conf(5)に書く。</p>
<div class="highlight-python"><pre># vi /etc/jail.conf

exec.prestart  = &quot;ifconfig epair${if} create up &gt; /dev/null&quot;;
exec.prestart += &quot;ifconfig vswitch0 addm epair${if}a&quot;;
exec.prestart += &quot;mount -t nullfs -o ro /jails/ports /jails/${name}/usr/ports&quot;;
exec.start     = &quot;ifconfig lo0 up 127.0.0.1&quot;;
exec.start    += &quot;ifconfig epair${if}b up $ipaddr&quot;;
exec.start    += &quot;route add default 192.168.0.254&quot;;
exec.start    += &quot;sh /etc/rc&quot;;
exec.stop      = &quot;sh /etc/rc.shutdown&quot;;
exec.poststop  = &quot;ifconfig epair${if}a destroy&quot;;
exec.poststop += &quot;umount /jails/${name}/usr/ports&quot;;
host.hostname = &quot;${name}.localnet&quot;;
mount.devfs;
devfs_ruleset = 5;
vnet;
vnet.interface = &quot;epair${if}b&quot;;
path = &quot;/jails/${name}&quot;;
persist;

test01 {
        $if = 1;
        $ipaddr = 192.168.0.1;
}

test02 {
        $if = 2;
        $ipaddr = 192.168.0.2;
}</pre>
</div>
<p>portsをリードオンリーでマウントしているのでビルド時の作業用ディレクトリが作成できない。そのためjail環境のmake.conf(5)に作業ディレクトリの指定、ディレクトリを作成する必要がある。設定した環境変数の説明はports(5)に書いてある。</p>
<div class="highlight-python"><pre># vi /jails/test01/etc/make.conf

WRKDIRPREFIX = /var/ports/
DISTDIR = /var/ports/distfiles/
PACKAGES = /var/ports/packages/

# mkdir -p /jails/test01/var/ports/distfiles
# mkdir -p /jails/test01/var/ports/packages</pre>
</div>
</div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ jail ]]></category>
             <pubDate>Fri, 23 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html</link>
            <guid>http://127.0.0.1/blog/html/2013/08/22/freebsd_jail_vimage_zfs.html</guid>
            <title><![CDATA[FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築]]></title>
            <description><![CDATA[<div class="section" id="freebsd-9-1-vimage-zfs-jail">
<h1>FreeBSD 9.1 VIMAGE + ZFS で Jail環境構築</h1>
<p>VIMAGE + ZFSでいくらでも作ったり、壊したり、巻き戻したり出来る環境を構築してみる。jail環境をビルドするためにソースを取ってくる。ソースはsubversionで管理されている。まずsubversionをインストールから。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># portsnap fetch</span>
<span class="c"># portsnap extract</span>
<span class="c"># portsnap update</span>

<span class="c"># cd /usr/ports/devel/subversion</span>
<span class="c"># make install</span>
</pre></div>
</div>
<p>VIMAGEが使えるようにカーネルを再構築する。</p>
<div class="highlight-python"><pre># cd /usr/src
# svn checkout svn://svn.freebsd.org/base/release/9.1.0
# cd 9.1.0/sys/amd64/conf
# cp GENERIC VIMAGE

# vi VIMAGE
options         VIMAGE

# cd /usr/src/9.1.0
# make buildkernel KERNCONF=VIMAGE
# make installkernel KERNCONF=VIMAGE
# reboot</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /usr/src/9.1.0</span>
<span class="c"># make buildworld</span>
<span class="c"># make installworld DESTDIR=/jails/test01</span>
<span class="c"># make distribution DESTDIR=/jails/test01</span>
</pre></div>
</div>
<div class="highlight-python"><pre># zpool list
NAME    SIZE  ALLOC   FREE    CAP  DEDUP  HEALTH  ALTROOT
jails   356G   900M   355G     0%  1.00x  ONLINE  -

# zfs create jails/test01
# zfs snapshot jails/test01@base
# zfs clone jails/test01@base jails/test02</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>

<span class="n">ifconfig_re0</span><span class="o">=</span><span class="s">&quot; inet 192.168.0.253 netmask 255.255.255.0&quot;</span>
<span class="n">defaultrouter</span><span class="o">=</span><span class="s">&quot;192.168.0.254&quot;</span>

<span class="n">cloned_interfaces</span><span class="o">=</span><span class="s">&quot;bridge0&quot;</span>
<span class="n">ifconfig_bridge0_name</span><span class="o">=</span><span class="s">&quot;vswitch0&quot;</span>
<span class="n">ifconfig_vswitch0</span><span class="o">=</span><span class="s">&quot;addm re0&quot;</span>
</pre></div>
</div>
<p>netstatしたときなどに/dev/kmem,/dev/memがないよと言われるので、/etc/default/devfs.rulesを参考に、devfs.rules(5)のルールを追加しておく。</p>
<div class="highlight-python"><pre># vi /etc/devfs.rules

[devfsrules_jail=5]
add include $devfsrules_hide_all
add include $devfsrules_unhide_basic
add include $devfsrules_unhide_login
add path zfs unhide
add path mem unhide
add path kmem unhide</pre>
</div>
<p>jailの設定はrc.conf(5)ではなくjail.conf(5)に書く。jail(8)を眺めながら設定ファイルを書いてみた。変数が使えていい感じ。ネームサーバーを設定するパラメータが見当らないので、ネームサーバーの設定はjail内のresolv.confに書くことにする。</p>
<div class="highlight-python"><pre># vi /etc/jail.conf

exec.prestart  = &quot;ifconfig epair${if} create up &gt; /dev/null&quot;;
exec.prestart += &quot;ifconfig vswitch0 addm epair${if}a&quot;;
exec.start     = &quot;ifconfig lo0 up 127.0.0.1&quot;;
exec.start    += &quot;ifconfig epair${if}b up $ipaddr&quot;;
exec.start    += &quot;route add default 192.168.0.254&quot;;
exec.start    += &quot;sh /etc/rc&quot;;
exec.stop      = &quot;sh /etc/rc.shutdown&quot;;
exec.poststop  = &quot;ifconfig epair${if}a destroy&quot;;
host.hostname  = &quot;${name}.localnet&quot;;
mount.devfs;
devfs_ruleset = 5;
vnet;
vnet.interface = &quot;epair${if}b&quot;;
path = &quot;/jails/${name}&quot;;
persist;

test01 {
        $if = 1;
        $ipaddr = 192.168.0.1;
}

test02 {
        $if = 2;
        $ipaddr = 192.168.0.2;
}</pre>
</div>
<div class="highlight-python"><pre># jail -c test01
# jls
   JID  IP Address      Hostname                      Path
    11  -               test01.localnet               /jails/test01

# jexec 11 tcsh
# jail -r test01</pre>
</div>
<p>FreeBSD起動時にjailを起動させたければrc.conf(5)下記のように書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>

<span class="n">jail_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
<span class="n">jail_list</span><span class="o">=</span><span class="s">&quot;test01 test02&quot;</span>
</pre></div>
</div>
<p>ZFSのスナップショット、ロールバックで何度でもやり直せる。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># zfs snapshot jails/test01@snap01</span>
<span class="c"># zfs rollback jails/test01@snap01</span>
<span class="c"># zfs set quota=10g jails/test01</span>
<span class="c"># zfs clone jails/test01@snap01 jails/test03</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.freebsd.org/doc/ja/books/handbook/svn-mirrors.html">http://www.freebsd.org/doc/ja/books/handbook/svn-mirrors.html</a></li>
<li><a class="reference external" href="http://www.freebsd.org/doc/ja/books/handbook/kernelconfig-building.html">http://www.freebsd.org/doc/ja/books/handbook/kernelconfig-building.html</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ jail ]]></category>
            <category><![CDATA[ zfs ]]></category>
             <pubDate>Thu, 22 Aug 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html</link>
            <guid>http://127.0.0.1/blog/html/2013/07/20/freebsd_pxeboot.html</guid>
            <title><![CDATA[PXE boot + シェルスクリプトでFreeBSD 9.1のインストール自動化]]></title>
            <description><![CDATA[<div class="section" id="pxe-boot-freebsd-9-1">
<h1>PXE boot + シェルスクリプトでFreeBSD 9.1のインストール自動化</h1>
<p>OSインストールをするだけでお金が貰えるならば喜んでやるが、趣味の時間をOSインストールに奪われるのはつらいので、自動化してみた。</p>
<div class="section" id="pxe-boot">
<h2>PXE boot サーバ構築</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># mdconfig -a -t vnode -f FreeBSD-9.1-RELEASE-amd64-disc1.iso</span>
<span class="n">md0</span>
<span class="c"># mount_cd9660 /dev/md0 /mnt</span>
<span class="c"># mkdir /var/pxeboot</span>
<span class="c"># cp -Rv /mnt/ /var/pxeboot</span>
<span class="c"># umount /mnt</span>
<span class="c"># mdconfig -d -u 0</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/pxeboot/etc/fstab</span>
<span class="c"># /dev/iso9660/FREEBSD_INSTALL / cd9660 ro 0 0 &lt;- コメントアウト</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /etc/inetd.conf
tftp    dgram   udp     wait    root    /usr/libexec/tftpd      tftpd -l -s /var/pxeboot/boot

# /etc/rc.d/inetd onestart</pre>
</div>
<div class="highlight-python"><pre># cd /usr/ports/net/isc-dhcp42-server
# make install

# vi /usr/local/etc/dhcpd.conf
ddns-update-style none;
server-name &quot;pxeboot&quot;;               # name of the tftp-server
server-identifier 192.168.0.253;  # address of the tftp-server
next-server 192.168.0.253;        # address of the NFS-server

subnet 192.168.0.0 netmask 255.255.255.0 {
    range 192.168.0.220 192.168.0.250;
    option routers 192.168.0.254;
    option root-path &quot;/var/pxeboot&quot;; # root-path for NFS
    filename &quot;pxeboot&quot;;                    # filename of NBP (network bootstrap program)
}

# /usr/local/etc/rc.d/isc-dhcpd onestart</pre>
</div>
<div class="highlight-python"><pre># vi /etc/exports
/var/pxeboot -alldirs -maproot=root

# /etc/rc.d/nfsd onestart</pre>
</div>
<p>再起動後もデーモンを起動させておきたければrc.confに書いておく。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/rc.conf</span>
<span class="n">inetd_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
<span class="n">dhcpd_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
<span class="n">nfs_server_enable</span><span class="o">=</span><span class="s">&quot;YES&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="freebsd">
<h2>FreeBSDインストールスクリプト</h2>
<p>このシェルスクリプトはPXE bootしたマシンのMACアドレスを見てマッチした[MACアドレス].confファイルに書かれたシェルスクリプトを実行するようになっている。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /var/pxeboot/var/scripts/os_install.sh</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/sh</span>

get_conf<span class="o">()</span> <span class="o">{</span>
  <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;FreeBSD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">&quot;`ifconfig | awk '/ether/ {print $NF}'`&quot;</span>
  <span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;Linux&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">    </span><span class="nb">local </span><span class="nv">MACADDR</span><span class="o">=</span><span class="s2">&quot;`ifconfig | awk '/HWaddr/ {print $NF}'`&quot;</span>
  <span class="k">fi</span>

<span class="k">  for </span>a in <span class="nv">$MACADDR</span>; <span class="k">do</span>
<span class="k">    </span>find . -name <span class="k">${</span><span class="nv">a</span><span class="k">}</span>.conf
  <span class="k">done</span>
<span class="o">}</span>

<span class="nv">OS</span><span class="o">=</span><span class="sb">`</span>uname<span class="sb">`</span>
<span class="nv">CONFFILE</span><span class="o">=</span><span class="sb">`</span>get_conf<span class="sb">`</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;FreeBSD&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($3 ~ /^UG$/) print $6}'</span><span class="sb">`</span>
  <span class="nv">DIRNAME</span><span class="o">=</span><span class="sb">`</span>sha256 -q <span class="nv">$CONFFILE</span><span class="sb">`</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;Linux&quot;</span> <span class="o">]</span>; <span class="k">then</span>
<span class="k">  </span><span class="nv">IFACE</span><span class="o">=</span><span class="sb">`</span>netstat -nr | awk <span class="s1">'{if($4 ~ /^UG$/) print $8}'</span><span class="sb">`</span>
  <span class="nv">DIRNAME</span><span class="o">=</span><span class="sb">`</span>sha256sum <span class="nv">$CONFFILE</span> | awk <span class="s1">'{print $1}'</span><span class="sb">`</span>
<span class="k">fi</span>

mkdir /mnt/<span class="k">${</span><span class="nv">DIRNAME</span><span class="k">}</span>

<span class="k">if</span> <span class="o">[</span> -n <span class="s2">&quot;$CONFFILE&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  ./<span class="nv">$CONFFILE</span> <span class="nv">$IFACE</span> <span class="nv">$DIRNAME</span>
<span class="k">fi</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /var/pxeboot/var/scripts/01:23:45:67:89:ab.conf

#!/bin/sh

IFACE=$1
DISK=ada1
MOUNTDIR=&quot;/mnt/$2&quot;
DIST_TXZ=`ls /usr/freebsd-dist/*.txz`

gpart destroy -F $DISK
gpart create -s gpt $DISK
gpart add -s 64K -t freebsd-boot $DISK
gpart add -s 8G -t freebsd-swap -l swap0 $DISK
gpart add -t freebsd-ufs $DISK
gpart bootcode -b /boot/pmbr -p /boot/gptboot -i 1 $DISK

newfs -U /dev/${DISK}p3

mount /dev/${DISK}p3 $MOUNTDIR

cd $MOUNTDIR

for FILE in $DIST_TXZ; do
  tar xfzp $FILE
done

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/etc/rc.conf
hostname=&quot;freebsd.local&quot;
keymap=&quot;us.iso.kbd&quot;
ifconfig_${IFACE}=&quot; inet 192.168.0.252 netmask 255.255.255.0&quot;
defaultrouter=&quot;192.168.0.254&quot;
sshd_enable=&quot;YES&quot;
# Set dumpdev to &quot;AUTO&quot; to enable crash dumps, &quot;NO&quot; to disable
dumpdev=&quot;AUTO&quot;
EOF

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/etc/resolv.conf
nameserver 8.8.8.8
EOF

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/etc/fstab
# Device        Mountpoint      FStype  Options Dump    Pass#
/dev/${DISK}p3     /               ufs     rw      1       1
/dev/${DISK}p2     none            swap    sw      0       0
EOF

cat &lt;&lt; EOF &gt; ${MOUNTDIR}/tmp/freebsd_setup.sh
newaliases
touch /etc/wall_cmos_clock
tzsetup Asia/Tokyo

printf &quot;hogefugamoge&quot; | pw usermod -n root -h 0

pw useradd -n nanashi -s /bin/tcsh -G wheel -m
printf &quot;ebifuraibutsukenzo&quot; | pw usermod -n nanashi -h 0

dumpon /dev/${DISK}p2
ln -sf /dev/${DISK}p2 /dev/dumpdev
EOF

mount -t devfs dev ${MOUNTDIR}/dev
chroot $MOUNTDIR /bin/sh /tmp/freebsd_setup.sh

rm ${MOUNTDIR}/tmp/freebsd_setup.sh

cd /
umount ${MOUNTDIR}/dev
umount $MOUNTDIR

rmdir $MOUNTDIR
reboot</pre>
</div>
<p>PXE boot時に指定のスクリプトを実行するようにrc.localに書いておく。</p>
<div class="highlight-python"><pre># vi /var/pxeboot/etc/rc.local

#!/bin/sh
# $FreeBSD: release/9.1.0/release/rc.local 232427 2012-03-03 02:13:53Z nwhitehorn $

/var/script/os_install.sh</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY_2013022201">https://www.bsdconsulting.co.jp/CGI/BSDC.CGI?CNT=FREEBSDSTUDY_2013022201</a></li>
<li><a class="reference external" href="http://stefankonarski.de/content/freebsd-9-pxe-boot-und-bsdinstall-installieren">http://stefankonarski.de/content/freebsd-9-pxe-boot-und-bsdinstall-installieren</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ freebsd ]]></category>
            <category><![CDATA[ pxeboot ]]></category>
             <pubDate>Sat, 20 Jul 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/22/centos_cobbler_puppet_install.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/22/centos_cobbler_puppet_install.html</guid>
            <title><![CDATA[Cobbler + Puppet]]></title>
            <description><![CDATA[<div class="section" id="cobbler-puppet">
<h1>Cobbler + Puppet</h1>
<p>前回はCobblerでとりあえずOSインストールが出来るところまでやったので、今回はkickstartファイルの編集、Puppet(Puppet client)のインストールとセットアップを自動化してみる。</p>
<div class="section" id="dnsmasq">
<h2>dnsmasq</h2>
<p>DHCP,DNSサーバにdnsmasqを使用する。ISC DHCPよりもdnsmasqを使ったほうがPuppetと連携させやすいことに気が付いた。</p>
<div class="highlight-python"><pre># vi /etc/cobbler/settings

manage_dns: 1
manage_dhcp: 1
server: 192.168.0.1
next_server: 192.168.0.254 &lt;- Gateway</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/cobbler/modules.conf</span>

<span class="p">[</span><span class="n">dns</span><span class="p">]</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">manage_dnsmasq</span>

<span class="p">[</span><span class="n">dhcp</span><span class="p">]</span>
<span class="n">module</span> <span class="o">=</span> <span class="n">manage_dnsmasq</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># yum install dnsmasq</span>
</pre></div>
</div>
<div class="highlight-python"><pre># vi /etc/cobbler/dnsmasq.template

# Cobbler generated configuration file for dnsmasq
# $date
#

# resolve.conf .. ?
#no-poll
#enable-dbus
read-ethers
addn-hosts = /var/lib/cobbler/cobbler_hosts

dhcp-range=192.168.0.220,192.168.0.250
dhcp-option=3,$next_server
dhcp-lease-max=1000
dhcp-authoritative
dhcp-boot=pxelinux.0
dhcp-boot=net:normalarch,pxelinux.0
dhcp-boot=net:ia64,$elilo

$insert_cobbler_system_definitions</pre>
</div>
<div class="highlight-python"><pre># vi /etc/hosts
192.168.0.1 cobbler.localnet</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># chkconfig dnsmasq on</span>
<span class="c"># service dnsmasq start</span>
<span class="c"># service cobblerd restart</span>
<span class="c"># cobbler sync</span>
</pre></div>
</div>
</div>
<div class="section" id="cobbler">
<h2>Cobbler</h2>
<div class="highlight-python"><pre># cobbler profile report
Name                           : CentOS6.4-x86_64
TFTP Boot Files                : {}
Comment                        :
DHCP Tag                       : default
Distribution                   : CentOS6.4-x86_64
Enable gPXE?                   : 0
Enable PXE Menu?               : 1
Fetchable Files                : {}
Kernel Options                 : {}
Kernel Options (Post Install)  : {}
Kickstart                      : /var/lib/cobbler/kickstarts/sample.ks
Kickstart Metadata             : {}
Management Classes             : []
Management Parameters          : &lt;&lt;inherit&gt;&gt;
Name Servers                   : []
Name Servers Search Path       : []
Owners                         : ['admin']
Parent Profile                 :
Proxy                          :
Red Hat Management Key         : &lt;&lt;inherit&gt;&gt;
Red Hat Management Server      : &lt;&lt;inherit&gt;&gt;
Repos                          : []
Server Override                : &lt;&lt;inherit&gt;&gt;
Template Files                 : {}
Virt Auto Boot                 : 1
Virt Bridge                    : xenbr0
Virt CPUs                      : 1
Virt Disk Driver Type          : raw
Virt File Size(GB)             : 5
Virt Path                      :
Virt RAM (MB)                  : 512
Virt Type                      : qemu</pre>
</div>
<p>登録しているprofileからPuppet Server,Puppet Clientのprofileを作成する。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler profile copy --name=CentOS6.4-x86_64 --newname=CentOS6.4-puppet_server</span>
<span class="c"># cobbler profile copy --name=CentOS6.4-x86_64 --newname=CentOS6.4-puppet_client</span>
</pre></div>
</div>
<p>EPELにあるPuppetを使用する。</p>
<div class="highlight-python"><pre># yum -y install wget

# cobbler repo add --name=CentOS6.4-epel --mirror=http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel/6/x86_64 --mirror-locally=no
# cobbler reposync
# mkdir /var/www/cobbler/repo_mirror/CentOS6.4-epel/.origin
# cobbler reposync

# cobbler repo report
Name                           : CentOS6.4-epel
Arch                           : x86_64
Breed                          : yum
Comment                        :
Createrepo Flags               : &lt;&lt;inherit&gt;&gt;
Environment Variables          : {}
Keep Updated                   : True
Mirror                         : http://ftp.jaist.ac.jp/pub/Linux/Fedora/epel/6/x86_64
Mirror locally                 : False
Owners                         : ['admin']
Priority                       : 99
RPM List                       : []
Yum Options                    : {}</pre>
</div>
<p>profileにリポジトリの情報を追加</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler profile edit --name=CentOS6.4-puppet_server --repos=&quot;CentOS6.4-epel&quot;</span>
<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_client --repos=&quot;CentOS6.4-epel&quot;</span>
</pre></div>
</div>
<p>profileをコピーしたままの状態ではsample.ksファイルが読み込まれるので、ksファイルをコピーしてPuppetをインストールするよう書き換える。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cd /var/lib/cobbler/kickstarts</span>
<span class="c"># cp sample.ks puppet_server.ks</span>
<span class="c"># cp sample.ks puppet_client.ks</span>

<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_server --kickstart=/var/lib/cobbler/kickstarts/puppet_server.ks</span>
<span class="c"># cobbler profile edit --name=CentOS6.4-puppet_client --kickstart=/var/lib/cobbler/kickstarts/puppet_client.ks</span>
</pre></div>
</div>
<p>固定IPを割り振るためにsystemに登録する。</p>
<div class="highlight-python"><pre># vi /etc/cobbler/settings
pxe_just_once: 1

# service cobblerd restart</pre>
</div>
<div class="highlight-python"><pre># cobbler system add  \
--name=puppet-server-2 \
--hostname=puppetserver.localnet \
--dns-name=puppetserver.localnet \
--profile=CentOS6.4-puppet_server \
--interface=eth0 \
--mac=XX:XX:XX:XX:XX:XX \
--static=1 \
--ip-address=192.168.0.2 \
--subnet=255.255.255.0 \
--gateway=192.168.0.254 \
--name-servers=192.168.0.1

# cobbler system add  \
--name=puppet-client-003 \
--hostname=puppetclient003.localnet \
--dns-name=puppetclient003.localnet \
--profile=CentOS6.4-puppet_client \
--interface=eth0 \
--mac=XX:XX:XX:XX:XX:XX \
--static=1 \
--ip-address=192.168.0.3 \
--subnet=255.255.255.0 \
--gateway=192.168.0.254 \
--name-servers=192.168.0.1</pre>
</div>
<p>pxe_just_onceを有効にすると登録したsystemは1度しかpxe bootしないので、OSインストール後に、もう1度pxe bootさせたくなったら下記を実行する。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># cobbler system edit --name=puppet-client-003 --netboot-enabled=1</span>
</pre></div>
</div>
</div>
<div class="section" id="puppet">
<h2>Puppet</h2>
<p>PuppetにはPUSHモードとPULLモードがある。</p>
<table border="1" class="docutils">
<colgroup>
<col width="14%"/>
<col width="86%"/>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>PULL</td>
<td>クライアントからサーバへ定期的にマニュフェストを取得し適用する。</td>
</tr>
<tr class="row-even"><td>PUSH</td>
<td>サーバからクライアントへマニュフェストを取得し適用するよう指示する。</td>
</tr>
</tbody>
</table>
<p>今回はPUSHモードのPuppet環境を構築する。</p>
<div class="section" id="puppet-server">
<h3>Puppet server</h3>
<p>Puppet clientを自動構築するためにPuppet serverを作り込む。</p>
<p>Puppet serverのほうはOSインストール後にPuppet serverをインストールするなり、Cobblerサーバのkickstartファイルのpackageセクションに記述するなり好きにすればいいと思う。</p>
<div class="highlight-python"><pre># puppet --version
2.6.18</pre>
</div>
<div class="highlight-python"><pre># vi /etc/sysconfig/puppet

# The puppetmaster server
#PUPPET_SERVER=puppet

# If you wish to specify the port to connect to do so here
PUPPET_PORT=8139

# Where to log to. Specify syslog to send log messages to the system log.
PUPPET_LOG=/var/log/puppet/puppet.log

# You may specify other parameters to the puppet client here
#PUPPET_EXTRA_OPTS=--waitforcert=500</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/autosign.conf

*.localnet</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/fileserver.conf

[files]
 path /etc/puppet/manifests/files
 allow *</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/manifests/site.pp

package { 'zsh' :
        ensure =&gt; present;
}

file { '/etc/sysconfig/puppet' :
        owner =&gt; 'root',
        group =&gt; 'root',
        mode =&gt; 644,
        source =&gt; 'puppet://puppetserver.localnet/files/puppet',
}

file { '/etc/puppet/auth.conf' :
        owner =&gt; 'root',
        group =&gt; 'root',
        mode =&gt; 644,
        source =&gt; 'puppet://puppetserver.localnet/files/auth.conf',
}</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/manifests/files/puppet

# The puppetmaster server
PUPPET_SERVER=puppetsrv.localnet

# If you wish to specify the port to connect to do so here
#PUPPET_PORT=8140

# Where to log to. Specify syslog to send log messages to the system log.
PUPPET_LOG=/var/log/puppet/puppet.log

# You may specify other parameters to the puppet client here
#PUPPET_EXTRA_OPTS=--waitforcert=500
PUPPET_EXTRA_OPTS=&quot;--listen --no-client&quot;</pre>
</div>
<div class="highlight-python"><pre># vi /etc/puppet/manifests/files/auth.conf

path /run
method save
allow *

path /
auth any</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># service puppetmaster start</span>
</pre></div>
</div>
<p>これで以下のコマンドを実行すればPuppet clientにマニュフェストが適用される。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># puppet kick --host puppetclient002.localnet</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="kickstart">
<h2>Kickstart</h2>
<p>Puppet client用のkickstartファイルは下記のようになっている。</p>
<p>postセクションに</p>
<div class="highlight-python"><pre>/sbin/chkconfig puppet on
puppet agent --server=puppetserver.localnet --no-daemonize --onetime</pre>
</div>
<p>を記述することで、Puppetの自動起動、Puppet serverからマニュフェストを取得する処理が1度だけ実行される。これでPuppet clientはOSインストールからPuppetインストール,セットアップまで自動化することが出来た。しかし、今回の設定では各clientの細かい制御(client1にはapache,client2にはmysqlなど)が出来ていないのでそれについては、またの機会に書きたいと思う。</p>
<div class="highlight-python"><pre># vi /var/lib/cobbler/kickstarts/puppet_client.ks

#platform=x86, AMD64, or Intel EM64T
# System authorization information
auth  --useshadow  --enablemd5
# System bootloader configuration
bootloader --location=mbr
# Partition clearing information
clearpart --all --initlabel
# Use text mode install
text
# Firewall configuration
#firewall --enabled
firewall --disabled
# Run the Setup Agent on first boot
firstboot --disable
# Timezone
timezone Asia/Tokyo
# System keyboard
keyboard us
# System language
lang en_US
# Use network installation
url --url=$tree
# If any cobbler repo definitions were referenced in the kickstart profile, include them here.
$yum_repo_stanza
# Network information
$SNIPPET('network_config')
# Reboot after installation
reboot

#Root password
rootpw --iscrypted $default_password_crypted
# SELinux configuration
selinux --disabled
# Do not configure the X Window System
skipx
# System timezone
timezone  America/New_York
# Install OS instead of upgrade
install
# Clear the Master Boot Record
zerombr
# Allow anaconda to partition the system as needed
autopart


%pre
$SNIPPET('log_ks_pre')
$SNIPPET('kickstart_start')
$SNIPPET('pre_install_network_config')
# Enable installation monitoring
$SNIPPET('pre_anamon')

%packages
$SNIPPET('func_install_if_enabled')
$SNIPPET('puppet_install_if_enabled')
puppet

%post
$SNIPPET('log_ks_post')
# Start yum configuration
$yum_config_stanza
# End yum configuration
$SNIPPET('post_install_kernel_options')
$SNIPPET('post_install_network_config')
$SNIPPET('func_register_if_enabled')
$SNIPPET('puppet_register_if_enabled')
$SNIPPET('download_config_files')
$SNIPPET('koan_environment')
$SNIPPET('redhat_register')
$SNIPPET('cobbler_register')
/sbin/chkconfig puppet on
puppet agent --server=puppetserver.localnet --no-daemonize --onetime
# Enable post-install boot notification
$SNIPPET('post_anamon')
# Start final steps
$SNIPPET('kickstart_done')
# End final steps</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.cobblerd.org/manuals/2.4.0/4/4/2_-_Managing_DNS.html">Managing DNS</a></li>
<li><a class="reference external" href="http://www.cobblerd.org/manuals/2.2.3/4/3/1_-_Managing_DHCP.html">Managing DHCP</a></li>
<li><a class="reference external" href="http://d.hatena.ne.jp/int128/20120226/1330247800">http://d.hatena.ne.jp/int128/20120226/1330247800</a></li>
<li><a class="reference external" href="http://blog.glidenote.com/blog/2012/03/16/cobbler-system-add">http://blog.glidenote.com/blog/2012/03/16/cobbler-system-add/</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ puppet ]]></category>
            <category><![CDATA[ cobbler ]]></category>
             <pubDate>Sat, 22 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/18/centos_cobbler_setup.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/18/centos_cobbler_setup.html</guid>
            <title><![CDATA[CentOS6.4にCobblerサーバ構築]]></title>
            <description><![CDATA[<div class="section" id="centos6-4cobbler">
<h1>CentOS6.4にCobblerサーバ構築</h1>
<p>サーバ100台くらいにOSインストールする作業が発生するかもしれないので怠けるための作業をメモしておく。まずはCobblerサーバを構築してOSインストールが出来るまで。</p>
<div class="highlight-python"><pre># uname -a
Linux localhost.localdomain 2.6.32-358.11.1.el6.x86_64 #1 SMP Wed Jun 12 03:34:52 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux

# cat /etc/centos-release
CentOS release 6.4 (Final)</pre>
</div>
<p>SELinuxを無効にしないとCobblerが動作しない。</p>
<p>下記のファイルを編集して再起動</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi /etc/selinux/config</span>
<span class="n">SELINUX</span><span class="o">=</span><span class="n">disabled</span>

<span class="c"># chkconfig xinetd on</span>
<span class="c"># chkconfig httpd on</span>
<span class="c"># chkconfig cobblerd on</span>
<span class="c"># chkconfig dhcpd on</span>
<span class="c"># reboot</span>
</pre></div>
</div>
<div class="highlight-python"><pre># rpm -i http://mirror.symnds.com/distributions/fedora-epel/6/x86_64/epel-release-6-8.noarch.rpm
# yum -y install cobbler pykickstart dhcp

# cobbler --version
Cobbler 2.2.3
  source: ?, ?
  build time: Mon Jun 18 01:04:49 2012

# cobbler check
The following are potential configuration items that you may want to fix:

1 : The 'server' field in /etc/cobbler/settings must be set to something other than localhost, or kickstarting features will not work.  This should be a resolvable hostname or IP for the boot server as reachable by all machines that will use it.
2 : For PXE to be functional, the 'next_server' field in /etc/cobbler/settings must be set to something other than 127.0.0.1, and should match the IP of the boot server on the PXE network.
3 : some network boot-loaders are missing from /var/lib/cobbler/loaders, you may run 'cobbler get-loaders' to download them, or, if you only want to handle x86/x86_64 netbooting, you may ensure that you have installed a *recent* version of the syslinux package installed and can ignore this message entirely.  Files in this directory, should you want to support all architectures, should include pxelinux.0, menu.c32, elilo.efi, and yaboot. The 'cobbler get-loaders' command is the easiest way to resolve these requirements.
4 : change 'disable' to 'no' in /etc/xinetd.d/rsync
5 : since iptables may be running, ensure 69, 80/443, and 25151 are unblocked
6 : debmirror package is not installed, it will be required to manage debian deployments and repositories
7 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: &quot;openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'&quot; to generate new one
8 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them

Restart cobblerd and then run 'cobbler sync' to apply changes.

# /etc/init.d/cobblerd start

# vi /etc/xinetd.d/rsync
disable = no

# vi /etc/xinetd.d/tftp
disable = no

# vi /etc/cobbler/settings
server: 192.168.0.1
manage_dhcp: 1
next_server: 192.168.0.254 &lt;- Gateway

# vi /etc/cobbler/dhcp.template
subnet 192.168.0.0 netmask 255.255.255.0 {
     option routers             192.168.0.254;
     option domain-name-servers 8.8.8.8;
     option subnet-mask         255.255.255.0;
     range dynamic-bootp        192.168.0.200 192.168.0.250;
     filename                   &quot;/pxelinux.0&quot;;
     default-lease-time         21600;
     max-lease-time             43200;
     next-server                $next_server;
}

# /etc/init.d/iptables stop
# /etc/init.d/xinetd restart
# /etc/init.d/cobblerd restart

# cobbler get-loaders
# cobbler sync

# cobbler import --path=rsync://ftp.jaist.ac.jp/pub/Linux/CentOS/6.4/os/x86_64/ --name=CentOS6.4_x86_64
# cobbler sync</pre>
</div>
<p>Cobblerを使いインストールするとデフォルトのパスワードはcobblerとなっている。</p>
<p>変更する場合は</p>
<div class="highlight-python"><pre># cobbler check
The following are potential configuration items that you may want to fix:

1 : debmirror package is not installed, it will be required to manage debian deployments and repositories
2 : The default password used by the sample templates for newly installed machines (default_password_crypted in /etc/cobbler/settings) is still set to 'cobbler' and should be changed, try: &quot;openssl passwd -1 -salt 'random-phrase-here' 'your-password-here'&quot; to generate new one
3 : fencing tools were not found, and are required to use the (optional) power management features. install cman or fence-agents to use them

Restart cobblerd and then run 'cobbler sync' to apply changes.</pre>
</div>
<p>に書いてあるように</p>
<div class="highlight-python"><pre># openssl passwd -1 -salt &quot;cobbler&quot; &quot;password&quot;
$1$cobbler$UTIGTKoLfLdeMAPNxROQZ1</pre>
</div>
<p>を実行して</p>
<div class="highlight-python"><pre># vi /etc/cobbler/settings
default_password_crypted: &quot;$1$cobbler$UTIGTKoLfLdeMAPNxROQZ1&quot;</pre>
</div>
<p>設定ファイルを書き換えてCobblerを再起動</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># /etc/init.d/cobblerd restart</span>
</pre></div>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.asahi-net.or.jp/~aa4t-nngk/pxeinstall.html">http://www.asahi-net.or.jp/~aa4t-nngk/pxeinstall.html</a></li>
<li><a class="reference external" href="http://blog.glidenote.com/blog/2012/03/15/cobbler-install">http://blog.glidenote.com/blog/2012/03/15/cobbler-install/</a></li>
<li><a class="reference external" href="http://www.ibm.com/developerworks/jp/linux/library/l-cobbler">http://www.ibm.com/developerworks/jp/linux/library/l-cobbler/</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ cobbler ]]></category>
             <pubDate>Tue, 18 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/08/ubuntu_mongodb_rails3_setup.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/08/ubuntu_mongodb_rails3_setup.html</guid>
            <title><![CDATA[Rails3でMongoDBを使ってみる]]></title>
            <description><![CDATA[<div class="section" id="rails3mongodb">
<h1>Rails3でMongoDBを使ってみる</h1>
<div class="highlight-python"><pre>$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 12.04.2 LTS
Release:        12.04
Codename:       precise

$ uname -a
Linux ubuntu1204-64-base 3.2.0-45-generic #70-Ubuntu SMP Wed May 29 20:12:06 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux

$ rails -v
Rails 3.2.12

$ rails new mongodb_app --skip-active-record

$ cd mongodb_app

$ vi Gemfile
gem 'mongoid'
gem 'bson_ext'

$ bundle install --path vendor/bundle --binstubs

$ bin/rails g mongoid:config
  create  config/mongoid.yml

$ bin/rails g scaffold Post title:string subscription:text

$ cat app/models/post.rb
class Post
  include Mongoid::Document
  field :title, type: String
  field :subscription, type: String
end

$ mongo
&gt; show dbs
mongodb_app_development 0.203125GB
&gt; use mongodb_app_development
&gt; show collections
posts
&gt; db.posts.find()
{ &quot;_id&quot; : ObjectId(&quot;51b1ea5da64aef614e000001&quot;), &quot;title&quot; : &quot;sample&quot;, &quot;subscription&quot; : &quot;text&quot; }
{ &quot;_id&quot; : ObjectId(&quot;51b2afb0a64aef0c3f000001&quot;), &quot;title&quot; : &quot;hogehoge&quot;, &quot;subscription&quot; : &quot;fugafuga&quot; }</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://mongoid.org/en/mongoid">http://mongoid.org/en/mongoid/</a></li>
<li><a class="reference external" href="http://docs.mongodb.org/ecosystem/tutorial/getting-started-with-ruby-on-rails-3">http://docs.mongodb.org/ecosystem/tutorial/getting-started-with-ruby-on-rails-3/</a></li>
</ul>
</div>]]></description>
            <category><![CDATA[ mongodb ]]></category>
            <category><![CDATA[ rails ]]></category>
             <pubDate>Sat, 08 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/06/05/debian_wheezy_nested_kvm.html</link>
            <guid>http://127.0.0.1/blog/html/2013/06/05/debian_wheezy_nested_kvm.html</guid>
            <title><![CDATA[Debian wheezyでNested KVMを試してみる]]></title>
            <description><![CDATA[<div class="section" id="debian-wheezynested-kvm">
<h1>Debian wheezyでNested KVMを試してみる</h1>
<p><a class="reference external" href="https://code.google.com/p/ganeti">ganeti</a>のbetaを触るのに実機を2,3台用意しないといけないことから開放されそう。</p>
<div class="section" id="kvm">
<h2>KVM インストール</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install install qemu-kvm libvirt-bin virtinst bridge-utils</span>
</pre></div>
</div>
</div>
<div class="section" id="nested-kvm">
<h2>Nested KVM</h2>
<p>Nested KVMを有効にするための設定を行う。</p>
<div class="highlight-python"><pre># modinfo kvm_intel
filename:       /lib/modules/3.2.0-4-amd64/kernel/arch/x86/kvm/kvm-intel.ko
license:        GPL
author:         Qumranet
depends:        kvm
intree:         Y
vermagic:       3.2.0-4-amd64 SMP mod_unload modversions
parm:           vpid:bool
parm:           flexpriority:bool
parm:           ept:bool
parm:           unrestricted_guest:bool
parm:           emulate_invalid_guest_state:bool
parm:           vmm_exclusive:bool
parm:           yield_on_hlt:bool
parm:           fasteoi:bool
parm:           nested:bool
parm:           ple_gap:int
parm:           ple_window:int

# cat /sys/module/kvm_intel/parameters/nested
N

# vi /etc/modprobe.d/kvm-nested.conf
options kvm_intel nested=1

# modprobe -r kvm_intel
# modprobe kvm_intel

# cat /sys/module/kvm_intel/parameters/nested
Y</pre>
</div>
</div>
<div class="section" id="id1">
<h2>仮想マシンの作成</h2>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">VM_NAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">MEM</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">SIZE</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$4</span>
<span class="nv">OS</span><span class="o">=</span><span class="nv">$5</span>

<span class="nv">DISKIMAGE</span><span class="o">=</span><span class="s2">&quot;/var/lib/libvirt/images/$VM_NAME&quot;</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;centos&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># CentOS 6.4 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jaist.ac.jp/pub/Linux/CentOS/6.4/os/x86_64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;precise&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Ubuntu 12.04 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.riken.jp/Linux/ubuntu/dists/precise/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;squeeze&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Squeeze amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/squeeze/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;wheezy&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Wheezy amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/wheezy/main/installer-amd64/'</span>
<span class="k">fi</span>

virt-install --hvm --accelerate --nographics <span class="se">\</span>
  --name <span class="nv">$VM_NAME</span> <span class="se">\</span>
  --network <span class="nv">bridge</span><span class="o">=</span><span class="nv">$IFACE</span>,model<span class="o">=</span>virtio <span class="se">\</span>
  --ram <span class="nv">$MEM</span> <span class="se">\</span>
  --vcpus 1 <span class="se">\</span>
  --cpu core2duo <span class="se">\</span>
  --os-type linux <span class="se">\</span>
  --location <span class="nv">$DIST</span> <span class="se">\</span>
  --disk <span class="nv">path</span><span class="o">=</span><span class="nv">$DISKIMAGE</span>.qcow2,format<span class="o">=</span>qcow2,size<span class="o">=</span><span class="nv">$SIZE</span>,bus<span class="o">=</span>virtio,cache<span class="o">=</span>writethrough <span class="se">\</span>
  --extra-args<span class="o">=</span><span class="s1">'console=tty0 console=ttyS0,115200n8'</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vm-install.sh debian7_vm 1500 100 br1 wheezy</span>
</pre></div>
</div>
</div>
<div class="section" id="os">
<h2>ゲストOSでの仮想マシン作成</h2>
<p>ゲストOSでKVMのインストールと仮想マシンの作成を行う。</p>
<p>スクリプトは–cpuオプションを取っただけであとは同じ。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install install qemu-kvm libvirt-bin virtinst bridge-utils</span>
</pre></div>
</div>
<div class="highlight-bash"><div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="nv">VM_NAME</span><span class="o">=</span><span class="nv">$1</span>
<span class="nv">MEM</span><span class="o">=</span><span class="nv">$2</span>
<span class="nv">SIZE</span><span class="o">=</span><span class="nv">$3</span>
<span class="nv">IFACE</span><span class="o">=</span><span class="nv">$4</span>
<span class="nv">OS</span><span class="o">=</span><span class="nv">$5</span>

<span class="nv">DISKIMAGE</span><span class="o">=</span><span class="s2">&quot;/var/lib/libvirt/images/$VM_NAME&quot;</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;centos&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># CentOS 6.4 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jaist.ac.jp/pub/Linux/CentOS/6.4/os/x86_64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;precise&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Ubuntu 12.04 amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.riken.jp/Linux/ubuntu/dists/precise/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;squeeze&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Squeeze amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/squeeze/main/installer-amd64/'</span>
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$OS&quot;</span> <span class="o">=</span> <span class="s2">&quot;wheezy&quot;</span> <span class="o">]</span>; <span class="k">then</span>
  <span class="c"># Debian Wheezy amd64</span>
  <span class="nv">DIST</span><span class="o">=</span><span class="s1">'http://ftp.jp.debian.org/debian/dists/wheezy/main/installer-amd64/'</span>
<span class="k">fi</span>

virt-install --hvm --accelerate --nographics <span class="se">\</span>
  --name <span class="nv">$VM_NAME</span> <span class="se">\</span>
  --network <span class="nv">bridge</span><span class="o">=</span><span class="nv">$IFACE</span>,model<span class="o">=</span>virtio <span class="se">\</span>
  --ram <span class="nv">$MEM</span> <span class="se">\</span>
  --vcpus 1 <span class="se">\</span>
  --os-type linux <span class="se">\</span>
  --location <span class="nv">$DIST</span> <span class="se">\</span>
  --disk <span class="nv">path</span><span class="o">=</span><span class="nv">$DISKIMAGE</span>.qcow2,format<span class="o">=</span>qcow2,size<span class="o">=</span><span class="nv">$SIZE</span>,bus<span class="o">=</span>virtio,cache<span class="o">=</span>writethrough <span class="se">\</span>
  --extra-args<span class="o">=</span><span class="s1">'console=tty0 console=ttyS0,115200n8'</span>
</pre></div>
</div>
<div class="highlight-python"><pre># virsh net-list --all
Name                 State      Autostart
-----------------------------------------
default              inactive   no

# virsh net-start default
# vm-install.sh debian7_nested 500 50 virbr0 wheezy</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.debian.org/releases/wheezy">http://www.debian.org/releases/wheezy/</a></li>
<li><a class="reference external" href="http://wiki.debian.org/KVM">http://wiki.debian.org/KVM</a></li>
<li><a class="reference external" href="http://aikotobaha.blogspot.jp/2012/02/kvm-on-kvmnested-kvm.html">http://aikotobaha.blogspot.jp/2012/02/kvm-on-kvmnested-kvm.html</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ kvm ]]></category>
             <pubDate>Wed, 05 Jun 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/05/26/ubuntu_mongodb_install.html</link>
            <guid>http://127.0.0.1/blog/html/2013/05/26/ubuntu_mongodb_install.html</guid>
            <title><![CDATA[Ubuntu12.04にMongoDBをインストール]]></title>
            <description><![CDATA[<div class="section" id="ubuntu12-04mongodb">
<h1>Ubuntu12.04にMongoDBをインストール</h1>
<p>積読になっていた「MongoDB イン・アクション」をようやく読み始めた。</p>
<p>「Ubuntu 12.04 amd64」にMongoDBをインストールして手を動かしてみたのでメモしておく。</p>
<p>Railsで使いたいなと思っているところ。</p>
<p>本家のドキュメントにaptでインストール出来ると書いているのでそれに従ってみた。</p>
<div class="section" id="mongodb">
<h2>MongoDB インストール</h2>
<div class="highlight-python"><pre>$ sudo apt-key adv --keyserver keyserver.ubuntu.com --recv 7F0CEB10
$ echo 'deb http://downloads-distro.mongodb.org/repo/ubuntu-upstart dist 10gen' | sudo tee /etc/apt/sources.list.d/10gen.list
$ sudo apt-get update
$ sudo apt-get install mongodb-10gen</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install mongodb-10gen=2.2.3</span>
</pre></div>
</div>
<p>で指定のVersionをインストールすることが出来る。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># echo &quot;mongodb-10gen hold&quot; | dpkg --set-selections</span>
</pre></div>
</div>
<p>でインストールしたVersionからアップグレードしないように出来る。</p>
</div>
<div class="section" id="id1">
<h2>MongoDB 操作</h2>
<div class="highlight-python"><pre>$ mongo
MongoDB shell version: 2.4.3
connecting to: test
Welcome to the MongoDB shell.
For interactive help, type &quot;help&quot;.
For more comprehensive documentation, see
        http://docs.mongodb.org/
Questions? Try the support group
        http://groups.google.com/group/mongodb-user

use tutorial

db.users.insert({username: &quot;hoge&quot;})

db.users.find()
{ &quot;_id&quot; : ObjectId(&quot;51a1f5c136f07a662784e8ae&quot;), &quot;username&quot; : &quot;hoge&quot; }

db.users.save({username: &quot;moge&quot;})

db.users.find()
{ &quot;_id&quot; : ObjectId(&quot;51a1f5c136f07a662784e8ae&quot;), &quot;username&quot; : &quot;hoge&quot; }
{ &quot;_id&quot; : ObjectId(&quot;51a1f8d336f07a662784e8af&quot;), &quot;username&quot; : &quot;moge&quot; }

db.users.count()
2

db.users.update({username: &quot;hoge&quot;}, {$set: {country: &quot;canada&quot;}})
db.users.find({username: &quot;hoge&quot;})
{ &quot;_id&quot; : ObjectId(&quot;51a1f5c136f07a662784e8ae&quot;), &quot;country&quot; : &quot;canada&quot;, &quot;username&quot; : &quot;hoge&quot; }

db.users.update({username: &quot;hoge&quot;}, {$unset: {country: 1}})
db.users.find({username: &quot;hoge&quot;})
{ &quot;_id&quot; : ObjectId(&quot;51adf33a197bc318df1ad8ad&quot;), &quot;username&quot; : &quot;hoge&quot; }</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu">http://docs.mongodb.org/manual/tutorial/install-mongodb-on-ubuntu/</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ mongodb ]]></category>
             <pubDate>Sun, 26 May 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/05/20/unbound_nsd.html</link>
            <guid>http://127.0.0.1/blog/html/2013/05/20/unbound_nsd.html</guid>
            <title><![CDATA[Unbound + NSD]]></title>
            <description><![CDATA[<div class="section" id="unbound-nsd">
<h1>Unbound + NSD</h1>
<p>Chef Serverと戯れるときにhostsをいちいち書き換えるのは</p>
<p>面倒なので内部にDNSサーバを立ててみた。</p>
<table border="1" class="docutils">
<caption>Ubuntu 12.04 server amd64</caption>
<colgroup>
<col width="33%"/>
<col width="33%"/>
<col width="33%"/>
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td>コンテンツサーバ</td>
<td>NSD(3.2.9)</td>
<td>192.168.0.1</td>
</tr>
<tr class="row-even"><td>キャッシュサーバ</td>
<td>Unbound(1.4.16)</td>
<td>192.168.0.2</td>
</tr>
</tbody>
</table>
<div class="section" id="nsd">
<h2>NSD</h2>
<p>今回は正引きだけ設定した。</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install nsd</span>
<span class="c"># cd /etc/nsd3</span>
<span class="c"># cp nsd.conf.sample nsd.conf</span>
<span class="c"># vi nsd.conf</span>
</pre></div>
</div>
<div class="highlight-python"><pre>server:
  ip-address: 192.168.0.1
  hide-version: yes
  ipv4-only: yes
  database: &quot;/etc/nsd3/nsd.conf&quot;
  pidfile: &quot;/etc/nsd3/nsd.pid&quot;
  chroot: &quot;/etc/nsd3&quot;
  username: nsd
  zonedir: &quot;/etc/nsd3&quot;
  difffile: &quot;/etc/nsd3/ixfr.db&quot;
  xfrdfile: &quot;/etc/nsd3/xfrd.state&quot;

zone:
  name: chef.local
  zonefile: chef.local.zone</pre>
</div>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># vi chef.local.zone</span>
</pre></div>
</div>
<div class="highlight-python"><pre>$TTL 3600
@ IN SOA ns1.chef.local. postmaster.chef.local. (
  2013052001  ;Serial
  3600        ;Refresh
  1800        ;Retry
  57200       ;Expire
  86400       ;Minimum TTL
)

@ IN  NS  ns1.chef.local.

ns1   IN  A 192.168.0.1
ns2   IN  A 192.168.0.2
www   IN  A 192.168.0.3
hoge  IN  A 192.168.0.4
fuga  IN  A 192.168.0.5
moge  IN  A 192.168.0.6</pre>
</div>
</div>
<div class="section" id="unbound">
<h2>Unbound</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># apt-get install unbound</span>
<span class="c"># cd /etc/unbound</span>
<span class="c"># zcat `locate unbound.conf | sed -n 2p` &gt; unbound.conf</span>
<span class="c"># vi unbound.conf</span>
</pre></div>
</div>
<div class="highlight-python"><pre>server:
  verbosity: 1
  interface 192.168.0.2
  do-ip6: no
  access-control: 127.0.0.0/8 allow
  access-control: 192.168.0.0/24 allow
  chroot: &quot;etc/unbound&quot;
  username: &quot;unbound&quot;
  directory: &quot;/etc/unbound&quot;
  use-syslog: yes
  pidfile: &quot;/etc/unbound/unbound.pid&quot;

stub-zone:
  name: &quot;chef.local&quot;
  stub-addr: 192.168.0.1</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://unbound.jp">http://unbound.jp/</a></li>
<li><a class="reference external" href="http://unbound.jp/news20110624">http://unbound.jp/news20110624/</a></li>
<li><a class="reference external" href="http://gihyo.jp/admin/feature/01/unbound">http://gihyo.jp/admin/feature/01/unbound</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ nsd ]]></category>
            <category><![CDATA[ unbound ]]></category>
             <pubDate>Mon, 20 May 2013 00:00:00 +0900</pubDate>
        </item>
    
        <item>
            <link>http://127.0.0.1/blog/html/2013/03/23/tinkerer_github.html</link>
            <guid>http://127.0.0.1/blog/html/2013/03/23/tinkerer_github.html</guid>
            <title><![CDATA[Tinkerer + Github]]></title>
            <description><![CDATA[<div class="section" id="tinkerer-github">
<h1>Tinkerer + Github</h1>
<p>jekyll + Githubを使ってブログを書いていたのだけれどローカルで確認するのにWEBRick動かすということに面倒くささを感じ流らく放置してしまっていた。</p>
<p>もっと手軽な(Sphinxみたいにhtmlが掃き出される)ものはないかと探してみたところTinkererというものを見付けた。</p>
<div class="highlight-python"><pre>$ pip install tinkerer</pre>
</div>
<div class="highlight-python"><pre>$ tinker -s</pre>
</div>
<div class="highlight-python"><pre>$ wget http://dl.dropbox.com/u/218108/files/japanesesupport.py
$ mkdir _exts
$ mv japanesesupport.py _exts
$ hg clone https://bitbucket.org/vladris/tinkerer-contrib
$ cp `find tinkerer-contrib -name withgithub.py` _exts
$ rm -rf tinkerer-contrib
$ touch .nojekyll</pre>
</div>
<div class="section" id="conf-py">
<h2>conf.py 修正</h2>
<div class="highlight-python"><div class="highlight"><pre><span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="s">'tinkerer.ext.blog'</span><span class="p">,</span> <span class="s">'tinkerer.ext.disqus'</span><span class="p">,</span> <span class="s">'japanesesupport'</span><span class="p">,</span> <span class="s">'withgithub'</span><span class="p">]</span>

<span class="c"># Add templates to be rendered in sidebar here</span>
<span class="n">html_sidebars</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;**&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s">&quot;recent.html&quot;</span><span class="p">,</span> <span class="s">&quot;categories.html&quot;</span><span class="p">,</span> <span class="s">&quot;tags.html&quot;</span><span class="p">,</span> <span class="s">&quot;searchbox.html&quot;</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-python"><pre>$ tinker -p 'first post'
$ tinker -b
$ git init
$ git add .
$ git commit -m 'first post'
$ git remote add origin git@github.com:zinrai/zinrai.github.com.git
$ git push -u origin master</pre>
</div>
<ul class="simple">
<li><a class="reference external" href="http://www.tinkerer.me/exts/withgithub.html">http://www.tinkerer.me/exts/withgithub.html</a></li>
<li><a class="reference external" href="http://sphinx-users.jp/reverse-dict/html/japanese.html">http://sphinx-users.jp/reverse-dict/html/japanese.html</a></li>
</ul>
</div>
</div>]]></description>
            <category><![CDATA[ tinkerer ]]></category>
             <pubDate>Sat, 23 Mar 2013 00:00:00 +0900</pubDate>
        </item>
    
    </channel>
</rss>